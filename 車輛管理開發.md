# 車輛管理開發規劃文件

此文件為車輛管理系統開發的完整規劃文件，詳細記錄專案背景、需求分析、技術架構、開發計畫等。

## 📋 專案概述

### 專案背景
企業集團需要統一管理旗下車輛的基本資料，以建立完整的企業架構管理系統。此系統將整合現有的公司分類體系，並為未來的行費管理功能預留擴展空間。

### 專案目標
- 建立統一的車輛資料管理平台
- 提供完整的車輛生命週期管理
- 整合企業現有的分類架構
- 支援行照、驗車到期提醒功能
- 建立可擴展的資料架構

### 專案範圍
- 車輛基本資料管理（CRUD）
- 證照與執照管理
- 車隊歸屬管理
- 狀態追蹤管理

## 🎯 功能需求

### 核心功能

#### 1. 車輛資料管理
- **新增車輛**: 完整表單輸入，支援分步驟填寫
  - 公司類別與公司名稱欄位採聯動設計：選定公司類別後僅顯示該類別底下的公司選項，未選擇類別時公司下拉停用；當類別變更且原本的公司不屬於新類別時，會自動清空既有選取以避免配對錯誤。
- **編輯車輛**: 即時編輯，自動儲存草稿
- **刪除車輛**: 軟刪除機制，支援恢復
- **查看詳情**: 完整資料展示，歷史紀錄追蹤

#### 2. 搜尋與篩選功能
- **關鍵字搜尋**: 車號、隊員編號
- **進階篩選**: 
  - 公司類別篩選
  - 狀態篩選（在籍/退籍）預設為在即
  - 驗車到期日範圍
- **排序功能**: 支援多欄位排序
- **分頁顯示**: 可調整每頁顯示筆數

#### 3. 證照管理功能
- **到期提醒**: 自動計算剩餘天數
- **批次提醒**: 產生即將到期清單
- **更新記錄**: 車輛驗車日期更新歷史追蹤

#### 4. 匯入匯出功能
- **Excel 匯入**: 支援批次新增，含錯誤檢查
- **Excel 匯出**: 支援篩選條件匯出
- **範本下載**: 提供標準匯入範本

### 使用者權限

#### 角色定義
- **系統管理員**: 
  - 完整的增刪改查功能
  - 權限管理功能
  - 系統設定管理
  - 匯入匯出功能

- **車輛管理員**:
  - 車輛資料的增刪改查
  - 匯入匯出功能
  - 報表查看功能

- **一般使用者**:
  - 車輛資料查看
  - 基本搜尋功能
  - （權限可由管理員調整）

## 🔧 技術架構

### 技術堆疊
- **後端框架**: Laravel 11.x + PHP 8.4+
- **前端框架**: Vue 3 + Inertia.js + Vite
- **UI框架**: AdminLTE 4 + Bootstrap 5
- **資料庫**: SQLite (開發) / MySQL (正式)
- **權限管理**: Spatie Laravel Permission
- **表單驗證**: Laravel Form Requests
- **檔案處理**: Laravel Excel (匯入匯出)

### 資料庫設計

#### 主要資料表結構

```sql
-- 車輛主表
CREATE TABLE vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_category_id BIGINT NOT NULL COMMENT '公司類別ID',
    company_id BIGINT NOT NULL COMMENT '公司名稱ID',
    license_number VARCHAR(20) UNIQUE NOT NULL COMMENT '車牌號碼',
    replacement_license VARCHAR(20) NULL COMMENT '替補車號',
    vehicle_type VARCHAR(50) NULL COMMENT '車輛類型',
    owner_name VARCHAR(100) NOT NULL COMMENT '車主名稱',
    address TEXT NULL COMMENT '地址',
    brand VARCHAR(50) NULL COMMENT '車輛廠牌',
    manufacture_year YEAR NULL COMMENT '出廠年',
    manufacture_month TINYINT NULL COMMENT '出廠月',
    vehicle_form VARCHAR(50) NULL COMMENT '車輛形式',
    engine_displacement DECIMAL(8,2) NULL COMMENT '排氣量',
    fuel_type VARCHAR(20) NULL COMMENT '燃料種類',
    vehicle_model VARCHAR(100) NULL COMMENT '車輛款式',
    vehicle_style VARCHAR(100) NULL COMMENT '車輛樣式',
    engine_number VARCHAR(50) NULL COMMENT '引擎號碼',
    chassis_number VARCHAR(50) NULL COMMENT '車身號碼',
    passenger_capacity TINYINT NULL COMMENT '載運人數',
    license_issue_year SMALLINT NULL COMMENT '發照年(西元)',
    license_issue_month TINYINT NULL COMMENT '發照月',
    license_issue_day TINYINT NULL COMMENT '發照日',
    vehicle_color VARCHAR(30) NULL COMMENT '車輛顏色',
    inspection_year SMALLINT NULL COMMENT '檢驗年(西元)',
    inspection_month TINYINT NULL COMMENT '檢驗月',
    inspection_day TINYINT NULL COMMENT '檢驗日',
    registration_year SMALLINT NULL DEFAULT (YEAR(CURDATE()) - 1911) COMMENT '車輛入籍年(西元，預設當年)',
    registration_month TINYINT NULL DEFAULT (MONTH(CURDATE())) COMMENT '車輛入籍月(預設當月)',
    registration_day TINYINT NULL DEFAULT (DAY(CURDATE())) COMMENT '車輛入籍日(預設當日)',
    deregistration_year SMALLINT NULL COMMENT '車輛退籍年(西元)',
    deregistration_month TINYINT NULL COMMENT '車輛退籍月',
    deregistration_day TINYINT NULL COMMENT '車輛退籍日',
    property_type VARCHAR(50) NULL COMMENT '產權類別',
    notes TEXT NULL COMMENT '備註',
    vehicle_status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '車輛狀態(在籍/退籍)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL COMMENT '軟刪除時間',

    -- 索引
    INDEX idx_license_number (license_number),
    INDEX idx_company_category (company_category_id),
    INDEX idx_company (company_id),
    INDEX idx_vehicle_status (vehicle_status),
    INDEX idx_inspection_date (inspection_year, inspection_month, inspection_day),
    INDEX idx_registration_date (registration_year, registration_month, registration_day),

    -- 外鍵約束
    FOREIGN KEY (company_category_id) REFERENCES company_categories(id),
    FOREIGN KEY (company_id) REFERENCES companies(id)
);

-- 公司類別設定表 (用於控制替補車號和車主名稱的顯示邏輯)
CREATE TABLE vehicle_config_settings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_category_id BIGINT NOT NULL,
    enable_replacement_license BOOLEAN DEFAULT FALSE COMMENT '是否啟用替補車號選擇',
    enable_owner_dropdown BOOLEAN DEFAULT FALSE COMMENT '是否啟用車主下拉選單',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY unique_category (company_category_id),
    FOREIGN KEY (company_category_id) REFERENCES company_categories(id)
);
```

> 替補車號 API 以公司 ID 作為查詢條件，會先透過公司找出對應的公司類別，再檢查此設定表是否啟用替補車號。

#### 資料驗證規則
- **車牌號碼**: 必填、唯一值、格式驗證 (台灣車牌格式)
- **車主名稱**: 必填、最大100字元
- **年份欄位**: 1900-2100 範圍驗證
- **月份欄位**: 1-12 範圍驗證
- **日期欄位**: 1-31 範圍驗證，配合月份邏輯檢查
- **車輛狀態**: 僅允許 'active' 或 'inactive'
- **退籍邏輯**: 退籍時自動填入當前日期，復籍時清除退籍日期
- **入籍預設值**: 新車輛預設為當前日期 (民國年)

### 車輛管理資料庫欄位
1. 公司類別ID : company_categories資料表的id
2. 公司名稱ID : companies資料表的id（companies表以`category_id`對應公司類別），前端依所選公司類別動態篩選顯示；若未選擇類別則禁止選取公司，並在類別變更時自動清除不屬於新類別的既有選項
3. 車牌號碼 ： 必填欄位，唯一值
4. 替補車號 ： 無資料直接null，前端依所選公司名稱動態載入 `vehicle_licenses` 中屬於該公司的已退役（revoked）牌照，優先使用 `previous_license_number`，若無則改用當前 `license_number`。如該公司沒有任何 revoked 狀態的行牌，下拉欄位即不顯示
5. 車輛類型 ： 無資料直接null
6. 車主名稱 ： 必填欄位，前端要做判斷，若是選擇哪些公司類別，則提供下拉選單提供對應companies資料表的名字為選項當作車主名稱，要設計參數設定提供哪些公司類別選擇後才執行上訴動作，管理員會先設定哪些公司類別提供選項，其他類別就是手打車主姓名
7. 地址 ： 無資料直接null
8. 車輛廠牌 ： 無資料直接null
9. 出廠年 ： 無資料直接null，前端使用西元年
10. 出廠月 ： 無資料直接null
11. 車輛形式： 無資料直接null
12. 排氣量 ： 無資料直接null
13. 燃料種類 ： 無資料直接null
14. 車輛款式 ： 無資料直接null
30. 車輛樣式 ： 無資料直接null
15. 引勤號碼 ： 無資料直接null
16. 車身號碼 ： 無資料直接null
17. 載運人數 ： 無資料直接null
18. 發照年 ： 無資料直接null，前端輸入民國年，存檔要自動轉換存入資料庫
19. 發照月 ： 無資料直接null
20. 發照日 ： 無資料直接null
31. 車輛顏色：無資料直接null
21. 檢驗年 ： 無資料直接null，前端輸入民國年，存檔要自動轉換存入資料庫
22. 檢驗月 ： 無資料直接null
23. 檢驗日 ： 無資料直接null
24. 車輛入籍年 ： 無資料直接null，前端輸入民國年，存檔要自動轉換存入資料庫，預設當下年份
25. 車輛入籍月 ：無資料直接null，預設當下月份
26. 車輛入籍日 ：無資料直接null，預設當下日
27. 車輛退籍年 ：無資料直接null，前端輸入民國年，存檔要自動轉換存入資料庫
28. 車輛退籍月 ：無資料直接null
29. 車輛退籍日 ：無資料直接null
32. 產權類別 ： 無資料直接null
33. 備註 ： 無資料直接null
34. 狀態 ： 分為兩個狀態在籍與退籍，預設在籍，如果有按退籍按鈕則改為退籍，退籍年、退籍月、退籍日要依當日日期填入

### 車輛管理資料庫欄位與行牌管理互動
當替補車號有資料時，新增按鈕按下後除了新增車輛資料還會去進行vehicle_licenses資料表填入資料或修改，把選擇的previous_license_number的對應欄位填入資料，詳細如下

1. 車牌號碼填入vehicle_license資料表對應的license_number
2. 出廠年填入vehicle_license資料表對應的license_year
3. 出廠月填入vehicle_license資料表對應的license_month
4. vehicle_license資料表對應的revoked欄位更改為active狀態
5. vehicle_license資料表對應的replacement_date改為當下日期

## 🚀 API設計

### RESTful API端點

#### 車輛管理API
```
GET    /api/vehicles                    # 取得車輛列表 (支援搜尋、篩選、分頁)
POST   /api/vehicles                    # 新增車輛
GET    /api/vehicles/{id}               # 取得特定車輛詳情
PUT    /api/vehicles/{id}               # 更新車輛資料
DELETE /api/vehicles/{id}               # 刪除車輛 (軟刪除)
POST   /api/vehicles/{id}/restore       # 恢復已刪除車輛
POST   /api/vehicles/{id}/deregister    # 車輛退籍 (更新退籍日期和狀態)
POST   /api/vehicles/{id}/reactivate    # 車輛復籍 (清除退籍日期，恢復在籍狀態)
```

#### 匯入匯出API
```
POST   /api/vehicles/import       # Excel匯入車輛資料
GET    /api/vehicles/export       # 匯出車輛資料為Excel
GET    /api/vehicles/template     # 下載匯入範本
```

#### 配置管理API
```
GET    /api/vehicle-configs                    # 取得所有配置
PUT    /api/vehicle-configs/{category_id}      # 更新公司類別配置
GET    /api/replacement-licenses?company_id=   # 取得指定公司的可用替補車號
GET    /api/company-owners/{category_id}       # 取得公司車主選項
```

> `/api/replacement-licenses` 會回傳陣列，每筆資料含 `id`, `replacement_number`, `holder_name`，僅列出狀態為 revoked 的牌照，若沒有 `previous_license_number` 則改用 `license_number`。

### 請求/回應格式範例

#### 新增車輛請求
```json
{
  "company_category_id": 1,
  "company_id": 2,
  "license_number": "ABC-1234",
  "replacement_license": "DEF-5678",
  "vehicle_type": "小客車",
  "owner_name": "公司名稱",
  "manufacture_year": 2020,
  "manufacture_month": 5,
  "inspection_year": 2024,
  "inspection_month": 6,
  "inspection_day": 15,
  "registration_year": 113,
  "registration_month": 9,
  "registration_day": 17,
  "vehicle_status": "active"
}
```

#### 車輛列表回應
```json
{
  "data": [
    {
      "id": 1,
      "license_number": "ABC-1234",
      "owner_name": "公司名稱",
      "vehicle_type": "小客車",
      "inspection_date": "2024-06-15",
      "days_until_inspection": 45,
      "registration_date": "2024-09-17",
      "deregistration_date": null,
      "vehicle_status": "active"
    }
  ],
  "meta": {
    "current_page": 1,
    "per_page": 20,
    "total": 150,
    "last_page": 8
  }
}
```

## 🔒 安全性設計

### 權限控制矩陣

| 功能 | 系統管理員 | 車輛管理員 | 一般使用者 |
|------|-----------|-----------|-----------|
| 查看車輛列表 | ✅ | ✅ | ✅ |
| 查看車輛詳情 | ✅ | ✅ | ✅ |
| 新增車輛 | ✅ | ✅ | ❌ |
| 編輯車輛 | ✅ | ✅ | ❌ |
| 刪除車輛 | ✅ | ✅ | ❌ |
| 車輛退籍 | ✅ | ✅ | ❌ |
| 車輛復籍 | ✅ | ✅ | ❌ |
| 匯入匯出 | ✅ | ✅ | ❌ |
| 系統配置 | ✅ | ❌ | ❌ |
| 權限管理 | ✅ | ❌ | ❌ |

### 資料安全措施
- **存取控制**: 基於角色的權限檢查
- **操作日誌**: 記錄所有 CRUD 操作
- **資料驗證**: 前後端雙重驗證
- **SQL注入防護**: 使用 Laravel Eloquent ORM
- **CSRF保護**: Laravel 內建 CSRF 令牌
- **軟刪除**: 重要資料不實際刪除

## 🖥️ 前端介面設計

### 頁面結構

#### 1. 車輛列表頁面
- **路由**: `/admin/vehicles`
- **版面**: AdminLayout
- **功能**: 搜尋、篩選、分頁、批次操作

#### 2. 車輛新增/編輯頁面
- **路由**: `/admin/vehicles/create`, `/admin/vehicles/{id}/edit`
- **版面**: AdminLayout
- **功能**:
  - 表單驗證、自動儲存草稿、分步驟填寫
  - 入籍日期預設當前日期
  - 民國年份自動轉換
  - 退籍/復籍狀態控制

#### 3. 車輛詳情頁面
- **路由**: `/admin/vehicles/{id}`
- **版面**: AdminLayout
- **功能**:
  - 完整資料展示、操作歷史
  - 車輛狀態顯示 (在籍/退籍)
  - 退籍/復籍操作按鈕
  - 入籍及退籍日期顯示

### UI組件設計

#### 表單組件
```vue
<VehicleForm
  :vehicle="vehicle"
  :company-categories="categories"
  :is-editing="isEditing"
  @submit="handleSubmit"
  @save-draft="handleSaveDraft"
/>
```

#### 搜尋篩選組件
```vue
<VehicleFilters
  :filters="filters"
  :company-categories="categories"
  :status-options="['active', 'inactive']"
  @filter-change="handleFilterChange"
/>
```

#### 車輛狀態操作組件
```vue
<VehicleStatusActions
  :vehicle="vehicle"
  :can-deregister="canDeregister"
  :can-reactivate="canReactivate"
  @deregister="handleDeregister"
  @reactivate="handleReactivate"
/>
```

#### 到期提醒組件
```vue
<ExpirationAlerts
  :expiring-vehicles="expiringVehicles"
  :alert-days="alertDays"
/>
```

## 📅 開發計畫

### 第一階段 (2週) - 基礎架構
- [ ] 資料庫設計與建立
- [ ] 基本 CRUD API 開發
- [ ] 權限系統整合
- [ ] 基礎前端頁面

### 第二階段 (2週) - 核心功能
- [ ] 搜尋篩選功能
- [ ] 替補車號邏輯
- [ ] 車主名稱動態選單
- [ ] 表單驗證完善

### 第三階段 (1週) - 進階功能
- [ ] Excel 匯入匯出
- [ ] 到期提醒系統
- [ ] 操作日誌記錄
- [ ] 系統配置管理

### 第四階段 (1週) - 測試與優化
- [ ] 單元測試
- [ ] 整合測試
- [ ] 效能優化
- [ ] 使用者體驗優化

## 🧪 測試計畫

### 測試策略
- **單元測試**: PHPUnit (後端邏輯)
- **功能測試**: Laravel Dusk (完整流程)
- **API測試**: Postman/Newman (API端點)
- **前端測試**: Vitest (Vue組件)

### 測試覆蓋範圍
- 車輛 CRUD 操作
- 權限檢查機制
- 資料驗證規則
- 搜尋篩選功能
- 匯入匯出功能
- 到期提醒邏輯

## 🚀 部署與維護

### 部署流程
1. **開發環境**: 本地 SQLite + Vite dev server
2. **測試環境**: MySQL + 完整功能測試
3. **正式環境**: MySQL + 效能監控

### 維護計畫
- **日常監控**: 系統效能、錯誤日誌
- **定期備份**: 資料庫自動備份
- **版本更新**: 定期安全更新
- **使用者支援**: 問題回報與處理機制

## 📋 驗收標準

### 功能驗收
- [ ] 所有 CRUD 功能正常運作
- [ ] 權限控制準確有效
- [ ] 搜尋篩選回應迅速
- [ ] 匯入匯出功能穩定
- [ ] 到期提醒準確及時

### 效能驗收
- [ ] 頁面載入時間 < 3秒
- [ ] API 回應時間 < 1秒
- [ ] 支援 1000+ 車輛資料
- [ ] 同時在線用戶 > 50人

### 安全驗收
- [ ] 權限測試通過
- [ ] 資料驗證有效
- [ ] 無 SQL 注入漏洞
- [ ] CSRF 保護正常

## 📚 相關文件

### 技術文件
- Laravel 官方文件
- Vue 3 + Inertia.js 整合指南
- AdminLTE 4 使用手冊
- Spatie Permission 套件文件

### 專案文件
- 資料庫設計文件
- API 規格文件
- 使用者操作手冊
- 系統維護手冊
