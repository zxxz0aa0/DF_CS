# 支出款項管理開發規劃文件

此文件為支出款項管理模組的完整開發規劃，涵蓋專案背景、功能與流程設計、技術架構、資料庫設計、開發與測試計畫，以及驗收標準等內容，作為產品開發與跨部門協作的基礎文件。

## 📋 專案概述

### 專案背景
企業內部現行的支出請款作業分散於紙本與多個 Excel 表單，缺乏統一的資料管理與歷程追蹤，導致核對困難、狀態不透明、資料維護成本高。為持續提升財務透明度與核對效率，需要建置一套支出款項管理系統，串連現有的人員、車輛與帳務資料，落實線上化與流程化管理。

### 專案目標
- 建立統一的支出請款資料平台
- 覆蓋請款建檔與支付的完整生命週期
- 強化款項狀態追蹤與歷程稽核能力
- 提供批次操作、匯出與整合報表能力，支援外部帳務流程

### 專案範圍
- 支出款項資料 CRUD 與查詢
- 款項狀態管理（未支付 / 已支付）
- 批次請款與批次狀態更新
- 匯入匯出、報表與記錄追蹤
- 權限控管與審計紀錄

### 不在範圍（Out of Scope）
- 實際付款執行與金流整合
- 完整的預算控管與 KPI 分析
- 第三方會計系統 API 介接（僅預留欄位與匯出格式）
- 行動裝置 App 版本

## 🎯 需求分析

### 使用者角色與權限
- **系統管理員**
  - 管理所有支出資料與系統設定
  - 指派角色權限、設定匯出範本
  - 檢視審計紀錄
- **財務 / 核帳人員**
  - 建立、編輯、刪除支出款項
  - 執行批次請款與狀態更新
  - 匯出報表，匯入匯整資料
- **隊員主管 / 部門主管**
  - 查閱所屬隊員的支出記錄
  - 發起請款申請或提供補件資訊

### 使用情境（高優先）
1. 財務人員每日匯入隊員或外部系統回傳的支出資料，進行批次建檔。
2. 部門主管透過系統查詢某段期間的隊員支出狀態，確認是否已支付。
3. 財務人員勾選多筆「未支付」款項，執行批次請款並同步紀錄支付日期。
4. 系統管理員匯出符合條件的資料並提供給會計系統進行對帳。

### 業務流程概述
1. **資料建檔**：手動新增或匯入形成待處理狀態。
2. **支付排程**：財務依內部規則確認金額與備註，安排付款批次。
3. **支付執行**：財務在系統中批次更新「已支付」，並記錄付款日期與方式。
4. **歷程追蹤**：透過操作紀錄與狀態變更時間表進行稽核。
5. **匯出報表**：依日期、隊員、車輛等條件匯整報表。

## 🧩 功能規劃

### 核心功能
1. **支出款項資料管理**
   - 建立、編輯、刪除、查詢
   - 支援草稿狀態、資料補件紀錄
   - 狀態僅分為「未支付」「已支付」，可加註支付備註
2. **搜尋與篩選**
   - 關鍵字搜尋（隊員編號、姓名、車牌、款項名稱）
   - 進階篩選：日期區間、狀態、金額範圍、支付方式
   - 支援多欄位排序及分頁控制
3. **批次操作**
   - 批次選取與狀態更新（標記已支付、更新支付日期）
   - 批次匯出 Excel / CSV
4. **匯入匯出功能**
   - Excel 匯入：欄位驗證、錯誤回報、重複檢查
   - Excel / CSV 匯出：依篩選條件產生
   - 匯入範本維護與版本控管
5. **稽核日誌與歷程追蹤**
   - 記錄建立、修改、批次支付行為
   - 提供操作查詢與匯出

### 支援功能
- 欄位合法性檢核與即時提示
- 權限控管與資料隔離（依部門 / 角色）
- 權限設定介面：於角色／職務管理頁面提供 `view/create/edit/delete/import/export expense payments` 勾選控制
- 報表視覺化（折線圖 / 長條圖）

### 非功能性需求
- **效能**：單次批次操作需可處理 1,000 筆資料，系統回應時間 < 3 秒。
- **安全**：所有寫入操作需記錄操作者與時間；權限至少符合 RBAC Level 2。
- **可靠性**：匯入失敗需可重試；資料異動需具備交易性保證。
- **可用性**：支援桌面瀏覽器（Chrome / Edge / Firefox 最新版）。

## 🖥 前端介面需求
- **列表頁**
  - 篩選條件區塊（收合式）、列表呈現、批次操作工具列
  - 欄位：日期、隊員編號、姓名、車牌、款項名稱、金額、應扣款、實付金額、狀態、支付日期、最後更新者
  - 支援欄位顯示設定與儲存使用者偏好
- **詳情 / 編輯視窗**
  - 以側邊欄或彈窗顯示完整欄位
  - 顯示狀態變更與支付紀錄
  - 狀態變更操作需提供確認提示
- **匯入流程**
  - 上傳檔案、欄位對應、預檢報告（含錯誤筆數、警告）
  - 支援錯誤資料下載修正再匯入
- **權限設定面板**
  - 在角色／職務設定頁顯示模組權限群組，提供支出款項管理六項權限切換
  - 顯示目前勾選狀態與上次更新時間
- **報表頁面（選配）**
  - 依篩選條件統計總金額、已支付比例
  - 提供圖表視覺化

## 🗄 資料庫設計

### 主要資料表結構

```sql
CREATE TABLE expense_payments (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    record_date DATE NOT NULL COMMENT '紀錄日期',
    record_time TIME NULL COMMENT '紀錄時間',
    member_id BIGINT UNSIGNED NULL COMMENT '隊員ID (對應 members 表)',
    member_code VARCHAR(20) NULL COMMENT '隊員編號（冗餘欄位強化查詢）',
    member_name VARCHAR(100) NOT NULL COMMENT '隊員姓名',
    license_number VARCHAR(20) NULL COMMENT '車牌號碼',
    item_name VARCHAR(120) NOT NULL COMMENT '款項名稱',
    gross_amount DECIMAL(10,2) NOT NULL COMMENT '支付金額',
    deduction DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '應扣款',
    net_amount DECIMAL(10,2) NOT NULL COMMENT '實付金額',
    payment_date DATE NULL COMMENT '支付日期',
    payment_method VARCHAR(30) NULL COMMENT '支付方式',
    status ENUM('pending','paid') NOT NULL DEFAULT 'pending' COMMENT '款項狀態',
    note TEXT NULL COMMENT '備註',
    created_by BIGINT UNSIGNED NOT NULL COMMENT '建立者ID',
    updated_by BIGINT UNSIGNED NOT NULL COMMENT '最後更新者ID',
    paid_by BIGINT UNSIGNED NULL COMMENT '支付經手人ID',
    paid_at DATETIME NULL COMMENT '支付時間',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME NULL,
    INDEX idx_record_date (record_date),
    INDEX idx_status (status),
    INDEX idx_member (member_id),
    INDEX idx_license (license_number),
    UNIQUE KEY uniq_member_record_ts (member_id, record_date, record_time)
) COMMENT='支出款項主表';
```

### 關聯資料表
- `expense_payment_details`（可選）：拆分多筆明細或對應不同費用項目。
- `members` / `vehicles` / `departments`：從既有系統連結隊員與車輛資料。
- `payment_activity_logs`：紀錄狀態變更、操作者、備註。

### 資料一致性與計算規則
- `net_amount = gross_amount - deduction`，需在後端驗證。
- 當狀態為 `paid` 時必須填寫 `payment_date` 與 `paid_by`。
- 批次匯入時如未提供 `member_id`，可由 `member_code` 進行查表補值。

## 🔗 API 與整合設計

| 功能 | Method / Endpoint | 說明 |
| --- | --- | --- |
| 查詢清單 | `GET /api/expense-payments` | 支援多條件篩選、排序、分頁 |
| 取得詳情 | `GET /api/expense-payments/{id}` | 包含狀態變更與支付紀錄 |
| 建立資料 | `POST /api/expense-payments` | 驗證欄位與狀態預設 |
| 更新資料 | `PUT /api/expense-payments/{id}` | 更新欄位、狀態需遵守轉換規則 |
| 刪除資料 | `DELETE /api/expense-payments/{id}` | 軟刪除 |
| 批次更新 | `PATCH /api/expense-payments/bulk-status` | 多筆狀態更新與付款資訊寫入 |
| 匯入資料 | `POST /api/expense-payments/import` | 上傳檔案，回傳預檢結果 |
| 匯出資料 | `GET /api/expense-payments/export` | 依篩選條件匯出 Excel / CSV |
| 取得欄位設定 | `GET /api/expense-payments/settings` | 取得欄位顯示、匯出欄位設定 |
| 取得權限清單 | `GET /admin/permissions` | 取得支出款項相關權限分組，提供前端權限面板 |

### 整合需求
- 與既有隊員、車輛資料表整合，提供 dropdown 與 autocomplete 功能。
- 預留與會計系統的資料匯出模板（欄位對應、編碼規則）。
- 整合公司內部通知系統，在狀態改變時觸發通知。

## 💼 業務規則與驗證
- 支出金額不得為負數，`gross_amount >= deduction >= 0`。
- 批次更新需保證所有筆數於資料庫交易中一次寫入，避免半途失敗。
- 當狀態由 `pending` 更新為 `paid` 時需記錄付款資訊與操作者備註。
- 允許重複款項名稱，同一隊員可於同日建立多筆，但 `member_id`（或 `member_code`）+ `record_date` + `record_time` 需唯一；若 `record_time` 為空值則匯入需退件或補值。
- 刪除資料僅允許在 `paid` 之前，且需保留操作記錄。

## 🔧 技術架構
- **後端框架**：Laravel 11.x + PHP 8.4+
- **前端框架**：Vue 3 + Inertia.js + Vite
- **UI 套件**：AdminLTE 4 + Bootstrap 5
- **資料庫**：MySQL (正式) / SQLite (開發)
- **排程任務**：Laravel Scheduler（逾期請款提醒、報表產出）
- **匯入匯出**：Laravel Excel
- **權限管理**：Spatie Laravel Permission
- **日誌追蹤**：Monolog + 自訂審計表

## 🗓 開發計畫

| 階段 | 時程 | 主要工作 | 交付成果 |
| --- | --- | --- | --- |
| 第一階段：需求與設計 | 1 週 | 詳細需求確認、資料庫/流程設計、UI prototype | SRS、DB Schema、流程圖、Figma Wireframe |
| 第二階段：基礎開發 | 2 週 | 後端 API、前端列表/詳情頁、基本權限 | 基本 CRUD、登入後列表操作 |
| 第三階段：進階功能 | 2 週 | 批次操作、匯入匯出、狀態通知 | 匯入匯出模組、狀態通知設定 |
| 第四階段：測試與優化 | 1 週 | 單元/整合測試、效能調校、UX 調整 | 測試報告、缺陷修復、最終版原型 |
| 第五階段：部署與驗收 | 1 週 | 上線準備、資料移轉、使用者訓練、驗收 | 部署手冊、操作手冊、驗收文件 |

## 🧪 測試計畫
- **測試策略**：
  - 單元測試（PHPUnit）：驗證資料驗證、狀態轉換、匯入解析。
  - API 功能測試（Pest / PHPUnit HTTP）：CRUD、批次更新、匯出。
  - 前端組件測試（Vitest）：列表篩選、批次操作流程。
  - 匯入測試：多場景檔案（成功、格式錯誤、重複資料）。
- **測試覆蓋重點**：
  - 欄位驗證、登入權限
  - 狀態轉換流程
  - 匯入匯出結果正確性
  - 操作日誌與稽核紀錄
  - 錯誤與例外處理（重試機制）

## 🚀 部署與維護
- **部署流程**：
  1. QA/預備環境建立資料表與測試資料
  2. 執行自動化測試與手動驗收
  3. 正式環境部署，導入初始主檔與歷史紀錄
  4. 建立排程任務與備份機制
- **維護計畫**：
  - 每日備份資料庫與匯出檔案
  - 定期清理匯入暫存檔
  - 監控錯誤日誌與匯入失敗紀錄
  - 版本更新與安全修補流程

## 📋 驗收標準
- **功能驗收**
  - ✅ CRUD、批次請款、匯入匯出全數通過
  - ✅ 權限控制與支付流程符合需求
  - ✅ 報表與匯出欄位正確無誤
  - ✅ 操作歷程完整記錄且可查詢
- **效能驗收**
  - ✅ 列表查詢 1,000 筆資料回應 < 3 秒
  - ✅ 批次更新 200 筆須於 5 秒內完成
  - ✅ 匯出 1,000 筆資料於 10 秒內產出檔案
- **安全驗收**
  - ✅ 權限繞過測試通過
  - ✅ 參數驗證與防注入測試通過
  - ✅ 匯入檔案安全檢查（副檔名 / 容量）

## ⚠️ 風險與因應
- **資料品質風險**：匯入資料格式多樣易出錯 → 建立範本與預檢報告、提供錯誤下載。
- **流程採納風險**：使用者習慣紙本流程 → 規劃教育訓練與試營運期並收集回饋。
- **系統整合風險**：與既有人員/車輛資料同步不穩 → 與既有系統建立快取與同步錯誤警示。
- **資安風險**：支出資料敏感 → 啟用 HTTPS、RBAC、操作日誌存放至少 1 年。

## 📚 相關文件與附錄
- 相關開發文件：
  - 《車輛管理開發規劃文件》
  - 資料庫 ERD 圖（待更新）
  - API 規格書（Swagger / Stoplight 產出）
  - 操作手冊與教育訓練教材
- 附錄：
  - 欄位對應表（Excel 匯入模板）
  - 權限矩陣表
  - 狀態轉換圖（Mermaid / Draw.io）

---
如需調整需求或新增功能，請同步更新本文件並通知相關利害關係人，以維持規劃與實作的一致性。
