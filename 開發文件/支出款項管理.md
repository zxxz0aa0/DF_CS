# 支出款項管理功能文件

此文件記錄支出款項管理模組的完整實作狀況,包含系統架構、核心功能、資料庫設計、API 規格、業務邏輯,以及使用說明等內容,作為系統維護與功能擴充的參考文件。

**文件狀態**: ✅ 已完成實作
**最後更新**: 2025-12-15
**模組版本**: 1.0.0

---

## 📋 模組概述

### 功能背景
支出款項管理模組為大豐交通車隊管理系統的核心財務功能之一,用於管理隊員的支出請款與支付作業。系統整合駕駛資料、車輛資料,提供完整的支出款項記錄、批次狀態更新、匯入匯出等功能,取代過往分散的紙本與 Excel 作業流程。

### 核心目標
- ✅ 建立統一的支出款項資料平台
- ✅ 支援支出記錄建檔與支付狀態管理
- ✅ 提供批次操作、篩選查詢、匯入匯出功能
- ✅ 整合駕駛與車輛資料,支援關聯查詢
- ✅ 完整的權限控管與操作記錄追蹤

### 功能範圍
- ✅ 支出款項資料 CRUD（新增、編輯、刪除、查詢）
- ✅ 款項狀態管理（未支付 / 已支付）
- ✅ 批次標記已支付功能
- ✅ Excel 匯入匯出（含範本下載）
- ✅ 多條件篩選與關鍵字搜尋
- ✅ 統計資訊顯示（未支付 / 已支付金額）
- ✅ 權限控管（六項權限）
- ✅ 軟刪除保留歷史記錄

### 不在範圍
- 實際付款執行與金流整合
- 完整的預算控管與 KPI 分析
- 第三方會計系統 API 介接
- 行動裝置 App 版本

---

## 🎯 使用者角色與權限

### 權限列表
支出款項管理模組定義了 6 項權限,透過 Spatie Permission 套件與職務系統整合:

| 權限名稱 | 權限標識 | 說明 |
|---------|---------|------|
| 檢視支出款項 | `view expense payments` | 查看支出款項列表與詳細資料 |
| 新增支出款項 | `create expense payments` | 建立新的支出款項記錄 |
| 編輯支出款項 | `edit expense payments` | 修改支出款項資料、批次更新狀態 |
| 刪除支出款項 | `delete expense payments` | 刪除支出款項記錄（軟刪除） |
| 匯入支出款項 | `import expense payments` | Excel 檔案匯入功能 |
| 匯出支出款項 | `export expense payments` | Excel 檔案匯出與範本下載 |

### 典型角色配置
- **系統管理員**: 擁有全部 6 項權限
- **財務人員**: 擁有 view, create, edit, import, export 權限
- **會計主管**: 擁有全部 6 項權限
- **部門主管**: 僅 view 權限（查閱所屬隊員支出記錄）

### 權限檢查機制
- **後端**: 使用中介軟體 `permission:權限名稱` 保護路由
- **前端**: 透過 `$page.props.auth.permissions` 取得權限,控制按鈕與功能顯示
- **職務優先**: 用戶透過職務繼承的權限優先於角色權限

---

## 🧩 核心功能

### 1. 支出款項資料管理

#### 新增支出款項
- **功能**: 建立新的支出款項記錄
- **欄位**:
  - 必填: 紀錄日期、紀錄時間、隊員姓名、款項名稱、支付金額、實付金額、狀態
  - 選填: 隊員編號、車輛、車牌號碼、應扣款、支付日期、支付方式、備註
- **自動計算**: `實付金額 = 支付金額 - 應扣款`
- **關聯綁定**:
  - 選擇隊員時自動帶入姓名
  - 選擇車輛時自動帶入車牌號碼
  - 若填入車牌號碼,系統自動查詢並綁定 vehicle_id
- **狀態處理**:
  - 狀態為「已支付」時必須填入支付日期
  - 自動記錄 paid_at（支付時間）、paid_by（支付經手人）

#### 編輯支出款項
- **功能**: 修改現有支出款項資料
- **限制**: 可修改所有欄位,包含狀態變更
- **審計**: 自動記錄 updated_by（最後更新者）、updated_at（更新時間）

#### 刪除支出款項
- **功能**: 刪除支出款項記錄
- **機制**: 軟刪除（soft delete）,保留歷史記錄於 deleted_at 欄位
- **權限**: 需要 `delete expense payments` 權限
- **確認**: 前端提供刪除確認提示

#### 查詢與篩選
- **關鍵字搜尋**: 支援隊員編號、隊員姓名、車牌號碼、款項名稱模糊搜尋
- **篩選條件**:
  - 狀態: 全部 / 未支付 / 已支付
  - 紀錄日期範圍（起訖日期）
  - 支付日期範圍（起訖日期）
  - 隊員篩選（下拉選單）
  - 車輛篩選（下拉選單）
- **分頁**: 支援 10 / 20 / 50 / 100 筆/頁
- **預設狀態**: 首次載入時預設顯示「未支付」狀態的款項
- **排序**: 依紀錄日期、紀錄時間降序排列

### 2. 批次操作

#### 批次標記已支付
- **功能**: 一次將多筆款項標記為已支付
- **操作流程**:
  1. 勾選欲更新的款項（支援單頁全選）
  2. 點擊「標記已支付」按鈕
  3. 彈窗輸入支付日期、支付方式、備註
  4. 確認後批次更新
- **資料更新**:
  - status: 'paid'
  - payment_date: 輸入的支付日期
  - payment_method: 輸入的支付方式
  - paid_at: 當前時間
  - paid_by: 當前用戶 ID
  - updated_by: 當前用戶 ID
- **交易保證**: 使用資料庫交易確保批次更新的原子性
- **回饋訊息**: 顯示「已更新 X 筆款項狀態」

### 3. 匯入匯出功能

#### Excel 匯入
- **功能**: 批次匯入支出款項資料
- **格式**: 支援 .xlsx, .csv 格式
- **標題列**: 支援中文與英文標題（自動對應）
- **欄位對應**:
  - 紀錄日期 / record_date / 交易日期
  - 紀錄時間 / record_time / 時間
  - 隊員編號 / member_code
  - 隊員姓名 / member_name
  - 車牌號碼 / vehicle_license_number
  - 款項名稱 / item_name / 款項
  - 支付金額 / gross_amount
  - 應扣款 / deduction
  - 實付金額 / net_amount
  - 狀態 / status
  - 支付日期 / payment_date
  - 支付方式 / payment_method
  - 備註 / note
- **資料驗證**:
  - 必填欄位檢查（紀錄日期、紀錄時間、隊員姓名、款項名稱、支付金額、狀態）
  - 日期格式驗證（支援 Excel 序列號自動轉換）
  - 時間格式驗證（支援 Excel 小數格式自動轉換）
  - 金額數值驗證
  - 狀態值驗證（pending / paid / 已支付）
- **重複檢查**: 根據 member_code + record_date + record_time 檢查是否重複
- **車牌綁定**: 根據 vehicle_license_number 自動查詢並綁定 vehicle_id
- **錯誤處理**:
  - 逐列驗證,失敗的列不影響其他列
  - 收集所有錯誤並回報（列號、欄位、錯誤訊息）
  - 顯示成功筆數與失敗筆數
- **使用方式**: 點擊「匯入」按鈕 → 選擇檔案 → 自動上傳並處理 → 顯示結果

#### Excel 匯出
- **功能**: 匯出符合篩選條件的支出款項資料
- **格式**: .xlsx 格式
- **欄位**:
  - 紀錄日期、紀錄時間、公司種類、隊員編號、隊員姓名
  - 車牌號碼、款項名稱、支付金額、應扣款、實付金額
  - 狀態、支付日期、支付方式、備註、建立日期、最後更新日期
- **檔名**: `expense_payments_YYYYMMdd_HHmmss.xlsx`
- **篩選**: 依據當前頁面的篩選條件匯出（非僅當前頁）
- **使用方式**: 點擊「匯出」按鈕 → 自動下載檔案

#### 範本下載
- **功能**: 下載空白的 Excel 匯入範本
- **內容**: 包含標題列與範例資料（一列）
- **檔名**: `expense_payments_template.xlsx`
- **使用方式**: 點擊「範本」按鈕 → 下載範本檔案

### 4. 統計資訊

#### 金額統計
- **顯示位置**: 列表頁上方
- **統計項目**:
  - 未支付金額總計
  - 已支付金額總計
- **計算範圍**: 依據當前篩選條件
- **格式**: 千分位顯示,最多顯示兩位小數
- **範例**: 「未支付 1,234,567.50 元 · 已支付 987,654.00 元」

---

## 🗄 資料庫設計

### expense_payments 資料表

**Migration 檔案**: `2025_10_04_232715_create_expense_payments_table.php`

#### 欄位結構

| 欄位名稱 | 資料型別 | 長度 | 必填 | 預設值 | 說明 |
|---------|---------|-----|------|--------|------|
| id | BIGINT UNSIGNED | - | ✅ | AUTO_INCREMENT | 主鍵 |
| record_date | DATE | - | ✅ | - | 紀錄日期 |
| record_time | TIME | - | ✅ | - | 紀錄時間 |
| driver_id | BIGINT UNSIGNED | - | ❌ | NULL | 隊員 ID（外鍵 → drivers） |
| vehicle_id | BIGINT UNSIGNED | - | ❌ | NULL | 車輛 ID（外鍵 → vehicles） |
| member_code | VARCHAR | 50 | ❌ | NULL | 隊員編號（冗餘欄位） |
| member_name | VARCHAR | 100 | ✅ | - | 隊員姓名 |
| vehicle_license_number | VARCHAR | 20 | ❌ | NULL | 車牌號碼（冗餘欄位） |
| item_name | VARCHAR | 120 | ✅ | - | 款項名稱 |
| gross_amount | DECIMAL | 12,2 | ✅ | - | 支付金額 |
| deduction | DECIMAL | 12,2 | ❌ | 0 | 應扣款 |
| net_amount | DECIMAL | 12,2 | ✅ | - | 實付金額 |
| payment_date | DATE | - | ❌ | NULL | 支付日期 |
| payment_method | VARCHAR | 30 | ❌ | NULL | 支付方式 |
| status | ENUM | - | ✅ | pending | 款項狀態（pending/paid） |
| note | TEXT | - | ❌ | NULL | 備註 |
| created_by | BIGINT UNSIGNED | - | ❌ | NULL | 建立者 ID（外鍵 → users） |
| updated_by | BIGINT UNSIGNED | - | ❌ | NULL | 最後更新者 ID（外鍵 → users） |
| paid_by | BIGINT UNSIGNED | - | ❌ | NULL | 支付經手人 ID（外鍵 → users） |
| paid_at | TIMESTAMP | - | ❌ | NULL | 支付時間 |
| created_at | TIMESTAMP | - | ✅ | CURRENT_TIMESTAMP | 建立時間 |
| updated_at | TIMESTAMP | - | ✅ | CURRENT_TIMESTAMP | 更新時間 |
| deleted_at | TIMESTAMP | - | ❌ | NULL | 軟刪除時間 |

#### 索引設計

```sql
-- 單欄位索引
INDEX idx_record_date (record_date)
INDEX idx_status (status)
INDEX idx_driver_id (driver_id)
INDEX idx_member_code (member_code)
INDEX idx_vehicle_license_number (vehicle_license_number)

-- 唯一複合索引（防止重複資料）
UNIQUE INDEX expense_payments_driver_datetime_unique
    (driver_id, record_date, record_time, deleted_at)

UNIQUE INDEX expense_payments_code_datetime_unique
    (member_code, record_date, record_time, deleted_at)
```

#### 外鍵關聯

```sql
-- 隊員關聯（軟約束）
FOREIGN KEY (driver_id) REFERENCES drivers(id) ON DELETE SET NULL

-- 車輛關聯（軟約束）
FOREIGN KEY (vehicle_id) REFERENCES vehicles(id) ON DELETE SET NULL

-- 建立者關聯（軟約束）
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL

-- 更新者關聯（軟約束）
FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL

-- 支付者關聯（軟約束）
FOREIGN KEY (paid_by) REFERENCES users(id) ON DELETE SET NULL
```

**外鍵策略說明**: 採用 `nullOnDelete()` 確保當駕駛、車輛或用戶被刪除時,支出款項記錄不會被連帶刪除,僅將關聯欄位設為 NULL,保留歷史資料完整性。

### 資料一致性規則

#### 計算公式
```
實付金額 (net_amount) = 支付金額 (gross_amount) - 應扣款 (deduction)
```

#### 業務規則
1. **金額限制**: 支付金額、應扣款、實付金額必須 ≥ 0
2. **扣款限制**: 應扣款不得大於支付金額
3. **狀態限制**: status 僅能為 `pending` 或 `paid`
4. **已支付必填**: 當 status = 'paid' 時,必須填入 payment_date、paid_at、paid_by
5. **未支付清空**: 當 status = 'pending' 時,payment_date、payment_method、paid_at、paid_by 必須為 NULL
6. **重複檢查**: 同一隊員（依 driver_id 或 member_code）在同一天同一時間不得有重複記錄

#### 自動維護欄位
- **created_by / updated_by**: 透過 Model Event 自動填入當前用戶 ID
- **created_at / updated_at**: Laravel 自動維護時間戳記
- **paid_at / paid_by**: 當狀態變更為 'paid' 時自動設定

---

## 🔗 API 與路由設計

### 路由結構

**路由前綴**: `/admin/expense-payments`
**中介軟體**: `auth`, `verified`, `permission:view expense payments`

| HTTP 方法 | 路由路徑 | 控制器方法 | 權限 | 說明 |
|----------|---------|-----------|------|------|
| GET | `/` | index | view expense payments | 列表頁（含篩選） |
| POST | `/` | store | create expense payments | 新增支出款項 |
| PUT | `/{expense_payment}` | update | edit expense payments | 更新支出款項 |
| DELETE | `/{expense_payment}` | destroy | delete expense payments | 刪除支出款項 |
| POST | `/bulk-status` | bulkStatus | edit expense payments | 批次更新狀態 |
| GET | `/export` | export | export expense payments | 匯出 Excel |
| GET | `/template` | template | export expense payments | 下載範本 |
| POST | `/import` | import | import expense payments | 匯入 Excel |

### API 端點詳細說明

#### 1. GET /admin/expense-payments - 列表查詢

**功能**: 取得支出款項列表,支援分頁、篩選、排序

**查詢參數**:
```
keyword: string (選填) - 關鍵字搜尋
status: string (選填) - 狀態篩選 (pending/paid/空白=全部)
record_date_from: date (選填) - 紀錄日期起
record_date_to: date (選填) - 紀錄日期迄
payment_date_from: date (選填) - 支付日期起
payment_date_to: date (選填) - 支付日期迄
driver_id: integer (選填) - 隊員 ID
vehicle_id: integer (選填) - 車輛 ID
per_page: integer (選填) - 每頁筆數 (預設 20)
page: integer (選填) - 頁碼 (預設 1)
```

**回應資料** (Inertia Response):
```javascript
{
  payments: {
    data: [...], // 分頁資料
    current_page: 1,
    per_page: 20,
    total: 150,
    from: 1,
    to: 20,
    links: [...] // 分頁連結
  },
  filters: {...}, // 目前篩選條件
  statistics: {
    pending_total: 123456.50,
    paid_total: 987654.00
  },
  drivers: [...], // 隊員列表（供下拉選單）
  vehicles: [...], // 車輛列表（供下拉選單）
  permissions: {
    canCreate: true,
    canEdit: true,
    canDelete: false,
    canImport: true,
    canExport: true
  }
}
```

#### 2. POST /admin/expense-payments - 新增支出款項

**請求本文** (Request Body):
```json
{
  "record_date": "2025-12-15",
  "record_time": "14:30",
  "driver_id": 123,
  "vehicle_id": 456,
  "member_code": "A001",
  "member_name": "王小明",
  "vehicle_license_number": "ABC-1234",
  "item_name": "油資補貼",
  "gross_amount": 1500.00,
  "deduction": 50.00,
  "net_amount": 1450.00,
  "status": "pending",
  "payment_date": null,
  "payment_method": null,
  "note": "12月油資"
}
```

**驗證規則**: 參照 `ExpensePaymentStoreRequest`

**回應**: 重導回列表頁,顯示成功訊息

#### 3. PUT /admin/expense-payments/{id} - 更新支出款項

**請求本文**: 同新增,但需包含所有欄位

**驗證規則**: 參照 `ExpensePaymentUpdateRequest`

**回應**: 重導回列表頁,顯示成功訊息

#### 4. DELETE /admin/expense-payments/{id} - 刪除支出款項

**回應**: 重導回列表頁,顯示成功訊息

#### 5. POST /admin/expense-payments/bulk-status - 批次更新狀態

**請求本文**:
```json
{
  "ids": [1, 2, 3, 4, 5],
  "status": "paid",
  "payment_date": "2025-12-15",
  "payment_method": "現金",
  "note": "批次支付"
}
```

**驗證規則**: 參照 `ExpensePaymentBulkStatusRequest`

**回應**: 重導回列表頁,顯示「已更新 X 筆款項狀態」

#### 6. GET /admin/expense-payments/export - 匯出 Excel

**查詢參數**: 同列表查詢 (keyword, status, record_date_from 等)

**回應**: 直接下載 Excel 檔案 (`BinaryFileResponse`)

#### 7. GET /admin/expense-payments/template - 下載範本

**回應**: 直接下載範本 Excel 檔案

#### 8. POST /admin/expense-payments/import - 匯入 Excel

**請求**: `multipart/form-data` 格式,包含 `file` 欄位

**驗證規則**: 參照 `ExpensePaymentImportRequest`

**回應** (JSON):
```json
{
  "success": true,
  "message": "匯入完成,成功 45 筆,失敗 5 筆",
  "type": "warning",
  "import_failures": [
    {
      "row": 10,
      "attribute": "validation",
      "errors": ["紀錄日期欄位為必填"]
    },
    ...
  ]
}
```

---

## 💼 業務邏輯與服務層

### ExpensePaymentService

**檔案位置**: `app/Services/ExpensePaymentService.php`

#### 核心方法

##### 1. paginate(array $filters, int $perPage): LengthAwarePaginator
分頁查詢支出款項,支援多條件篩選

**處理邏輯**:
- 載入關聯: driver.companyCategory, vehicle, creator, payer
- 排序: record_date DESC, record_time DESC
- 套用篩選條件（透過 applyFilters 方法）
- 分頁並保留查詢字串

##### 2. statistics(array $filters): array
計算統計資訊

**回傳格式**:
```php
[
  'pending_total' => 123456.50,
  'paid_total' => 987654.00
]
```

##### 3. create(array $data): ExpensePayment
建立新的支出款項

**處理流程**:
1. 準備資料 (preparePayload)
2. 資料庫交易包裝
3. 建立記錄
4. 自動設定 created_by, updated_by

##### 4. update(ExpensePayment $expensePayment, array $data): ExpensePayment
更新支出款項

**處理流程**:
1. 準備資料 (preparePayload)
2. 資料庫交易包裝
3. 更新記錄
4. 自動更新 updated_by

##### 5. bulkUpdateStatus(array $ids, array $data): int
批次更新款項狀態

**處理邏輯**:
- 組裝更新欄位 (status, payment_date, payment_method, note)
- 根據狀態設定或清空支付相關欄位 (paid_at, paid_by)
- 執行批次更新 (whereIn + update)
- 回傳更新筆數

#### 輔助方法

##### preparePayload(array $data, ?ExpensePayment $existing): array
準備儲存資料

**處理項目**:
1. 欄位白名單過濾
2. 時間格式正規化 (normalizeTime)
3. 金額四捨五入至小數點後兩位
4. 實付金額自動計算 (若未提供)
5. 車牌號碼自動查詢 vehicle_id
6. 已支付狀態處理 (payment_date, paid_at, paid_by)
7. 未支付狀態清空支付欄位
8. 空字串轉 NULL

##### normalizeTime(?string $time): ?string
時間格式正規化

**支援格式**:
- `HH:MM:SS` → 維持
- `HH:MM` → 補成 `HH:MM:00`
- 其他格式 → 嘗試 Carbon 解析

##### applyFilters(Builder $query, array $filters): void
套用篩選條件

**支援篩選**:
- keyword: 呼叫 Model 的 keyword() scope
- status: 呼叫 Model 的 status() scope
- record_date_from / record_date_to: 呼叫 recordDateBetween() scope
- payment_date_from / payment_date_to: 呼叫 paymentDateBetween() scope
- driver_id: where 條件
- vehicle_id: where 條件

---

## 🔧 技術架構

### 後端技術

| 項目 | 技術 | 說明 |
|-----|------|------|
| 框架 | Laravel 11.x | PHP Web 框架 |
| PHP 版本 | PHP 8.2+ | 最低版本需求 |
| 資料庫 | SQLite (開發) / MySQL (正式) | 關聯式資料庫 |
| ORM | Eloquent | Laravel 內建 ORM |
| 權限管理 | Spatie Laravel Permission | 角色權限套件 |
| Excel 處理 | Maatwebsite/Excel | 匯入匯出套件 |
| 路由輔助 | Ziggy | Laravel 路由轉 JS |

### 前端技術

| 項目 | 技術 | 說明 |
|-----|------|------|
| 框架 | Vue 3 (Composition API) | JavaScript 框架 |
| 整合 | Inertia.js | 無需 API 的 SPA 方案 |
| UI 套件 | AdminLTE 4 + Bootstrap 5 | 管理面板框架 |
| 圖示 | Bootstrap Icons | 向量圖示庫 |
| 建置工具 | Vite | 前端建置工具 |

### 核心檔案架構

```
app/
├── Http/
│   ├── Controllers/
│   │   └── Admin/
│   │       └── ExpensePaymentController.php   # 控制器
│   ├── Requests/
│   │   └── Admin/
│   │       ├── ExpensePaymentStoreRequest.php   # 新增驗證
│   │       ├── ExpensePaymentUpdateRequest.php  # 更新驗證
│   │       ├── ExpensePaymentBulkStatusRequest.php # 批次驗證
│   │       └── ExpensePaymentImportRequest.php  # 匯入驗證
│   └── Middleware/
│       └── HandleInertiaRequests.php  # Inertia 共享資料
├── Models/
│   └── ExpensePayment.php  # Eloquent 模型
├── Services/
│   └── ExpensePaymentService.php  # 業務邏輯服務層
├── Imports/
│   └── ExpensePaymentsImport.php  # Excel 匯入處理
└── Exports/
    ├── ExpensePaymentsExport.php  # Excel 匯出
    └── ExpensePaymentsTemplateExport.php  # 範本匯出

database/
└── migrations/
    └── 2025_10_04_232715_create_expense_payments_table.php  # 資料表結構

resources/
└── js/
    └── Pages/
        └── Admin/
            └── ExpensePayments/
                └── Index.vue  # 列表頁面（含新增、編輯、批次功能）

routes/
└── web.php  # 路由定義（255-267 行）
```

---

## 🖥 前端介面設計

### 列表頁面 (Index.vue)

#### 頁面區塊

1. **頁面標題與麵包屑**
   - 標題: 支出款項管理
   - 麵包屑: 儀表板 > 支出款項管理

2. **卡片標題列**
   - 左側: 「支出款項列表」標題 + 圖示
   - 右側: 功能按鈕群組
     - 新增按鈕 (需 create 權限)
     - 匯出按鈕 (需 export 權限)
     - 範本按鈕 (需 import 權限)
     - 匯入按鈕 (需 import 權限)

3. **篩選區塊**（淺色背景,可收合）
   - 關鍵字搜尋（隊員編號/姓名/車牌/款項名稱）
   - 狀態下拉選單（全部/未支付/已支付）
   - 每頁筆數選擇（10/20/50/100）
   - 按鈕: 套用、清除

4. **批次操作與統計資訊**
   - 左側: 「標記已支付」按鈕（需 edit 權限,選取時啟用）
   - 右側: 統計資訊（未支付/已支付金額,依篩選條件計算）

5. **資料表格**
   - 欄位:
     - 勾選框（全選支援）
     - 交易日期
     - 時間
     - 公司種類（來自駕駛關聯）
     - 隊員編號
     - 隊員姓名
     - 車牌
     - 款項
     - 支付金額（靠右對齊）
     - 應扣款（靠右對齊）
     - 實付金額（靠右對齊,粗體）
     - 狀態（徽章顯示: 已支付=綠色,未支付=黃色）
     - 支付日期
     - 建立日期
     - 操作（編輯、刪除按鈕）
   - 樣式: 響應式表格,固定表頭,最大高度 65vh

6. **分頁資訊與控制**
   - 左側: 顯示第 X - Y 筆,總計 Z 筆
   - 右側: 分頁連結（上一頁、頁碼、下一頁）

#### 彈窗 (Modal) 設計

##### 新增支出款項彈窗
- **標題**: 新增支出款項
- **表單欄位**:
  - 第一列: 紀錄日期*、紀錄時間*、狀態*
  - 第二列: 隊員（下拉選單,自動帶入姓名）、隊員編號
  - 第三列: 隊員姓名*、車輛（下拉選單,自動帶入車牌）
  - 第四列: 車牌號碼、款項名稱*
  - 第五列: 支付金額*、應扣款、實付金額*（自動計算）
  - 第六列（狀態=已支付時顯示）: 支付日期*、支付方式
  - 第七列: 備註（多行文字）
- **按鈕**: 取消、儲存
- **自動計算**: 當 gross_amount 或 deduction 變動時,自動更新 net_amount

##### 編輯支出款項彈窗
- **標題**: 編輯支出款項
- **表單欄位**: 同新增,但帶入現有資料
- **按鈕**: 取消、更新

##### 批次更新狀態彈窗
- **標題**: 批次更新狀態
- **表單欄位**:
  - 更新筆數（唯讀,顯示選取筆數）
  - 狀態（下拉選單: 未支付/已支付）
  - 支付日期*（狀態=已支付時顯示）
  - 支付方式（狀態=已支付時顯示）
  - 備註（多行文字）
- **按鈕**: 取消、套用

#### 互動邏輯

##### 搜尋與篩選
1. 使用者輸入篩選條件
2. 點擊「套用」按鈕
3. 使用 Inertia router.get() 重新載入頁面
4. 保留滾動位置與狀態
5. 更新統計資訊

##### 批次選取
- 勾選個別列: 加入/移除 selectedIds 陣列
- 點擊全選框: 選取/取消當前頁所有列
- 翻頁後: 保留已選取的 ID（跨頁選取）

##### 新增流程
1. 點擊「新增」按鈕
2. 彈窗開啟,表單重置為預設值
3. 使用者填入資料
4. 點擊「儲存」
5. 使用 Inertia form.post() 送出
6. 成功: 關閉彈窗,重新載入列表,顯示成功訊息
7. 失敗: 顯示驗證錯誤於彈窗內

##### 編輯流程
1. 點擊列表列的「編輯」按鈕
2. 載入該筆資料至編輯表單
3. 彈窗開啟,顯示現有資料
4. 使用者修改資料
5. 點擊「更新」
6. 使用 Inertia form.put() 送出
7. 成功: 關閉彈窗,重新載入列表,顯示成功訊息
8. 失敗: 顯示驗證錯誤於彈窗內

##### 刪除流程
1. 點擊列表列的「刪除」按鈕
2. 瀏覽器原生確認對話框: 「確定要刪除「XXX」嗎？」
3. 確認: 使用 Inertia router.delete() 送出
4. 成功: 重新載入列表,顯示成功訊息

##### 批次標記已支付流程
1. 勾選欲更新的款項
2. 點擊「標記已支付」按鈕
3. 彈窗開啟,顯示選取筆數
4. 使用者輸入支付日期、支付方式、備註
5. 點擊「套用」
6. 使用 Inertia form.post() 送出至 bulk-status 端點
7. 成功: 關閉彈窗,清空選取,重新載入列表,顯示「已更新 X 筆款項狀態」
8. 失敗: 顯示驗證錯誤於彈窗內

##### 匯入流程
1. 點擊「匯入」按鈕
2. 觸發隱藏的檔案輸入框
3. 使用者選擇 Excel 檔案
4. 使用原生 fetch API 上傳檔案（FormData）
5. 後端處理並回傳 JSON 結果
6. 前端解析 JSON:
   - 完全成功: 重新載入頁面,顯示成功訊息
   - 部分失敗: 重新載入頁面,顯示警告訊息與失敗列表
   - 完全失敗: 顯示錯誤訊息
7. 清空檔案輸入框

##### 匯出流程
1. 點擊「匯出」按鈕
2. 組裝查詢參數（依目前篩選條件）
3. 開新視窗導向匯出端點
4. 瀏覽器自動下載檔案
5. 按鈕顯示「匯出中...」1.2 秒後恢復

#### 響應式設計
- 大螢幕（≥ 992px）: 完整版面,表格橫向滾動
- 中等螢幕（768px - 991px）: 按鈕群組調整,表格橫向滾動
- 小螢幕（< 768px）: 按鈕縱向排列,表格卡片化顯示（建議）

---

## 📋 使用手冊

### 基本操作

#### 查看支出款項列表
1. 登入系統
2. 從側邊欄選擇「帳務管理」→「支出款項」
3. 預設顯示「未支付」狀態的款項
4. 可透過篩選條件調整顯示內容

#### 新增支出款項
1. 點擊右上角「新增」按鈕
2. 填入必填欄位（標有紅色 *）
3. 選擇隊員時會自動帶入姓名
4. 選擇車輛時會自動帶入車牌號碼
5. 輸入支付金額與應扣款後,實付金額會自動計算
6. 若狀態選擇「已支付」,需填入支付日期
7. 點擊「儲存」完成新增

#### 編輯支出款項
1. 在列表中找到欲修改的記錄
2. 點擊該列的「編輯」按鈕（鉛筆圖示）
3. 修改欄位內容
4. 點擊「更新」儲存變更

#### 刪除支出款項
1. 在列表中找到欲刪除的記錄
2. 點擊該列的「刪除」按鈕（垃圾桶圖示）
3. 確認刪除提示
4. 記錄將被軟刪除（保留於資料庫但不顯示）

#### 批次標記已支付
1. 勾選欲標記為已支付的款項（可跨頁選取）
2. 點擊左上方「標記已支付」按鈕
3. 輸入支付日期（必填）
4. 輸入支付方式（選填,例如: 現金、匯款）
5. 輸入備註（選填）
6. 點擊「套用」完成批次更新

#### 篩選與搜尋
- **關鍵字搜尋**: 在搜尋框輸入隊員編號、姓名、車牌或款項名稱
- **狀態篩選**: 選擇「全部」、「未支付」或「已支付」
- **日期範圍**: 設定紀錄日期或支付日期的起訖範圍（註解的欄位需先取消註解）
- **隊員篩選**: 選擇特定隊員（註解的欄位需先取消註解）
- **車輛篩選**: 選擇特定車輛（註解的欄位需先取消註解）
- 點擊「套用」執行篩選
- 點擊「清除」重置所有篩選條件

#### 匯出 Excel
1. 設定篩選條件（匯出將依此條件）
2. 點擊「匯出」按鈕
3. 瀏覽器自動下載 Excel 檔案
4. 檔名格式: `expense_payments_YYYYMMdd_HHmmss.xlsx`

#### 匯入 Excel
1. 點擊「範本」按鈕下載匯入範本
2. 在 Excel 中填入資料（依範本格式）
3. 點擊「匯入」按鈕
4. 選擇填好的 Excel 檔案
5. 系統自動驗證並匯入
6. 檢視匯入結果（成功筆數、失敗筆數與錯誤明細）

### 進階功能

#### 跨頁批次選取
1. 在第一頁勾選部分記錄
2. 翻至第二頁
3. 繼續勾選其他記錄
4. 已選取的記錄 ID 會被保留
5. 執行批次操作時會一併處理所有選取的記錄

#### 快速重置篩選
- 點擊篩選區塊的「清除」按鈕
- 所有篩選條件重置為預設值
- 自動重新載入列表

#### 調整每頁顯示筆數
- 在篩選區塊選擇 10 / 20 / 50 / 100 筆
- 點擊「套用」或直接變更（依實作）
- 適合不同螢幕尺寸與使用習慣

### 常見問題

#### Q: 為什麼無法看到「新增」按鈕？
A: 您的帳號可能沒有「新增支出款項」權限。請聯絡系統管理員確認您的職務或角色權限設定。

#### Q: 匯入時出現「此記錄已存在」錯誤？
A: 系統依據「隊員編號（或隊員 ID）+ 紀錄日期 + 紀錄時間」判斷重複。請檢查 Excel 中是否有重複的記錄,或該筆資料已於系統中存在。

#### Q: 實付金額無法手動修改？
A: 實付金額會依據「支付金額 - 應扣款」自動計算。若需調整,請修改支付金額或應扣款欄位。

#### Q: 刪除的記錄可以復原嗎？
A: 本系統採用軟刪除機制,刪除的記錄仍保留於資料庫。若需復原,請聯絡系統管理員透過資料庫操作恢復。

#### Q: 匯出時沒有資料？
A: 請檢查目前的篩選條件,匯出功能會依據篩選條件匯出符合的資料。若篩選條件過嚴,可能沒有符合的記錄。

#### Q: 統計資訊的金額不正確？
A: 統計資訊依據當前篩選條件計算。請確認篩選條件是否符合您的預期,特別是狀態篩選（未支付/已支付/全部）。

---

## 🧪 測試建議

### 功能測試項目

#### 基本 CRUD
- [ ] 新增支出款項（必填欄位驗證）
- [ ] 編輯支出款項（資料正確更新）
- [ ] 刪除支出款項（軟刪除確認）
- [ ] 列表查詢（分頁正確）

#### 篩選功能
- [ ] 關鍵字搜尋（隊員編號、姓名、車牌、款項名稱）
- [ ] 狀態篩選（未支付/已支付/全部）
- [ ] 日期範圍篩選（紀錄日期、支付日期）
- [ ] 隊員篩選
- [ ] 車輛篩選
- [ ] 組合篩選（多條件同時使用）

#### 批次操作
- [ ] 單筆選取與取消
- [ ] 當頁全選
- [ ] 跨頁選取
- [ ] 批次標記已支付（狀態更新、日期記錄、經手人記錄）
- [ ] 批次操作後資料正確性

#### 匯入匯出
- [ ] 匯出 Excel（欄位完整、資料正確）
- [ ] 下載範本（格式正確）
- [ ] 匯入成功案例（所有欄位正確）
- [ ] 匯入失敗案例（必填欄位缺漏、格式錯誤、重複資料）
- [ ] 匯入部分成功（成功與失敗筆數正確、錯誤訊息清楚）
- [ ] Excel 日期序列號轉換
- [ ] Excel 時間小數格式轉換

#### 自動計算
- [ ] 實付金額自動計算（支付金額 - 應扣款）
- [ ] 狀態為已支付時自動記錄 paid_at, paid_by
- [ ] 狀態改回未支付時清空支付欄位

#### 權限控制
- [ ] view 權限: 能查看列表
- [ ] create 權限: 顯示新增按鈕
- [ ] edit 權限: 顯示編輯按鈕與批次按鈕
- [ ] delete 權限: 顯示刪除按鈕
- [ ] import 權限: 顯示匯入與範本按鈕
- [ ] export 權限: 顯示匯出按鈕
- [ ] 無權限: 按鈕隱藏、路由阻擋

#### 關聯查詢
- [ ] 選擇隊員後自動帶入姓名
- [ ] 選擇車輛後自動帶入車牌號碼
- [ ] 列表顯示公司種類（來自駕駛關聯）
- [ ] 匯入時依車牌號碼自動綁定 vehicle_id

#### 資料驗證
- [ ] 必填欄位驗證
- [ ] 日期格式驗證
- [ ] 時間格式驗證
- [ ] 金額數值驗證（非負數）
- [ ] 狀態值驗證（pending/paid）
- [ ] 已支付時支付日期必填
- [ ] 重複資料檢查（member_code + record_date + record_time）

### 非功能測試

#### 效能測試
- [ ] 列表查詢 1,000 筆資料回應時間 < 3 秒
- [ ] 批次更新 200 筆資料於 5 秒內完成
- [ ] 匯出 1,000 筆資料於 10 秒內產生檔案
- [ ] 匯入 500 筆資料處理時間合理

#### 安全測試
- [ ] 未登入存取 → 重導登入頁
- [ ] 無權限存取 → 403 錯誤
- [ ] SQL 注入測試（參數化查詢防護）
- [ ] XSS 測試（Vue 自動轉義）
- [ ] CSRF 保護（Laravel 內建機制）

#### 相容性測試
- [ ] Chrome 最新版
- [ ] Edge 最新版
- [ ] Firefox 最新版
- [ ] Safari 最新版（macOS）
- [ ] 響應式設計（桌面、平板、手機）

---

## 📚 相關文件

### 專案文件
- [CLAUDE.md](/Users/raystyle/Desktop/Ray-Project/DF_CS/CLAUDE.md) - 專案總覽與開發指引
- [README.md](/Users/raystyle/Desktop/Ray-Project/DF_CS/README.md) - 專案說明與安裝指南

### API 文件
- 路由定義: [routes/web.php](/Users/raystyle/Desktop/Ray-Project/DF_CS/routes/web.php#L255-L267)
- 控制器: [ExpensePaymentController.php](/Users/raystyle/Desktop/Ray-Project/DF_CS/app/Http/Controllers/Admin/ExpensePaymentController.php)
- 服務層: [ExpensePaymentService.php](/Users/raystyle/Desktop/Ray-Project/DF_CS/app/Services/ExpensePaymentService.php)

### 資料庫文件
- Migration: [2025_10_04_232715_create_expense_payments_table.php](/Users/raystyle/Desktop/Ray-Project/DF_CS/database/migrations/2025_10_04_232715_create_expense_payments_table.php)
- Model: [ExpensePayment.php](/Users/raystyle/Desktop/Ray-Project/DF_CS/app/Models/ExpensePayment.php)

### 前端文件
- 列表頁面: [Index.vue](/Users/raystyle/Desktop/Ray-Project/DF_CS/resources/js/Pages/Admin/ExpensePayments/Index.vue)
- 版面配置: [AdminLayout.vue](/Users/raystyle/Desktop/Ray-Project/DF_CS/resources/js/Layouts/AdminLayout.vue)

---

## 📝 版本歷史

### v1.0.0 (2025-12-15)
- ✅ 完成支出款項 CRUD 功能
- ✅ 實作批次標記已支付功能
- ✅ 實作 Excel 匯入匯出功能
- ✅ 實作多條件篩選與搜尋
- ✅ 實作統計資訊顯示
- ✅ 整合駕駛與車輛資料
- ✅ 實作六項權限控制
- ✅ 軟刪除機制
- ✅ 自動計算與資料驗證
- ✅ 響應式介面設計

---

## 🔮 未來規劃

### 短期改進（1-3 個月）
- [ ] 增加日期範圍與隊員/車輛篩選功能（目前已註解）
- [ ] 支援批次改回「未支付」狀態
- [ ] 提供款項狀態變更歷程記錄
- [ ] 增加匯出格式選項（CSV, PDF）
- [ ] 優化行動裝置顯示（表格卡片化）

### 中期功能（3-6 個月）
- [ ] 支出款項類別管理
- [ ] 經常性支出模板快速建立
- [ ] 支出預算控管與提醒
- [ ] 與帳務記錄模組整合
- [ ] 報表視覺化（折線圖、圓餅圖）

### 長期目標（6-12 個月）
- [ ] 工作流程引擎（申請→審核→支付）
- [ ] 第三方會計系統 API 介接
- [ ] 行動裝置 App 支援
- [ ] 智能提醒與通知系統
- [ ] 進階數據分析與 BI 整合

---

**文件維護者**: 開發團隊
**聯絡方式**: 請透過專案 Issue 追蹤系統回報問題或建議
**文件授權**: 僅供內部使用
