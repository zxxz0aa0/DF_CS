# 催帳管理頁面開發評估

## 功能需求
帳務管理的延伸功能，統計每位駕駛的帳務餘額（借方金額加總 - 貸方金額加總），列出餘額為負數（欠款）的駕駛資訊，包含姓名、身分證字號、金額等。

## 規模評估
- **預估駕駛人數**: 約 1000 人
- **預估帳務記錄**: 每位駕駛平均 500 筆，總計約 50 萬筆記錄
- **效能需求**: 查詢響應時間需 < 500ms

## 技術方案選擇

### ❌ 方案 A：即時查詢彙總（不採用）
```sql
SELECT driver_id, SUM(debit_amount) - SUM(credit_amount) as balance
FROM accounting_records
WHERE deleted_at IS NULL
GROUP BY driver_id
HAVING balance < 0
```

**問題分析**:
- 每次查詢需彙總 50 萬筆記錄
- 預估查詢時間: 1-3 秒（即使有索引）
- 資料庫負載過高
- 不適合 1000+ 駕駛規模

### ✅ 方案 B：彙總表 + 事件同步（採用）

**核心概念**: 使用物化檢視表（Materialized View）概念，建立獨立的駕駛餘額彙總表，在帳務異動時自動更新。

**優勢**:
- 查詢速度: < 100ms（僅查詢 1000 筆預先計算好的彙總資料）
- 效能提升: 10-30 倍
- 資料一致性: 透過 Model Event 自動同步
- 擴充性強: 可記錄最後交易日期、交易筆數等統計資訊

---

## 資料庫設計

### 駕駛餘額彙總表 (driver_balance_summary)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| driver_id | BIGINT | - | PRIMARY KEY, NOT NULL | 駕駛 ID (外鍵 drivers.id) |
| driver_name | VARCHAR | 100 | NOT NULL | 駕駛姓名（冗餘欄位，快照） |
| driver_id_number | VARCHAR | 20 | NOT NULL | 身分證字號（冗餘欄位，快照） |
| total_debit | DECIMAL | 15,2 | NOT NULL, DEFAULT 0 | 借方金額總計 |
| total_credit | DECIMAL | 15,2 | NOT NULL, DEFAULT 0 | 貸方金額總計 |
| balance | DECIMAL | 15,2 | NOT NULL, DEFAULT 0 | 餘額（借方 - 貸方） |
| last_transaction_date | DATE | - | NULLABLE | 最後交易日期 |
| transaction_count | INT | - | NOT NULL, DEFAULT 0 | 交易筆數統計 |
| updated_at | TIMESTAMP | - | NOT NULL | 最後更新時間 |

**索引設計**:
```sql
PRIMARY KEY: driver_id
INDEX: balance (查詢負餘額用)
INDEX: driver_id_number (搜尋用)
INDEX: last_transaction_date (查詢長期未交易用)
FOREIGN KEY: driver_id REFERENCES drivers(id) ON DELETE CASCADE
```

**設計說明**:
1. **主鍵設計**: `driver_id` 為主鍵且 NOT NULL，每位駕駛只有一筆彙總記錄
2. **外鍵約束**: `ON DELETE CASCADE` - 駕駛刪除時，自動刪除對應的彙總記錄
3. **冗餘欄位**: `driver_name` 和 `driver_id_number` 為快照資料，避免每次查詢都要 JOIN drivers 表
   - 每次更新彙總時，會同步更新這兩個欄位為駕駛的最新資料
   - 若駕駛資料變更（改名、改身分證），彙總會自動同步
4. **餘額欄位**: 預先計算好的餘額，負數代表欠款
5. **統計欄位**: `last_transaction_date` 和 `transaction_count` 可用於分析長期未交易的欠款駕駛
6. **無 created_at**: 此表為彙總性質，只需記錄更新時間
7. **所有欄位 NOT NULL**: 除了 `last_transaction_date`（可能無交易記錄），其他欄位都必填以確保資料完整性

---

## 後端實作

### 1. Migration

```php
// database/migrations/xxxx_create_driver_balance_summary_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('driver_balance_summary', function (Blueprint $table) {
            $table->unsignedBigInteger('driver_id')->primary();
            $table->string('driver_name', 100);
            $table->string('driver_id_number', 20);
            $table->decimal('total_debit', 15, 2)->default(0);
            $table->decimal('total_credit', 15, 2)->default(0);
            $table->decimal('balance', 15, 2)->default(0);
            $table->date('last_transaction_date')->nullable();
            $table->integer('transaction_count')->default(0);
            $table->timestamp('updated_at')->useCurrent();

            $table->foreign('driver_id')
                  ->references('id')
                  ->on('drivers')
                  ->onDelete('cascade');

            $table->index('balance');
            $table->index('driver_id_number');
            $table->index('last_transaction_date');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('driver_balance_summary');
    }
};
```

### 2. Model

```php
// app/Models/DriverBalanceSummary.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class DriverBalanceSummary extends Model
{
    protected $table = 'driver_balance_summary';
    protected $primaryKey = 'driver_id';
    public $incrementing = false;
    public $timestamps = false;

    protected $fillable = [
        'driver_id',
        'driver_name',
        'driver_id_number',
        'total_debit',
        'total_credit',
        'balance',
        'last_transaction_date',
        'transaction_count',
        'updated_at',
    ];

    protected $casts = [
        'total_debit' => 'decimal:2',
        'total_credit' => 'decimal:2',
        'balance' => 'decimal:2',
        'transaction_count' => 'integer',
        'last_transaction_date' => 'date',
        'updated_at' => 'datetime',
    ];

    /**
     * 關聯到駕駛
     */
    public function driver()
    {
        return $this->belongsTo(Driver::class, 'driver_id');
    }

    /**
     * 更新指定駕駛的餘額彙總
     */
    public static function updateBalance(int $driverId): void
    {
        $driver = Driver::find($driverId);
        if (!$driver) {
            // 駕駛不存在，刪除彙總記錄
            static::where('driver_id', $driverId)->delete();
            return;
        }

        $summary = DB::table('accounting_records')
            ->where('driver_id', $driverId)
            ->whereNull('deleted_at')
            ->selectRaw('
                COALESCE(SUM(debit_amount), 0) as total_debit,
                COALESCE(SUM(credit_amount), 0) as total_credit,
                MAX(transaction_date) as last_transaction_date,
                COUNT(*) as transaction_count
            ')
            ->first();

        $balance = $summary->total_debit - $summary->total_credit;

        static::updateOrCreate(
            ['driver_id' => $driverId],
            [
                'driver_name' => $driver->name,
                'driver_id_number' => $driver->id_number,
                'total_debit' => $summary->total_debit,
                'total_credit' => $summary->total_credit,
                'balance' => $balance,
                'last_transaction_date' => $summary->last_transaction_date,
                'transaction_count' => $summary->transaction_count,
                'updated_at' => now(),
            ]
        );
    }

    /**
     * 重建所有駕駛的彙總（用於初始化或修復）
     */
    public static function rebuildAll(): void
    {
        DB::transaction(function () {
            // 清空現有彙總
            static::truncate();

            // 重新計算所有駕駛
            $driverIds = Driver::whereNull('deleted_at')->pluck('id');

            foreach ($driverIds as $driverId) {
                static::updateBalance($driverId);
            }
        });
    }

    /**
     * Scope: 只查詢有欠款的駕駛
     */
    public function scopeDebtors($query)
    {
        return $query->where('balance', '<', 0);
    }

    /**
     * Scope: 搜尋駕駛
     */
    public function scopeSearch($query, ?string $term)
    {
        if (!$term) {
            return $query;
        }

        return $query->where(function ($q) use ($term) {
            $q->where('driver_name', 'like', "%{$term}%")
              ->orWhere('driver_id_number', 'like', "%{$term}%");
        });
    }
}
```

### 3. 自動同步機制（Model Event）

```php
// app/Models/AccountingRecord.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class AccountingRecord extends Model
{
    use SoftDeletes;

    // ... 其他程式碼 ...

    /**
     * Model 事件監聽
     */
    protected static function booted(): void
    {
        // 新增帳務記錄時更新彙總
        static::created(function (AccountingRecord $record) {
            if ($record->driver_id) {
                DriverBalanceSummary::updateBalance($record->driver_id);
            }
        });

        // 更新帳務記錄時重新計算
        static::updated(function (AccountingRecord $record) {
            // 更新當前駕駛的彙總
            if ($record->driver_id) {
                DriverBalanceSummary::updateBalance($record->driver_id);
            }

            // 如果 driver_id 改變，舊駕駛也要更新
            if ($record->isDirty('driver_id') && $record->getOriginal('driver_id')) {
                DriverBalanceSummary::updateBalance($record->getOriginal('driver_id'));
            }
        });

        // 刪除帳務記錄時更新（包含軟刪除）
        static::deleted(function (AccountingRecord $record) {
            if ($record->driver_id) {
                DriverBalanceSummary::updateBalance($record->driver_id);
            }
        });

        // 恢復軟刪除的記錄時更新
        static::restored(function (AccountingRecord $record) {
            if ($record->driver_id) {
                DriverBalanceSummary::updateBalance($record->driver_id);
            }
        });
    }
}
```

### 4. Controller

```php
// app/Http/Controllers/Admin/CollectionController.php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\DriverBalanceSummary;
use Illuminate\Http\Request;
use Inertia\Inertia;

class CollectionController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view collections');
    }

    /**
     * 顯示催帳管理頁面
     */
    public function index(Request $request)
    {
        $query = DriverBalanceSummary::query()
            ->debtors() // 只顯示有欠款的駕駛
            ->with('driver:id,name,mobile_phone1,status');

        // 搜尋功能
        if ($request->has('search') && $request->search) {
            $query->search($request->search);
        }

        // 排序（預設依欠款金額由多到少）
        $sortBy = $request->get('sort_by', 'balance');
        $sortOrder = $request->get('sort_order', 'asc');
        $query->orderBy($sortBy, $sortOrder);

        $debtors = $query->paginate(20);

        // 統計資訊
        $statistics = [
            'total_debtors' => DriverBalanceSummary::debtors()->count(),
            'total_debt_amount' => DriverBalanceSummary::debtors()->sum('balance'),
        ];

        return Inertia::render('Admin/Collections/Index', [
            'debtors' => $debtors,
            'statistics' => $statistics,
            'filters' => $request->only(['search', 'sort_by', 'sort_order']),
        ]);
    }

    /**
     * 查看駕駛的詳細帳務記錄
     */
    public function show(int $driverId)
    {
        $summary = DriverBalanceSummary::with('driver')->findOrFail($driverId);

        // 可以重導向到帳務管理頁面，並帶上駕駛篩選
        return redirect()->route('admin.accounting.index', [
            'driver_id' => $driverId
        ]);
    }
}
```

### 5. 修復指令（Console Command）

```php
// app/Console/Commands/RebuildDriverBalances.php
<?php

namespace App\Console\Commands;

use App\Models\DriverBalanceSummary;
use Illuminate\Console\Command;

class RebuildDriverBalances extends Command
{
    protected $signature = 'balance:rebuild {--driver= : 指定駕駛 ID，不指定則重建全部}';
    protected $description = '重建駕駛餘額彙總表';

    public function handle()
    {
        $this->info('開始重建駕駛餘額彙總...');

        if ($driverId = $this->option('driver')) {
            DriverBalanceSummary::updateBalance($driverId);
            $this->info("駕駛 ID {$driverId} 的餘額已更新");
        } else {
            DriverBalanceSummary::rebuildAll();
            $this->info('所有駕駛餘額已重建完成');
        }

        return Command::SUCCESS;
    }
}
```

### 6. 路由設定

```php
// routes/web.php

Route::middleware(['auth', 'role:admin'])->prefix('admin')->name('admin.')->group(function () {
    // 催帳管理
    Route::get('/collections', [CollectionController::class, 'index'])
        ->name('collections.index');
    Route::get('/collections/{driver}', [CollectionController::class, 'show'])
        ->name('collections.show');
});
```

---

## 前端實作

### 催帳管理頁面 (Collections/Index.vue)

```vue
<template>
    <AdminLayout :user="$page.props.auth.user">
        <template #header>
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">催帳管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item">
                            <Link :href="route('admin.dashboard')">儀表板</Link>
                        </li>
                        <li class="breadcrumb-item active">催帳管理</li>
                    </ol>
                </div>
            </div>
        </template>

        <!-- 統計卡片 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="info-box">
                    <span class="info-box-icon bg-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">欠款人數</span>
                        <span class="info-box-number">{{ statistics.total_debtors }} 人</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box">
                    <span class="info-box-icon bg-warning">
                        <i class="bi bi-currency-dollar"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">總欠款金額</span>
                        <span class="info-box-number">
                            {{ formatCurrency(statistics.total_debt_amount) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜尋與列表 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">欠款駕駛列表</h3>
            </div>
            <div class="card-body">
                <!-- 搜尋列 -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input
                                v-model="searchForm.search"
                                type="text"
                                class="form-control"
                                placeholder="搜尋姓名、身分證..."
                                @keyup.enter="search"
                            >
                            <button @click="search" class="btn btn-primary" type="button">
                                <i class="bi bi-search"></i> 搜尋
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>身分證字號</th>
                                <th>聯絡電話</th>
                                <th class="text-end">借方總額</th>
                                <th class="text-end">貸方總額</th>
                                <th class="text-end">餘額</th>
                                <th>最後交易日</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="debtor in debtors.data" :key="debtor.driver_id">
                                <td>{{ debtor.driver_name }}</td>
                                <td>{{ debtor.driver_id_number }}</td>
                                <td>{{ debtor.driver?.mobile_phone1 || '-' }}</td>
                                <td class="text-end">{{ formatCurrency(debtor.total_debit) }}</td>
                                <td class="text-end">{{ formatCurrency(debtor.total_credit) }}</td>
                                <td class="text-end">
                                    <span class="badge bg-danger">
                                        {{ formatCurrency(debtor.balance) }}
                                    </span>
                                </td>
                                <td>{{ formatDate(debtor.last_transaction_date) }}</td>
                                <td>
                                    <span
                                        :class="'badge ' + (debtor.driver?.status === 'open' ? 'bg-success' : 'bg-secondary')"
                                    >
                                        {{ debtor.driver?.status === 'open' ? '在籍' : '已退籍' }}
                                    </span>
                                </td>
                                <td>
                                    <Link
                                        :href="route('admin.accounting.index', { driver_id: debtor.driver_id })"
                                        class="btn btn-sm btn-info"
                                    >
                                        <i class="bi bi-list"></i> 查看明細
                                    </Link>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                <Pagination :data="debtors" />
            </div>
        </div>
    </AdminLayout>
</template>

<script setup>
import { ref } from 'vue'
import { Link, router } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import Pagination from '@/Components/Pagination.vue'

const props = defineProps({
    debtors: Object,
    statistics: Object,
    filters: Object
})

const searchForm = ref({
    search: props.filters.search || ''
})

const search = () => {
    router.get(route('admin.collections.index'), searchForm.value, {
        preserveState: true,
        replace: true
    })
}

const formatCurrency = (amount) => {
    return new Intl.NumberFormat('zh-TW', {
        style: 'currency',
        currency: 'TWD',
        minimumFractionDigits: 0
    }).format(amount)
}

const formatDate = (date) => {
    if (!date) return '-'
    return new Date(date).toLocaleDateString('zh-TW')
}
</script>
```

---

## 實作步驟

### 階段一：資料庫與基礎結構
1. ✅ 建立 Migration (`driver_balance_summary` 表)
2. ✅ 建立 Model (`DriverBalanceSummary`)
3. ✅ 在 `AccountingRecord` Model 加入事件監聽
4. ✅ 建立修復指令 (`balance:rebuild`)
5. ✅ 執行初始化：`php artisan balance:rebuild`

### 階段二：權限設定
```php
// database/seeders/PermissionSeeder.php
Permission::create(['name' => 'view collections', 'guard_name' => 'web']);
// 將權限分配給 admin 角色
```

### 階段三：後端開發
1. ✅ 建立 `CollectionController`
2. ✅ 設定路由
3. ✅ 測試 API 回應

### 階段四：前端開發
1. ✅ 建立 `Collections/Index.vue` 頁面
2. ✅ 加入選單連結（在 AdminLayout 側邊欄）
3. ✅ 測試搜尋、分頁、排序功能

### 階段五：測試與優化
1. 單元測試：`DriverBalanceSummary::updateBalance()`
2. 功能測試：新增/修改/刪除帳務記錄後檢查彙總是否正確更新
3. 效能測試：查詢響應時間
4. 資料驗證：執行 `balance:rebuild` 比對資料一致性

---

## 維護機制

### 1. 定期驗證（排程任務）

```php
// app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    // 每天凌晨 2 點驗證並修復餘額資料
    $schedule->command('balance:rebuild')
             ->dailyAt('02:00')
             ->onOneServer();
}
```

### 2. 批次匯入時的處理

如果需要批次匯入大量帳務記錄，建議：
```php
// 暫時停用事件
AccountingRecord::withoutEvents(function () {
    // 批次匯入邏輯
    foreach ($records as $record) {
        AccountingRecord::create($record);
    }
});

// 批次完成後統一重建
DriverBalanceSummary::rebuildAll();
```

### 3. 監控與警報

建議建立監控機制：
- 監控彙總表與實際計算的差異
- 記錄更新失敗的情況
- 設定欠款金額門檻警報

---

## 效能評估

### 查詢效能比較

| 方案 | 駕駛數 | 帳務記錄數 | 查詢時間 | 資料庫負載 |
|-----|-------|----------|---------|----------|
| 即時彙總 | 1000 | 500,000 | 1-3 秒 | 高 ❌ |
| 彙總表 | 1000 | 1,000 | < 100ms | 低 ✅ |

### 儲存空間

- 彙總表記錄數 = 駕駛數 (1000 筆)
- 每筆約 150 bytes
- 總空間需求：約 150 KB（可忽略不計）

### 維護成本

- 每次帳務異動觸發一次更新（< 10ms）
- 定期驗證：每日一次全量重建（約 1-2 分鐘）
- 幾乎無額外維護成本

---

## 統計範圍說明

### 包含在催帳統計的記錄
- ✅ 有綁定駕駛 ID 的帳務記錄（`driver_id IS NOT NULL`）
- ✅ 同時綁定駕駛和車輛的帳務記錄

### 排除在催帳統計外的記錄
- ❌ 只綁定車輛的帳務記錄（`driver_id IS NULL AND vehicle_id IS NOT NULL`）
  - 這類記錄通常為車輛維護、保險等成本，不屬於駕駛欠款
  - 此類帳務不會觸發彙總表更新
- ❌ 未綁定任何對象的帳務記錄（`driver_id IS NULL AND vehicle_id IS NULL`）
  - 這類記錄屬於公司一般支出，不涉及催帳

### 業務邏輯說明
催帳管理的目的是追蹤**駕駛個人**的帳務餘額，因此：
- 只統計與駕駛相關的收支（有 `driver_id` 的記錄）
- 車輛相關的純成本支出（如保養、保險）不計入駕駛欠款
- Model Event 中已自動處理：`if ($record->driver_id)` 只處理有駕駛的記錄
- 如需分析車輛成本，應使用「車輛成本管理」功能（未來可擴充）

### 自動更新觸發時機
```php
// AccountingRecord Model Event
static::created(function (AccountingRecord $record) {
    if ($record->driver_id) {  // ✅ 只有綁駕駛的才更新彙總
        DriverBalanceSummary::updateBalance($record->driver_id);
    }
    // driver_id 為 NULL 的記錄不觸發更新，自動排除
});
```

---

## 注意事項與限制

1. **資料一致性**
   - 依賴 Model Event，需確保所有帳務異動都透過 Eloquent Model
   - 如果使用 Raw SQL 或 Query Builder 直接操作，需手動呼叫 `updateBalance()`

2. **駕駛資料變更**
   - 駕駛姓名或身分證異動時，需更新彙總表的冗餘欄位
   - 建議在 Driver Model 也加入事件監聽

3. **軟刪除處理**
   - 帳務記錄軟刪除時會自動更新彙總
   - 駕駛軟刪除時，CASCADE 會自動刪除彙總記錄

4. **並發問題**
   - 使用 `updateOrCreate()` 可避免並發寫入問題
   - 高並發環境建議加入 Redis Lock

5. **歷史記錄**
   - 目前只記錄當前餘額，不保存歷史變化
   - 如需追蹤餘額變化趨勢，需另外設計歷史記錄表

6. **統計範圍限制**
   - 只統計有綁定駕駛的帳務記錄
   - 純車輛成本不列入催帳管理
   - 符合「向人催款」的業務邏輯

---

## 未來擴充方向

1. **餘額變化趨勢圖表**
   - 新增歷史快照表，記錄每月餘額
   - 視覺化呈現欠款趨勢

2. **自動提醒功能**
   - 欠款超過門檻時發送通知
   - 長期未交易且有欠款的駕駛警示

3. **分期付款管理**
   - 記錄還款計畫
   - 追蹤還款進度

4. **匯出報表**
   - Excel 匯出催帳清單
   - 產生催款通知單 PDF
