# 快速搜尋頁面開發規劃文件

此文件為開發前端快速搜尋頁面的完整規劃文件，詳細記錄專案背景、需求分析、技術架構、開發計畫等。

---

## 📋 專案概述

### 🎯 專案背景
建立一個快速搜尋工具頁面，讓使用者能夠快速查詢駕駛與車輛資料，作為資料檢視和後續操作的入口頁面。此頁面主要著重於資料展示，不包含編輯功能，但預留擴充按鈕介面，方便未來整合其他管理功能。

### 🎯 專案目標
- **主要目標**：提供快速、直觀的駕駛與車輛資料查詢介面
- **核心功能**：關鍵字搜尋、資料列表展示、詳細資料檢視
- **使用者體驗**：簡潔、快速、易用的查詢體驗
- **擴充性**：預留操作按鈕介面，支援未來功能整合

### 🎯 專案範圍

#### 核心功能模組
- **關鍵字搜尋**：支援姓名、車牌號碼、身分證字號、車隊編號等關鍵字搜尋
- **駕駛列表**：顯示符合條件的駕駛資料，支援詳細資料檢視
- **車輛列表**：顯示符合條件的車輛資料，支援詳細資料檢視
- **詳細資料檢視**：Modal 彈窗顯示完整駕駛/車輛資訊
- **操作按鈕區**：預留按鈕介面，未來可整合至其他管理功能（如帳務管理、維修記錄等）

#### 技術範圍
- **後端開發**：Laravel 11.x + PHP 8.4+
- **前端開發**：Vue 3 + Inertia.js + AdminLTE 4
- **資料庫**：查詢 `drivers` 和 `vehicles` 資料表
- **權限管理**：整合現有 Position (職務) 系統

#### 非功能需求
- **效能要求**：搜尋回應時間 < 1 秒
- **資料筆數**：支援分頁顯示，每頁顯示 10 筆
- **響應式設計**：支援桌面和行動裝置

---

## 🎬 使用者操作流程

### 標準操作流程

#### 1️⃣ 進入搜尋頁面
```
使用者點擊導航選單「快速搜尋」→ 進入搜尋頁面
```

**系統行為**：
- 顯示搜尋輸入框和搜尋類型選擇
- 頁面初始狀態不顯示任何列表（空白狀態提示）

#### 2️⃣ 執行搜尋
```
使用者輸入關鍵字 → 選擇搜尋類型（可選）→ 點擊搜尋按鈕或按下 Enter
```

**搜尋類型選項**：
- **全部**（預設）：同時搜尋駕駛和車輛
- **駕駛**：僅搜尋駕駛資料
- **車輛**：僅搜尋車輛資料

**關鍵字搜尋範圍**：
- **駕駛**：姓名、身分證字號、手機號碼
  - 同時透過 `driver_vehicle_assignments` 關聯載入該駕駛開的所有車輛
- **車輛**：車牌號碼、車主名稱、車身號碼、引擎號碼
  - 同時透過 `driver_vehicle_assignments` 關聯載入開這台車的所有駕駛

**系統行為**：
- 執行搜尋查詢
- 根據搜尋類型顯示對應的列表卡片
- 顯示搜尋結果數量統計
- 若無結果，顯示「查無資料」提示

#### 3️⃣ 檢視搜尋結果

**駕駛列表顯示欄位**：
- 姓名
- 身分證字號
- 手機號碼
- 公司類別
- 狀態（在籍/退籍）
- 操作按鈕

**車輛列表顯示欄位**：
- 車牌號碼
- 車主名稱
- 車輛類型
- 公司類別
- 狀態（在籍/退籍）
- 操作按鈕

**系統行為**：
- 列表支援分頁顯示（每頁 10 筆）
- 顯示總筆數統計
- 提供「查看詳情」按鈕

#### 4️⃣ 查看詳細資料

**操作流程**：
```
點擊列表項目的「查看詳情」按鈕 → 彈出 Modal 顯示完整資料
```

**駕駛詳細資料包含**：
- 基本資料：姓名、身分證字號、生日、聯絡地址、戶籍地址
- 聯絡資訊：住家電話、手機號碼、緊急聯絡人
- 日期資訊：入籍日期、退籍日期、駕照到期日、執登到期日
- 狀態資訊：目前狀態、公司類別

**車輛詳細資料包含**：
- 基本資料：車牌號碼、車主名稱、車輛類型、地址
- 製造資訊：廠牌、出廠年月、車輛形式、排氣量、燃料種類
- 車身資訊：引擎號碼、車身號碼、載運人數、車輛顏色
- 日期資訊：發照日期、檢驗日期、入籍日期、退籍日期
- 狀態資訊：車輛狀態、產權類別、公司類別

#### 5️⃣ 快速操作（預留功能）

**操作按鈕區**：
- 「新增帳務記錄」：帶入駕駛/車輛資料至帳務管理頁面
- 「查看帳務記錄」：跳轉至該駕駛/車輛的帳務記錄頁面
- 「編輯資料」：跳轉至駕駛/車輛編輯頁面
- （更多按鈕可依需求擴充）

**系統行為**：
- 點擊操作按鈕時，透過 Inertia.js 傳遞資料至目標頁面
- 目標頁面自動載入對應的駕駛/車輛資料

---

## 🔄 互動流程圖

```
┌─────────────────────┐
│   進入快速搜尋頁面   │
│   (空白狀態)         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────────┐
│ 輸入關鍵字 + 選擇搜尋類型         │
│ • 全部（預設）                    │
│ • 駕駛                           │
│ • 車輛                           │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│  執行搜尋                        │
│  • 搜尋駕駛（姓名/身分證/手機）   │
│  • 搜尋車輛（車牌/車主/車身號）   │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│  顯示搜尋結果                    │
│  ┌─────────────────────────┐    │
│  │ 駕駛列表 (N 筆)          │    │
│  │ • 支援分頁               │    │
│  │ • 顯示關鍵欄位           │    │
│  │ • 查看詳情按鈕           │    │
│  └─────────────────────────┘    │
│  ┌─────────────────────────┐    │
│  │ 車輛列表 (M 筆)          │    │
│  │ • 支援分頁               │    │
│  │ • 顯示關鍵欄位           │    │
│  │ • 查看詳情按鈕           │    │
│  └─────────────────────────┘    │
└──────────┬──────────────────────┘
           │
           ├──→ 點擊「查看詳情」
           │         │
           │         ▼
           │    ┌────────────────────┐
           │    │ Modal 顯示完整資料  │
           │    │ • 駕駛詳細資料      │
           │    │ • 車輛詳細資料      │
           │    └────────────────────┘
           │
           ├──→ 點擊「新增帳務記錄」（預留）
           │         │
           │         ▼
           │    跳轉至帳務管理頁面（帶資料）
           │
           ├──→ 點擊「查看帳務記錄」（預留）
           │         │
           │         ▼
           │    跳轉至帳務查詢頁面
           │
           └──→ 點擊「編輯資料」（預留）
                     │
                     ▼
                跳轉至編輯頁面
```

---

## 💡 使用者體驗重點

### ✅ 簡潔性
- 單一搜尋框，無需複雜的篩選條件
- 預設搜尋全部，減少操作步驟
- 清晰的視覺層次，資料一目了然

### ✅ 快速性
- 即時搜尋回應（< 1 秒）
- 支援 Enter 快捷鍵執行搜尋
- 分頁載入，避免資料過多影響效能

### ✅ 直觀性
- 搜尋結果分區顯示（駕駛/車輛）
- 統計資訊清楚顯示（找到 N 筆駕駛、M 筆車輛）
- 操作按鈕位置固定，易於點擊

### ✅ 擴充性
- 預留操作按鈕區域
- 支援未來整合更多功能
- 資料傳遞機制已規劃

---

## 🗄️ 資料庫設計

### 相關資料表

#### 1. drivers（駕駛資料表）

**搜尋相關欄位**：
- `name`：姓名（主要搜尋欄位）
- `id_number`：身分證字號（精確搜尋）
- `mobile_phone1`、`mobile_phone2`：手機號碼

**列表顯示欄位**：
- `id`、`name`、`id_number`、`mobile_phone1`、`company_category_id`、`status`
- 額外顯示：該駕駛開的車輛列表（透過 `driver_vehicle_assignments` 關聯）

**詳細資料欄位**：
- 全部欄位（基本資料、聯絡資訊、日期資訊、狀態）

**關聯資料**：
- `company_categories`（公司類別）：透過 `company_category_id` 關聯
- `driver_vehicle_assignments`（駕駛車輛綁定）：透過 `driver_id` 關聯
- `vehicles`（車輛）：透過 `driver_vehicle_assignments` 間接關聯

#### 2. vehicles（車輛資料表）

**搜尋相關欄位**：
- `license_number`：車牌號碼（主要搜尋欄位）
- `owner_name`：車主名稱
- `chassis_number`：車身號碼
- `engine_number`：引擎號碼

**列表顯示欄位**：
- `id`、`license_number`、`owner_name`、`vehicle_type`、`company_category_id`、`vehicle_status`
- 額外顯示：開這台車的駕駛列表（透過 `driver_vehicle_assignments` 關聯）

**詳細資料欄位**：
- 全部欄位（基本資料、製造資訊、日期資訊、狀態）

**關聯資料**：
- `company_categories`（公司類別）：透過 `company_category_id` 關聯
- `companies`（公司名稱）：透過 `company_id` 關聯
- `driver_vehicle_assignments`（駕駛車輛綁定）：透過 `vehicle_id` 關聯
- `drivers`（駕駛）：透過 `driver_vehicle_assignments` 間接關聯

#### 3. driver_vehicle_assignments（駕駛車輛綁定資料表）

**用途**：記錄駕駛與車輛的多對多綁定關係

**關鍵欄位**：
- `driver_id`：駕駛 ID（外鍵關聯 drivers.id）
- `vehicle_id`：車輛 ID（外鍵關聯 vehicles.id）
- `notes`：備註

**唯一約束**：
- `(driver_id, vehicle_id)`：避免重複綁定

**搜尋邏輯**：
- 搜尋駕駛時，透過此表找出該駕駛開的所有車輛
- 搜尋車輛時，透過此表找出開這台車的所有駕駛

### 搜尋效能優化

**現有索引**（已存在於資料表）：
```sql
-- drivers 資料表
INDEX: idx_name (name)
INDEX: idx_id_number (id_number)
INDEX: idx_status (status)

-- vehicles 資料表
INDEX: idx_license_number (license_number)
INDEX: idx_vehicle_status (vehicle_status)

-- driver_vehicle_assignments 資料表
INDEX: driver_id (查詢駕駛的車輛)
INDEX: vehicle_id (查詢車輛的駕駛)
UNIQUE INDEX: (driver_id, vehicle_id) (避免重複綁定)
```

**搜尋查詢策略**：
- 使用 `LIKE` 進行模糊搜尋（前綴匹配）
- 利用現有索引加速查詢
- 透過 `driver_vehicle_assignments` 關聯查詢時使用 `whereIn` 提升效能
- 限制搜尋結果筆數（避免過多資料）

**搜尋實作邏輯（參考 AccountingRecordService）**：
```php
// 搜尋駕駛時，同時載入其開的車輛
$drivers = Driver::where('name', 'like', "%{$keyword}%")
    ->with('companyCategory')
    ->get();

if ($drivers->isNotEmpty()) {
    $driverIds = $drivers->pluck('id');
    $vehicleIds = DriverVehicleAssignment::whereIn('driver_id', $driverIds)
        ->pluck('vehicle_id');
    $vehicles = Vehicle::whereIn('id', $vehicleIds)
        ->with(['companyCategory', 'company'])
        ->get();
}

// 搜尋車輛時，同時載入開這台車的駕駛
$vehicles = Vehicle::where('license_number', 'like', "%{$keyword}%")
    ->with(['companyCategory', 'company'])
    ->get();

if ($vehicles->isNotEmpty()) {
    $vehicleIds = $vehicles->pluck('id');
    $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
        ->pluck('driver_id');
    $drivers = Driver::whereIn('id', $driverIds)
        ->with('companyCategory')
        ->get();
}
```

---

## 🔌 API 設計

### 後端 API 端點

#### 1. 搜尋 API

**路由**：`GET /admin/quick-search`

**請求參數**：
```php
[
    'keyword' => 'string|required|min:1',  // 搜尋關鍵字
    'type' => 'string|nullable|in:all,driver,vehicle',  // 搜尋類型（預設 all）
]
```

**回應格式**：
```php
[
    'drivers' => [
        [
            'id' => 1,
            'name' => '王小明',
            'id_number' => 'A123456789',
            'mobile_phone1' => '0912345678',
            'status' => 'open',
            'company_category' => [
                'id' => 1,
                'name' => '甲類公司',
            ],
            'vehicles' => [  // 該駕駛開的車輛列表
                [
                    'id' => 1,
                    'license_number' => 'ABC-1234',
                    'vehicle_type' => '轎車',
                ],
                // ... more vehicles
            ],
        ],
        // ... more drivers
    ],
    'vehicles' => [
        [
            'id' => 1,
            'license_number' => 'ABC-1234',
            'owner_name' => '王小明',
            'vehicle_type' => '轎車',
            'vehicle_status' => 'active',
            'company_category' => [
                'id' => 1,
                'name' => '甲類公司',
            ],
            'drivers' => [  // 開這台車的駕駛列表
                [
                    'id' => 1,
                    'name' => '王小明',
                    'mobile_phone1' => '0912345678',
                ],
                // ... more drivers
            ],
        ],
        // ... more vehicles
    ],
    'filters' => [
        'keyword' => '王小明',
        'type' => 'all',
    ],
]
```

**注意事項**：
- 不使用分頁，直接返回所有搜尋結果（通常不會太多）
- 駕駛列表包含其開的車輛資訊
- 車輛列表包含開這台車的駕駛資訊

#### 2. 取得駕駛詳細資料 API

**路由**：`GET /admin/quick-search/driver/{id}`

**回應格式**：
```php
[
    'id' => 1,
    'name' => '王小明',
    'id_number' => 'A123456789',
    'birthday' => '1980-01-01',
    'contact_address' => '台北市...',
    'residence_address' => '新北市...',
    'home_phone' => '02-12345678',
    'mobile_phone1' => '0912345678',
    'mobile_phone2' => null,
    'emergency_contact' => '王大明',
    'emergency_phone' => '0987654321',
    'registration_date' => '2020-01-01',
    'deregistration_date' => null,
    'fleet_join_date' => '2020-01-15',
    'fleet_leave_date' => null,
    'license_expire_date' => '2025-12-31',
    'professional_license_expire_date' => '2025-12-31',
    'status' => 'open',
    'company_category' => [
        'id' => 1,
        'name' => '甲類公司',
    ],
]
```

#### 3. 取得車輛詳細資料 API

**路由**：`GET /admin/quick-search/vehicle/{id}`

**回應格式**：
```php
[
    'id' => 1,
    'license_number' => 'ABC-1234',
    'owner_name' => '王小明',
    'vehicle_type' => '轎車',
    'address' => '台北市...',
    'brand' => 'TOYOTA',
    'manufacture_year' => 2020,
    'manufacture_month' => 5,
    'vehicle_form' => '4門',
    'engine_displacement' => 2000.00,
    'fuel_type' => '汽油',
    'vehicle_model' => 'CAMRY',
    'engine_number' => 'ENG123456',
    'chassis_number' => 'CHS789012',
    'passenger_capacity' => 5,
    'vehicle_color' => '白色',
    'license_issue_year' => 2020,
    'license_issue_month' => 6,
    'license_issue_day' => 15,
    'inspection_year' => 2024,
    'inspection_month' => 6,
    'inspection_day' => 15,
    'vehicle_status' => 'active',
    'property_type' => '自有',
    'notes' => null,
    'company_category' => [
        'id' => 1,
        'name' => '甲類公司',
    ],
    'company' => [
        'id' => 1,
        'name' => 'ABC 汽車公司',
    ],
]
```

---

## 🎨 前端介面設計

### 頁面結構

```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <!-- 頁面標題 -->
    <PageHeader title="快速搜尋" />

    <!-- 搜尋區域 -->
    <SearchSection
      v-model:keyword="searchForm.keyword"
      v-model:type="searchForm.type"
      @search="handleSearch"
    />

    <!-- 搜尋結果統計 -->
    <SearchStats
      v-if="hasResults"
      :driver-count="drivers.total"
      :vehicle-count="vehicles.total"
    />

    <!-- 駕駛列表 -->
    <DriverList
      v-if="showDriverList"
      :drivers="drivers"
      @view-detail="showDriverDetail"
      @page-change="handleDriverPageChange"
    />

    <!-- 車輛列表 -->
    <VehicleList
      v-if="showVehicleList"
      :vehicles="vehicles"
      @view-detail="showVehicleDetail"
      @page-change="handleVehiclePageChange"
    />

    <!-- 駕駛詳細資料 Modal -->
    <DriverDetailModal
      v-model:show="modals.driverDetail"
      :driver="selectedDriver"
    />

    <!-- 車輛詳細資料 Modal -->
    <VehicleDetailModal
      v-model:show="modals.vehicleDetail"
      :vehicle="selectedVehicle"
    />
  </AdminLayout>
</template>
```

### UI 組件設計

#### 1. 搜尋區域 (SearchSection)

**UI 元素**：
- 關鍵字輸入框（文字輸入，placeholder: "請輸入姓名、車牌號碼、身分證字號..."）
- 搜尋類型選擇（下拉選單：全部/駕駛/車輛）
- 搜尋按鈕（主要按鈕，支援 Enter 快捷鍵）

**樣式參考**：
- 使用 Bootstrap 5 的 input-group 元件
- 搜尋按鈕使用主色調（primary）

#### 2. 駕駛列表 (DriverList)

**表格欄位**：
| 欄位 | 寬度 | 說明 |
|------|------|------|
| 姓名 | 15% | 顯示駕駛姓名 |
| 身分證字號 | 15% | 部分遮罩（A12****789） |
| 手機號碼 | 15% | 主要聯絡電話 |
| 公司類別 | 15% | 關聯公司類別名稱 |
| 狀態 | 10% | Badge 顯示（在籍/退籍） |
| 操作 | 30% | 查看詳情、快速操作按鈕 |

**UI 特性**：
- 使用 Bootstrap Table 元件
- 狀態 Badge：在籍（success）、退籍（secondary）
- 支援滑鼠 hover 高亮效果
- 底部顯示分頁元件

#### 3. 車輛列表 (VehicleList)

**表格欄位**：
| 欄位 | 寬度 | 說明 |
|------|------|------|
| 車牌號碼 | 15% | 顯示車牌 |
| 車主名稱 | 15% | 車主姓名 |
| 車輛類型 | 15% | 車輛類型 |
| 公司類別 | 15% | 關聯公司類別名稱 |
| 狀態 | 10% | Badge 顯示（在籍/退籍） |
| 操作 | 30% | 查看詳情、快速操作按鈕 |

**UI 特性**：
- 使用 Bootstrap Table 元件
- 狀態 Badge：在籍（success）、退籍（secondary）
- 支援滑鼠 hover 高亮效果
- 底部顯示分頁元件

#### 4. 詳細資料 Modal

**駕駛詳細資料 Modal**：
- 使用 Bootstrap Modal（大尺寸）
- 分區顯示：基本資料、聯絡資訊、日期資訊、狀態資訊
- 使用 Description List 元件排版

**車輛詳細資料 Modal**：
- 使用 Bootstrap Modal（大尺寸）
- 分區顯示：基本資料、製造資訊、車身資訊、日期資訊、狀態資訊
- 使用 Description List 元件排版

---

## 🔐 權限管理

### 頁面存取權限

**路由設定**：
```php
Route::middleware(['auth', 'role_or_permission:...'])->group(function () {
    Route::get('/admin/quick-search', [QuickSearchController::class, 'index'])
        ->name('admin.quick-search.index');

    Route::get('/admin/quick-search/driver/{driver}', [QuickSearchController::class, 'showDriver'])
        ->name('admin.quick-search.driver');

    Route::get('/admin/quick-search/vehicle/{vehicle}', [QuickSearchController::class, 'showVehicle'])
        ->name('admin.quick-search.vehicle');
});
```

**權限需求**：
- 需要登入後才能存取
- 根據現有職務系統設定存取權限（待確認具體權限角色）

---

## 🛠️ 技術實作細節

### 後端實作

#### Controller 結構

```php
namespace App\Http\Controllers\Admin;

use App\Models\Driver;
use App\Models\Vehicle;
use App\Models\DriverVehicleAssignment;
use Illuminate\Http\Request;
use Inertia\Inertia;

class QuickSearchController extends Controller
{
    /**
     * 顯示快速搜尋頁面
     */
    public function index(Request $request)
    {
        $keyword = $request->input('keyword');
        $type = $request->input('type', 'all');

        $drivers = [];
        $vehicles = [];

        if ($keyword) {
            $searchResult = $this->performSearch($type, $keyword);
            $drivers = $searchResult['drivers'];
            $vehicles = $searchResult['vehicles'];
        }

        return Inertia::render('Admin/QuickSearch/Index', [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
            'filters' => [
                'keyword' => $keyword,
                'type' => $type,
            ],
        ]);
    }

    /**
     * 執行搜尋（參考 AccountingRecordService）
     */
    private function performSearch(string $type, string $keyword): array
    {
        $drivers = [];
        $vehicles = [];

        if ($type === 'all' || $type === 'driver') {
            // 搜尋駕駛
            $drivers = Driver::where(function ($query) use ($keyword) {
                $query->where('name', 'LIKE', "%{$keyword}%")
                    ->orWhere('id_number', 'LIKE', "%{$keyword}%")
                    ->orWhere('mobile_phone1', 'LIKE', "%{$keyword}%")
                    ->orWhere('mobile_phone2', 'LIKE', "%{$keyword}%");
            })
            ->with('companyCategory')
            ->get();

            // 透過駕駛找車輛（使用 driver_vehicle_assignments）
            if ($drivers->isNotEmpty()) {
                $driverIds = $drivers->pluck('id');
                $vehicleIds = DriverVehicleAssignment::whereIn('driver_id', $driverIds)
                    ->pluck('vehicle_id')
                    ->unique();

                if ($vehicleIds->isNotEmpty()) {
                    $relatedVehicles = Vehicle::whereIn('id', $vehicleIds)
                        ->with(['companyCategory', 'company'])
                        ->get();

                    // 為每個駕駛附加其開的車輛列表
                    $drivers->each(function ($driver) use ($relatedVehicles) {
                        $driver->vehicles = $relatedVehicles->filter(function ($vehicle) use ($driver) {
                            return DriverVehicleAssignment::where('driver_id', $driver->id)
                                ->where('vehicle_id', $vehicle->id)
                                ->exists();
                        })->values();
                    });

                    // 如果搜尋類型為 all，也將這些車輛加入車輛列表
                    if ($type === 'all') {
                        $vehicles = $relatedVehicles;
                    }
                }
            }
        }

        if ($type === 'all' || $type === 'vehicle') {
            // 搜尋車輛
            $vehicleQuery = Vehicle::where(function ($query) use ($keyword) {
                $query->where('license_number', 'LIKE', "%{$keyword}%")
                    ->orWhere('owner_name', 'LIKE', "%{$keyword}%")
                    ->orWhere('chassis_number', 'LIKE', "%{$keyword}%")
                    ->orWhere('engine_number', 'LIKE', "%{$keyword}%");
            })
            ->with(['companyCategory', 'company']);

            // 如果 type 為 all 且已經有從駕駛找到的車輛，則排除這些車輛
            if ($type === 'all' && !empty($vehicles)) {
                $existingVehicleIds = collect($vehicles)->pluck('id');
                $vehicleQuery->whereNotIn('id', $existingVehicleIds);
            }

            $searchedVehicles = $vehicleQuery->get();

            // 合併車輛列表
            if ($type === 'all') {
                $vehicles = collect($vehicles)->merge($searchedVehicles);
            } else {
                $vehicles = $searchedVehicles;
            }

            // 透過車輛找駕駛（使用 driver_vehicle_assignments）
            if ($vehicles->isNotEmpty()) {
                $vehicleIds = $vehicles->pluck('id');
                $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
                    ->pluck('driver_id')
                    ->unique();

                if ($driverIds->isNotEmpty()) {
                    $relatedDrivers = Driver::whereIn('id', $driverIds)
                        ->with('companyCategory')
                        ->get();

                    // 為每個車輛附加開這台車的駕駛列表
                    $vehicles->each(function ($vehicle) use ($relatedDrivers) {
                        $vehicle->drivers = $relatedDrivers->filter(function ($driver) use ($vehicle) {
                            return DriverVehicleAssignment::where('driver_id', $driver->id)
                                ->where('vehicle_id', $vehicle->id)
                                ->exists();
                        })->values();
                    });

                    // 如果搜尋類型為 vehicle，也將這些駕駛加入駕駛列表
                    if ($type === 'vehicle') {
                        $drivers = $relatedDrivers;
                    }
                }
            }
        }

        return [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
        ];
    }

    /**
     * 顯示駕駛詳細資料
     */
    public function showDriver(Driver $driver)
    {
        return response()->json(
            $driver->load('companyCategory')
        );
    }

    /**
     * 顯示車輛詳細資料
     */
    public function showVehicle(Vehicle $vehicle)
    {
        return response()->json(
            $vehicle->load('companyCategory', 'company')
        );
    }
}
```

**重點說明**：
1. 參考 `AccountingRecordService` 的搜尋邏輯
2. 使用 `DriverVehicleAssignment` 關聯查詢駕駛與車輛
3. 搜尋駕駛時，自動載入其開的車輛
4. 搜尋車輛時，自動載入開這台車的駕駛
5. 搜尋類型為 `all` 時，兩邊都搜尋並合併結果

### 前端實作

#### 主頁面 Vue 組件

```vue
<script setup>
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'

// Props
const props = defineProps({
    drivers: Array,  // 改為 Array
    vehicles: Array, // 改為 Array
    filters: Object,
})

// State
const searchForm = ref({
    keyword: props.filters?.keyword || '',
    type: props.filters?.type || 'all',
})

const modals = ref({
    driverDetail: false,
    vehicleDetail: false,
})

const selectedDriver = ref(null)
const selectedVehicle = ref(null)

// Computed
const hasResults = computed(() => {
    return (props.drivers?.length > 0) || (props.vehicles?.length > 0)
})

const showDriverList = computed(() => {
    return searchForm.value.type === 'all' || searchForm.value.type === 'driver'
})

const showVehicleList = computed(() => {
    return searchForm.value.type === 'all' || searchForm.value.type === 'vehicle'
})

// Methods
const handleSearch = () => {
    router.get(route('admin.quick-search.index'), searchForm.value, {
        preserveState: true,
        preserveScroll: true,
    })
}

const showDriverDetail = async (driverId) => {
    try {
        const response = await fetch(route('admin.quick-search.driver', driverId))
        selectedDriver.value = await response.json()
        modals.value.driverDetail = true
    } catch (error) {
        console.error('Error fetching driver details:', error)
    }
}

const showVehicleDetail = async (vehicleId) => {
    try {
        const response = await fetch(route('admin.quick-search.vehicle', vehicleId))
        selectedVehicle.value = await response.json()
        modals.value.vehicleDetail = true
    } catch (error) {
        console.error('Error fetching vehicle details:', error)
    }
}
</script>

<template>
  <AdminLayout :user="$page.props.auth.user">
    <!-- 頁面標題 -->
    <div class="content-header">
      <div class="container-fluid">
        <h1 class="m-0">快速搜尋</h1>
      </div>
    </div>

    <!-- 主要內容 -->
    <div class="content">
      <div class="container-fluid">

        <!-- 搜尋區域 -->
        <div class="card">
          <div class="card-body">
            <form @submit.prevent="handleSearch">
              <div class="row">
                <div class="col-md-4">
                  <input
                    v-model="searchForm.keyword"
                    type="text"
                    class="form-control"
                    placeholder="請輸入姓名、車牌號碼、身分證字號..."
                    @keyup.enter="handleSearch"
                  >
                </div>
                <div class="col-md-3">
                  <select v-model="searchForm.type" class="form-select">
                    <option value="all">全部</option>
                    <option value="driver">駕駛</option>
                    <option value="vehicle">車輛</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 搜尋
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- 搜尋結果統計 -->
        <div v-if="hasResults" class="alert alert-info">
          找到 {{ drivers.length }} 筆駕駛、{{ vehicles.length }} 筆車輛
        </div>

        <!-- 駕駛列表 -->
        <div v-if="showDriverList && drivers.length > 0" class="card">
          <div class="card-header">
            <h3 class="card-title">駕駛列表</h3>
          </div>
          <div class="card-body">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>身分證字號</th>
                  <th>手機號碼</th>
                  <th>公司類別</th>
                  <th>開的車輛</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="driver in drivers" :key="driver.id">
                  <td>{{ driver.name }}</td>
                  <td>{{ maskIdNumber(driver.id_number) }}</td>
                  <td>{{ driver.mobile_phone1 }}</td>
                  <td>{{ driver.company_category?.name }}</td>
                  <td>
                    <span
                      v-for="vehicle in driver.vehicles"
                      :key="vehicle.id"
                      class="badge bg-secondary me-1"
                    >
                      {{ vehicle.license_number }}
                    </span>
                  </td>
                  <td>
                    <span :class="driver.status === 'open' ? 'badge bg-success' : 'badge bg-secondary'">
                      {{ driver.status === 'open' ? '在籍' : '退籍' }}
                    </span>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-info"
                      @click="showDriverDetail(driver.id)"
                    >
                      查看詳情
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 車輛列表 -->
        <div v-if="showVehicleList && vehicles.length > 0" class="card mt-3">
          <div class="card-header">
            <h3 class="card-title">車輛列表</h3>
          </div>
          <div class="card-body">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>車牌號碼</th>
                  <th>車主名稱</th>
                  <th>車輛類型</th>
                  <th>公司類別</th>
                  <th>駕駛</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="vehicle in vehicles" :key="vehicle.id">
                  <td>{{ vehicle.license_number }}</td>
                  <td>{{ vehicle.owner_name }}</td>
                  <td>{{ vehicle.vehicle_type }}</td>
                  <td>{{ vehicle.company_category?.name }}</td>
                  <td>
                    <span
                      v-for="driver in vehicle.drivers"
                      :key="driver.id"
                      class="badge bg-info me-1"
                    >
                      {{ driver.name }}
                    </span>
                  </td>
                  <td>
                    <span :class="vehicle.vehicle_status === 'active' ? 'badge bg-success' : 'badge bg-secondary'">
                      {{ vehicle.vehicle_status === 'active' ? '在籍' : '退籍' }}
                    </span>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-info"
                      @click="showVehicleDetail(vehicle.id)"
                    >
                      查看詳情
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 空白狀態提示 -->
        <div v-if="!hasResults && searchForm.keyword" class="alert alert-warning">
          查無符合條件的資料
        </div>

      </div>
    </div>

    <!-- Modal 部分省略，同前面設計 -->
  </AdminLayout>
</template>
```

**輔助函數**：
```javascript
// 遮罩身分證字號
const maskIdNumber = (idNumber) => {
    if (!idNumber || idNumber.length < 10) return idNumber
    return idNumber.substring(0, 3) + '****' + idNumber.substring(7)
}
```

---

## 📦 開發任務清單

### Phase 1: 後端開發（預估 2-3 天）

- [ ] **資料庫與模型**
  - [ ] 確認 Driver 模型關聯設定
  - [ ] 確認 Vehicle 模型關聯設定
  - [ ] 測試搜尋效能

- [ ] **Controller 開發**
  - [ ] 建立 QuickSearchController
  - [ ] 實作搜尋邏輯（駕駛）
  - [ ] 實作搜尋邏輯（車輛）
  - [ ] 實作詳細資料 API

- [ ] **路由設定**
  - [ ] 設定搜尋頁面路由
  - [ ] 設定 API 路由
  - [ ] 設定權限中介軟體

- [ ] **測試**
  - [ ] 搜尋功能測試
  - [ ] 分頁功能測試
  - [ ] 權限測試

### Phase 2: 前端開發（預估 3-4 天）

- [ ] **頁面結構**
  - [ ] 建立主頁面 Index.vue
  - [ ] 整合 AdminLayout
  - [ ] 建立頁面標題區塊

- [ ] **搜尋功能**
  - [ ] 建立搜尋輸入組件
  - [ ] 實作搜尋類型選擇
  - [ ] 實作搜尋送出邏輯
  - [ ] 支援 Enter 快捷鍵

- [ ] **列表顯示**
  - [ ] 建立駕駛列表組件
  - [ ] 建立車輛列表組件
  - [ ] 實作分頁組件
  - [ ] 實作搜尋結果統計

- [ ] **詳細資料 Modal**
  - [ ] 建立駕駛詳細資料 Modal
  - [ ] 建立車輛詳細資料 Modal
  - [ ] 實作資料載入邏輯
  - [ ] Bootstrap Modal 初始化（使用 setTimeout）

- [ ] **UI/UX 優化**
  - [ ] 空白狀態提示
  - [ ] 載入中狀態
  - [ ] 錯誤訊息提示
  - [ ] 響應式設計調整

### Phase 3: 整合測試（預估 1 天）

- [ ] **功能測試**
  - [ ] 搜尋功能完整測試
  - [ ] 分頁功能測試
  - [ ] Modal 彈窗測試
  - [ ] 不同裝置測試

- [ ] **效能測試**
  - [ ] 搜尋回應時間測試
  - [ ] 大量資料載入測試

- [ ] **瀏覽器相容性測試**
  - [ ] Chrome
  - [ ] Firefox
  - [ ] Safari
  - [ ] Edge

### Phase 4: 預留擴充功能（後續開發）

- [ ] **快速操作按鈕**
  - [ ] 新增帳務記錄按鈕
  - [ ] 查看帳務記錄按鈕
  - [ ] 編輯資料按鈕
  - [ ] 資料傳遞機制

- [ ] **進階搜尋**
  - [ ] 多條件組合搜尋
  - [ ] 日期範圍篩選
  - [ ] 狀態篩選

---

## 🎯 開發重點提醒

### 必須注意事項

1. **AdminLayout 使用**
   - ✅ 必須傳入 `:user="$page.props.auth.user"` prop
   - ❌ 否則會導致白屏錯誤

2. **Bootstrap Modal 初始化**
   - ✅ 使用 `setTimeout` 延遲初始化（100ms）
   - ❌ 避免直接在 `onMounted` 初始化導致白屏

3. **搜尋效能**
   - ✅ 使用現有索引加速查詢
   - ✅ 限制搜尋結果筆數（分頁）
   - ❌ 避免全表掃描

4. **資料安全**
   - ✅ 身分證字號部分遮罩顯示（A12****789）
   - ✅ 僅在詳細資料 Modal 顯示完整資訊
   - ✅ 確認使用者權限

5. **使用者體驗**
   - ✅ 提供清楚的空白狀態提示
   - ✅ 顯示載入中狀態
   - ✅ 錯誤訊息友善提示
   - ✅ 支援 Enter 快捷鍵

---

## 📝 開發備註

### 與帳務管理的差異

| 項目 | 帳務管理 | 快速搜尋 |
|------|---------|---------|
| 主要功能 | 資料選擇 + 帳務操作 | 資料檢視 |
| 選擇機制 | 需要選擇駕駛/車輛 | 不需要選擇 |
| 自動載入 | 自動載入帳務記錄 | 無自動載入 |
| 操作按鈕 | 新增/編輯/刪除帳務 | 查看詳情（預留擴充） |
| 資料呈現 | 強調選擇與操作 | 強調檢視與快速查詢 |

### 未來擴充方向

1. **整合其他管理功能**
   - 從快速搜尋直接跳轉至帳務管理並帶入資料
   - 從快速搜尋直接跳轉至維修記錄管理
   - 從快速搜尋直接跳轉至編輯頁面

2. **進階搜尋功能**
   - 新增進階搜尋面板
   - 支援多欄位組合查詢
   - 支援日期範圍篩選

3. **匯出功能**
   - 匯出搜尋結果為 Excel
   - 匯出搜尋結果為 PDF

4. **搜尋歷史記錄**
   - 記錄使用者搜尋關鍵字
   - 提供快速搜尋建議

---

## 🔗 相關文件連結

- [帳務管理系統開發規劃文件](./帳務管理.md)
- [駕駛管理系統文件](待補充)
- [車輛管理系統文件](待補充)
- [CLAUDE.md 專案指導文件](../CLAUDE.md)

---

## 🔄 開發歷程與優化記錄

### v1.1 - 效能優化與功能完善 (2025-10-10)

#### 🎯 優化項目

**1. 消除 N+1 查詢問題**
- **問題**：原始實作在為每個駕駛/車輛附加關聯資料時，使用 `filter()` + `exists()` 組合，導致大量資料庫查詢
- **影響**：10 個駕駛 × 5 台車 = 50+ 次額外查詢
- **解決方案**：使用 Eloquent `with()` 預載入關聯，將查詢次數從 50+ 次降低到 2-3 次
- **程式碼簡化**：從 85 行簡化到 52 行

**修正前**：
```php
// ❌ 每個駕駛都會執行 N 次資料庫查詢
$drivers->each(function ($driver) use ($relatedVehicles) {
    $driver->vehicles = $relatedVehicles->filter(function ($vehicle) use ($driver) {
        return DriverVehicleAssignment::where('driver_id', $driver->id)
            ->where('vehicle_id', $vehicle->id)
            ->exists();  // 重複查詢!
    })->values();
});
```

**修正後**：
```php
// ✅ 使用 Eloquent 關聯，一次查詢完成
$drivers = Driver::search($keyword)
    ->with([
        'companyCategory',
        'vehicles' => function ($query) {
            $query->with(['companyCategory', 'company']);
        },
    ])
    ->get();
```

**2. 完善詳細資料 API**
- **改進**：`showDriver()` 和 `showVehicle()` API 現在會載入完整的綁定關係資料
- **新增**：駕駛詳情包含綁定車輛、車輛詳情包含綁定駕駛

**修正前**：
```php
// ❌ 缺少綁定關係資料
public function showDriver(Driver $driver)
{
    return response()->json($driver->load('companyCategory'));
}
```

**修正後**：
```php
// ✅ 載入完整綁定關係
public function showDriver(Driver $driver)
{
    return response()->json(
        $driver->load([
            'companyCategory',
            'vehicles' => function ($query) {
                $query->with(['companyCategory', 'company']);
            }
        ])
    );
}
```

**3. Modal 新增綁定資料顯示**
- **DriverDetailModal.vue**：新增「綁定車輛」區塊，以表格形式顯示該駕駛開的所有車輛
- **VehicleDetailModal.vue**：新增「綁定駕駛」區塊，以表格形式顯示開該車的所有駕駛
- **資料保護**：身分證字號在綁定駕駛列表中也進行遮罩處理

**UI 改進**：
```
駕駛詳細資料 Modal
├─ 基本資料
├─ 聯絡資訊
├─ 日期資訊
├─ ✨ 綁定車輛（新增）
│   └─ 車牌、車主、類型、公司類別、狀態
└─ 備註

車輛詳細資料 Modal
├─ 基本資料
├─ 製造資訊
├─ 車身資訊
├─ 日期資訊
├─ ✨ 綁定駕駛（新增）
│   └─ 姓名、身分證(遮罩)、手機、公司類別、狀態
└─ 備註
```

**4. 程式碼品質提升**
- 移除未使用的 `ref` import
- 程式碼更簡潔、可讀性更高
- 充分利用 Laravel Eloquent 關聯特性

#### 📊 效能提升

| 指標 | 修正前 | 修正後 | 改善幅度 |
|------|--------|--------|----------|
| 資料庫查詢次數 | 50+ 次 | 2-3 次 | **減少 94%** |
| 程式碼行數 | 85 行 | 52 行 | **減少 39%** |
| 記憶體使用 | 較高 | 較低 | **優化** |
| 程式碼可維護性 | 中等 | 高 | **提升** |

#### ✅ 驗證清單

- [x] 搜尋駕駛時正確顯示綁定車輛
- [x] 搜尋車輛時正確顯示綁定駕駛
- [x] 詳細資料 Modal 顯示綁定關係
- [x] 消除 N+1 查詢問題
- [x] 程式碼簡化與優化
- [x] 身分證字號遮罩保護

#### 📝 技術重點

**Eloquent 關聯使用**：
- 使用 `belongsToMany` 關聯定義多對多關係
- 使用 `with()` 進行 Eager Loading 避免 N+1 問題
- 使用巢狀預載入 `vehicles.companyCategory` 一次載入深層關聯

**效能優化原則**：
- 避免在迴圈中查詢資料庫
- 使用 Collection 方法進行記憶體中的資料處理
- 適當使用 `unique()` 避免重複資料

---

**文件版本**：v1.1
**最後更新**：2025-10-10
**文件作者**：Ray
**審核狀態**：已完成開發並優化
