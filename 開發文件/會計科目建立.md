# 會計科目管理系統開發規劃文件

此文件為自訂會計科目管理系統的完整開發規劃文件，詳細記錄專案背景、需求分析、技術架構、資料庫設計、API 設計、前端介面設計、權限管理、開發時程等完整開發藍圖。

---

## 📋 專案概述

### 🎯 專案背景
企業集團需要建立標準化的會計科目管理系統，以支援後續的財務管理和帳務處理作業。系統應具備彈性化的科目分類架構，支援多層級的會計科目管理，並整合現有的企業管理系統架構。

### 🎯 專案目標
- **主要目標**：建立完整的會計科目管理系統
- **核心功能**：會計科目的建立、分類、管理和維護
- **系統整合**：整合現有的 AdminLTE 4 管理介面和權限系統
- **資料管理**：支援會計科目的匯入、匯出和批量處理
- **使用者體驗**：提供直觀易用的管理介面

### 🎯 專案範圍

#### 核心功能模組
- **會計科目總類管理**：管理會計科目的主要分類
- **會計科目子分類管理**：管理細分的會計科目類別
- **會計科目明細管理**：管理具體的會計科目項目
- **科目編碼系統**：自動化的科目編號生成和驗證
- **搜尋與篩選**：多條件搜尋和高級篩選功能
- **資料匯入匯出**：Excel 格式的批量處理功能
- **審計日誌**：完整的操作記錄和變更追蹤
- **權限管理**：基於角色的存取控制

#### 技術範圍
- **後端開發**：Laravel 11.x + PHP 8.4+
- **前端開發**：Vue 3 + Inertia.js + AdminLTE 4
- **資料庫設計**：SQLite（開發）/ MySQL（正式）
- **權限管理**：整合 Spatie Laravel Permission
- **測試覆蓋**：單元測試和功能測試

---

## 🗄️ 資料庫設計

### 資料表結構概覽

會計科目系統採用三層架構設計：**總類 → 子分類 → 明細科目**

```
會計科目總類 (AccountMainCategories)
    ↓ (1:N)
會計科目子分類 (AccountSubCategories)
    ↓ (1:N)
會計科目明細 (AccountDetails)
```

### 1. 會計科目總類資料表 (account_main_categories)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | 主鍵 |
| category_code | VARCHAR | 10 | UNIQUE, NOT NULL | 總類編號（如：1xxx, 2xxx）|
| category_name | VARCHAR | 100 | NOT NULL | 總類名稱 |
| description | TEXT | - | NULLABLE | 總類描述 |
| sort_order | INTEGER | - | DEFAULT 0 | 排序順序 |
| is_active | BOOLEAN | - | DEFAULT true | 是否啟用 |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | 建立者 |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | 最後更新者 |
| created_at | TIMESTAMP | - | NOT NULL | 建立時間 |
| updated_at | TIMESTAMP | - | NOT NULL | 更新時間 |

**索引設計**
- PRIMARY KEY: `id`
- UNIQUE KEY: `category_code`
- INDEX: `sort_order`
- INDEX: `is_active`

### 2. 會計科目子分類資料表 (account_sub_categories)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | 主鍵 |
| main_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | 總類外鍵 |
| sub_category_code | VARCHAR | 10 | NOT NULL | 子分類編號（如：11xx, 12xx）|
| sub_category_name | VARCHAR | 100 | NOT NULL | 子分類名稱 |
| description | TEXT | - | NULLABLE | 子分類描述 |
| sort_order | INTEGER | - | DEFAULT 0 | 排序順序 |
| is_active | BOOLEAN | - | DEFAULT true | 是否啟用 |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | 建立者 |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | 最後更新者 |
| created_at | TIMESTAMP | - | NOT NULL | 建立時間 |
| updated_at | TIMESTAMP | - | NOT NULL | 更新時間 |

**索引設計**
- PRIMARY KEY: `id`
- UNIQUE KEY: `main_category_id, sub_category_code`
- INDEX: `main_category_id`
- INDEX: `sort_order`
- INDEX: `is_active`

### 3. 會計科目明細資料表 (account_details)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | 主鍵 |
| main_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | 總類外鍵 |
| sub_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | 子分類外鍵 |
| account_code | VARCHAR | 20 | UNIQUE, NOT NULL | 完整科目編號 |
| account_name | VARCHAR | 150 | NOT NULL | 科目名稱 |
| account_name_en | VARCHAR | 150 | NULLABLE | 英文科目名稱 |
| description | TEXT | - | NULLABLE | 科目說明 |
| account_type | ENUM | - | NOT NULL | 科目性質（資產/負債/權益/收入/費用）|
| debit_credit | ENUM | - | NOT NULL | 借貸性質（借方/貸方）|
| is_summary | BOOLEAN | - | DEFAULT false | 是否為統馭科目 |
| parent_id | BIGINT | - | FOREIGN KEY, NULLABLE | 上級科目（用於多層結構）|
| level | INTEGER | - | DEFAULT 1 | 科目層級 |
| sort_order | INTEGER | - | DEFAULT 0 | 排序順序 |
| is_active | BOOLEAN | - | DEFAULT true | 是否啟用 |
| notes | TEXT | - | NULLABLE | 備註 |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | 建立者 |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | 最後更新者 |
| created_at | TIMESTAMP | - | NOT NULL | 建立時間 |
| updated_at | TIMESTAMP | - | NOT NULL | 更新時間 |

**ENUM 定義**
- `account_type`: ['asset', 'liability', 'equity', 'revenue', 'expense']
- `debit_credit`: ['debit', 'credit']

**索引設計**
- PRIMARY KEY: `id`
- UNIQUE KEY: `account_code`
- INDEX: `main_category_id`
- INDEX: `sub_category_id`
- INDEX: `parent_id`
- INDEX: `account_type`
- INDEX: `is_active`
- INDEX: `level`

### 4. 會計科目審計日誌資料表 (account_audit_logs)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | 主鍵 |
| auditable_type | VARCHAR | 255 | NOT NULL | 異動表格類型 |
| auditable_id | BIGINT | - | NOT NULL | 異動記錄ID |
| event | VARCHAR | 50 | NOT NULL | 操作類型 (created/updated/deleted) |
| old_values | JSON | - | NULLABLE | 異動前的值 |
| new_values | JSON | - | NULLABLE | 異動後的值 |
| user_id | BIGINT | - | FOREIGN KEY (users.id) | 操作使用者 |
| ip_address | VARCHAR | 45 | NULLABLE | 操作IP位址 |
| user_agent | TEXT | - | NULLABLE | 使用者代理 |
| url | VARCHAR | 500 | NULLABLE | 操作URL |
| created_at | TIMESTAMP | - | NOT NULL | 操作時間 |

**索引設計**
- PRIMARY KEY: `id`
- INDEX: `auditable_type, auditable_id`
- INDEX: `user_id`
- INDEX: `created_at`

### 外鍵約束關係

```sql
-- 子分類表外鍵約束
ALTER TABLE account_sub_categories
    ADD CONSTRAINT fk_sub_categories_main_category
    FOREIGN KEY (main_category_id) REFERENCES account_main_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE;

-- 明細表外鍵約束
ALTER TABLE account_details
    ADD CONSTRAINT fk_details_main_category
    FOREIGN KEY (main_category_id) REFERENCES account_main_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_details_sub_category
    FOREIGN KEY (sub_category_id) REFERENCES account_sub_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_details_parent
    FOREIGN KEY (parent_id) REFERENCES account_details(id)
    ON DELETE SET NULL ON UPDATE CASCADE;

-- 使用者關聯外鍵約束
ALTER TABLE account_main_categories
    ADD CONSTRAINT fk_main_categories_created_by
    FOREIGN KEY (created_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE,
    ADD CONSTRAINT fk_main_categories_updated_by
    FOREIGN KEY (updated_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE;

-- 其他表格的使用者關聯約束類似...
```

### 資料庫設計要點

#### 編碼規則設計
- **總類編碼**：1位數字 (1-9)，如：1=資產、2=負債、3=權益、4=收入、5=費用
- **子分類編碼**：2位數字 (01-99)，如：11=流動資產、12=非流動資產
- **明細編碼**：完整編碼，如：1101001=現金及約當現金

#### 數據完整性保障
- 使用外鍵約束確保參照完整性
- 使用唯一索引防止重複編碼
- 使用 CHECK 約束確保編碼格式正確
- 軟刪除機制保護關聯資料

#### 效能最佳化考量
- 針對常用查詢條件建立複合索引
- 使用適當的資料型態減少儲存空間
- 考慮讀寫分離的資料庫架構

---

## ⚙️ 技術架構設計

### 後端架構設計

#### 控制器架構 (Controllers)

系統採用 Laravel 的 RESTful 控制器模式，每個主要功能模組對應一個控制器：

```php
// 控制器結構
app/Http/Controllers/Admin/
├── AccountMainCategoryController.php     // 會計科目總類管理
├── AccountSubCategoryController.php      // 會計科目子分類管理
├── AccountDetailController.php           // 會計科目明細管理
├── AccountImportExportController.php     // 匯入匯出功能
└── AccountAuditLogController.php         // 審計日誌查看
```

**控制器設計模式**
```php
<?php
class AccountMainCategoryController extends Controller
{
    // 標準 RESTful 方法
    public function index()     // 列表頁面
    public function create()    // 新增頁面
    public function store()     // 儲存新增
    public function show($id)   // 詳細頁面
    public function edit($id)   // 編輯頁面
    public function update($id) // 儲存更新
    public function destroy($id)// 刪除操作

    // 自定義方法
    public function export()    // 匯出功能
    public function import()    // 匯入功能
    public function toggleStatus($id) // 啟用/停用
}
```

#### 模型架構 (Models)

**模型設計原則**
- 使用 Eloquent ORM 實現資料操作
- 實現模型間的關聯關係
- 整合審計日誌功能
- 實現軟刪除機制

```php
// 模型結構
app/Models/
├── AccountMainCategory.php
├── AccountSubCategory.php
├── AccountDetail.php
└── AccountAuditLog.php
```

**模型關聯設計**
```php
// AccountMainCategory.php
class AccountMainCategory extends Model
{
    use HasFactory, SoftDeletes, LogsActivity;

    protected $fillable = [
        'category_code', 'category_name', 'description',
        'sort_order', 'is_active'
    ];

    // 關聯關係
    public function subCategories()
    {
        return $this->hasMany(AccountSubCategory::class, 'main_category_id');
    }

    public function accountDetails()
    {
        return $this->hasManyThrough(
            AccountDetail::class,
            AccountSubCategory::class,
            'main_category_id',
            'sub_category_id'
        );
    }
}

// AccountSubCategory.php
class AccountSubCategory extends Model
{
    public function mainCategory()
    {
        return $this->belongsTo(AccountMainCategory::class, 'main_category_id');
    }

    public function accountDetails()
    {
        return $this->hasMany(AccountDetail::class, 'sub_category_id');
    }
}

// AccountDetail.php
class AccountDetail extends Model
{
    public function mainCategory()
    {
        return $this->belongsTo(AccountMainCategory::class, 'main_category_id');
    }

    public function subCategory()
    {
        return $this->belongsTo(AccountSubCategory::class, 'sub_category_id');
    }

    public function parent()
    {
        return $this->belongsTo(AccountDetail::class, 'parent_id');
    }

    public function children()
    {
        return $this->hasMany(AccountDetail::class, 'parent_id');
    }
}
```

#### 路由設計 (Routes)

**路由結構**
```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth', 'permission:manage accounts'])->group(function () {

    // 會計科目總類管理
    Route::resource('account-main-categories', AccountMainCategoryController::class);
    Route::put('account-main-categories/{category}/toggle-status',
        [AccountMainCategoryController::class, 'toggleStatus'])->name('account-main-categories.toggle-status');

    // 會計科目子分類管理
    Route::resource('account-sub-categories', AccountSubCategoryController::class);
    Route::put('account-sub-categories/{category}/toggle-status',
        [AccountSubCategoryController::class, 'toggleStatus'])->name('account-sub-categories.toggle-status');

    // 會計科目明細管理 (位於 accounts 群組中)
    Route::get('details/export', [AccountDetailController::class, 'export'])->name('account.details.export');
    Route::post('details/import', [AccountDetailController::class, 'import'])->name('account.details.import');
    Route::get('details/template', [AccountDetailController::class, 'template'])->name('account.details.template');
    Route::put('details/{detail}/toggle-status', [AccountDetailController::class, 'toggleStatus'])->name('details.toggle-status');
    // 會計科目明細 CRUD 路由
    Route::get('details', [AccountDetailController::class, 'index'])->name('account.details.index');
    Route::get('details/create', [AccountDetailController::class, 'create'])->name('account.details.create');
    Route::post('details', [AccountDetailController::class, 'store'])->name('account.details.store');
    Route::get('details/{detail}', [AccountDetailController::class, 'show'])->name('account.details.show');
    Route::get('details/{detail}/edit', [AccountDetailController::class, 'edit'])->name('account.details.edit');
    Route::put('details/{detail}', [AccountDetailController::class, 'update'])->name('account.details.update');
    Route::delete('details/{detail}', [AccountDetailController::class, 'destroy'])->name('account.details.destroy');

    // API 路由 (位於 accounts 群組中)
    Route::prefix('api')->name('api.')->group(function () {
        Route::get('sub-categories/by-main/{mainId}', [AccountDetailController::class, 'getSubCategories'])->name('sub-categories.by-main');
        Route::get('details/validate-code', [AccountDetailController::class, 'validateCode'])->name('details.validate-code');
        Route::get('details/next-code', [AccountDetailController::class, 'getNextCode'])->name('details.next-code');
    });

    // 審計日誌
    Route::get('account-audit-logs', [AccountAuditLogController::class, 'index'])->name('account-audit-logs.index');
});
```

#### 請求驗證 (Form Requests)

**驗證類別結構**
```php
// app/Http/Requests/
├── AccountMainCategoryRequest.php
├── AccountSubCategoryRequest.php
├── AccountDetailRequest.php
└── AccountImportRequest.php
```

**驗證規則範例**
```php
// AccountDetailRequest.php
class AccountDetailRequest extends FormRequest
{
    public function rules()
    {
        $accountId = $this->route('account_detail');

        return [
            'main_category_id' => 'required|exists:account_main_categories,id',
            'sub_category_id' => 'required|exists:account_sub_categories,id',
            'account_code' => [
                'required',
                'string',
                'max:20',
                'regex:/^[0-9]+$/',
                Rule::unique('account_details')->ignore($accountId)
            ],
            'account_name' => 'required|string|max:150',
            'account_name_en' => 'nullable|string|max:150',
            'account_type' => 'required|in:asset,liability,equity,revenue,expense',
            'debit_credit' => 'required|in:debit,credit',
            'parent_id' => 'nullable|exists:account_details,id',
            'description' => 'nullable|string',
            'notes' => 'nullable|string',
        ];
    }

    public function messages()
    {
        return [
            'account_code.regex' => '科目編號只能包含數字',
            'account_code.unique' => '科目編號已存在',
            // 其他錯誤訊息...
        ];
    }
}
```

#### 服務層設計 (Services)

**服務類別架構**
```php
// app/Services/
├── AccountCodeService.php        // 科目編碼邏輯
├── AccountImportService.php      // 匯入處理
├── AccountExportService.php      // 匯出處理
└── AccountValidationService.php  // 業務驗證
```

**服務層範例**
```php
// AccountCodeService.php
class AccountCodeService
{
    public function generateNextCode($mainCategoryCode, $subCategoryCode)
    {
        // 產生下一個可用的科目編號
    }

    public function validateCodeFormat($code)
    {
        // 驗證編號格式是否正確
    }

    public function parseCodeStructure($code)
    {
        // 解析編號結構
    }
}
```

### 中介軟體設計

**自定義中介軟體**
```php
// app/Http/Middleware/
├── CheckAccountPermission.php    // 檢查會計權限
├── ValidateAccountAccess.php     // 驗證科目存取權限
└── LogAccountActivity.php        // 記錄科目操作日誌
```

### 前端架構設計

#### Vue 組件架構

**組件結構規劃**
```
resources/js/Pages/Admin/Accounts/
├── MainCategories/
│   ├── Index.vue                 // 總類列表頁面
│   ├── Create.vue               // 新增總類頁面
│   ├── Edit.vue                 // 編輯總類頁面
│   └── Show.vue                 // 總類詳細頁面
├── SubCategories/
│   ├── Index.vue                // 子分類列表頁面
│   ├── Create.vue               // 新增子分類頁面
│   ├── Edit.vue                 // 編輯子分類頁面
│   └── Show.vue                 // 子分類詳細頁面
├── Details/
│   ├── Index.vue                // 科目明細列表頁面
│   ├── Create.vue               // 新增科目明細頁面
│   ├── Edit.vue                 // 編輯科目明細頁面
│   ├── Show.vue                 // 科目明細詳細頁面
│   └── Import.vue               // 批量匯入頁面
└── Components/
    ├── AccountCodeInput.vue     // 科目編號輸入組件
    ├── AccountSelector.vue      // 科目選擇器組件
    ├── AccountTree.vue          // 科目樹狀結構組件
    ├── ImportModal.vue          // 匯入對話框組件
    └── AuditLogModal.vue        // 審計日誌查看組件
```

**核心組件設計**

**1. 科目明細列表組件 (Details/Index.vue)**
```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <div class="content-wrapper">
      <!-- 頁面標題與操作按鈕 -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>會計科目管理</h1>
            </div>
            <div class="col-sm-6">
              <div class="float-right">
                <Link :href="route('admin.accounts.account.details.create')"
                      class="btn btn-primary">
                  <i class="bi bi-plus"></i> 新增科目
                </Link>
                <button @click="showImportModal" class="btn btn-success ms-2">
                  <i class="bi bi-upload"></i> 匯入
                </button>
                <a :href="route('admin.accounts.account.details.export')"
                   class="btn btn-info ms-2">
                  <i class="bi bi-download"></i> 匯出
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 搜尋與篩選 -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">搜尋篩選</h3>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label>總類</label>
                      <select v-model="filters.main_category_id"
                              class="form-select">
                        <option value="">全部總類</option>
                        <option v-for="category in mainCategories"
                                :key="category.id"
                                :value="category.id">
                          {{ category.category_name }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label>子分類</label>
                      <select v-model="filters.sub_category_id"
                              class="form-select">
                        <option value="">全部子分類</option>
                        <option v-for="subCategory in subCategories"
                                :key="subCategory.id"
                                :value="subCategory.id">
                          {{ subCategory.sub_category_name }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label>科目編號/名稱</label>
                      <input v-model="filters.search"
                             type="text"
                             class="form-control"
                             placeholder="輸入關鍵字">
                    </div>
                    <div class="col-md-3">
                      <label>狀態</label>
                      <select v-model="filters.is_active" class="form-select">
                        <option value="">全部狀態</option>
                        <option value="1">啟用</option>
                        <option value="0">停用</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <button @click="applyFilters" class="btn btn-primary">
                        <i class="bi bi-search"></i> 搜尋
                      </button>
                      <button @click="resetFilters" class="btn btn-secondary ms-2">
                        <i class="bi bi-arrow-clockwise"></i> 重設
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 科目列表 -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">科目列表</h3>
                </div>
                <div class="card-body table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>科目編號</th>
                        <th>科目名稱</th>
                        <th>總類</th>
                        <th>子分類</th>
                        <th>科目性質</th>
                        <th>借貸性質</th>
                        <th>狀態</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="account in accounts.data" :key="account.id">
                        <td>{{ account.account_code }}</td>
                        <td>{{ account.account_name }}</td>
                        <td>{{ account.main_category.category_name }}</td>
                        <td>{{ account.sub_category.sub_category_name }}</td>
                        <td>
                          <span class="badge"
                                :class="getAccountTypeBadge(account.account_type)">
                            {{ getAccountTypeText(account.account_type) }}
                          </span>
                        </td>
                        <td>
                          <span class="badge"
                                :class="account.debit_credit === 'debit' ? 'bg-info' : 'bg-warning'">
                            {{ account.debit_credit === 'debit' ? '借方' : '貸方' }}
                          </span>
                        </td>
                        <td>
                          <button @click="toggleStatus(account)"
                                  class="btn btn-sm"
                                  :class="account.is_active ? 'btn-success' : 'btn-secondary'">
                            {{ account.is_active ? '啟用' : '停用' }}
                          </button>
                        </td>
                        <td>
                          <div class="btn-group">
                            <Link :href="route('admin.accounts.account.details.show', { detail: account.id })"
                                  class="btn btn-sm btn-info">
                              <i class="bi bi-eye"></i>
                            </Link>
                            <Link :href="route('admin.accounts.account.details.edit', { detail: account.id })"
                                  class="btn btn-sm btn-warning">
                              <i class="bi bi-pencil"></i>
                            </Link>
                            <button @click="deleteAccount(account)"
                                    class="btn btn-sm btn-danger">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="card-footer">
                  <Pagination :links="accounts.links" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 匯入模態框 -->
    <ImportModal v-if="showImport"
                 @close="showImport = false"
                 @imported="handleImported" />
  </AdminLayout>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue'
import { router, usePage, Link } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import ImportModal from '../Components/ImportModal.vue'
import Pagination from '@/Components/Pagination.vue'

const props = defineProps({
  accounts: Object,
  mainCategories: Array,
  subCategories: Array,
  filters: Object
})

const showImport = ref(false)

const filters = reactive({
  main_category_id: props.filters?.main_category_id || '',
  sub_category_id: props.filters?.sub_category_id || '',
  search: props.filters?.search || '',
  is_active: props.filters?.is_active || ''
})

// 監聽總類變更，自動更新子分類選項
watch(() => filters.main_category_id, (newValue) => {
  if (newValue) {
    // 載入對應的子分類
    router.get(route('admin.api.account-sub-categories.by-main', newValue), {}, {
      preserveState: true,
      preserveScroll: true,
      only: ['subCategories']
    })
  }
})

const applyFilters = () => {
  router.get(route('admin.accounts.account.details.index'), filters, {
    preserveState: true,
    preserveScroll: true
  })
}

const resetFilters = () => {
  Object.keys(filters).forEach(key => filters[key] = '')
  applyFilters()
}

const showImportModal = () => {
  showImport.value = true
}

const handleImported = () => {
  showImport.value = false
  router.reload({ only: ['accounts'] })
}

const toggleStatus = (account) => {
  router.put(route('admin.accounts.details.toggle-status', { detail: account.id }), {}, {
    preserveState: true,
    onSuccess: () => {
      // 更新狀態成功
    }
  })
}

const deleteAccount = (account) => {
  if (confirm('確定要刪除此會計科目嗎？')) {
    router.delete(route('admin.accounts.account.details.destroy', { detail: account.id }), {
      preserveState: true
    })
  }
}

const getAccountTypeBadge = (type) => {
  const badges = {
    asset: 'bg-primary',
    liability: 'bg-danger',
    equity: 'bg-success',
    revenue: 'bg-info',
    expense: 'bg-warning'
  }
  return badges[type] || 'bg-secondary'
}

const getAccountTypeText = (type) => {
  const texts = {
    asset: '資產',
    liability: '負債',
    equity: '權益',
    revenue: '收入',
    expense: '費用'
  }
  return texts[type] || type
}
</script>
```

**2. 科目編號輸入組件 (Components/AccountCodeInput.vue)**
```vue
<template>
  <div class="form-group">
    <label :for="inputId">{{ label }}</label>
    <div class="input-group">
      <input :id="inputId"
             v-model="localValue"
             type="text"
             class="form-control"
             :class="{ 'is-invalid': hasError }"
             :placeholder="placeholder"
             @input="handleInput"
             @blur="validateCode">
      <button v-if="showGenerator"
              @click="generateNextCode"
              class="btn btn-outline-secondary"
              type="button">
        <i class="bi bi-gear"></i>
      </button>
    </div>
    <div v-if="hasError" class="invalid-feedback">
      {{ errorMessage }}
    </div>
    <small v-if="hint" class="form-text text-muted">
      {{ hint }}
    </small>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { router } from '@inertiajs/vue3'

const props = defineProps({
  modelValue: String,
  label: {
    type: String,
    default: '科目編號'
  },
  placeholder: {
    type: String,
    default: '請輸入科目編號'
  },
  mainCategoryId: Number,
  subCategoryId: Number,
  showGenerator: {
    type: Boolean,
    default: true
  },
  hint: String,
  inputId: {
    type: String,
    default: 'account_code'
  }
})

const emit = defineEmits(['update:modelValue', 'validated'])

const localValue = ref(props.modelValue)
const errorMessage = ref('')
const isValidating = ref(false)

const hasError = computed(() => errorMessage.value !== '')

watch(() => props.modelValue, (newValue) => {
  localValue.value = newValue
})

const handleInput = () => {
  emit('update:modelValue', localValue.value)
  // 清除錯誤訊息
  if (errorMessage.value) {
    errorMessage.value = ''
  }
}

const validateCode = async () => {
  if (!localValue.value) return

  isValidating.value = true

  try {
    const response = await axios.get(route('admin.api.account-details.validate-code'), {
      params: {
        code: localValue.value,
        main_category_id: props.mainCategoryId,
        sub_category_id: props.subCategoryId
      }
    })

    if (!response.data.valid) {
      errorMessage.value = response.data.message || '科目編號不可用'
    } else {
      errorMessage.value = ''
    }

    emit('validated', {
      valid: response.data.valid,
      message: response.data.message
    })
  } catch (error) {
    errorMessage.value = '驗證失敗，請重試'
  } finally {
    isValidating.value = false
  }
}

const generateNextCode = async () => {
  if (!props.mainCategoryId || !props.subCategoryId) {
    alert('請先選擇總類和子分類')
    return
  }

  try {
    const response = await axios.get(route('admin.api.account-details.next-code'), {
      params: {
        main_category_id: props.mainCategoryId,
        sub_category_id: props.subCategoryId
      }
    })

    localValue.value = response.data.code
    emit('update:modelValue', localValue.value)
  } catch (error) {
    alert('產生編號失敗，請重試')
  }
}
</script>
```

#### UI/UX 設計原則

**設計原則**
1. **一致性**：遵循 AdminLTE 4 的設計風格和組件規範
2. **易用性**：提供直觀的操作流程和清晰的視覺回饋
3. **響應式**：支援桌面和行動裝置的最佳瀏覽體驗
4. **可訪問性**：遵循 WCAG 2.1 無障礙設計準則

**色彩配置**
- **主色調**：延用 AdminLTE 的藍色系 (#007bff)
- **功能色彩**：
  - 成功：綠色 (#28a745)
  - 警告：橙色 (#ffc107)
  - 危險：紅色 (#dc3545)
  - 資訊：淺藍 (#17a2b8)

**圖示系統**
- 使用 Bootstrap Icons 圖示庫
- 保持圖示使用的一致性和語義化

---

## 🔌 API 設計

### RESTful API 端點定義

#### 1. 會計科目總類 API

| HTTP方法 | 端點 | 描述 | 權限 |
|---------|------|------|------|
| GET | `/admin/account-main-categories` | 取得總類列表 | manage accounts |
| GET | `/admin/account-main-categories/create` | 取得新增頁面 | manage accounts |
| POST | `/admin/account-main-categories` | 建立新總類 | manage accounts |
| GET | `/admin/account-main-categories/{id}` | 取得總類詳細 | manage accounts |
| GET | `/admin/account-main-categories/{id}/edit` | 取得編輯頁面 | manage accounts |
| PUT/PATCH | `/admin/account-main-categories/{id}` | 更新總類 | manage accounts |
| DELETE | `/admin/account-main-categories/{id}` | 刪除總類 | manage accounts |
| PUT | `/admin/account-main-categories/{id}/toggle-status` | 切換狀態 | manage accounts |

**API 回應格式範例**
```json
{
  "data": {
    "id": 1,
    "category_code": "1",
    "category_name": "資產",
    "description": "包含所有資產相關科目",
    "sort_order": 1,
    "is_active": true,
    "sub_categories_count": 5,
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### 2. 會計科目子分類 API

| HTTP方法 | 端點 | 描述 | 權限 |
|---------|------|------|------|
| GET | `/admin/account-sub-categories` | 取得子分類列表 | manage accounts |
| POST | `/admin/account-sub-categories` | 建立新子分類 | manage accounts |
| GET | `/admin/account-sub-categories/{id}` | 取得子分類詳細 | manage accounts |
| PUT/PATCH | `/admin/account-sub-categories/{id}` | 更新子分類 | manage accounts |
| DELETE | `/admin/account-sub-categories/{id}` | 刪除子分類 | manage accounts |
| GET | `/admin/api/account-sub-categories/by-main/{mainId}` | 依總類取得子分類 | manage accounts |

#### 3. 會計科目明細 API

| HTTP方法 | 端點 | 描述 | 權限 |
|---------|------|------|------|
| GET | `/admin/account-details` | 取得科目列表 | manage accounts |
| POST | `/admin/account-details` | 建立新科目 | manage accounts |
| GET | `/admin/account-details/{id}` | 取得科目詳細 | manage accounts |
| PUT/PATCH | `/admin/account-details/{id}` | 更新科目 | manage accounts |
| DELETE | `/admin/account-details/{id}` | 刪除科目 | manage accounts |
| GET | `/admin/account-details/export` | 匯出科目資料 | manage accounts |
| POST | `/admin/account-details/import` | 匯入科目資料 | manage accounts |
| GET | `/admin/account-details/template` | 下載匯入範本 | manage accounts |

#### 4. 輔助 API 端點

| HTTP方法 | 端點 | 描述 | 權限 |
|---------|------|------|------|
| GET | `/admin/api/account-details/validate-code` | 驗證科目編號 | manage accounts |
| GET | `/admin/api/account-details/next-code` | 取得下一個可用編號 | manage accounts |
| GET | `/admin/api/account-main-categories/options` | 取得總類選項 | manage accounts |
| GET | `/admin/account-audit-logs` | 取得審計日誌 | view audit logs |

### API 請求與回應規範

#### 標準回應格式
```json
{
  "success": true,
  "message": "操作成功",
  "data": {},
  "meta": {
    "current_page": 1,
    "total": 100,
    "per_page": 15
  }
}
```

#### 錯誤回應格式
```json
{
  "success": false,
  "message": "驗證失敗",
  "errors": {
    "account_code": ["科目編號已存在"],
    "account_name": ["科目名稱為必填欄位"]
  },
  "error_code": "VALIDATION_ERROR"
}
```

---

## 🔐 權限管理

### Spatie Permission 整合

#### 權限定義
```php
// database/seeders/PermissionSeeder.php
$permissions = [
    // 會計科目權限
    'view accounts',              // 檢視會計科目
    'create accounts',            // 建立會計科目
    'edit accounts',              // 編輯會計科目
    'delete accounts',            // 刪除會計科目
    'manage accounts',            // 完整管理會計科目
    'import accounts',            // 匯入會計科目
    'export accounts',            // 匯出會計科目
    'view audit logs',            // 查看審計日誌
];
```

#### 角色配置
```php
// 會計主管角色
$accountingManager = Role::create(['name' => 'accounting_manager']);
$accountingManager->givePermissionTo([
    'manage accounts',
    'import accounts',
    'export accounts',
    'view audit logs'
]);

// 會計人員角色
$accountingStaff = Role::create(['name' => 'accounting_staff']);
$accountingStaff->givePermissionTo([
    'view accounts',
    'create accounts',
    'edit accounts'
]);
```

#### 中介軟體保護
```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {

    // 需要會計科目管理權限
    Route::middleware('permission:manage accounts')->group(function () {
        Route::resource('account-main-categories', AccountMainCategoryController::class);
        Route::resource('account-sub-categories', AccountSubCategoryController::class);
        Route::resource('account-details', AccountDetailController::class);
    });

    // 需要匯入權限
    Route::middleware('permission:import accounts')->group(function () {
        Route::post('account-details/import', [AccountDetailController::class, 'import']);
    });

    // 需要審計日誌查看權限
    Route::middleware('permission:view audit logs')->group(function () {
        Route::get('account-audit-logs', [AccountAuditLogController::class, 'index']);
    });
});
```

---

## ✅ 驗證規則與業務邏輯

### 資料驗證規則

#### 會計科目總類驗證
```php
public function rules()
{
    return [
        'category_code' => 'required|string|max:10|unique:account_main_categories,category_code,' . $this->id,
        'category_name' => 'required|string|max:100',
        'description' => 'nullable|string|max:500',
        'sort_order' => 'nullable|integer|min:0',
    ];
}
```

#### 會計科目明細驗證
```php
public function rules()
{
    return [
        'main_category_id' => 'required|exists:account_main_categories,id',
        'sub_category_id' => 'required|exists:account_sub_categories,id',
        'account_code' => [
            'required',
            'string',
            'max:20',
            'regex:/^[0-9]+$/',
            Rule::unique('account_details')->ignore($this->id)
        ],
        'account_name' => 'required|string|max:150',
        'account_type' => 'required|in:asset,liability,equity,revenue,expense',
        'debit_credit' => 'required|in:debit,credit',
    ];
}
```

### 業務邏輯規則

#### 科目編號生成邏輯
```php
class AccountCodeService
{
    public function generateNextCode($mainCategoryCode, $subCategoryCode)
    {
        // 1. 組合基礎代碼 (總類 + 子分類)
        $baseCode = $mainCategoryCode . $subCategoryCode;

        // 2. 查找最大的序號
        $maxCode = AccountDetail::where('account_code', 'LIKE', $baseCode . '%')
            ->orderBy('account_code', 'desc')
            ->value('account_code');

        if (!$maxCode) {
            return $baseCode . '001'; // 第一個編號
        }

        // 3. 取得序號部分並遞增
        $sequence = intval(substr($maxCode, strlen($baseCode))) + 1;

        return $baseCode . str_pad($sequence, 3, '0', STR_PAD_LEFT);
    }
}
```

#### 刪除業務規則
```php
public function destroy($id)
{
    $account = AccountDetail::findOrFail($id);

    // 檢查是否有子科目
    if ($account->children()->count() > 0) {
        return response()->json([
            'success' => false,
            'message' => '此科目底下還有子科目，無法刪除'
        ], 400);
    }

    // 檢查是否已有交易紀錄 (未來與帳務系統整合時)
    // if ($this->hasTransactions($account)) {
    //     return response()->json([
    //         'success' => false,
    //         'message' => '此科目已有交易紀錄，無法刪除'
    //     ], 400);
    // }

    $account->delete();

    return response()->json([
        'success' => true,
        'message' => '刪除成功'
    ]);
}
```

---

## ⏱️ 開發時程與測試計畫

### 開發階段規劃

#### 第一階段：基礎架構建立 (1-2週)
- [ ] 資料庫遷移檔案建立
- [ ] 模型與關聯關係建立
- [ ] 基礎控制器架構
- [ ] 路由設定
- [ ] 權限系統整合

#### 第二階段：核心功能開發 (2-3週)
- [ ] 會計科目總類 CRUD 功能
- [ ] 會計科目子分類 CRUD 功能
- [ ] 會計科目明細 CRUD 功能
- [ ] 科目編號自動產生邏輯
- [ ] 基本驗證規則實作

#### 第三階段：進階功能開發 (2-3週)
- [ ] 前端 Vue 組件開發
- [ ] 搜尋與篩選功能
- [ ] 匯入匯出功能
- [ ] 審計日誌功能
- [ ] API 端點完善

#### 第四階段：測試與優化 (1-2週)
- [ ] 單元測試編寫
- [ ] 功能測試編寫
- [ ] 效能測試與優化
- [ ] 使用者體驗優化
- [ ] 安全性檢查

### 測試計畫

#### 單元測試
```php
// tests/Unit/AccountCodeServiceTest.php
class AccountCodeServiceTest extends TestCase
{
    public function test_generate_first_account_code()
    {
        $service = new AccountCodeService();
        $code = $service->generateNextCode('1', '01');
        $this->assertEquals('101001', $code);
    }

    public function test_generate_next_account_code()
    {
        AccountDetail::factory()->create(['account_code' => '101001']);

        $service = new AccountCodeService();
        $code = $service->generateNextCode('1', '01');
        $this->assertEquals('101002', $code);
    }
}
```

#### 功能測試
```php
// tests/Feature/AccountManagementTest.php
class AccountManagementTest extends TestCase
{
    public function test_user_can_view_account_list()
    {
        $user = User::factory()->create();
        $user->givePermissionTo('view accounts');

        $response = $this->actingAs($user)
            ->get(route('admin.accounts.account.details.index'));

        $response->assertStatus(200);
    }
}
```

---

## 📝 附錄

### 實作檢核清單
- [ ] 資料庫遷移檔案完成
- [ ] 模型關聯關係正確
- [ ] 控制器 RESTful 實作
- [ ] 前端 Vue 組件完成
- [ ] API 端點測試通過
- [ ] 權限控制正確實作
- [ ] 驗證規則完整
- [ ] 審計日誌功能正常
- [ ] 匯入匯出功能測試
- [ ] 單元測試覆蓋率 >80%
- [ ] 功能測試通過
- [ ] 效能測試達標
- [ ] 安全性檢查通過
- [ ] 使用者文件完成

### 注意事項與建議
1. **編碼一致性**：確保科目編號的格式在整個系統中保持一致
2. **效能考量**：對於大量科目資料，考慮實作快取機制
3. **資料完整性**：實作完整的外鍵約束和驗證邏輯
4. **使用者體驗**：提供清晰的錯誤訊息和操作回饋
5. **擴展性**：設計時考慮未來與其他財務模組的整合需求
6. **備份策略**：定期備份重要的會計科目資料
7. **版本控制**：對重要的科目變更進行版本記錄

## 實作中發現的問題與修正

### 1. Laravel 路由模型繫結問題
**問題**：控制器方法參數名稱與路由參數不匹配導致模型繫結失敗
```php
// 錯誤寫法
Route::get('details/{detail}', [AccountDetailController::class, 'show']);
public function show(AccountDetail $accountDetail) // 參數名稱不匹配

// 正確寫法
Route::get('details/{detail}', [AccountDetailController::class, 'show']);
public function show(AccountDetail $detail) // 參數名稱必須匹配路由
```

**修正**：確保所有控制器方法的參數名稱與路由參數一致：
- `show(AccountDetail $detail)`
- `edit(AccountDetail $detail)`
- `update(AccountDetailRequest $request, AccountDetail $detail)`
- `destroy(AccountDetail $detail)`
- `toggleStatus(AccountDetail $detail)`

### 2. Vue.js Props 資料初始化問題
**問題**：Edit.vue 和 Show.vue 中的表單資料無法正確載入

**解決方案**：
```javascript
// Edit.vue - 正確的資料初始化
watchEffect(async () => {
  if (!props.account) return

  // 設置表單資料
  Object.assign(form, {
    main_category_id: props.account.main_category_id || '',
    sub_category_id: props.account.sub_category_id || '',
    // ... 其他欄位
  })

  // 載入子分類
  if (form.main_category_id && subCategories.value.length === 0) {
    await fetchSubCategories(form.main_category_id)
  }
})

// Show.vue - 正確的 props 定義
const props = defineProps({
  account: { type: Object, required: true }
})
const { account } = props
```

### 3. 路由群組結構修正
**實際實作結構**：所有會計相關路由都放在 `admin.accounts` 群組下
```php
Route::prefix('admin')->name('admin.')->group(function () {
    Route::prefix('accounts')->name('accounts.')->middleware('permission:view accounts')->group(function () {
        // 總類管理: admin.accounts.main-categories.*
        // 子分類管理: admin.accounts.sub-categories.*
        // 科目明細管理: admin.accounts.account.details.*

        // API 路由: admin.accounts.api.*
        Route::prefix('api')->name('api.')->group(function () {
            Route::get('sub-categories/by-main/{mainId}', [...]);
            Route::get('details/validate-code', [...]);
            Route::get('details/next-code', [...]);
        });
    });
});
```

### 4. 前端路由引用修正
將所有前端路由引用從 `admin.account-details.*` 修正為 `admin.accounts.account.details.*`：

```javascript
// 修正前
route('admin.account-details.show', account.id)

// 修正後
route('admin.accounts.account.details.show', { detail: account.id })
```

---

**文件版本**：1.1
**最後更新**：2025年9月28日
**文件狀態**：已修正實作問題
