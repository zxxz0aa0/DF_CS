# æœƒè¨ˆç§‘ç›®ç®¡ç†ç³»çµ±é–‹ç™¼è¦åŠƒæ–‡ä»¶

æ­¤æ–‡ä»¶ç‚ºè‡ªè¨‚æœƒè¨ˆç§‘ç›®ç®¡ç†ç³»çµ±çš„å®Œæ•´é–‹ç™¼è¦åŠƒæ–‡ä»¶ï¼Œè©³ç´°è¨˜éŒ„å°ˆæ¡ˆèƒŒæ™¯ã€éœ€æ±‚åˆ†æã€æŠ€è¡“æ¶æ§‹ã€è³‡æ–™åº«è¨­è¨ˆã€API è¨­è¨ˆã€å‰ç«¯ä»‹é¢è¨­è¨ˆã€æ¬Šé™ç®¡ç†ã€é–‹ç™¼æ™‚ç¨‹ç­‰å®Œæ•´é–‹ç™¼è—åœ–ã€‚

---

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

### ğŸ¯ å°ˆæ¡ˆèƒŒæ™¯
ä¼æ¥­é›†åœ˜éœ€è¦å»ºç«‹æ¨™æº–åŒ–çš„æœƒè¨ˆç§‘ç›®ç®¡ç†ç³»çµ±ï¼Œä»¥æ”¯æ´å¾ŒçºŒçš„è²¡å‹™ç®¡ç†å’Œå¸³å‹™è™•ç†ä½œæ¥­ã€‚ç³»çµ±æ‡‰å…·å‚™å½ˆæ€§åŒ–çš„ç§‘ç›®åˆ†é¡æ¶æ§‹ï¼Œæ”¯æ´å¤šå±¤ç´šçš„æœƒè¨ˆç§‘ç›®ç®¡ç†ï¼Œä¸¦æ•´åˆç¾æœ‰çš„ä¼æ¥­ç®¡ç†ç³»çµ±æ¶æ§‹ã€‚

### ğŸ¯ å°ˆæ¡ˆç›®æ¨™
- **ä¸»è¦ç›®æ¨™**ï¼šå»ºç«‹å®Œæ•´çš„æœƒè¨ˆç§‘ç›®ç®¡ç†ç³»çµ±
- **æ ¸å¿ƒåŠŸèƒ½**ï¼šæœƒè¨ˆç§‘ç›®çš„å»ºç«‹ã€åˆ†é¡ã€ç®¡ç†å’Œç¶­è­·
- **ç³»çµ±æ•´åˆ**ï¼šæ•´åˆç¾æœ‰çš„ AdminLTE 4 ç®¡ç†ä»‹é¢å’Œæ¬Šé™ç³»çµ±
- **è³‡æ–™ç®¡ç†**ï¼šæ”¯æ´æœƒè¨ˆç§‘ç›®çš„åŒ¯å…¥ã€åŒ¯å‡ºå’Œæ‰¹é‡è™•ç†
- **ä½¿ç”¨è€…é«”é©—**ï¼šæä¾›ç›´è§€æ˜“ç”¨çš„ç®¡ç†ä»‹é¢

### ğŸ¯ å°ˆæ¡ˆç¯„åœ

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„
- **æœƒè¨ˆç§‘ç›®ç¸½é¡ç®¡ç†**ï¼šç®¡ç†æœƒè¨ˆç§‘ç›®çš„ä¸»è¦åˆ†é¡
- **æœƒè¨ˆç§‘ç›®å­åˆ†é¡ç®¡ç†**ï¼šç®¡ç†ç´°åˆ†çš„æœƒè¨ˆç§‘ç›®é¡åˆ¥
- **æœƒè¨ˆç§‘ç›®æ˜ç´°ç®¡ç†**ï¼šç®¡ç†å…·é«”çš„æœƒè¨ˆç§‘ç›®é …ç›®
- **ç§‘ç›®ç·¨ç¢¼ç³»çµ±**ï¼šè‡ªå‹•åŒ–çš„ç§‘ç›®ç·¨è™Ÿç”Ÿæˆå’Œé©—è­‰
- **æœå°‹èˆ‡ç¯©é¸**ï¼šå¤šæ¢ä»¶æœå°‹å’Œé«˜ç´šç¯©é¸åŠŸèƒ½
- **è³‡æ–™åŒ¯å…¥åŒ¯å‡º**ï¼šExcel æ ¼å¼çš„æ‰¹é‡è™•ç†åŠŸèƒ½
- **å¯©è¨ˆæ—¥èªŒ**ï¼šå®Œæ•´çš„æ“ä½œè¨˜éŒ„å’Œè®Šæ›´è¿½è¹¤
- **æ¬Šé™ç®¡ç†**ï¼šåŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶

#### æŠ€è¡“ç¯„åœ
- **å¾Œç«¯é–‹ç™¼**ï¼šLaravel 11.x + PHP 8.4+
- **å‰ç«¯é–‹ç™¼**ï¼šVue 3 + Inertia.js + AdminLTE 4
- **è³‡æ–™åº«è¨­è¨ˆ**ï¼šSQLiteï¼ˆé–‹ç™¼ï¼‰/ MySQLï¼ˆæ­£å¼ï¼‰
- **æ¬Šé™ç®¡ç†**ï¼šæ•´åˆ Spatie Laravel Permission
- **æ¸¬è©¦è¦†è“‹**ï¼šå–®å…ƒæ¸¬è©¦å’ŒåŠŸèƒ½æ¸¬è©¦

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### è³‡æ–™è¡¨çµæ§‹æ¦‚è¦½

æœƒè¨ˆç§‘ç›®ç³»çµ±æ¡ç”¨ä¸‰å±¤æ¶æ§‹è¨­è¨ˆï¼š**ç¸½é¡ â†’ å­åˆ†é¡ â†’ æ˜ç´°ç§‘ç›®**

```
æœƒè¨ˆç§‘ç›®ç¸½é¡ (AccountMainCategories)
    â†“ (1:N)
æœƒè¨ˆç§‘ç›®å­åˆ†é¡ (AccountSubCategories)
    â†“ (1:N)
æœƒè¨ˆç§‘ç›®æ˜ç´° (AccountDetails)
```

### 1. æœƒè¨ˆç§‘ç›®ç¸½é¡è³‡æ–™è¡¨ (account_main_categories)

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | é•·åº¦ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | ä¸»éµ |
| category_code | VARCHAR | 10 | UNIQUE, NOT NULL | ç¸½é¡ç·¨è™Ÿï¼ˆå¦‚ï¼š1xxx, 2xxxï¼‰|
| category_name | VARCHAR | 100 | NOT NULL | ç¸½é¡åç¨± |
| description | TEXT | - | NULLABLE | ç¸½é¡æè¿° |
| sort_order | INTEGER | - | DEFAULT 0 | æ’åºé †åº |
| is_active | BOOLEAN | - | DEFAULT true | æ˜¯å¦å•Ÿç”¨ |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | å»ºç«‹è€… |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | æœ€å¾Œæ›´æ–°è€… |
| created_at | TIMESTAMP | - | NOT NULL | å»ºç«‹æ™‚é–“ |
| updated_at | TIMESTAMP | - | NOT NULL | æ›´æ–°æ™‚é–“ |

**ç´¢å¼•è¨­è¨ˆ**
- PRIMARY KEY: `id`
- UNIQUE KEY: `category_code`
- INDEX: `sort_order`
- INDEX: `is_active`

### 2. æœƒè¨ˆç§‘ç›®å­åˆ†é¡è³‡æ–™è¡¨ (account_sub_categories)

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | é•·åº¦ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | ä¸»éµ |
| main_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | ç¸½é¡å¤–éµ |
| sub_category_code | VARCHAR | 10 | NOT NULL | å­åˆ†é¡ç·¨è™Ÿï¼ˆå¦‚ï¼š11xx, 12xxï¼‰|
| sub_category_name | VARCHAR | 100 | NOT NULL | å­åˆ†é¡åç¨± |
| description | TEXT | - | NULLABLE | å­åˆ†é¡æè¿° |
| sort_order | INTEGER | - | DEFAULT 0 | æ’åºé †åº |
| is_active | BOOLEAN | - | DEFAULT true | æ˜¯å¦å•Ÿç”¨ |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | å»ºç«‹è€… |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | æœ€å¾Œæ›´æ–°è€… |
| created_at | TIMESTAMP | - | NOT NULL | å»ºç«‹æ™‚é–“ |
| updated_at | TIMESTAMP | - | NOT NULL | æ›´æ–°æ™‚é–“ |

**ç´¢å¼•è¨­è¨ˆ**
- PRIMARY KEY: `id`
- UNIQUE KEY: `main_category_id, sub_category_code`
- INDEX: `main_category_id`
- INDEX: `sort_order`
- INDEX: `is_active`

### 3. æœƒè¨ˆç§‘ç›®æ˜ç´°è³‡æ–™è¡¨ (account_details)

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | é•·åº¦ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | ä¸»éµ |
| main_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | ç¸½é¡å¤–éµ |
| sub_category_id | BIGINT | - | FOREIGN KEY, NOT NULL | å­åˆ†é¡å¤–éµ |
| account_code | VARCHAR | 20 | UNIQUE, NOT NULL | å®Œæ•´ç§‘ç›®ç·¨è™Ÿ |
| account_name | VARCHAR | 150 | NOT NULL | ç§‘ç›®åç¨± |
| account_name_en | VARCHAR | 150 | NULLABLE | è‹±æ–‡ç§‘ç›®åç¨± |
| description | TEXT | - | NULLABLE | ç§‘ç›®èªªæ˜ |
| account_type | ENUM | - | NOT NULL | ç§‘ç›®æ€§è³ªï¼ˆè³‡ç”¢/è² å‚µ/æ¬Šç›Š/æ”¶å…¥/è²»ç”¨ï¼‰|
| debit_credit | ENUM | - | NOT NULL | å€Ÿè²¸æ€§è³ªï¼ˆå€Ÿæ–¹/è²¸æ–¹ï¼‰|
| is_summary | BOOLEAN | - | DEFAULT false | æ˜¯å¦ç‚ºçµ±é¦­ç§‘ç›® |
| parent_id | BIGINT | - | FOREIGN KEY, NULLABLE | ä¸Šç´šç§‘ç›®ï¼ˆç”¨æ–¼å¤šå±¤çµæ§‹ï¼‰|
| level | INTEGER | - | DEFAULT 1 | ç§‘ç›®å±¤ç´š |
| sort_order | INTEGER | - | DEFAULT 0 | æ’åºé †åº |
| is_active | BOOLEAN | - | DEFAULT true | æ˜¯å¦å•Ÿç”¨ |
| notes | TEXT | - | NULLABLE | å‚™è¨» |
| created_by | BIGINT | - | FOREIGN KEY (users.id) | å»ºç«‹è€… |
| updated_by | BIGINT | - | FOREIGN KEY (users.id) | æœ€å¾Œæ›´æ–°è€… |
| created_at | TIMESTAMP | - | NOT NULL | å»ºç«‹æ™‚é–“ |
| updated_at | TIMESTAMP | - | NOT NULL | æ›´æ–°æ™‚é–“ |

**ENUM å®šç¾©**
- `account_type`: ['asset', 'liability', 'equity', 'revenue', 'expense']
- `debit_credit`: ['debit', 'credit']

**ç´¢å¼•è¨­è¨ˆ**
- PRIMARY KEY: `id`
- UNIQUE KEY: `account_code`
- INDEX: `main_category_id`
- INDEX: `sub_category_id`
- INDEX: `parent_id`
- INDEX: `account_type`
- INDEX: `is_active`
- INDEX: `level`

### 4. æœƒè¨ˆç§‘ç›®å¯©è¨ˆæ—¥èªŒè³‡æ–™è¡¨ (account_audit_logs)

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | é•·åº¦ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | ä¸»éµ |
| auditable_type | VARCHAR | 255 | NOT NULL | ç•°å‹•è¡¨æ ¼é¡å‹ |
| auditable_id | BIGINT | - | NOT NULL | ç•°å‹•è¨˜éŒ„ID |
| event | VARCHAR | 50 | NOT NULL | æ“ä½œé¡å‹ (created/updated/deleted) |
| old_values | JSON | - | NULLABLE | ç•°å‹•å‰çš„å€¼ |
| new_values | JSON | - | NULLABLE | ç•°å‹•å¾Œçš„å€¼ |
| user_id | BIGINT | - | FOREIGN KEY (users.id) | æ“ä½œä½¿ç”¨è€… |
| ip_address | VARCHAR | 45 | NULLABLE | æ“ä½œIPä½å€ |
| user_agent | TEXT | - | NULLABLE | ä½¿ç”¨è€…ä»£ç† |
| url | VARCHAR | 500 | NULLABLE | æ“ä½œURL |
| created_at | TIMESTAMP | - | NOT NULL | æ“ä½œæ™‚é–“ |

**ç´¢å¼•è¨­è¨ˆ**
- PRIMARY KEY: `id`
- INDEX: `auditable_type, auditable_id`
- INDEX: `user_id`
- INDEX: `created_at`

### å¤–éµç´„æŸé—œä¿‚

```sql
-- å­åˆ†é¡è¡¨å¤–éµç´„æŸ
ALTER TABLE account_sub_categories
    ADD CONSTRAINT fk_sub_categories_main_category
    FOREIGN KEY (main_category_id) REFERENCES account_main_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE;

-- æ˜ç´°è¡¨å¤–éµç´„æŸ
ALTER TABLE account_details
    ADD CONSTRAINT fk_details_main_category
    FOREIGN KEY (main_category_id) REFERENCES account_main_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_details_sub_category
    FOREIGN KEY (sub_category_id) REFERENCES account_sub_categories(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_details_parent
    FOREIGN KEY (parent_id) REFERENCES account_details(id)
    ON DELETE SET NULL ON UPDATE CASCADE;

-- ä½¿ç”¨è€…é—œè¯å¤–éµç´„æŸ
ALTER TABLE account_main_categories
    ADD CONSTRAINT fk_main_categories_created_by
    FOREIGN KEY (created_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE,
    ADD CONSTRAINT fk_main_categories_updated_by
    FOREIGN KEY (updated_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE;

-- å…¶ä»–è¡¨æ ¼çš„ä½¿ç”¨è€…é—œè¯ç´„æŸé¡ä¼¼...
```

### è³‡æ–™åº«è¨­è¨ˆè¦é»

#### ç·¨ç¢¼è¦å‰‡è¨­è¨ˆ
- **ç¸½é¡ç·¨ç¢¼**ï¼š1ä½æ•¸å­— (1-9)ï¼Œå¦‚ï¼š1=è³‡ç”¢ã€2=è² å‚µã€3=æ¬Šç›Šã€4=æ”¶å…¥ã€5=è²»ç”¨
- **å­åˆ†é¡ç·¨ç¢¼**ï¼š2ä½æ•¸å­— (01-99)ï¼Œå¦‚ï¼š11=æµå‹•è³‡ç”¢ã€12=éæµå‹•è³‡ç”¢
- **æ˜ç´°ç·¨ç¢¼**ï¼šå®Œæ•´ç·¨ç¢¼ï¼Œå¦‚ï¼š1101001=ç¾é‡‘åŠç´„ç•¶ç¾é‡‘

#### æ•¸æ“šå®Œæ•´æ€§ä¿éšœ
- ä½¿ç”¨å¤–éµç´„æŸç¢ºä¿åƒç…§å®Œæ•´æ€§
- ä½¿ç”¨å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡è¤‡ç·¨ç¢¼
- ä½¿ç”¨ CHECK ç´„æŸç¢ºä¿ç·¨ç¢¼æ ¼å¼æ­£ç¢º
- è»Ÿåˆªé™¤æ©Ÿåˆ¶ä¿è­·é—œè¯è³‡æ–™

#### æ•ˆèƒ½æœ€ä½³åŒ–è€ƒé‡
- é‡å°å¸¸ç”¨æŸ¥è©¢æ¢ä»¶å»ºç«‹è¤‡åˆç´¢å¼•
- ä½¿ç”¨é©ç•¶çš„è³‡æ–™å‹æ…‹æ¸›å°‘å„²å­˜ç©ºé–“
- è€ƒæ…®è®€å¯«åˆ†é›¢çš„è³‡æ–™åº«æ¶æ§‹

---

## âš™ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### å¾Œç«¯æ¶æ§‹è¨­è¨ˆ

#### æ§åˆ¶å™¨æ¶æ§‹ (Controllers)

ç³»çµ±æ¡ç”¨ Laravel çš„ RESTful æ§åˆ¶å™¨æ¨¡å¼ï¼Œæ¯å€‹ä¸»è¦åŠŸèƒ½æ¨¡çµ„å°æ‡‰ä¸€å€‹æ§åˆ¶å™¨ï¼š

```php
// æ§åˆ¶å™¨çµæ§‹
app/Http/Controllers/Admin/
â”œâ”€â”€ AccountMainCategoryController.php     // æœƒè¨ˆç§‘ç›®ç¸½é¡ç®¡ç†
â”œâ”€â”€ AccountSubCategoryController.php      // æœƒè¨ˆç§‘ç›®å­åˆ†é¡ç®¡ç†
â”œâ”€â”€ AccountDetailController.php           // æœƒè¨ˆç§‘ç›®æ˜ç´°ç®¡ç†
â”œâ”€â”€ AccountImportExportController.php     // åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½
â””â”€â”€ AccountAuditLogController.php         // å¯©è¨ˆæ—¥èªŒæŸ¥çœ‹
```

**æ§åˆ¶å™¨è¨­è¨ˆæ¨¡å¼**
```php
<?php
class AccountMainCategoryController extends Controller
{
    // æ¨™æº– RESTful æ–¹æ³•
    public function index()     // åˆ—è¡¨é é¢
    public function create()    // æ–°å¢é é¢
    public function store()     // å„²å­˜æ–°å¢
    public function show($id)   // è©³ç´°é é¢
    public function edit($id)   // ç·¨è¼¯é é¢
    public function update($id) // å„²å­˜æ›´æ–°
    public function destroy($id)// åˆªé™¤æ“ä½œ

    // è‡ªå®šç¾©æ–¹æ³•
    public function export()    // åŒ¯å‡ºåŠŸèƒ½
    public function import()    // åŒ¯å…¥åŠŸèƒ½
    public function toggleStatus($id) // å•Ÿç”¨/åœç”¨
}
```

#### æ¨¡å‹æ¶æ§‹ (Models)

**æ¨¡å‹è¨­è¨ˆåŸå‰‡**
- ä½¿ç”¨ Eloquent ORM å¯¦ç¾è³‡æ–™æ“ä½œ
- å¯¦ç¾æ¨¡å‹é–“çš„é—œè¯é—œä¿‚
- æ•´åˆå¯©è¨ˆæ—¥èªŒåŠŸèƒ½
- å¯¦ç¾è»Ÿåˆªé™¤æ©Ÿåˆ¶

```php
// æ¨¡å‹çµæ§‹
app/Models/
â”œâ”€â”€ AccountMainCategory.php
â”œâ”€â”€ AccountSubCategory.php
â”œâ”€â”€ AccountDetail.php
â””â”€â”€ AccountAuditLog.php
```

**æ¨¡å‹é—œè¯è¨­è¨ˆ**
```php
// AccountMainCategory.php
class AccountMainCategory extends Model
{
    use HasFactory, SoftDeletes, LogsActivity;

    protected $fillable = [
        'category_code', 'category_name', 'description',
        'sort_order', 'is_active'
    ];

    // é—œè¯é—œä¿‚
    public function subCategories()
    {
        return $this->hasMany(AccountSubCategory::class, 'main_category_id');
    }

    public function accountDetails()
    {
        return $this->hasManyThrough(
            AccountDetail::class,
            AccountSubCategory::class,
            'main_category_id',
            'sub_category_id'
        );
    }
}

// AccountSubCategory.php
class AccountSubCategory extends Model
{
    public function mainCategory()
    {
        return $this->belongsTo(AccountMainCategory::class, 'main_category_id');
    }

    public function accountDetails()
    {
        return $this->hasMany(AccountDetail::class, 'sub_category_id');
    }
}

// AccountDetail.php
class AccountDetail extends Model
{
    public function mainCategory()
    {
        return $this->belongsTo(AccountMainCategory::class, 'main_category_id');
    }

    public function subCategory()
    {
        return $this->belongsTo(AccountSubCategory::class, 'sub_category_id');
    }

    public function parent()
    {
        return $this->belongsTo(AccountDetail::class, 'parent_id');
    }

    public function children()
    {
        return $this->hasMany(AccountDetail::class, 'parent_id');
    }
}
```

#### è·¯ç”±è¨­è¨ˆ (Routes)

**è·¯ç”±çµæ§‹**
```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth', 'permission:manage accounts'])->group(function () {

    // æœƒè¨ˆç§‘ç›®ç¸½é¡ç®¡ç†
    Route::resource('account-main-categories', AccountMainCategoryController::class);
    Route::put('account-main-categories/{category}/toggle-status',
        [AccountMainCategoryController::class, 'toggleStatus'])->name('account-main-categories.toggle-status');

    // æœƒè¨ˆç§‘ç›®å­åˆ†é¡ç®¡ç†
    Route::resource('account-sub-categories', AccountSubCategoryController::class);
    Route::put('account-sub-categories/{category}/toggle-status',
        [AccountSubCategoryController::class, 'toggleStatus'])->name('account-sub-categories.toggle-status');

    // æœƒè¨ˆç§‘ç›®æ˜ç´°ç®¡ç† (ä½æ–¼ accounts ç¾¤çµ„ä¸­)
    Route::get('details/export', [AccountDetailController::class, 'export'])->name('account.details.export');
    Route::post('details/import', [AccountDetailController::class, 'import'])->name('account.details.import');
    Route::get('details/template', [AccountDetailController::class, 'template'])->name('account.details.template');
    Route::put('details/{detail}/toggle-status', [AccountDetailController::class, 'toggleStatus'])->name('details.toggle-status');
    // æœƒè¨ˆç§‘ç›®æ˜ç´° CRUD è·¯ç”±
    Route::get('details', [AccountDetailController::class, 'index'])->name('account.details.index');
    Route::get('details/create', [AccountDetailController::class, 'create'])->name('account.details.create');
    Route::post('details', [AccountDetailController::class, 'store'])->name('account.details.store');
    Route::get('details/{detail}', [AccountDetailController::class, 'show'])->name('account.details.show');
    Route::get('details/{detail}/edit', [AccountDetailController::class, 'edit'])->name('account.details.edit');
    Route::put('details/{detail}', [AccountDetailController::class, 'update'])->name('account.details.update');
    Route::delete('details/{detail}', [AccountDetailController::class, 'destroy'])->name('account.details.destroy');

    // API è·¯ç”± (ä½æ–¼ accounts ç¾¤çµ„ä¸­)
    Route::prefix('api')->name('api.')->group(function () {
        Route::get('sub-categories/by-main/{mainId}', [AccountDetailController::class, 'getSubCategories'])->name('sub-categories.by-main');
        Route::get('details/validate-code', [AccountDetailController::class, 'validateCode'])->name('details.validate-code');
        Route::get('details/next-code', [AccountDetailController::class, 'getNextCode'])->name('details.next-code');
    });

    // å¯©è¨ˆæ—¥èªŒ
    Route::get('account-audit-logs', [AccountAuditLogController::class, 'index'])->name('account-audit-logs.index');
});
```

#### è«‹æ±‚é©—è­‰ (Form Requests)

**é©—è­‰é¡åˆ¥çµæ§‹**
```php
// app/Http/Requests/
â”œâ”€â”€ AccountMainCategoryRequest.php
â”œâ”€â”€ AccountSubCategoryRequest.php
â”œâ”€â”€ AccountDetailRequest.php
â””â”€â”€ AccountImportRequest.php
```

**é©—è­‰è¦å‰‡ç¯„ä¾‹**
```php
// AccountDetailRequest.php
class AccountDetailRequest extends FormRequest
{
    public function rules()
    {
        $accountId = $this->route('account_detail');

        return [
            'main_category_id' => 'required|exists:account_main_categories,id',
            'sub_category_id' => 'required|exists:account_sub_categories,id',
            'account_code' => [
                'required',
                'string',
                'max:20',
                'regex:/^[0-9]+$/',
                Rule::unique('account_details')->ignore($accountId)
            ],
            'account_name' => 'required|string|max:150',
            'account_name_en' => 'nullable|string|max:150',
            'account_type' => 'required|in:asset,liability,equity,revenue,expense',
            'debit_credit' => 'required|in:debit,credit',
            'parent_id' => 'nullable|exists:account_details,id',
            'description' => 'nullable|string',
            'notes' => 'nullable|string',
        ];
    }

    public function messages()
    {
        return [
            'account_code.regex' => 'ç§‘ç›®ç·¨è™Ÿåªèƒ½åŒ…å«æ•¸å­—',
            'account_code.unique' => 'ç§‘ç›®ç·¨è™Ÿå·²å­˜åœ¨',
            // å…¶ä»–éŒ¯èª¤è¨Šæ¯...
        ];
    }
}
```

#### æœå‹™å±¤è¨­è¨ˆ (Services)

**æœå‹™é¡åˆ¥æ¶æ§‹**
```php
// app/Services/
â”œâ”€â”€ AccountCodeService.php        // ç§‘ç›®ç·¨ç¢¼é‚è¼¯
â”œâ”€â”€ AccountImportService.php      // åŒ¯å…¥è™•ç†
â”œâ”€â”€ AccountExportService.php      // åŒ¯å‡ºè™•ç†
â””â”€â”€ AccountValidationService.php  // æ¥­å‹™é©—è­‰
```

**æœå‹™å±¤ç¯„ä¾‹**
```php
// AccountCodeService.php
class AccountCodeService
{
    public function generateNextCode($mainCategoryCode, $subCategoryCode)
    {
        // ç”¢ç”Ÿä¸‹ä¸€å€‹å¯ç”¨çš„ç§‘ç›®ç·¨è™Ÿ
    }

    public function validateCodeFormat($code)
    {
        // é©—è­‰ç·¨è™Ÿæ ¼å¼æ˜¯å¦æ­£ç¢º
    }

    public function parseCodeStructure($code)
    {
        // è§£æç·¨è™Ÿçµæ§‹
    }
}
```

### ä¸­ä»‹è»Ÿé«”è¨­è¨ˆ

**è‡ªå®šç¾©ä¸­ä»‹è»Ÿé«”**
```php
// app/Http/Middleware/
â”œâ”€â”€ CheckAccountPermission.php    // æª¢æŸ¥æœƒè¨ˆæ¬Šé™
â”œâ”€â”€ ValidateAccountAccess.php     // é©—è­‰ç§‘ç›®å­˜å–æ¬Šé™
â””â”€â”€ LogAccountActivity.php        // è¨˜éŒ„ç§‘ç›®æ“ä½œæ—¥èªŒ
```

### å‰ç«¯æ¶æ§‹è¨­è¨ˆ

#### Vue çµ„ä»¶æ¶æ§‹

**çµ„ä»¶çµæ§‹è¦åŠƒ**
```
resources/js/Pages/Admin/Accounts/
â”œâ”€â”€ MainCategories/
â”‚   â”œâ”€â”€ Index.vue                 // ç¸½é¡åˆ—è¡¨é é¢
â”‚   â”œâ”€â”€ Create.vue               // æ–°å¢ç¸½é¡é é¢
â”‚   â”œâ”€â”€ Edit.vue                 // ç·¨è¼¯ç¸½é¡é é¢
â”‚   â””â”€â”€ Show.vue                 // ç¸½é¡è©³ç´°é é¢
â”œâ”€â”€ SubCategories/
â”‚   â”œâ”€â”€ Index.vue                // å­åˆ†é¡åˆ—è¡¨é é¢
â”‚   â”œâ”€â”€ Create.vue               // æ–°å¢å­åˆ†é¡é é¢
â”‚   â”œâ”€â”€ Edit.vue                 // ç·¨è¼¯å­åˆ†é¡é é¢
â”‚   â””â”€â”€ Show.vue                 // å­åˆ†é¡è©³ç´°é é¢
â”œâ”€â”€ Details/
â”‚   â”œâ”€â”€ Index.vue                // ç§‘ç›®æ˜ç´°åˆ—è¡¨é é¢
â”‚   â”œâ”€â”€ Create.vue               // æ–°å¢ç§‘ç›®æ˜ç´°é é¢
â”‚   â”œâ”€â”€ Edit.vue                 // ç·¨è¼¯ç§‘ç›®æ˜ç´°é é¢
â”‚   â”œâ”€â”€ Show.vue                 // ç§‘ç›®æ˜ç´°è©³ç´°é é¢
â”‚   â””â”€â”€ Import.vue               // æ‰¹é‡åŒ¯å…¥é é¢
â””â”€â”€ Components/
    â”œâ”€â”€ AccountCodeInput.vue     // ç§‘ç›®ç·¨è™Ÿè¼¸å…¥çµ„ä»¶
    â”œâ”€â”€ AccountSelector.vue      // ç§‘ç›®é¸æ“‡å™¨çµ„ä»¶
    â”œâ”€â”€ AccountTree.vue          // ç§‘ç›®æ¨¹ç‹€çµæ§‹çµ„ä»¶
    â”œâ”€â”€ ImportModal.vue          // åŒ¯å…¥å°è©±æ¡†çµ„ä»¶
    â””â”€â”€ AuditLogModal.vue        // å¯©è¨ˆæ—¥èªŒæŸ¥çœ‹çµ„ä»¶
```

**æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ**

**1. ç§‘ç›®æ˜ç´°åˆ—è¡¨çµ„ä»¶ (Details/Index.vue)**
```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <div class="content-wrapper">
      <!-- é é¢æ¨™é¡Œèˆ‡æ“ä½œæŒ‰éˆ• -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>æœƒè¨ˆç§‘ç›®ç®¡ç†</h1>
            </div>
            <div class="col-sm-6">
              <div class="float-right">
                <Link :href="route('admin.accounts.account.details.create')"
                      class="btn btn-primary">
                  <i class="bi bi-plus"></i> æ–°å¢ç§‘ç›®
                </Link>
                <button @click="showImportModal" class="btn btn-success ms-2">
                  <i class="bi bi-upload"></i> åŒ¯å…¥
                </button>
                <a :href="route('admin.accounts.account.details.export')"
                   class="btn btn-info ms-2">
                  <i class="bi bi-download"></i> åŒ¯å‡º
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æœå°‹èˆ‡ç¯©é¸ -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">æœå°‹ç¯©é¸</h3>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label>ç¸½é¡</label>
                      <select v-model="filters.main_category_id"
                              class="form-select">
                        <option value="">å…¨éƒ¨ç¸½é¡</option>
                        <option v-for="category in mainCategories"
                                :key="category.id"
                                :value="category.id">
                          {{ category.category_name }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label>å­åˆ†é¡</label>
                      <select v-model="filters.sub_category_id"
                              class="form-select">
                        <option value="">å…¨éƒ¨å­åˆ†é¡</option>
                        <option v-for="subCategory in subCategories"
                                :key="subCategory.id"
                                :value="subCategory.id">
                          {{ subCategory.sub_category_name }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label>ç§‘ç›®ç·¨è™Ÿ/åç¨±</label>
                      <input v-model="filters.search"
                             type="text"
                             class="form-control"
                             placeholder="è¼¸å…¥é—œéµå­—">
                    </div>
                    <div class="col-md-3">
                      <label>ç‹€æ…‹</label>
                      <select v-model="filters.is_active" class="form-select">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="1">å•Ÿç”¨</option>
                        <option value="0">åœç”¨</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <button @click="applyFilters" class="btn btn-primary">
                        <i class="bi bi-search"></i> æœå°‹
                      </button>
                      <button @click="resetFilters" class="btn btn-secondary ms-2">
                        <i class="bi bi-arrow-clockwise"></i> é‡è¨­
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç§‘ç›®åˆ—è¡¨ -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">ç§‘ç›®åˆ—è¡¨</h3>
                </div>
                <div class="card-body table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ç§‘ç›®ç·¨è™Ÿ</th>
                        <th>ç§‘ç›®åç¨±</th>
                        <th>ç¸½é¡</th>
                        <th>å­åˆ†é¡</th>
                        <th>ç§‘ç›®æ€§è³ª</th>
                        <th>å€Ÿè²¸æ€§è³ª</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="account in accounts.data" :key="account.id">
                        <td>{{ account.account_code }}</td>
                        <td>{{ account.account_name }}</td>
                        <td>{{ account.main_category.category_name }}</td>
                        <td>{{ account.sub_category.sub_category_name }}</td>
                        <td>
                          <span class="badge"
                                :class="getAccountTypeBadge(account.account_type)">
                            {{ getAccountTypeText(account.account_type) }}
                          </span>
                        </td>
                        <td>
                          <span class="badge"
                                :class="account.debit_credit === 'debit' ? 'bg-info' : 'bg-warning'">
                            {{ account.debit_credit === 'debit' ? 'å€Ÿæ–¹' : 'è²¸æ–¹' }}
                          </span>
                        </td>
                        <td>
                          <button @click="toggleStatus(account)"
                                  class="btn btn-sm"
                                  :class="account.is_active ? 'btn-success' : 'btn-secondary'">
                            {{ account.is_active ? 'å•Ÿç”¨' : 'åœç”¨' }}
                          </button>
                        </td>
                        <td>
                          <div class="btn-group">
                            <Link :href="route('admin.accounts.account.details.show', { detail: account.id })"
                                  class="btn btn-sm btn-info">
                              <i class="bi bi-eye"></i>
                            </Link>
                            <Link :href="route('admin.accounts.account.details.edit', { detail: account.id })"
                                  class="btn btn-sm btn-warning">
                              <i class="bi bi-pencil"></i>
                            </Link>
                            <button @click="deleteAccount(account)"
                                    class="btn btn-sm btn-danger">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="card-footer">
                  <Pagination :links="accounts.links" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åŒ¯å…¥æ¨¡æ…‹æ¡† -->
    <ImportModal v-if="showImport"
                 @close="showImport = false"
                 @imported="handleImported" />
  </AdminLayout>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue'
import { router, usePage, Link } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import ImportModal from '../Components/ImportModal.vue'
import Pagination from '@/Components/Pagination.vue'

const props = defineProps({
  accounts: Object,
  mainCategories: Array,
  subCategories: Array,
  filters: Object
})

const showImport = ref(false)

const filters = reactive({
  main_category_id: props.filters?.main_category_id || '',
  sub_category_id: props.filters?.sub_category_id || '',
  search: props.filters?.search || '',
  is_active: props.filters?.is_active || ''
})

// ç›£è½ç¸½é¡è®Šæ›´ï¼Œè‡ªå‹•æ›´æ–°å­åˆ†é¡é¸é …
watch(() => filters.main_category_id, (newValue) => {
  if (newValue) {
    // è¼‰å…¥å°æ‡‰çš„å­åˆ†é¡
    router.get(route('admin.api.account-sub-categories.by-main', newValue), {}, {
      preserveState: true,
      preserveScroll: true,
      only: ['subCategories']
    })
  }
})

const applyFilters = () => {
  router.get(route('admin.accounts.account.details.index'), filters, {
    preserveState: true,
    preserveScroll: true
  })
}

const resetFilters = () => {
  Object.keys(filters).forEach(key => filters[key] = '')
  applyFilters()
}

const showImportModal = () => {
  showImport.value = true
}

const handleImported = () => {
  showImport.value = false
  router.reload({ only: ['accounts'] })
}

const toggleStatus = (account) => {
  router.put(route('admin.accounts.details.toggle-status', { detail: account.id }), {}, {
    preserveState: true,
    onSuccess: () => {
      // æ›´æ–°ç‹€æ…‹æˆåŠŸ
    }
  })
}

const deleteAccount = (account) => {
  if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœƒè¨ˆç§‘ç›®å—ï¼Ÿ')) {
    router.delete(route('admin.accounts.account.details.destroy', { detail: account.id }), {
      preserveState: true
    })
  }
}

const getAccountTypeBadge = (type) => {
  const badges = {
    asset: 'bg-primary',
    liability: 'bg-danger',
    equity: 'bg-success',
    revenue: 'bg-info',
    expense: 'bg-warning'
  }
  return badges[type] || 'bg-secondary'
}

const getAccountTypeText = (type) => {
  const texts = {
    asset: 'è³‡ç”¢',
    liability: 'è² å‚µ',
    equity: 'æ¬Šç›Š',
    revenue: 'æ”¶å…¥',
    expense: 'è²»ç”¨'
  }
  return texts[type] || type
}
</script>
```

**2. ç§‘ç›®ç·¨è™Ÿè¼¸å…¥çµ„ä»¶ (Components/AccountCodeInput.vue)**
```vue
<template>
  <div class="form-group">
    <label :for="inputId">{{ label }}</label>
    <div class="input-group">
      <input :id="inputId"
             v-model="localValue"
             type="text"
             class="form-control"
             :class="{ 'is-invalid': hasError }"
             :placeholder="placeholder"
             @input="handleInput"
             @blur="validateCode">
      <button v-if="showGenerator"
              @click="generateNextCode"
              class="btn btn-outline-secondary"
              type="button">
        <i class="bi bi-gear"></i>
      </button>
    </div>
    <div v-if="hasError" class="invalid-feedback">
      {{ errorMessage }}
    </div>
    <small v-if="hint" class="form-text text-muted">
      {{ hint }}
    </small>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { router } from '@inertiajs/vue3'

const props = defineProps({
  modelValue: String,
  label: {
    type: String,
    default: 'ç§‘ç›®ç·¨è™Ÿ'
  },
  placeholder: {
    type: String,
    default: 'è«‹è¼¸å…¥ç§‘ç›®ç·¨è™Ÿ'
  },
  mainCategoryId: Number,
  subCategoryId: Number,
  showGenerator: {
    type: Boolean,
    default: true
  },
  hint: String,
  inputId: {
    type: String,
    default: 'account_code'
  }
})

const emit = defineEmits(['update:modelValue', 'validated'])

const localValue = ref(props.modelValue)
const errorMessage = ref('')
const isValidating = ref(false)

const hasError = computed(() => errorMessage.value !== '')

watch(() => props.modelValue, (newValue) => {
  localValue.value = newValue
})

const handleInput = () => {
  emit('update:modelValue', localValue.value)
  // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
  if (errorMessage.value) {
    errorMessage.value = ''
  }
}

const validateCode = async () => {
  if (!localValue.value) return

  isValidating.value = true

  try {
    const response = await axios.get(route('admin.api.account-details.validate-code'), {
      params: {
        code: localValue.value,
        main_category_id: props.mainCategoryId,
        sub_category_id: props.subCategoryId
      }
    })

    if (!response.data.valid) {
      errorMessage.value = response.data.message || 'ç§‘ç›®ç·¨è™Ÿä¸å¯ç”¨'
    } else {
      errorMessage.value = ''
    }

    emit('validated', {
      valid: response.data.valid,
      message: response.data.message
    })
  } catch (error) {
    errorMessage.value = 'é©—è­‰å¤±æ•—ï¼Œè«‹é‡è©¦'
  } finally {
    isValidating.value = false
  }
}

const generateNextCode = async () => {
  if (!props.mainCategoryId || !props.subCategoryId) {
    alert('è«‹å…ˆé¸æ“‡ç¸½é¡å’Œå­åˆ†é¡')
    return
  }

  try {
    const response = await axios.get(route('admin.api.account-details.next-code'), {
      params: {
        main_category_id: props.mainCategoryId,
        sub_category_id: props.subCategoryId
      }
    })

    localValue.value = response.data.code
    emit('update:modelValue', localValue.value)
  } catch (error) {
    alert('ç”¢ç”Ÿç·¨è™Ÿå¤±æ•—ï¼Œè«‹é‡è©¦')
  }
}
</script>
```

#### UI/UX è¨­è¨ˆåŸå‰‡

**è¨­è¨ˆåŸå‰‡**
1. **ä¸€è‡´æ€§**ï¼šéµå¾ª AdminLTE 4 çš„è¨­è¨ˆé¢¨æ ¼å’Œçµ„ä»¶è¦ç¯„
2. **æ˜“ç”¨æ€§**ï¼šæä¾›ç›´è§€çš„æ“ä½œæµç¨‹å’Œæ¸…æ™°çš„è¦–è¦ºå›é¥‹
3. **éŸ¿æ‡‰å¼**ï¼šæ”¯æ´æ¡Œé¢å’Œè¡Œå‹•è£ç½®çš„æœ€ä½³ç€è¦½é«”é©—
4. **å¯è¨ªå•æ€§**ï¼šéµå¾ª WCAG 2.1 ç„¡éšœç¤™è¨­è¨ˆæº–å‰‡

**è‰²å½©é…ç½®**
- **ä¸»è‰²èª¿**ï¼šå»¶ç”¨ AdminLTE çš„è—è‰²ç³» (#007bff)
- **åŠŸèƒ½è‰²å½©**ï¼š
  - æˆåŠŸï¼šç¶ è‰² (#28a745)
  - è­¦å‘Šï¼šæ©™è‰² (#ffc107)
  - å±éšªï¼šç´…è‰² (#dc3545)
  - è³‡è¨Šï¼šæ·ºè— (#17a2b8)

**åœ–ç¤ºç³»çµ±**
- ä½¿ç”¨ Bootstrap Icons åœ–ç¤ºåº«
- ä¿æŒåœ–ç¤ºä½¿ç”¨çš„ä¸€è‡´æ€§å’Œèªç¾©åŒ–

---

## ğŸ”Œ API è¨­è¨ˆ

### RESTful API ç«¯é»å®šç¾©

#### 1. æœƒè¨ˆç§‘ç›®ç¸½é¡ API

| HTTPæ–¹æ³• | ç«¯é» | æè¿° | æ¬Šé™ |
|---------|------|------|------|
| GET | `/admin/account-main-categories` | å–å¾—ç¸½é¡åˆ—è¡¨ | manage accounts |
| GET | `/admin/account-main-categories/create` | å–å¾—æ–°å¢é é¢ | manage accounts |
| POST | `/admin/account-main-categories` | å»ºç«‹æ–°ç¸½é¡ | manage accounts |
| GET | `/admin/account-main-categories/{id}` | å–å¾—ç¸½é¡è©³ç´° | manage accounts |
| GET | `/admin/account-main-categories/{id}/edit` | å–å¾—ç·¨è¼¯é é¢ | manage accounts |
| PUT/PATCH | `/admin/account-main-categories/{id}` | æ›´æ–°ç¸½é¡ | manage accounts |
| DELETE | `/admin/account-main-categories/{id}` | åˆªé™¤ç¸½é¡ | manage accounts |
| PUT | `/admin/account-main-categories/{id}/toggle-status` | åˆ‡æ›ç‹€æ…‹ | manage accounts |

**API å›æ‡‰æ ¼å¼ç¯„ä¾‹**
```json
{
  "data": {
    "id": 1,
    "category_code": "1",
    "category_name": "è³‡ç”¢",
    "description": "åŒ…å«æ‰€æœ‰è³‡ç”¢ç›¸é—œç§‘ç›®",
    "sort_order": 1,
    "is_active": true,
    "sub_categories_count": 5,
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
}
```

#### 2. æœƒè¨ˆç§‘ç›®å­åˆ†é¡ API

| HTTPæ–¹æ³• | ç«¯é» | æè¿° | æ¬Šé™ |
|---------|------|------|------|
| GET | `/admin/account-sub-categories` | å–å¾—å­åˆ†é¡åˆ—è¡¨ | manage accounts |
| POST | `/admin/account-sub-categories` | å»ºç«‹æ–°å­åˆ†é¡ | manage accounts |
| GET | `/admin/account-sub-categories/{id}` | å–å¾—å­åˆ†é¡è©³ç´° | manage accounts |
| PUT/PATCH | `/admin/account-sub-categories/{id}` | æ›´æ–°å­åˆ†é¡ | manage accounts |
| DELETE | `/admin/account-sub-categories/{id}` | åˆªé™¤å­åˆ†é¡ | manage accounts |
| GET | `/admin/api/account-sub-categories/by-main/{mainId}` | ä¾ç¸½é¡å–å¾—å­åˆ†é¡ | manage accounts |

#### 3. æœƒè¨ˆç§‘ç›®æ˜ç´° API

| HTTPæ–¹æ³• | ç«¯é» | æè¿° | æ¬Šé™ |
|---------|------|------|------|
| GET | `/admin/account-details` | å–å¾—ç§‘ç›®åˆ—è¡¨ | manage accounts |
| POST | `/admin/account-details` | å»ºç«‹æ–°ç§‘ç›® | manage accounts |
| GET | `/admin/account-details/{id}` | å–å¾—ç§‘ç›®è©³ç´° | manage accounts |
| PUT/PATCH | `/admin/account-details/{id}` | æ›´æ–°ç§‘ç›® | manage accounts |
| DELETE | `/admin/account-details/{id}` | åˆªé™¤ç§‘ç›® | manage accounts |
| GET | `/admin/account-details/export` | åŒ¯å‡ºç§‘ç›®è³‡æ–™ | manage accounts |
| POST | `/admin/account-details/import` | åŒ¯å…¥ç§‘ç›®è³‡æ–™ | manage accounts |
| GET | `/admin/account-details/template` | ä¸‹è¼‰åŒ¯å…¥ç¯„æœ¬ | manage accounts |

#### 4. è¼”åŠ© API ç«¯é»

| HTTPæ–¹æ³• | ç«¯é» | æè¿° | æ¬Šé™ |
|---------|------|------|------|
| GET | `/admin/api/account-details/validate-code` | é©—è­‰ç§‘ç›®ç·¨è™Ÿ | manage accounts |
| GET | `/admin/api/account-details/next-code` | å–å¾—ä¸‹ä¸€å€‹å¯ç”¨ç·¨è™Ÿ | manage accounts |
| GET | `/admin/api/account-main-categories/options` | å–å¾—ç¸½é¡é¸é … | manage accounts |
| GET | `/admin/account-audit-logs` | å–å¾—å¯©è¨ˆæ—¥èªŒ | view audit logs |

### API è«‹æ±‚èˆ‡å›æ‡‰è¦ç¯„

#### æ¨™æº–å›æ‡‰æ ¼å¼
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {},
  "meta": {
    "current_page": 1,
    "total": 100,
    "per_page": 15
  }
}
```

#### éŒ¯èª¤å›æ‡‰æ ¼å¼
```json
{
  "success": false,
  "message": "é©—è­‰å¤±æ•—",
  "errors": {
    "account_code": ["ç§‘ç›®ç·¨è™Ÿå·²å­˜åœ¨"],
    "account_name": ["ç§‘ç›®åç¨±ç‚ºå¿…å¡«æ¬„ä½"]
  },
  "error_code": "VALIDATION_ERROR"
}
```

---

## ğŸ” æ¬Šé™ç®¡ç†

### Spatie Permission æ•´åˆ

#### æ¬Šé™å®šç¾©
```php
// database/seeders/PermissionSeeder.php
$permissions = [
    // æœƒè¨ˆç§‘ç›®æ¬Šé™
    'view accounts',              // æª¢è¦–æœƒè¨ˆç§‘ç›®
    'create accounts',            // å»ºç«‹æœƒè¨ˆç§‘ç›®
    'edit accounts',              // ç·¨è¼¯æœƒè¨ˆç§‘ç›®
    'delete accounts',            // åˆªé™¤æœƒè¨ˆç§‘ç›®
    'manage accounts',            // å®Œæ•´ç®¡ç†æœƒè¨ˆç§‘ç›®
    'import accounts',            // åŒ¯å…¥æœƒè¨ˆç§‘ç›®
    'export accounts',            // åŒ¯å‡ºæœƒè¨ˆç§‘ç›®
    'view audit logs',            // æŸ¥çœ‹å¯©è¨ˆæ—¥èªŒ
];
```

#### è§’è‰²é…ç½®
```php
// æœƒè¨ˆä¸»ç®¡è§’è‰²
$accountingManager = Role::create(['name' => 'accounting_manager']);
$accountingManager->givePermissionTo([
    'manage accounts',
    'import accounts',
    'export accounts',
    'view audit logs'
]);

// æœƒè¨ˆäººå“¡è§’è‰²
$accountingStaff = Role::create(['name' => 'accounting_staff']);
$accountingStaff->givePermissionTo([
    'view accounts',
    'create accounts',
    'edit accounts'
]);
```

#### ä¸­ä»‹è»Ÿé«”ä¿è­·
```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {

    // éœ€è¦æœƒè¨ˆç§‘ç›®ç®¡ç†æ¬Šé™
    Route::middleware('permission:manage accounts')->group(function () {
        Route::resource('account-main-categories', AccountMainCategoryController::class);
        Route::resource('account-sub-categories', AccountSubCategoryController::class);
        Route::resource('account-details', AccountDetailController::class);
    });

    // éœ€è¦åŒ¯å…¥æ¬Šé™
    Route::middleware('permission:import accounts')->group(function () {
        Route::post('account-details/import', [AccountDetailController::class, 'import']);
    });

    // éœ€è¦å¯©è¨ˆæ—¥èªŒæŸ¥çœ‹æ¬Šé™
    Route::middleware('permission:view audit logs')->group(function () {
        Route::get('account-audit-logs', [AccountAuditLogController::class, 'index']);
    });
});
```

---

## âœ… é©—è­‰è¦å‰‡èˆ‡æ¥­å‹™é‚è¼¯

### è³‡æ–™é©—è­‰è¦å‰‡

#### æœƒè¨ˆç§‘ç›®ç¸½é¡é©—è­‰
```php
public function rules()
{
    return [
        'category_code' => 'required|string|max:10|unique:account_main_categories,category_code,' . $this->id,
        'category_name' => 'required|string|max:100',
        'description' => 'nullable|string|max:500',
        'sort_order' => 'nullable|integer|min:0',
    ];
}
```

#### æœƒè¨ˆç§‘ç›®æ˜ç´°é©—è­‰
```php
public function rules()
{
    return [
        'main_category_id' => 'required|exists:account_main_categories,id',
        'sub_category_id' => 'required|exists:account_sub_categories,id',
        'account_code' => [
            'required',
            'string',
            'max:20',
            'regex:/^[0-9]+$/',
            Rule::unique('account_details')->ignore($this->id)
        ],
        'account_name' => 'required|string|max:150',
        'account_type' => 'required|in:asset,liability,equity,revenue,expense',
        'debit_credit' => 'required|in:debit,credit',
    ];
}
```

### æ¥­å‹™é‚è¼¯è¦å‰‡

#### ç§‘ç›®ç·¨è™Ÿç”Ÿæˆé‚è¼¯
```php
class AccountCodeService
{
    public function generateNextCode($mainCategoryCode, $subCategoryCode)
    {
        // 1. çµ„åˆåŸºç¤ä»£ç¢¼ (ç¸½é¡ + å­åˆ†é¡)
        $baseCode = $mainCategoryCode . $subCategoryCode;

        // 2. æŸ¥æ‰¾æœ€å¤§çš„åºè™Ÿ
        $maxCode = AccountDetail::where('account_code', 'LIKE', $baseCode . '%')
            ->orderBy('account_code', 'desc')
            ->value('account_code');

        if (!$maxCode) {
            return $baseCode . '001'; // ç¬¬ä¸€å€‹ç·¨è™Ÿ
        }

        // 3. å–å¾—åºè™Ÿéƒ¨åˆ†ä¸¦éå¢
        $sequence = intval(substr($maxCode, strlen($baseCode))) + 1;

        return $baseCode . str_pad($sequence, 3, '0', STR_PAD_LEFT);
    }
}
```

#### åˆªé™¤æ¥­å‹™è¦å‰‡
```php
public function destroy($id)
{
    $account = AccountDetail::findOrFail($id);

    // æª¢æŸ¥æ˜¯å¦æœ‰å­ç§‘ç›®
    if ($account->children()->count() > 0) {
        return response()->json([
            'success' => false,
            'message' => 'æ­¤ç§‘ç›®åº•ä¸‹é‚„æœ‰å­ç§‘ç›®ï¼Œç„¡æ³•åˆªé™¤'
        ], 400);
    }

    // æª¢æŸ¥æ˜¯å¦å·²æœ‰äº¤æ˜“ç´€éŒ„ (æœªä¾†èˆ‡å¸³å‹™ç³»çµ±æ•´åˆæ™‚)
    // if ($this->hasTransactions($account)) {
    //     return response()->json([
    //         'success' => false,
    //         'message' => 'æ­¤ç§‘ç›®å·²æœ‰äº¤æ˜“ç´€éŒ„ï¼Œç„¡æ³•åˆªé™¤'
    //     ], 400);
    // }

    $account->delete();

    return response()->json([
        'success' => true,
        'message' => 'åˆªé™¤æˆåŠŸ'
    ]);
}
```

---

## â±ï¸ é–‹ç™¼æ™‚ç¨‹èˆ‡æ¸¬è©¦è¨ˆç•«

### é–‹ç™¼éšæ®µè¦åŠƒ

#### ç¬¬ä¸€éšæ®µï¼šåŸºç¤æ¶æ§‹å»ºç«‹ (1-2é€±)
- [ ] è³‡æ–™åº«é·ç§»æª”æ¡ˆå»ºç«‹
- [ ] æ¨¡å‹èˆ‡é—œè¯é—œä¿‚å»ºç«‹
- [ ] åŸºç¤æ§åˆ¶å™¨æ¶æ§‹
- [ ] è·¯ç”±è¨­å®š
- [ ] æ¬Šé™ç³»çµ±æ•´åˆ

#### ç¬¬äºŒéšæ®µï¼šæ ¸å¿ƒåŠŸèƒ½é–‹ç™¼ (2-3é€±)
- [ ] æœƒè¨ˆç§‘ç›®ç¸½é¡ CRUD åŠŸèƒ½
- [ ] æœƒè¨ˆç§‘ç›®å­åˆ†é¡ CRUD åŠŸèƒ½
- [ ] æœƒè¨ˆç§‘ç›®æ˜ç´° CRUD åŠŸèƒ½
- [ ] ç§‘ç›®ç·¨è™Ÿè‡ªå‹•ç”¢ç”Ÿé‚è¼¯
- [ ] åŸºæœ¬é©—è­‰è¦å‰‡å¯¦ä½œ

#### ç¬¬ä¸‰éšæ®µï¼šé€²éšåŠŸèƒ½é–‹ç™¼ (2-3é€±)
- [ ] å‰ç«¯ Vue çµ„ä»¶é–‹ç™¼
- [ ] æœå°‹èˆ‡ç¯©é¸åŠŸèƒ½
- [ ] åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½
- [ ] å¯©è¨ˆæ—¥èªŒåŠŸèƒ½
- [ ] API ç«¯é»å®Œå–„

#### ç¬¬å››éšæ®µï¼šæ¸¬è©¦èˆ‡å„ªåŒ– (1-2é€±)
- [ ] å–®å…ƒæ¸¬è©¦ç·¨å¯«
- [ ] åŠŸèƒ½æ¸¬è©¦ç·¨å¯«
- [ ] æ•ˆèƒ½æ¸¬è©¦èˆ‡å„ªåŒ–
- [ ] ä½¿ç”¨è€…é«”é©—å„ªåŒ–
- [ ] å®‰å…¨æ€§æª¢æŸ¥

### æ¸¬è©¦è¨ˆç•«

#### å–®å…ƒæ¸¬è©¦
```php
// tests/Unit/AccountCodeServiceTest.php
class AccountCodeServiceTest extends TestCase
{
    public function test_generate_first_account_code()
    {
        $service = new AccountCodeService();
        $code = $service->generateNextCode('1', '01');
        $this->assertEquals('101001', $code);
    }

    public function test_generate_next_account_code()
    {
        AccountDetail::factory()->create(['account_code' => '101001']);

        $service = new AccountCodeService();
        $code = $service->generateNextCode('1', '01');
        $this->assertEquals('101002', $code);
    }
}
```

#### åŠŸèƒ½æ¸¬è©¦
```php
// tests/Feature/AccountManagementTest.php
class AccountManagementTest extends TestCase
{
    public function test_user_can_view_account_list()
    {
        $user = User::factory()->create();
        $user->givePermissionTo('view accounts');

        $response = $this->actingAs($user)
            ->get(route('admin.accounts.account.details.index'));

        $response->assertStatus(200);
    }
}
```

---

## ğŸ“ é™„éŒ„

### å¯¦ä½œæª¢æ ¸æ¸…å–®
- [ ] è³‡æ–™åº«é·ç§»æª”æ¡ˆå®Œæˆ
- [ ] æ¨¡å‹é—œè¯é—œä¿‚æ­£ç¢º
- [ ] æ§åˆ¶å™¨ RESTful å¯¦ä½œ
- [ ] å‰ç«¯ Vue çµ„ä»¶å®Œæˆ
- [ ] API ç«¯é»æ¸¬è©¦é€šé
- [ ] æ¬Šé™æ§åˆ¶æ­£ç¢ºå¯¦ä½œ
- [ ] é©—è­‰è¦å‰‡å®Œæ•´
- [ ] å¯©è¨ˆæ—¥èªŒåŠŸèƒ½æ­£å¸¸
- [ ] åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½æ¸¬è©¦
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ >80%
- [ ] åŠŸèƒ½æ¸¬è©¦é€šé
- [ ] æ•ˆèƒ½æ¸¬è©¦é”æ¨™
- [ ] å®‰å…¨æ€§æª¢æŸ¥é€šé
- [ ] ä½¿ç”¨è€…æ–‡ä»¶å®Œæˆ

### æ³¨æ„äº‹é …èˆ‡å»ºè­°
1. **ç·¨ç¢¼ä¸€è‡´æ€§**ï¼šç¢ºä¿ç§‘ç›®ç·¨è™Ÿçš„æ ¼å¼åœ¨æ•´å€‹ç³»çµ±ä¸­ä¿æŒä¸€è‡´
2. **æ•ˆèƒ½è€ƒé‡**ï¼šå°æ–¼å¤§é‡ç§‘ç›®è³‡æ–™ï¼Œè€ƒæ…®å¯¦ä½œå¿«å–æ©Ÿåˆ¶
3. **è³‡æ–™å®Œæ•´æ€§**ï¼šå¯¦ä½œå®Œæ•´çš„å¤–éµç´„æŸå’Œé©—è­‰é‚è¼¯
4. **ä½¿ç”¨è€…é«”é©—**ï¼šæä¾›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯å’Œæ“ä½œå›é¥‹
5. **æ“´å±•æ€§**ï¼šè¨­è¨ˆæ™‚è€ƒæ…®æœªä¾†èˆ‡å…¶ä»–è²¡å‹™æ¨¡çµ„çš„æ•´åˆéœ€æ±‚
6. **å‚™ä»½ç­–ç•¥**ï¼šå®šæœŸå‚™ä»½é‡è¦çš„æœƒè¨ˆç§‘ç›®è³‡æ–™
7. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°é‡è¦çš„ç§‘ç›®è®Šæ›´é€²è¡Œç‰ˆæœ¬è¨˜éŒ„

## å¯¦ä½œä¸­ç™¼ç¾çš„å•é¡Œèˆ‡ä¿®æ­£

### 1. Laravel è·¯ç”±æ¨¡å‹ç¹«çµå•é¡Œ
**å•é¡Œ**ï¼šæ§åˆ¶å™¨æ–¹æ³•åƒæ•¸åç¨±èˆ‡è·¯ç”±åƒæ•¸ä¸åŒ¹é…å°è‡´æ¨¡å‹ç¹«çµå¤±æ•—
```php
// éŒ¯èª¤å¯«æ³•
Route::get('details/{detail}', [AccountDetailController::class, 'show']);
public function show(AccountDetail $accountDetail) // åƒæ•¸åç¨±ä¸åŒ¹é…

// æ­£ç¢ºå¯«æ³•
Route::get('details/{detail}', [AccountDetailController::class, 'show']);
public function show(AccountDetail $detail) // åƒæ•¸åç¨±å¿…é ˆåŒ¹é…è·¯ç”±
```

**ä¿®æ­£**ï¼šç¢ºä¿æ‰€æœ‰æ§åˆ¶å™¨æ–¹æ³•çš„åƒæ•¸åç¨±èˆ‡è·¯ç”±åƒæ•¸ä¸€è‡´ï¼š
- `show(AccountDetail $detail)`
- `edit(AccountDetail $detail)`
- `update(AccountDetailRequest $request, AccountDetail $detail)`
- `destroy(AccountDetail $detail)`
- `toggleStatus(AccountDetail $detail)`

### 2. Vue.js Props è³‡æ–™åˆå§‹åŒ–å•é¡Œ
**å•é¡Œ**ï¼šEdit.vue å’Œ Show.vue ä¸­çš„è¡¨å–®è³‡æ–™ç„¡æ³•æ­£ç¢ºè¼‰å…¥

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```javascript
// Edit.vue - æ­£ç¢ºçš„è³‡æ–™åˆå§‹åŒ–
watchEffect(async () => {
  if (!props.account) return

  // è¨­ç½®è¡¨å–®è³‡æ–™
  Object.assign(form, {
    main_category_id: props.account.main_category_id || '',
    sub_category_id: props.account.sub_category_id || '',
    // ... å…¶ä»–æ¬„ä½
  })

  // è¼‰å…¥å­åˆ†é¡
  if (form.main_category_id && subCategories.value.length === 0) {
    await fetchSubCategories(form.main_category_id)
  }
})

// Show.vue - æ­£ç¢ºçš„ props å®šç¾©
const props = defineProps({
  account: { type: Object, required: true }
})
const { account } = props
```

### 3. è·¯ç”±ç¾¤çµ„çµæ§‹ä¿®æ­£
**å¯¦éš›å¯¦ä½œçµæ§‹**ï¼šæ‰€æœ‰æœƒè¨ˆç›¸é—œè·¯ç”±éƒ½æ”¾åœ¨ `admin.accounts` ç¾¤çµ„ä¸‹
```php
Route::prefix('admin')->name('admin.')->group(function () {
    Route::prefix('accounts')->name('accounts.')->middleware('permission:view accounts')->group(function () {
        // ç¸½é¡ç®¡ç†: admin.accounts.main-categories.*
        // å­åˆ†é¡ç®¡ç†: admin.accounts.sub-categories.*
        // ç§‘ç›®æ˜ç´°ç®¡ç†: admin.accounts.account.details.*

        // API è·¯ç”±: admin.accounts.api.*
        Route::prefix('api')->name('api.')->group(function () {
            Route::get('sub-categories/by-main/{mainId}', [...]);
            Route::get('details/validate-code', [...]);
            Route::get('details/next-code', [...]);
        });
    });
});
```

### 4. å‰ç«¯è·¯ç”±å¼•ç”¨ä¿®æ­£
å°‡æ‰€æœ‰å‰ç«¯è·¯ç”±å¼•ç”¨å¾ `admin.account-details.*` ä¿®æ­£ç‚º `admin.accounts.account.details.*`ï¼š

```javascript
// ä¿®æ­£å‰
route('admin.account-details.show', account.id)

// ä¿®æ­£å¾Œ
route('admin.accounts.account.details.show', { detail: account.id })
```

---

**æ–‡ä»¶ç‰ˆæœ¬**ï¼š1.1
**æœ€å¾Œæ›´æ–°**ï¼š2025å¹´9æœˆ28æ—¥
**æ–‡ä»¶ç‹€æ…‹**ï¼šå·²ä¿®æ­£å¯¦ä½œå•é¡Œ
