# å¸³å‹™ç®¡ç†ç³»çµ±é–‹ç™¼è¦åŠƒæ–‡ä»¶

æ­¤æ–‡ä»¶ç‚ºå¸³å‹™ç®¡ç†ç³»çµ±çš„å®Œæ•´é–‹ç™¼è¦åŠƒæ–‡ä»¶ï¼Œè©³ç´°è¨˜éŒ„å°ˆæ¡ˆèƒŒæ™¯ã€éœ€æ±‚åˆ†æã€æŠ€è¡“æ¶æ§‹ã€è³‡æ–™åº«è¨­è¨ˆã€API è¨­è¨ˆã€å‰ç«¯ä»‹é¢è¨­è¨ˆã€æ¬Šé™ç®¡ç†ã€é–‹ç™¼æ™‚ç¨‹ç­‰å®Œæ•´é–‹ç™¼è—åœ–ã€‚

---

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

### ğŸ¯ å°ˆæ¡ˆèƒŒæ™¯
ä¼æ¥­é›†åœ˜éœ€è¦å»ºç«‹æ¨™æº–åŒ–çš„å¸³å‹™ç®¡ç†ç³»çµ±ï¼Œä»¥è¨˜éŒ„è²¡å‹™å’Œå¸³å‹™è™•ç†ä½œæ¥­ã€‚ç³»çµ±éœ€æ•´åˆç¾æœ‰çš„é§•é§›ç®¡ç†ã€è»Šè¼›ç®¡ç†å’Œæœƒè¨ˆç§‘ç›®ç®¡ç†ï¼Œæä¾›å®Œæ•´çš„å¸³å‹™è¨˜éŒ„åŠŸèƒ½ã€‚

### ğŸ¯ å°ˆæ¡ˆç›®æ¨™
- **ä¸»è¦ç›®æ¨™**ï¼šå»ºç«‹å®Œæ•´çš„å¸³å‹™è¨˜éŒ„ç®¡ç†ç³»çµ±
- **æ ¸å¿ƒåŠŸèƒ½**ï¼šå¸³å‹™è¨˜éŒ„çš„å»ºç«‹ã€æŸ¥è©¢ã€ç·¨è¼¯å’Œç®¡ç†
- **ç³»çµ±æ•´åˆ**ï¼šæ•´åˆé§•é§›ã€è»Šè¼›ã€æœƒè¨ˆç§‘ç›®ç­‰ç¾æœ‰æ¨¡çµ„
- **è³‡æ–™ç®¡ç†**ï¼šæ”¯æ´æ‰¹æ¬¡æ–°å¢ã€å¤šæ¢ä»¶æœå°‹ã€çµ±è¨ˆå ±è¡¨
- **ä½¿ç”¨è€…é«”é©—**ï¼šæä¾›ç›´è§€æ˜“ç”¨çš„å‹•æ…‹è¡¨æ ¼ä»‹é¢

### ğŸ¯ å°ˆæ¡ˆç¯„åœ

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„
- **æœå°‹åŠŸèƒ½**ï¼šæ”¯æ´å§“åã€è»Šç‰Œè™Ÿç¢¼ã€è»ŠéšŠç·¨è™Ÿçš„é—œéµå­—æœå°‹
- **é§•é§›åˆ—è¡¨**ï¼šé¡¯ç¤ºæœå°‹åˆ°çš„é§•é§›è³‡æ–™ï¼Œæ”¯æ´é¸æ“‡èˆ‡è©³ç´°è³‡æ–™æª¢è¦– âœ¨
- **è»Šè¼›åˆ—è¡¨**ï¼šé¡¯ç¤ºæœå°‹åˆ°çš„è»Šè¼›è³‡æ–™ï¼Œæ”¯æ´é¸æ“‡èˆ‡è©³ç´°è³‡æ–™æª¢è¦– âœ¨
- **å¸³å‹™æ–°å¢**ï¼šå‹•æ…‹è¡¨æ ¼æ‰¹æ¬¡æ–°å¢å¤šç­†å¸³å‹™è¨˜éŒ„
- **å¸³å‹™æŸ¥è©¢**ï¼šæŸ¥è©¢é§•é§›æˆ–è»Šè¼›çš„æ‰€æœ‰å¸³å‹™è¨˜éŒ„
- **å¸³å‹™ç·¨è¼¯**ï¼šä¿®æ”¹å·²å»ºç«‹çš„å¸³å‹™è¨˜éŒ„
- **å¸³å‹™åˆªé™¤**ï¼šå¤šé¸è»Ÿåˆªé™¤å¸³å‹™è¨˜éŒ„
- **çµ±è¨ˆå ±è¡¨**ï¼šå€Ÿæ–¹ã€è²¸æ–¹é‡‘é¡çµ±è¨ˆ
- **è©³ç´°è³‡æ–™æª¢è¦–**ï¼šModal å½ˆçª—é¡¯ç¤ºé§•é§›/è»Šè¼›å®Œæ•´è³‡æ–™ âœ¨ æ–°å¢åŠŸèƒ½

#### æŠ€è¡“ç¯„åœ
- **å¾Œç«¯é–‹ç™¼**ï¼šLaravel 11.x + PHP 8.4+
- **å‰ç«¯é–‹ç™¼**ï¼šVue 3 + Inertia.js + AdminLTE 4
- **è³‡æ–™åº«è¨­è¨ˆ**ï¼šSQLiteï¼ˆé–‹ç™¼ï¼‰/ MySQLï¼ˆæ­£å¼ï¼‰
- **æ¬Šé™ç®¡ç†**ï¼šæ•´åˆç¾æœ‰ Position (è·å‹™) ç³»çµ±
- **æ¸¬è©¦è¦†è“‹**ï¼šå–®å…ƒæ¸¬è©¦å’ŒåŠŸèƒ½æ¸¬è©¦

---

## ğŸ¬ ä½¿ç”¨è€…æ“ä½œæµç¨‹

### æ¨™æº–æ“ä½œæµç¨‹

#### 1ï¸âƒ£ æœå°‹é§•é§›æˆ–è»Šè¼›
```
ä½¿ç”¨è€…è¼¸å…¥é—œéµå­— â†’ é¸æ“‡æœå°‹é¡å‹ï¼ˆå§“å/è»Šç‰Œ/è»ŠéšŠç·¨è™Ÿï¼‰â†’ é»æ“Šæœå°‹
```

**ç³»çµ±è¡Œç‚º**ï¼š
- åŸ·è¡Œæœå°‹ä¸¦é¡¯ç¤ºç¬¦åˆæ¢ä»¶çš„é§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨
- å¦‚æœæœ‰æœå°‹çµæœï¼Œè‡ªå‹•åŸ·è¡Œä»¥ä¸‹é¸æ“‡é‚è¼¯

#### 2ï¸âƒ£ è‡ªå‹•é¸æ“‡èˆ‡è¼‰å…¥é‚è¼¯

**é è¨­é¸æ“‡è¦å‰‡**ï¼ˆè‡ªå‹•åŸ·è¡Œï¼‰ï¼š
```
æœå°‹å¾Œè‡ªå‹•é¸æ“‡ï¼š
1. IF æœ‰é§•é§›åˆ—è¡¨è³‡æ–™ THEN è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹é§•é§›ï¼ˆé«˜äº®é¡¯ç¤ºï¼‰
2. IF æœ‰è»Šè¼›åˆ—è¡¨è³‡æ–™ THEN è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹è»Šè¼›ï¼ˆé«˜äº®é¡¯ç¤ºï¼‰

é¡¯ç¤ºå¸³å‹™è¨˜éŒ„å„ªå…ˆé †åºï¼š
IF æœ‰é¸æ“‡é§•é§› THEN
    é¡¯ç¤ºè©²é§•é§›çš„å¸³å‹™è¨˜éŒ„
ELSE IF æœ‰é¸æ“‡è»Šè¼› THEN
    é¡¯ç¤ºè©²è»Šè¼›çš„å¸³å‹™è¨˜éŒ„
END IF
```

**é‡è¦ç‰¹æ€§**ï¼š
1. âœ… **é›™åˆ—è¡¨é¸æ“‡**ï¼šé§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨éƒ½æœƒé¡¯ç¤ºé¸ä¸­ç‹€æ…‹ï¼ˆå„è‡ªç¨ç«‹é«˜äº®ï¼‰
2. âœ… **å„ªå…ˆé¡¯ç¤ºé§•é§›**ï¼šåŒæ™‚æœ‰é§•é§›å’Œè»Šè¼›æ™‚ï¼Œå„ªå…ˆé¡¯ç¤ºé§•é§›å¸³å‹™è¨˜éŒ„
3. âœ… **å¯è‡ªç”±åˆ‡æ›**ï¼šä½¿ç”¨è€…é»é¸ä»»ä¸€åˆ—è¡¨é …ç›®ï¼Œæœƒåˆ‡æ›é¡¯ç¤ºè©²å°è±¡çš„å¸³å‹™è¨˜éŒ„
4. âœ… **ä¿æŒé¸æ“‡ç‹€æ…‹**ï¼šåˆ‡æ›é¡¯ç¤ºæ™‚ï¼Œå…©å€‹åˆ—è¡¨çš„é¸ä¸­ç‹€æ…‹éƒ½ä¿ç•™ï¼ˆä¸æœƒæ¸…ç©ºï¼‰

**ä½¿ç”¨è€…å¯æ“ä½œ**ï¼š
- âœ… é»é¸é§•é§›åˆ—è¡¨ä¸­çš„ä»»ä¸€é§•é§› â†’ åˆ‡æ›æŸ¥çœ‹è©²é§•é§›çš„å¸³å‹™è¨˜éŒ„
- âœ… é»é¸è»Šè¼›åˆ—è¡¨ä¸­çš„ä»»ä¸€è»Šè¼› â†’ åˆ‡æ›æŸ¥çœ‹è©²è»Šè¼›çš„å¸³å‹™è¨˜éŒ„
- âœ… å…©å€‹åˆ—è¡¨éƒ½ä¿æŒå„è‡ªçš„é¸ä¸­ç‹€æ…‹ï¼ˆè¦–è¦ºæç¤ºï¼‰

#### 3ï¸âƒ£ å¸³å‹™è¨˜éŒ„é¡¯ç¤º

**é¡¯ç¤ºæ¢ä»¶**ï¼š
- åªè¦é¸æ“‡äº†é§•é§›æˆ–è»Šè¼›ï¼Œå°±æœƒé¡¯ç¤ºå¸³å‹™è¨˜éŒ„åˆ—è¡¨å¡ç‰‡
- å³ä½¿è©²é§•é§›/è»Šè¼›æ²’æœ‰ä»»ä½•å¸³å‹™è¨˜éŒ„ï¼Œä¹Ÿæœƒé¡¯ç¤ºåˆ—è¡¨ï¼ˆé¡¯ç¤ºã€Œç›®å‰æ²’æœ‰å¸³å‹™è¨˜éŒ„ã€ï¼‰

**çµ±è¨ˆè³‡è¨Š**ï¼š
- è‡ªå‹•è¨ˆç®—ä¸¦é¡¯ç¤ºï¼šå€Ÿæ–¹åŠ ç¸½ã€è²¸æ–¹åŠ ç¸½ã€é¤˜é¡ï¼ˆå€Ÿ-è²¸ï¼‰
- æ²’æœ‰è¨˜éŒ„æ™‚é¡¯ç¤º 0.00

#### 4ï¸âƒ£ æ–°å¢å¸³å‹™è¨˜éŒ„

**æ“ä½œæµç¨‹**ï¼š
```
é¸æ“‡é§•é§›/è»Šè¼› â†’ é¡¯ç¤ºå¸³å‹™æ–°å¢è¡¨æ ¼ â†’ å¡«å¯«å¸³å‹™è³‡æ–™ â†’ é»æ“Šã€Œç¢ºå®šæ–°å¢ã€
```

**ç³»çµ±è¡Œç‚º**ï¼ˆæ–°å¢å¾Œï¼‰ï¼š
- âœ… **ä¿ç•™æœå°‹çµæœ**ï¼šé§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨ä¸æœƒæ¶ˆå¤±
- âœ… **ä¿ç•™é¸æ“‡ç‹€æ…‹**ï¼šç•¶å‰é¸æ“‡çš„é§•é§›/è»Šè¼›ä¿æŒé¸ä¸­
- âœ… **æ›´æ–°å¸³å‹™åˆ—è¡¨**ï¼šè‡ªå‹•é‡æ–°è¼‰å…¥å¸³å‹™è¨˜éŒ„ï¼Œé¡¯ç¤ºå‰›æ–°å¢çš„è¨˜éŒ„
- âœ… **æ›´æ–°çµ±è¨ˆè³‡è¨Š**ï¼šè‡ªå‹•é‡æ–°è¨ˆç®—å€Ÿæ–¹ã€è²¸æ–¹ã€é¤˜é¡

#### 5ï¸âƒ£ ç·¨è¼¯èˆ‡åˆªé™¤

**ç·¨è¼¯æµç¨‹**ï¼š
```
é»æ“Šè¨˜éŒ„çš„ç·¨è¼¯æŒ‰éˆ• â†’ ä¿®æ”¹è³‡æ–™ â†’ å„²å­˜
```

**åˆªé™¤æµç¨‹**ï¼š
```
å‹¾é¸è¦åˆªé™¤çš„è¨˜éŒ„ â†’ é»æ“Šã€Œåˆªé™¤é¸å–é …ç›®ã€â†’ ç¢ºèªåˆªé™¤
```

**ç³»çµ±è¡Œç‚º**ï¼ˆç·¨è¼¯/åˆªé™¤å¾Œï¼‰ï¼š
- âœ… ä¿ç•™æœå°‹çµæœå’Œé¸æ“‡ç‹€æ…‹
- âœ… è‡ªå‹•æ›´æ–°å¸³å‹™åˆ—è¡¨å’Œçµ±è¨ˆè³‡è¨Š

---

## ğŸ”„ äº’å‹•æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœå°‹é é¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¼¸å…¥é—œéµå­— + é¸æ“‡æœå°‹é¡å‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸ·è¡Œæœå°‹                        â”‚
â”‚  â€¢ é¡¯ç¤ºé§•é§›åˆ—è¡¨                  â”‚
â”‚  â€¢ é¡¯ç¤ºè»Šè¼›åˆ—è¡¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªå‹•é¸æ“‡é‚è¼¯ï¼ˆé›™åˆ—è¡¨ï¼‰          â”‚
â”‚  1. æœ‰é§•é§› â†’ é¸ç¬¬ä¸€å€‹é§•é§›âœ…      â”‚
â”‚  2. æœ‰è»Šè¼› â†’ é¸ç¬¬ä¸€å€‹è»Šè¼›âœ…      â”‚
â”‚  (å…©å€‹åˆ—è¡¨å„è‡ªç¨ç«‹é«˜äº®)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªå‹•è¼‰å…¥å¸³å‹™è¨˜éŒ„ï¼ˆå„ªå…ˆé§•é§›ï¼‰    â”‚
â”‚  IF æœ‰é§•é§› THEN                  â”‚
â”‚    é¡¯ç¤ºé§•é§›å¸³å‹™è¨˜éŒ„              â”‚
â”‚  ELSE                            â”‚
â”‚    é¡¯ç¤ºè»Šè¼›å¸³å‹™è¨˜éŒ„              â”‚
â”‚  â€¢ é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š                  â”‚
â”‚  â€¢ é¡¯ç¤ºæ–°å¢è¡¨æ ¼                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ æ‰‹å‹•é»é¸é§•é§›ï¼ˆåˆ‡æ›é¡¯ç¤ºé§•é§›å¸³å‹™ï¼Œä¿ç•™è»Šè¼›é¸æ“‡ï¼‰
       â”œâ”€â”€â†’ æ‰‹å‹•é»é¸è»Šè¼›ï¼ˆåˆ‡æ›é¡¯ç¤ºè»Šè¼›å¸³å‹™ï¼Œä¿ç•™é§•é§›é¸æ“‡ï¼‰
       â”‚
       â”œâ”€â”€â†’ æ–°å¢å¸³å‹™è¨˜éŒ„
       â”‚         â”‚
       â”‚         â–¼
       â”‚    ä¿ç•™æœå°‹çµæœ + é¸æ“‡
       â”‚    æ›´æ–°åˆ—è¡¨ + çµ±è¨ˆ
       â”‚
       â”œâ”€â”€â†’ ç·¨è¼¯å¸³å‹™è¨˜éŒ„
       â”‚         â”‚
       â”‚         â–¼
       â”‚    ä¿ç•™æœå°‹çµæœ + é¸æ“‡
       â”‚    æ›´æ–°åˆ—è¡¨ + çµ±è¨ˆ
       â”‚
       â””â”€â”€â†’ åˆªé™¤å¸³å‹™è¨˜éŒ„
                 â”‚
                 â–¼
            ä¿ç•™æœå°‹çµæœ + é¸æ“‡
            æ›´æ–°åˆ—è¡¨ + çµ±è¨ˆ
```

---

## ğŸ’¡ ä½¿ç”¨è€…é«”é©—é‡é»

### âœ… ç›´è§€æ€§
- æœå°‹å¾Œè‡ªå‹•é¸æ“‡ç¬¬ä¸€ç­†ï¼Œæ¸›å°‘æ“ä½œæ­¥é©Ÿ
- å„ªå…ˆé¡¯ç¤ºé§•é§›å¸³å‹™ï¼ˆç¬¦åˆæ¥­å‹™é‚è¼¯ï¼‰

### âœ… ä¸€è‡´æ€§
- æ‰€æœ‰æ“ä½œï¼ˆæ–°å¢/ç·¨è¼¯/åˆªé™¤ï¼‰å¾Œéƒ½ä¿æŒæœå°‹ç‹€æ…‹
- ä¸éœ€è¦é‡æ–°æœå°‹ï¼Œæå‡æ•ˆç‡

### âœ… å®¹éŒ¯æ€§
- å³ä½¿æ²’æœ‰å¸³å‹™è¨˜éŒ„ï¼Œä¹Ÿæœƒé¡¯ç¤ºä»‹é¢
- æ¸…æ¥šæç¤ºã€Œç›®å‰æ²’æœ‰å¸³å‹™è¨˜éŒ„ã€

### âœ… éˆæ´»æ€§
- è‡ªå‹•é¸æ“‡ä¸å½±éŸ¿æ‰‹å‹•åˆ‡æ›
- é§•é§›èˆ‡è»Šè¼›å¯è‡ªç”±åˆ‡æ›æŸ¥çœ‹

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### è³‡æ–™è¡¨çµæ§‹æ¦‚è¦½

å¸³å‹™ç®¡ç†ç³»çµ±çš„æ ¸å¿ƒè³‡æ–™è¡¨é—œè¯ï¼š

```
Users (ä½¿ç”¨è€…)
    â†“ (å»ºç«‹è€…)
AccountingRecords (å¸³å‹™è¨˜éŒ„)
    â†“ (N:1)
    â”œâ”€â”€ Drivers (é§•é§›) - nullable
    â”œâ”€â”€ Vehicles (è»Šè¼›) - nullable
    â””â”€â”€ AccountDetails (æœƒè¨ˆç§‘ç›®æ˜ç´°) - required
        â†“ (N:1)
        â”œâ”€â”€ AccountMainCategories (æœƒè¨ˆç§‘ç›®ç¸½é¡)
        â””â”€â”€ AccountSubCategories (æœƒè¨ˆç§‘ç›®å­åˆ†é¡)
```

### 1. å¸³å‹™è¨˜éŒ„ä¸»è³‡æ–™è¡¨ (accounting_records)

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | é•·åº¦ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | ä¸»éµ |
| driver_id | BIGINT | - | FOREIGN KEY, NULLABLE | é§•é§›å¤–éµ (drivers.id) |
| vehicle_id | BIGINT | - | FOREIGN KEY, NULLABLE | è»Šè¼›å¤–éµ (vehicles.id) |
| account_detail_id | BIGINT | - | FOREIGN KEY, NOT NULL | æœƒè¨ˆç§‘ç›®å¤–éµ (account_details.id) |
| transaction_date | DATE | - | NOT NULL | äº¤æ˜“æ—¥æœŸ |
| driver_name | VARCHAR | 100 | NULLABLE | é§•é§›å§“åï¼ˆå†—ä½™æ¬„ä½ï¼Œä¿å­˜æ­·å²è¨˜éŒ„ï¼‰ |
| driver_id_number | VARCHAR | 20 | NULLABLE | é§•é§›èº«åˆ†è­‰å­—è™Ÿï¼ˆå†—ä½™æ¬„ä½ï¼‰ |
| vehicle_license_number | VARCHAR | 20 | NULLABLE | è»Šç‰Œè™Ÿç¢¼ï¼ˆå†—ä½™æ¬„ä½ï¼‰ |
| debit_amount | DECIMAL | 15,2 | NULLABLE | å€Ÿæ–¹é‡‘é¡ |
| credit_amount | DECIMAL | 15,2 | NULLABLE | è²¸æ–¹é‡‘é¡ |
| note | TEXT | - | NULLABLE | å‚™è¨» |
| created_by | BIGINT | - | FOREIGN KEY, NOT NULL | å»ºç«‹è€… (users.id) |
| updated_by | BIGINT | - | FOREIGN KEY, NULLABLE | æœ€å¾Œæ›´æ–°è€… (users.id) |
| created_at | TIMESTAMP | - | NOT NULL | å»ºç«‹æ™‚é–“ |
| updated_at | TIMESTAMP | - | NOT NULL | æ›´æ–°æ™‚é–“ |
| deleted_at | TIMESTAMP | - | NULLABLE | è»Ÿåˆªé™¤æ™‚é–“ |

**è¨­è¨ˆèªªæ˜**ï¼š
1. **å†—ä½™æ¬„ä½è¨­è¨ˆ**ï¼š`driver_name`ã€`driver_id_number`ã€`vehicle_license_number` é›–ç„¶å¯é€éé—œè¯å–å¾—ï¼Œä½†ç‚ºäº†ï¼š
   - **æ•ˆèƒ½è€ƒé‡**ï¼šé¿å…å¤šæ¬¡ JOIN æŸ¥è©¢
   - **æ­·å²è¨˜éŒ„**ï¼šä¿å­˜å»ºç«‹æ™‚çš„è³‡æ–™ç‹€æ…‹ï¼Œå³ä½¿é§•é§›æˆ–è»Šè¼›è³‡æ–™è¢«ä¿®æ”¹æˆ–åˆªé™¤ï¼Œå¸³å‹™è¨˜éŒ„ä»ä¿æŒåŸå§‹è³‡è¨Š

2. **é‡‘é¡æ¬„ä½**ï¼šä½¿ç”¨ DECIMAL(15,2) ç¢ºä¿ç²¾ç¢ºè¨ˆç®—ï¼Œé¿å…æµ®é»æ•¸èª¤å·®

3. **è»Ÿåˆªé™¤**ï¼šä½¿ç”¨ `deleted_at` å¯¦ç¾è»Ÿåˆªé™¤ï¼Œä¿ç•™æ­·å²è¨˜éŒ„ç”¨æ–¼å¯©è¨ˆ

**ç´¢å¼•è¨­è¨ˆ**
```sql
-- ä¸»éµ
PRIMARY KEY: `id`

-- å¤–éµç´¢å¼•
INDEX: `driver_id`
INDEX: `vehicle_id`
INDEX: `account_detail_id`
INDEX: `created_by`

-- æŸ¥è©¢å„ªåŒ–ç´¢å¼•
INDEX: `transaction_date`
INDEX: `deleted_at` (ç”¨æ–¼è»Ÿåˆªé™¤æŸ¥è©¢)
COMPOSITE INDEX: `driver_id, transaction_date` (é§•é§›å¸³å‹™æŸ¥è©¢å„ªåŒ–)
COMPOSITE INDEX: `vehicle_id, transaction_date` (è»Šè¼›å¸³å‹™æŸ¥è©¢å„ªåŒ–)

-- æœå°‹ç´¢å¼•
INDEX: `driver_name`
INDEX: `driver_id_number`
INDEX: `vehicle_license_number`
```

**CHECK ç´„æŸ**
```sql
-- ç¢ºä¿å€Ÿæ–¹æˆ–è²¸æ–¹è‡³å°‘æœ‰ä¸€å€‹æœ‰å€¼
CONSTRAINT chk_amount CHECK (
    (debit_amount IS NOT NULL AND debit_amount > 0) OR
    (credit_amount IS NOT NULL AND credit_amount > 0)
)

-- ç¢ºä¿é‡‘é¡ä¸ç‚ºè² æ•¸
CONSTRAINT chk_debit_positive CHECK (debit_amount IS NULL OR debit_amount >= 0)
CONSTRAINT chk_credit_positive CHECK (credit_amount IS NULL OR credit_amount >= 0)
```

### å¤–éµç´„æŸé—œä¿‚

```sql
-- å¸³å‹™è¨˜éŒ„è¡¨å¤–éµç´„æŸ
ALTER TABLE accounting_records
    -- é§•é§›å¤–éµ (nullable, åˆªé™¤é§•é§›æ™‚ä¿ç•™è¨˜éŒ„)
    ADD CONSTRAINT fk_accounting_records_driver
    FOREIGN KEY (driver_id) REFERENCES drivers(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- è»Šè¼›å¤–éµ (nullable, åˆªé™¤è»Šè¼›æ™‚ä¿ç•™è¨˜éŒ„)
    ADD CONSTRAINT fk_accounting_records_vehicle
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- æœƒè¨ˆç§‘ç›®å¤–éµ (required, ä¸å…è¨±åˆªé™¤å·²ä½¿ç”¨çš„ç§‘ç›®)
    ADD CONSTRAINT fk_accounting_records_account_detail
    FOREIGN KEY (account_detail_id) REFERENCES account_details(id)
    ON DELETE RESTRICT ON UPDATE CASCADE,

    -- å»ºç«‹è€…å¤–éµ (åˆªé™¤ä½¿ç”¨è€…æ™‚ä¿ç•™è¨˜éŒ„)
    ADD CONSTRAINT fk_accounting_records_created_by
    FOREIGN KEY (created_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- æ›´æ–°è€…å¤–éµ
    ADD CONSTRAINT fk_accounting_records_updated_by
    FOREIGN KEY (updated_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE;
```

### è³‡æ–™åº«è¨­è¨ˆè¦é»

#### 1. è³‡æ–™å®Œæ•´æ€§ä¿éšœ
- ä½¿ç”¨å¤–éµç´„æŸç¢ºä¿åƒç…§å®Œæ•´æ€§
- ä½¿ç”¨ CHECK ç´„æŸç¢ºä¿æ¥­å‹™é‚è¼¯æ­£ç¢ºæ€§
- è»Ÿåˆªé™¤æ©Ÿåˆ¶ä¿è­·æ­·å²è³‡æ–™

#### 2. æ•ˆèƒ½æœ€ä½³åŒ–è€ƒé‡
- é‡å°å¸¸ç”¨æŸ¥è©¢æ¢ä»¶å»ºç«‹è¤‡åˆç´¢å¼•
- å†—ä½™æ¬„ä½æ¸›å°‘ JOIN æŸ¥è©¢
- é©ç•¶çš„è³‡æ–™å‹æ…‹æ¸›å°‘å„²å­˜ç©ºé–“

#### 3. æ­·å²è¨˜éŒ„ä¿å­˜
- å†—ä½™æ¬„ä½ä¿å­˜å¿«ç…§è³‡æ–™
- è»Ÿåˆªé™¤ä¿ç•™å¯©è¨ˆè¿½è¹¤
- `created_by` å’Œ `updated_by` è¨˜éŒ„æ“ä½œè€…

---

## âš™ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### å¾Œç«¯æ¶æ§‹è¨­è¨ˆ

#### æ§åˆ¶å™¨æ¶æ§‹ (Controllers)

```php
// æ§åˆ¶å™¨çµæ§‹
app/Http/Controllers/Admin/
â””â”€â”€ AccountingRecordController.php     // å¸³å‹™è¨˜éŒ„ç®¡ç†
```

**æ§åˆ¶å™¨è¨­è¨ˆæ¨¡å¼**
```php
<?php
namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Http\Requests\AccountingRecordRequest;
use App\Models\AccountingRecord;
use App\Models\Driver;
use App\Models\Vehicle;
use App\Services\AccountingRecordService;
use Illuminate\Http\Request;
use Inertia\Inertia;

class AccountingRecordController extends Controller
{
    protected $accountingRecordService;

    public function __construct(AccountingRecordService $accountingRecordService)
    {
        $this->accountingRecordService = $accountingRecordService;
    }

    /**
     * é¡¯ç¤ºå¸³å‹™ç®¡ç†ä¸»é é¢
     */
    public function index(Request $request)
    {
        // è™•ç†æœå°‹é‚è¼¯
        $searchType = $request->input('search_type'); // name, license, fleet
        $keyword = $request->input('keyword');

        $drivers = [];
        $vehicles = [];
        $records = [];
        $statistics = null;

        if ($keyword) {
            // æ ¹æ“šæœå°‹é¡å‹åŸ·è¡Œæœå°‹
            $result = $this->accountingRecordService->search($searchType, $keyword);
            $drivers = $result['drivers'];
            $vehicles = $result['vehicles'];
        }

        // å¦‚æœæœ‰é¸æ“‡çš„é§•é§›æˆ–è»Šè¼›ï¼Œè¼‰å…¥å¸³å‹™è¨˜éŒ„
        $selectedDriverId = $request->input('driver_id');
        $selectedVehicleId = $request->input('vehicle_id');

        if ($selectedDriverId || $selectedVehicleId) {
            $records = $this->accountingRecordService->getRecords(
                $selectedDriverId,
                $selectedVehicleId
            );
            $statistics = $this->accountingRecordService->calculateStatistics($records);
        }

        return Inertia::render('Admin/AccountingRecords/Index', [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
            'records' => $records,
            'statistics' => $statistics,
            'filters' => [
                'search_type' => $searchType,
                'keyword' => $keyword,
                'driver_id' => $selectedDriverId,
                'vehicle_id' => $selectedVehicleId,
            ]
        ]);
    }

    /**
     * æ‰¹æ¬¡å„²å­˜å¸³å‹™è¨˜éŒ„
     */
    public function store(AccountingRecordRequest $request)
    {
        try {
            $records = $this->accountingRecordService->batchCreate(
                $request->validated()
            );

            return redirect()
                ->route('admin.accounting-records.index')
                ->with('success', 'æˆåŠŸæ–°å¢ ' . count($records) . ' ç­†å¸³å‹™è¨˜éŒ„');

        } catch (\Exception $e) {
            return back()
                ->withErrors(['error' => 'æ–°å¢å¤±æ•—ï¼š' . $e->getMessage()])
                ->withInput();
        }
    }

    /**
     * æ›´æ–°å–®ç­†å¸³å‹™è¨˜éŒ„
     */
    public function update(AccountingRecordRequest $request, AccountingRecord $accountingRecord)
    {
        try {
            $this->accountingRecordService->update($accountingRecord, $request->validated());

            return back()->with('success', 'å¸³å‹™è¨˜éŒ„å·²æ›´æ–°');

        } catch (\Exception $e) {
            return back()->withErrors(['error' => 'æ›´æ–°å¤±æ•—ï¼š' . $e->getMessage()]);
        }
    }

    /**
     * æ‰¹æ¬¡è»Ÿåˆªé™¤å¸³å‹™è¨˜éŒ„
     */
    public function batchDestroy(Request $request)
    {
        $request->validate([
            'ids' => 'required|array',
            'ids.*' => 'exists:accounting_records,id'
        ]);

        try {
            $count = $this->accountingRecordService->batchDelete($request->ids);

            return back()->with('success', "æˆåŠŸåˆªé™¤ {$count} ç­†å¸³å‹™è¨˜éŒ„");

        } catch (\Exception $e) {
            return back()->withErrors(['error' => 'åˆªé™¤å¤±æ•—ï¼š' . $e->getMessage()]);
        }
    }

    /**
     * API: æœå°‹æœƒè¨ˆç§‘ç›®
     */
    public function searchAccountDetails(Request $request)
    {
        $keyword = $request->input('keyword');

        $accounts = $this->accountingRecordService->searchAccountDetails($keyword);

        return response()->json($accounts);
    }
}
```

#### æ¨¡å‹æ¶æ§‹ (Models)

**AccountingRecord æ¨¡å‹è¨­è¨ˆ**
```php
<?php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\SoftDeletes;

class AccountingRecord extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'driver_id',
        'vehicle_id',
        'account_detail_id',
        'transaction_date',
        'driver_name',
        'driver_id_number',
        'vehicle_license_number',
        'debit_amount',
        'credit_amount',
        'note',
        'created_by',
        'updated_by',
    ];

    protected $casts = [
        'transaction_date' => 'date',
        'debit_amount' => 'decimal:2',
        'credit_amount' => 'decimal:2',
    ];

    /**
     * é—œè¯ï¼šé§•é§›
     */
    public function driver(): BelongsTo
    {
        return $this->belongsTo(Driver::class)->withTrashed();
    }

    /**
     * é—œè¯ï¼šè»Šè¼›
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(Vehicle::class)->withTrashed();
    }

    /**
     * é—œè¯ï¼šæœƒè¨ˆç§‘ç›®æ˜ç´°
     */
    public function accountDetail(): BelongsTo
    {
        return $this->belongsTo(AccountDetail::class);
    }

    /**
     * é—œè¯ï¼šå»ºç«‹è€…
     */
    public function creator(): BelongsTo
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /**
     * é—œè¯ï¼šæ›´æ–°è€…
     */
    public function updater(): BelongsTo
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    /**
     * è‡ªå‹•å¡«å…¥å»ºç«‹è€…
     */
    protected static function boot()
    {
        parent::boot();

        static::creating(function ($model) {
            if (auth()->check()) {
                $model->created_by = auth()->id();
            }
        });

        static::updating(function ($model) {
            if (auth()->check()) {
                $model->updated_by = auth()->id();
            }
        });
    }

    /**
     * Scope: ä¾é§•é§›ç¯©é¸
     */
    public function scopeByDriver($query, $driverId)
    {
        return $query->where('driver_id', $driverId);
    }

    /**
     * Scope: ä¾è»Šè¼›ç¯©é¸
     */
    public function scopeByVehicle($query, $vehicleId)
    {
        return $query->where('vehicle_id', $vehicleId);
    }

    /**
     * Scope: ä¾æ—¥æœŸç¯„åœç¯©é¸
     */
    public function scopeDateRange($query, $startDate, $endDate)
    {
        return $query->whereBetween('transaction_date', [$startDate, $endDate]);
    }

    /**
     * Scope: ä¾é—œéµå­—æœå°‹
     */
    public function scopeSearch($query, $keyword)
    {
        return $query->where(function($q) use ($keyword) {
            $q->where('driver_name', 'like', "%{$keyword}%")
              ->orWhere('driver_id_number', 'like', "%{$keyword}%")
              ->orWhere('vehicle_license_number', 'like', "%{$keyword}%")
              ->orWhere('note', 'like', "%{$keyword}%");
        });
    }
}
```

#### æœå‹™å±¤è¨­è¨ˆ (Services)

**AccountingRecordService**
```php
<?php
namespace App\Services;

use App\Models\AccountingRecord;
use App\Models\AccountDetail;
use App\Models\Driver;
use App\Models\Vehicle;
use App\Models\DriverVehicleAssignment;
use Illuminate\Support\Facades\DB;

class AccountingRecordService
{
    /**
     * æœå°‹åŠŸèƒ½
     */
    public function search(string $searchType, string $keyword): array
    {
        $drivers = [];
        $vehicles = [];

        switch ($searchType) {
            case 'name':
                // æœå°‹é§•é§›å§“å
                $drivers = Driver::where('name', 'like', "%{$keyword}%")
                    ->select('id', 'name', 'id_number', 'birth_date')
                    ->get();

                // é€éé§•é§›æ‰¾è»Šè¼›
                if ($drivers->isNotEmpty()) {
                    $driverIds = $drivers->pluck('id');
                    $vehicleIds = DriverVehicleAssignment::whereIn('driver_id', $driverIds)
                        ->pluck('vehicle_id');
                    $vehicles = Vehicle::whereIn('id', $vehicleIds)
                        ->select('id', 'license_number', 'fleet_number', 'owner_name')
                        ->get();
                }
                break;

            case 'license':
                // æœå°‹è»Šç‰Œè™Ÿç¢¼
                $vehicles = Vehicle::where('license_number', 'like', "%{$keyword}%")
                    ->select('id', 'license_number', 'fleet_number', 'owner_name')
                    ->get();

                // é€éè»Šè¼›æ‰¾é§•é§›
                if ($vehicles->isNotEmpty()) {
                    $vehicleIds = $vehicles->pluck('id');
                    $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
                        ->pluck('driver_id');
                    $drivers = Driver::whereIn('id', $driverIds)
                        ->select('id', 'name', 'id_number', 'birth_date')
                        ->get();
                }
                break;

            case 'fleet':
                // æœå°‹è»ŠéšŠç·¨è™Ÿ
                $vehicles = Vehicle::where('fleet_number', 'like', "%{$keyword}%")
                    ->select('id', 'license_number', 'fleet_number', 'owner_name')
                    ->get();

                // é€éè»Šè¼›æ‰¾é§•é§›
                if ($vehicles->isNotEmpty()) {
                    $vehicleIds = $vehicles->pluck('id');
                    $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
                        ->pluck('driver_id');
                    $drivers = Driver::whereIn('id', $driverIds)
                        ->select('id', 'name', 'id_number', 'birth_date')
                        ->get();
                }
                break;
        }

        return [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
        ];
    }

    /**
     * å–å¾—å¸³å‹™è¨˜éŒ„
     */
    public function getRecords($driverId = null, $vehicleId = null)
    {
        $query = AccountingRecord::with(['accountDetail.mainCategory', 'accountDetail.subCategory']);

        if ($driverId) {
            $query->byDriver($driverId);
        } elseif ($vehicleId) {
            $query->byVehicle($vehicleId);
        }

        return $query->orderBy('transaction_date', 'desc')
            ->orderBy('created_at', 'desc')
            ->paginate(20);
    }

    /**
     * è¨ˆç®—çµ±è¨ˆæ•¸æ“š
     */
    public function calculateStatistics($records): array
    {
        $debitTotal = 0;
        $creditTotal = 0;

        foreach ($records as $record) {
            $debitTotal += $record->debit_amount ?? 0;
            $creditTotal += $record->credit_amount ?? 0;
        }

        $balance = $debitTotal - $creditTotal;

        return [
            'debit_total' => number_format($debitTotal, 2),
            'credit_total' => number_format($creditTotal, 2),
            'balance' => number_format($balance, 2),
            'balance_is_negative' => $balance < 0,
        ];
    }

    /**
     * æ‰¹æ¬¡å»ºç«‹å¸³å‹™è¨˜éŒ„
     */
    public function batchCreate(array $data): array
    {
        $records = [];

        DB::beginTransaction();

        try {
            foreach ($data['records'] as $recordData) {
                // æª¢æŸ¥é‡è¤‡è¨˜éŒ„ï¼ˆè­¦å‘Šä½†å…è¨±ï¼‰
                $this->checkDuplicateWarning($recordData);

                // å–å¾—é§•é§›è³‡æ–™
                $driver = null;
                if (!empty($recordData['driver_id'])) {
                    $driver = Driver::find($recordData['driver_id']);
                }

                // å–å¾—è»Šè¼›è³‡æ–™
                $vehicle = null;
                if (!empty($recordData['vehicle_id'])) {
                    $vehicle = Vehicle::find($recordData['vehicle_id']);
                }

                // å»ºç«‹è¨˜éŒ„
                $record = AccountingRecord::create([
                    'driver_id' => $recordData['driver_id'] ?? null,
                    'vehicle_id' => $recordData['vehicle_id'] ?? null,
                    'account_detail_id' => $recordData['account_detail_id'],
                    'transaction_date' => $recordData['transaction_date'],
                    'driver_name' => $driver ? $driver->name : null,
                    'driver_id_number' => $driver ? $driver->id_number : null,
                    'vehicle_license_number' => $vehicle ? $vehicle->license_number : null,
                    'debit_amount' => $recordData['debit_amount'] ?? null,
                    'credit_amount' => $recordData['credit_amount'] ?? null,
                    'note' => $recordData['note'] ?? null,
                ]);

                $records[] = $record;
            }

            DB::commit();

            return $records;

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }

    /**
     * æ›´æ–°å¸³å‹™è¨˜éŒ„
     */
    public function update(AccountingRecord $record, array $data): AccountingRecord
    {
        DB::beginTransaction();

        try {
            // å¦‚æœæ›´æ”¹äº†é§•é§›ï¼Œæ›´æ–°å†—ä½™æ¬„ä½
            if (isset($data['driver_id']) && $data['driver_id'] != $record->driver_id) {
                $driver = Driver::find($data['driver_id']);
                $data['driver_name'] = $driver ? $driver->name : null;
                $data['driver_id_number'] = $driver ? $driver->id_number : null;
            }

            // å¦‚æœæ›´æ”¹äº†è»Šè¼›ï¼Œæ›´æ–°å†—ä½™æ¬„ä½
            if (isset($data['vehicle_id']) && $data['vehicle_id'] != $record->vehicle_id) {
                $vehicle = Vehicle::find($data['vehicle_id']);
                $data['vehicle_license_number'] = $vehicle ? $vehicle->license_number : null;
            }

            $record->update($data);

            DB::commit();

            return $record->fresh();

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }

    /**
     * æ‰¹æ¬¡åˆªé™¤ï¼ˆè»Ÿåˆªé™¤ï¼‰
     */
    public function batchDelete(array $ids): int
    {
        return AccountingRecord::whereIn('id', $ids)->delete();
    }

    /**
     * æœå°‹æœƒè¨ˆç§‘ç›®
     */
    public function searchAccountDetails(string $keyword): array
    {
        return AccountDetail::with(['mainCategory', 'subCategory'])
            ->where('account_code', 'like', "{$keyword}%")
            ->orWhere('account_name', 'like', "%{$keyword}%")
            ->where('is_active', true)
            ->orderBy('account_code')
            ->limit(20)
            ->get()
            ->map(function ($account) {
                return [
                    'id' => $account->id,
                    'account_code' => $account->account_code,
                    'account_name' => $account->account_name,
                    'main_category_name' => $account->mainCategory->category_name,
                    'sub_category_name' => $account->subCategory->sub_category_name,
                ];
            })
            ->toArray();
    }

    /**
     * æª¢æŸ¥é‡è¤‡è¨˜éŒ„ï¼ˆåƒ…è­¦å‘Šï¼‰
     */
    protected function checkDuplicateWarning(array $data): void
    {
        $duplicate = AccountingRecord::where('driver_id', $data['driver_id'] ?? null)
            ->where('vehicle_id', $data['vehicle_id'] ?? null)
            ->where('account_detail_id', $data['account_detail_id'])
            ->where('transaction_date', $data['transaction_date'])
            ->where('debit_amount', $data['debit_amount'] ?? null)
            ->where('credit_amount', $data['credit_amount'] ?? null)
            ->exists();

        if ($duplicate) {
            \Log::warning('å¯èƒ½çš„é‡è¤‡å¸³å‹™è¨˜éŒ„', $data);
            // é€™è£¡åªè¨˜éŒ„è­¦å‘Šï¼Œä¸é˜»æ­¢æ–°å¢
        }
    }
}
```

#### è«‹æ±‚é©—è­‰ (Form Requests)

**AccountingRecordRequest**
```php
<?php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class AccountingRecordRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        // æ‰¹æ¬¡æ–°å¢
        if ($this->isMethod('post') && $this->has('records')) {
            return [
                'records' => 'required|array|min:1',
                'records.*.driver_id' => 'nullable|exists:drivers,id',
                'records.*.vehicle_id' => 'nullable|exists:vehicles,id',
                'records.*.account_detail_id' => 'required|exists:account_details,id',
                'records.*.transaction_date' => 'required|date',
                'records.*.debit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
                'records.*.credit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
                'records.*.note' => 'nullable|string|max:1000',
            ];
        }

        // å–®ç­†æ›´æ–°
        return [
            'driver_id' => 'nullable|exists:drivers,id',
            'vehicle_id' => 'nullable|exists:vehicles,id',
            'account_detail_id' => 'required|exists:account_details,id',
            'transaction_date' => 'required|date',
            'debit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
            'credit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
            'note' => 'nullable|string|max:1000',
        ];
    }

    public function messages(): array
    {
        return [
            'records.required' => 'è‡³å°‘éœ€è¦æ–°å¢ä¸€ç­†è¨˜éŒ„',
            'records.*.account_detail_id.required' => 'æœƒè¨ˆç§‘ç›®ç‚ºå¿…å¡«æ¬„ä½',
            'records.*.transaction_date.required' => 'äº¤æ˜“æ—¥æœŸç‚ºå¿…å¡«æ¬„ä½',
            'records.*.debit_amount.numeric' => 'å€Ÿæ–¹é‡‘é¡å¿…é ˆç‚ºæ•¸å­—',
            'records.*.credit_amount.numeric' => 'è²¸æ–¹é‡‘é¡å¿…é ˆç‚ºæ•¸å­—',
        ];
    }

    /**
     * é¡å¤–é©—è­‰ï¼šç¢ºä¿å€Ÿæ–¹æˆ–è²¸æ–¹è‡³å°‘æœ‰ä¸€å€‹æœ‰å€¼
     */
    public function withValidator($validator)
    {
        $validator->after(function ($validator) {
            if ($this->has('records')) {
                foreach ($this->records as $index => $record) {
                    $debit = $record['debit_amount'] ?? 0;
                    $credit = $record['credit_amount'] ?? 0;

                    if ($debit == 0 && $credit == 0) {
                        $validator->errors()->add(
                            "records.{$index}.debit_amount",
                            'å€Ÿæ–¹é‡‘é¡æˆ–è²¸æ–¹é‡‘é¡è‡³å°‘éœ€è¦å¡«å¯«ä¸€å€‹'
                        );
                    }
                }
            } else {
                // å–®ç­†é©—è­‰
                $debit = $this->debit_amount ?? 0;
                $credit = $this->credit_amount ?? 0;

                if ($debit == 0 && $credit == 0) {
                    $validator->errors()->add(
                        'debit_amount',
                        'å€Ÿæ–¹é‡‘é¡æˆ–è²¸æ–¹é‡‘é¡è‡³å°‘éœ€è¦å¡«å¯«ä¸€å€‹'
                    );
                }
            }
        });
    }
}
```

#### è·¯ç”±è¨­è¨ˆ (Routes)

```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {

    // å¸³å‹™ç®¡ç†è·¯ç”±ç¾¤çµ„
    Route::prefix('accounting')->name('accounting.')->middleware('permission:view accounting')->group(function () {

        // ä¸»é é¢ï¼ˆæœå°‹ã€åˆ—è¡¨ã€æ–°å¢ï¼‰
        Route::get('records', [AccountingRecordController::class, 'index'])
            ->name('records.index');

        // æ‰¹æ¬¡æ–°å¢
        Route::post('records', [AccountingRecordController::class, 'store'])
            ->name('records.store')
            ->middleware('permission:create accounting');

        // å–®ç­†æ›´æ–°
        Route::put('records/{accountingRecord}', [AccountingRecordController::class, 'update'])
            ->name('records.update')
            ->middleware('permission:edit accounting');

        // æ‰¹æ¬¡åˆªé™¤
        Route::delete('records/batch', [AccountingRecordController::class, 'batchDestroy'])
            ->name('records.batch-destroy')
            ->middleware('permission:delete accounting');

        // API è·¯ç”±
        Route::prefix('api')->name('api.')->group(function () {
            // æœå°‹æœƒè¨ˆç§‘ç›®
            Route::get('account-details/search', [AccountingRecordController::class, 'searchAccountDetails'])
                ->name('account-details.search');
        });
    });
});
```

---

## ğŸ¨ å‰ç«¯ä»‹é¢è¨­è¨ˆ

### Vue çµ„ä»¶æ¶æ§‹

**çµ„ä»¶çµæ§‹è¦åŠƒ**
```
resources/js/Pages/Admin/AccountingRecords/
â”œâ”€â”€ Index.vue                    // å¸³å‹™ç®¡ç†ä¸»é é¢
â””â”€â”€ Components/
    â”œâ”€â”€ SearchPanel.vue          // æœå°‹é¢æ¿çµ„ä»¶
    â”œâ”€â”€ DriverList.vue           // é§•é§›åˆ—è¡¨çµ„ä»¶
    â”œâ”€â”€ VehicleList.vue          // è»Šè¼›åˆ—è¡¨çµ„ä»¶
    â”œâ”€â”€ AccountingForm.vue       // å¸³å‹™æ–°å¢è¡¨æ ¼çµ„ä»¶
    â”œâ”€â”€ AccountingRecordList.vue // å¸³å‹™è¨˜éŒ„åˆ—è¡¨çµ„ä»¶
    â”œâ”€â”€ AccountSelector.vue      // æœƒè¨ˆç§‘ç›®é¸æ“‡å™¨çµ„ä»¶
    â”œâ”€â”€ DriverDetailModal.vue    // é§•é§›è©³ç´°è³‡æ–™æ¨¡æ…‹æ¡†çµ„ä»¶ âœ¨ æ–°å¢
    â””â”€â”€ VehicleDetailModal.vue   // è»Šè¼›è©³ç´°è³‡æ–™æ¨¡æ…‹æ¡†çµ„ä»¶ âœ¨ æ–°å¢
```

### ä¸»é é¢è¨­è¨ˆ (Index.vue)

```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <div class="content-wrapper">
      <!-- é é¢æ¨™é¡Œ -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>å¸³å‹™ç®¡ç†</h1>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸»è¦å…§å®¹ -->
      <div class="content">
        <div class="container-fluid">

          <!-- 1. æœå°‹åŠŸèƒ½å¡ç‰‡ -->
          <SearchPanel
            :filters="filters"
            @search="handleSearch"
          />

          <!-- 2. é§•é§›åˆ—è¡¨å¡ç‰‡ -->
          <DriverList
            v-if="drivers.length > 0"
            :drivers="drivers"
            :selected-id="selectedDriverId"
            @select="handleDriverSelect"
          />

          <!-- 3. è»Šè¼›åˆ—è¡¨å¡ç‰‡ -->
          <VehicleList
            v-if="vehicles.length > 0"
            :vehicles="vehicles"
            :selected-id="selectedVehicleId"
            @select="handleVehicleSelect"
          />

          <!-- 4. å¸³å‹™æ–°å¢è¡¨æ ¼å¡ç‰‡ -->
          <AccountingForm
            :selected-driver="selectedDriver"
            :selected-vehicle="selectedVehicle"
            @submit="handleSubmit"
          />

          <!-- 5. å¸³å‹™è³‡è¨Šåˆ—è¡¨å¡ç‰‡ -->
          <AccountingRecordList
            v-if="records.data && records.data.length > 0"
            :records="records"
            :statistics="statistics"
            :show-driver-button="drivers.length > 0"
            :show-vehicle-button="vehicles.length > 0"
            @edit="handleEdit"
            @delete="handleDelete"
            @switch-view="handleSwitchView"
          />

        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <EditModal
      v-if="editingRecord"
      :record="editingRecord"
      @close="editingRecord = null"
      @save="handleUpdate"
    />
  </AdminLayout>
</template>

<script setup>
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import SearchPanel from './Components/SearchPanel.vue'
import DriverList from './Components/DriverList.vue'
import VehicleList from './Components/VehicleList.vue'
import AccountingForm from './Components/AccountingForm.vue'
import AccountingRecordList from './Components/AccountingRecordList.vue'
import EditModal from './Components/EditModal.vue'

const props = defineProps({
  drivers: { type: Array, default: () => [] },
  vehicles: { type: Array, default: () => [] },
  records: { type: Object, default: () => ({ data: [] }) },
  statistics: { type: Object, default: null },
  filters: { type: Object, default: () => ({}) }
})

// é¸æ“‡çš„é§•é§›å’Œè»Šè¼›
const selectedDriverId = ref(props.filters.driver_id || (props.drivers[0]?.id || null))
const selectedVehicleId = ref(props.filters.vehicle_id || (props.vehicles[0]?.id || null))

const selectedDriver = computed(() =>
  props.drivers.find(d => d.id === selectedDriverId.value)
)

const selectedVehicle = computed(() =>
  props.vehicles.find(v => v.id === selectedVehicleId.value)
)

// ç·¨è¼¯ä¸­çš„è¨˜éŒ„
const editingRecord = ref(null)

// è™•ç†æœå°‹
const handleSearch = (searchData) => {
  router.get(route('admin.accounting.records.index'), searchData, {
    preserveState: false
  })
}

// è™•ç†é§•é§›é¸æ“‡
const handleDriverSelect = (driverId) => {
  selectedDriverId.value = driverId
  loadRecords()
}

// è™•ç†è»Šè¼›é¸æ“‡
const handleVehicleSelect = (vehicleId) => {
  selectedVehicleId.value = vehicleId
  loadRecords()
}

// è¼‰å…¥å¸³å‹™è¨˜éŒ„
const loadRecords = () => {
  router.get(route('admin.accounting.records.index'), {
    ...props.filters,
    driver_id: selectedDriverId.value,
    vehicle_id: selectedVehicleId.value
  }, {
    preserveState: true,
    preserveScroll: true,
    only: ['records', 'statistics']
  })
}

// è™•ç†æ–°å¢æäº¤
const handleSubmit = (formData) => {
  router.post(route('admin.accounting.records.store'), formData, {
    onSuccess: () => {
      loadRecords()
    }
  })
}

// è™•ç†ç·¨è¼¯
const handleEdit = (record) => {
  editingRecord.value = record
}

// è™•ç†æ›´æ–°
const handleUpdate = (recordId, data) => {
  router.put(route('admin.accounting.records.update', recordId), data, {
    onSuccess: () => {
      editingRecord.value = null
      loadRecords()
    }
  })
}

// è™•ç†åˆªé™¤
const handleDelete = (ids) => {
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${ids.length} ç­†å¸³å‹™è¨˜éŒ„å—ï¼Ÿ`)) return

  router.delete(route('admin.accounting.records.batch-destroy'), {
    data: { ids },
    onSuccess: () => {
      loadRecords()
    }
  })
}

// è™•ç†åˆ‡æ›æª¢è¦–ï¼ˆé§•é§›/è»Šè¼›ï¼‰
const handleSwitchView = (viewType) => {
  if (viewType === 'driver') {
    selectedVehicleId.value = null
  } else {
    selectedDriverId.value = null
  }
  loadRecords()
}
</script>
```

### æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ

#### 1. æœå°‹é¢æ¿çµ„ä»¶ (SearchPanel.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">æœå°‹åŠŸèƒ½</h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <label>æœå°‹é¡å‹</label>
          <select v-model="form.search_type" class="form-select">
            <option value="name">å§“å</option>
            <option value="license">è»Šç‰Œè™Ÿç¢¼</option>
            <option value="fleet">è»ŠéšŠç·¨è™Ÿ</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>é—œéµå­—</label>
          <input
            v-model="form.keyword"
            type="text"
            class="form-control"
            placeholder="è«‹è¼¸å…¥æœå°‹é—œéµå­—"
            @keyup.enter="search"
          >
        </div>
        <div class="col-md-3">
          <label>&nbsp;</label>
          <button @click="search" class="btn btn-primary d-block w-100">
            <i class="bi bi-search"></i> æœå°‹
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { reactive } from 'vue'

const props = defineProps({
  filters: { type: Object, default: () => ({}) }
})

const emit = defineEmits(['search'])

const form = reactive({
  search_type: props.filters.search_type || 'name',
  keyword: props.filters.keyword || ''
})

const search = () => {
  emit('search', { ...form })
}
</script>
```

#### 2. é§•é§›åˆ—è¡¨çµ„ä»¶ (DriverList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">é§•é§›åˆ—è¡¨</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width: 50px;">é¸æ“‡</th>
              <th>å§“å</th>
              <th>èº«åˆ†è­‰å­—è™Ÿ</th>
              <th>ç”Ÿæ—¥</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="driver in drivers"
              :key="driver.id"
              :class="{ 'table-active': driver.id === selectedId }"
              @click="selectDriver(driver.id)"
              style="cursor: pointer;"
            >
              <td>
                <input
                  type="radio"
                  :checked="driver.id === selectedId"
                  @change="selectDriver(driver.id)"
                >
              </td>
              <td>{{ driver.name }}</td>
              <td>{{ driver.id_number }}</td>
              <td>{{ formatDate(driver.birth_date) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script setup>
const props = defineProps({
  drivers: { type: Array, required: true },
  selectedId: { type: Number, default: null }
})

const emit = defineEmits(['select'])

const selectDriver = (driverId) => {
  emit('select', driverId)
}

const formatDate = (date) => {
  if (!date) return '-'
  return new Date(date).toLocaleDateString('zh-TW')
}
</script>
```

#### 3. è»Šè¼›åˆ—è¡¨çµ„ä»¶ (VehicleList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">è»Šè¼›åˆ—è¡¨</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width: 50px;">é¸æ“‡</th>
              <th>è»Šç‰Œè™Ÿç¢¼</th>
              <th>è»ŠéšŠç·¨è™Ÿ</th>
              <th>è»Šä¸»åç¨±</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="vehicle in vehicles"
              :key="vehicle.id"
              :class="{ 'table-active': vehicle.id === selectedId }"
              @click="selectVehicle(vehicle.id)"
              style="cursor: pointer;"
            >
              <td>
                <input
                  type="radio"
                  :checked="vehicle.id === selectedId"
                  @change="selectVehicle(vehicle.id)"
                >
              </td>
              <td>{{ vehicle.license_number }}</td>
              <td>{{ vehicle.fleet_number || '-' }}</td>
              <td>{{ vehicle.owner_name || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script setup>
const props = defineProps({
  vehicles: { type: Array, required: true },
  selectedId: { type: Number, default: null }
})

const emit = defineEmits(['select'])

const selectVehicle = (vehicleId) => {
  emit('select', vehicleId)
}
</script>
```

#### 4. å¸³å‹™æ–°å¢è¡¨æ ¼çµ„ä»¶ (AccountingForm.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">å¸³å‹™æ–°å¢</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th style="width: 100px;">æ—¥æœŸ</th>
              <th style="width: 150px;">ç§‘ç›®ç·¨è™Ÿ</th>
              <th style="width: 120px;">ç¸½é¡</th>
              <th style="width: 120px;">å­åˆ†é¡</th>
              <th style="width: 100px;">è»Šç‰Œè™Ÿç¢¼</th>
              <th style="width: 120px;">èº«åˆ†è­‰å­—è™Ÿ</th>
              <th style="width: 100px;">å§“å</th>
              <th style="width: 120px;">å€Ÿæ–¹é‡‘é¡</th>
              <th style="width: 120px;">è²¸æ–¹é‡‘é¡</th>
              <th style="width: 200px;">å‚™è¨»</th>
              <th style="width: 80px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(row, index) in rows" :key="index">
              <!-- æ—¥æœŸ -->
              <td>
                <input
                  v-model="row.transaction_date"
                  type="date"
                  class="form-control form-control-sm"
                  :class="{ 'is-invalid': errors[`records.${index}.transaction_date`] }"
                >
              </td>

              <!-- ç§‘ç›®ç·¨è™Ÿæœå°‹ -->
              <td>
                <AccountSelector
                  v-model="row.account_detail_id"
                  @select="(account) => handleAccountSelect(index, account)"
                />
              </td>

              <!-- ç¸½é¡ -->
              <td>
                <input
                  :value="row.main_category_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- å­åˆ†é¡ -->
              <td>
                <input
                  :value="row.sub_category_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- è»Šç‰Œè™Ÿç¢¼ -->
              <td>
                <input
                  :value="row.vehicle_license_number"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- èº«åˆ†è­‰å­—è™Ÿ -->
              <td>
                <input
                  :value="row.driver_id_number"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- å§“å -->
              <td>
                <input
                  :value="row.driver_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- å€Ÿæ–¹é‡‘é¡ -->
              <td>
                <input
                  v-model.number="row.debit_amount"
                  type="number"
                  step="0.01"
                  class="form-control form-control-sm text-end"
                  :class="{ 'is-invalid': errors[`records.${index}.debit_amount`] }"
                >
              </td>

              <!-- è²¸æ–¹é‡‘é¡ -->
              <td>
                <input
                  v-model.number="row.credit_amount"
                  type="number"
                  step="0.01"
                  class="form-control form-control-sm text-end"
                  :class="{ 'is-invalid': errors[`records.${index}.credit_amount`] }"
                >
              </td>

              <!-- å‚™è¨» -->
              <td>
                <input
                  v-model="row.note"
                  type="text"
                  class="form-control form-control-sm"
                >
              </td>

              <!-- æ“ä½œ -->
              <td class="text-center">
                <button
                  @click="removeRow(index)"
                  class="btn btn-sm btn-danger"
                  :disabled="rows.length === 1"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <button @click="addRow" class="btn btn-secondary">
            <i class="bi bi-plus-circle"></i> æ–°å¢åˆ—
          </button>
        </div>
        <div class="col-md-6 text-end">
          <button @click="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> ç¢ºå®šæ–°å¢
          </button>
        </div>
      </div>

      <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤º -->
      <div v-if="Object.keys(errors).length > 0" class="alert alert-danger mt-3">
        <ul class="mb-0">
          <li v-for="(error, key) in errors" :key="key">{{ error }}</li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch, computed } from 'vue'
import { usePage } from '@inertiajs/vue3'
import AccountSelector from './AccountSelector.vue'

const props = defineProps({
  selectedDriver: { type: Object, default: null },
  selectedVehicle: { type: Object, default: null }
})

const emit = defineEmits(['submit'])

const page = usePage()
const errors = computed(() => page.props.errors || {})

// è¡¨æ ¼åˆ—è³‡æ–™
const rows = ref([createNewRow()])

// å»ºç«‹æ–°åˆ—
function createNewRow() {
  const today = new Date().toISOString().split('T')[0]

  return {
    transaction_date: today,
    account_detail_id: null,
    account_code: '',
    main_category_name: '',
    sub_category_name: '',
    driver_id: props.selectedDriver?.id || null,
    driver_name: props.selectedDriver?.name || '',
    driver_id_number: props.selectedDriver?.id_number || '',
    vehicle_id: props.selectedVehicle?.id || null,
    vehicle_license_number: props.selectedVehicle?.license_number || '',
    debit_amount: null,
    credit_amount: null,
    note: ''
  }
}

// æ–°å¢åˆ—
const addRow = () => {
  rows.value.push(createNewRow())
}

// åˆªé™¤åˆ—
const removeRow = (index) => {
  if (rows.value.length > 1) {
    rows.value.splice(index, 1)
  }
}

// è™•ç†æœƒè¨ˆç§‘ç›®é¸æ“‡
const handleAccountSelect = (index, account) => {
  rows.value[index].account_detail_id = account.id
  rows.value[index].account_code = account.account_code
  rows.value[index].main_category_name = account.main_category_name
  rows.value[index].sub_category_name = account.sub_category_name
}

// ç›£è½é¸æ“‡çš„é§•é§›è®Šæ›´
watch(() => props.selectedDriver, (newDriver) => {
  rows.value.forEach(row => {
    row.driver_id = newDriver?.id || null
    row.driver_name = newDriver?.name || ''
    row.driver_id_number = newDriver?.id_number || ''
  })
})

// ç›£è½é¸æ“‡çš„è»Šè¼›è®Šæ›´
watch(() => props.selectedVehicle, (newVehicle) => {
  rows.value.forEach(row => {
    row.vehicle_id = newVehicle?.id || null
    row.vehicle_license_number = newVehicle?.license_number || ''
  })
})

// æäº¤è¡¨å–®
const submit = () => {
  // é©—è­‰å¿…å¡«æ¬„ä½
  let hasError = false

  rows.value.forEach((row, index) => {
    if (!row.account_detail_id) {
      alert(`ç¬¬ ${index + 1} åˆ—ï¼šæœƒè¨ˆç§‘ç›®ç‚ºå¿…å¡«`)
      hasError = true
      return
    }

    if (!row.transaction_date) {
      alert(`ç¬¬ ${index + 1} åˆ—ï¼šæ—¥æœŸç‚ºå¿…å¡«`)
      hasError = true
      return
    }

    if (!row.debit_amount && !row.credit_amount) {
      alert(`ç¬¬ ${index + 1} åˆ—ï¼šå€Ÿæ–¹æˆ–è²¸æ–¹é‡‘é¡è‡³å°‘éœ€è¦å¡«å¯«ä¸€å€‹`)
      hasError = true
      return
    }
  })

  if (hasError) return

  emit('submit', { records: rows.value })
}
</script>
```

#### 5. æœƒè¨ˆç§‘ç›®é¸æ“‡å™¨çµ„ä»¶ (AccountSelector.vue)

```vue
<template>
  <div class="position-relative">
    <div class="input-group input-group-sm">
      <input
        v-model="searchKeyword"
        type="text"
        class="form-control"
        placeholder="è¼¸å…¥ç§‘ç›®ç·¨è™Ÿ"
        @input="handleInput"
        @focus="showDropdown = true"
      >
      <button
        @click="openModal"
        class="btn btn-outline-secondary"
        type="button"
      >
        <i class="bi bi-search"></i>
      </button>
    </div>

    <!-- è‡ªå‹•å®Œæˆä¸‹æ‹‰é¸å–® -->
    <div
      v-if="showDropdown && filteredAccounts.length > 0"
      class="dropdown-menu show position-absolute w-100"
      style="max-height: 300px; overflow-y: auto; z-index: 1000;"
    >
      <a
        v-for="account in filteredAccounts"
        :key="account.id"
        href="#"
        class="dropdown-item"
        @click.prevent="selectAccount(account)"
      >
        <strong>{{ account.account_code }}</strong> - {{ account.account_name }}
        <br>
        <small class="text-muted">
          {{ account.main_category_name }} / {{ account.sub_category_name }}
        </small>
      </a>
    </div>

    <!-- æ¨¡æ…‹æ¡†é¸æ“‡å™¨ -->
    <div
      v-if="showModal"
      class="modal fade show d-block"
      tabindex="-1"
      style="background-color: rgba(0,0,0,0.5);"
      @click.self="closeModal"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">é¸æ“‡æœƒè¨ˆç§‘ç›®</h5>
            <button
              type="button"
              class="btn-close"
              @click="closeModal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              v-model="modalSearchKeyword"
              type="text"
              class="form-control mb-3"
              placeholder="æœå°‹ç§‘ç›®ç·¨è™Ÿæˆ–åç¨±"
              @input="searchInModal"
            >
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç§‘ç›®ç·¨è™Ÿ</th>
                    <th>ç§‘ç›®åç¨±</th>
                    <th>ç¸½é¡</th>
                    <th>å­åˆ†é¡</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="account in modalAccounts"
                    :key="account.id"
                    @click="selectAccount(account)"
                    style="cursor: pointer;"
                  >
                    <td>{{ account.account_code }}</td>
                    <td>{{ account.account_name }}</td>
                    <td>{{ account.main_category_name }}</td>
                    <td>{{ account.sub_category_name }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'
import axios from 'axios'

const props = defineProps({
  modelValue: { type: Number, default: null }
})

const emit = defineEmits(['update:modelValue', 'select'])

const searchKeyword = ref('')
const filteredAccounts = ref([])
const showDropdown = ref(false)

const showModal = ref(false)
const modalSearchKeyword = ref('')
const modalAccounts = ref([])

// è™•ç†è¼¸å…¥ - è‡ªå‹•å®Œæˆ
const handleInput = async () => {
  if (searchKeyword.value.length === 0) {
    filteredAccounts.value = []
    showDropdown.value = false
    return
  }

  try {
    const response = await axios.get(
      route('admin.accounting.api.account-details.search'),
      { params: { keyword: searchKeyword.value } }
    )
    filteredAccounts.value = response.data
    showDropdown.value = true
  } catch (error) {
    console.error('æœå°‹å¤±æ•—:', error)
  }
}

// æ¨¡æ…‹æ¡†æœå°‹
const searchInModal = async () => {
  if (modalSearchKeyword.value.length === 0) {
    modalAccounts.value = []
    return
  }

  try {
    const response = await axios.get(
      route('admin.accounting.api.account-details.search'),
      { params: { keyword: modalSearchKeyword.value } }
    )
    modalAccounts.value = response.data
  } catch (error) {
    console.error('æœå°‹å¤±æ•—:', error)
  }
}

// é¸æ“‡ç§‘ç›®
const selectAccount = (account) => {
  searchKeyword.value = account.account_code
  emit('update:modelValue', account.id)
  emit('select', account)
  showDropdown.value = false
  closeModal()
}

// é–‹å•Ÿæ¨¡æ…‹æ¡†
const openModal = () => {
  showModal.value = true
  modalSearchKeyword.value = ''
  modalAccounts.value = []
}

// é—œé–‰æ¨¡æ…‹æ¡†
const closeModal = () => {
  showModal.value = false
}

// é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
document.addEventListener('click', (e) => {
  if (!e.target.closest('.position-relative')) {
    showDropdown.value = false
  }
})
</script>
```

#### 6. å¸³å‹™è¨˜éŒ„åˆ—è¡¨çµ„ä»¶ (AccountingRecordList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">å¸³å‹™è³‡è¨Šåˆ—è¡¨</h3>
      <div class="card-tools">
        <button
          v-if="showDriverButton"
          @click="$emit('switch-view', 'driver')"
          class="btn btn-sm btn-primary me-2"
        >
          <i class="bi bi-person"></i> é§•é§›å¸³å‹™
        </button>
        <button
          v-if="showVehicleButton"
          @click="$emit('switch-view', 'vehicle')"
          class="btn btn-sm btn-info"
        >
          <i class="bi bi-car-front"></i> è»Šè¼›å¸³å‹™
        </button>
      </div>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div v-if="statistics" class="card-body border-bottom">
      <div class="row text-center">
        <div class="col-md-4">
          <h5>å€Ÿæ–¹åŠ ç¸½</h5>
          <h3 class="text-primary">{{ statistics.debit_total }}</h3>
        </div>
        <div class="col-md-4">
          <h5>è²¸æ–¹åŠ ç¸½</h5>
          <h3 class="text-success">{{ statistics.credit_total }}</h3>
        </div>
        <div class="col-md-4">
          <h5>é¤˜é¡ï¼ˆå€Ÿ-è²¸ï¼‰</h5>
          <h3 :class="statistics.balance_is_negative ? 'text-danger' : 'text-info'">
            {{ statistics.balance }}
          </h3>
        </div>
      </div>
    </div>

    <!-- å¸³å‹™åˆ—è¡¨ -->
    <div class="card-body">
      <div class="mb-3">
        <button
          @click="deleteSelected"
          class="btn btn-danger"
          :disabled="selectedIds.length === 0"
        >
          <i class="bi bi-trash"></i> åˆªé™¤é¸å–é …ç›® ({{ selectedIds.length }})
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input
                  type="checkbox"
                  @change="toggleAll"
                  :checked="allSelected"
                >
              </th>
              <th>æ—¥æœŸ</th>
              <th>ç§‘ç›®ç·¨è™Ÿ</th>
              <th>ç§‘ç›®åç¨±</th>
              <th>å§“å</th>
              <th>è»Šç‰Œ</th>
              <th>å€Ÿæ–¹</th>
              <th>è²¸æ–¹</th>
              <th>å‚™è¨»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="record in records.data" :key="record.id">
              <td>
                <input
                  type="checkbox"
                  :value="record.id"
                  v-model="selectedIds"
                >
              </td>
              <td>{{ formatDate(record.transaction_date) }}</td>
              <td>{{ record.account_detail?.account_code }}</td>
              <td>{{ record.account_detail?.account_name }}</td>
              <td>{{ record.driver_name || '-' }}</td>
              <td>{{ record.vehicle_license_number || '-' }}</td>
              <td class="text-end">{{ formatAmount(record.debit_amount) }}</td>
              <td class="text-end">{{ formatAmount(record.credit_amount) }}</td>
              <td>{{ record.note || '-' }}</td>
              <td>
                <button
                  @click="$emit('edit', record)"
                  class="btn btn-sm btn-warning"
                >
                  <i class="bi bi-pencil"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- åˆ†é  -->
      <div v-if="records.links" class="mt-3">
        <nav>
          <ul class="pagination">
            <li
              v-for="link in records.links"
              :key="link.label"
              class="page-item"
              :class="{ active: link.active, disabled: !link.url }"
            >
              <a
                class="page-link"
                href="#"
                @click.prevent="changePage(link.url)"
                v-html="link.label"
              ></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'

const props = defineProps({
  records: { type: Object, required: true },
  statistics: { type: Object, default: null },
  showDriverButton: { type: Boolean, default: false },
  showVehicleButton: { type: Boolean, default: false }
})

const emit = defineEmits(['edit', 'delete', 'switch-view'])

const selectedIds = ref([])

const allSelected = computed(() => {
  return props.records.data.length > 0 &&
         selectedIds.value.length === props.records.data.length
})

const toggleAll = () => {
  if (allSelected.value) {
    selectedIds.value = []
  } else {
    selectedIds.value = props.records.data.map(r => r.id)
  }
}

const deleteSelected = () => {
  if (selectedIds.value.length === 0) return
  emit('delete', selectedIds.value)
  selectedIds.value = []
}

const changePage = (url) => {
  if (!url) return
  router.visit(url, { preserveState: true, preserveScroll: true })
}

const formatDate = (date) => {
  if (!date) return '-'
  return new Date(date).toLocaleDateString('zh-TW')
}

const formatAmount = (amount) => {
  if (!amount) return '-'
  return new Intl.NumberFormat('zh-TW', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount)
}
</script>
```

---

## ğŸ”Œ API è¨­è¨ˆ

### RESTful API ç«¯é»å®šç¾©

| HTTPæ–¹æ³• | ç«¯é» | æè¿° | æ¬Šé™ |
|---------|------|------|------|
| GET | `/admin/accounting/records` | å–å¾—å¸³å‹™ç®¡ç†ä¸»é é¢ | view accounting |
| POST | `/admin/accounting/records` | æ‰¹æ¬¡æ–°å¢å¸³å‹™è¨˜éŒ„ | create accounting |
| PUT | `/admin/accounting/records/{id}` | æ›´æ–°å–®ç­†å¸³å‹™è¨˜éŒ„ | edit accounting |
| DELETE | `/admin/accounting/records/batch` | æ‰¹æ¬¡åˆªé™¤å¸³å‹™è¨˜éŒ„ | delete accounting |
| GET | `/admin/accounting/api/account-details/search` | æœå°‹æœƒè¨ˆç§‘ç›® | view accounting |

### API è«‹æ±‚èˆ‡å›æ‡‰è¦ç¯„

#### 1. æ‰¹æ¬¡æ–°å¢å¸³å‹™è¨˜éŒ„

**è«‹æ±‚ (POST /admin/accounting/records)**
```json
{
  "records": [
    {
      "driver_id": 1,
      "vehicle_id": 5,
      "account_detail_id": 123,
      "transaction_date": "2025-01-15",
      "debit_amount": 1000.00,
      "credit_amount": null,
      "note": "æ²¹è³‡è£œè²¼"
    },
    {
      "driver_id": 1,
      "vehicle_id": 5,
      "account_detail_id": 124,
      "transaction_date": "2025-01-15",
      "debit_amount": null,
      "credit_amount": 1000.00,
      "note": "ç¾é‡‘æ”¯å‡º"
    }
  ]
}
```

**æˆåŠŸå›æ‡‰**
```json
{
  "success": true,
  "message": "æˆåŠŸæ–°å¢ 2 ç­†å¸³å‹™è¨˜éŒ„"
}
```

#### 2. æœå°‹æœƒè¨ˆç§‘ç›®

**è«‹æ±‚ (GET /admin/accounting/api/account-details/search?keyword=1101)**

**å›æ‡‰**
```json
[
  {
    "id": 123,
    "account_code": "1101001",
    "account_name": "ç¾é‡‘",
    "main_category_name": "è³‡ç”¢",
    "sub_category_name": "æµå‹•è³‡ç”¢"
  },
  {
    "id": 124,
    "account_code": "1101002",
    "account_name": "éŠ€è¡Œå­˜æ¬¾",
    "main_category_name": "è³‡ç”¢",
    "sub_category_name": "æµå‹•è³‡ç”¢"
  }
]
```

---

## ğŸ” æ¬Šé™ç®¡ç†

### æ¬Šé™å®šç¾©

```php
// database/seeders/AccountingPermissionSeeder.php
$permissions = [
    'view accounting',        // æŸ¥çœ‹å¸³å‹™è¨˜éŒ„
    'create accounting',      // æ–°å¢å¸³å‹™è¨˜éŒ„
    'edit accounting',        // ç·¨è¼¯å¸³å‹™è¨˜éŒ„
    'delete accounting',      // åˆªé™¤å¸³å‹™è¨˜éŒ„
    'export accounting',      // åŒ¯å‡ºå¸³å‹™è¨˜éŒ„
];

foreach ($permissions as $permission) {
    Permission::firstOrCreate(['name' => $permission]);
}
```

### è·å‹™æ¬Šé™é…ç½®

åŸºæ–¼ç¾æœ‰çš„ Position (è·å‹™) ç³»çµ±ï¼Œç‚º**æœƒè¨ˆäººå“¡**è·å‹™æ–°å¢å¸³å‹™ç®¡ç†æ¬Šé™ï¼š

```php
// æ›´æ–°æœƒè¨ˆäººå“¡è·å‹™æ¬Šé™
$accountantPosition = Position::where('code', 'ACCOUNTANT')->first();

if ($accountantPosition) {
    $accountantPosition->givePermissionTo([
        'view accounting',
        'create accounting',
        'edit accounting',
        'delete accounting',
        'export accounting',
    ]);
}

// ç³»çµ±ç®¡ç†å“¡ä¹Ÿæ‡‰è©²æœ‰å®Œæ•´æ¬Šé™
$adminPosition = Position::where('code', 'SYS_ADMIN')->first();
if ($adminPosition) {
    $adminPosition->givePermissionTo([
        'view accounting',
        'create accounting',
        'edit accounting',
        'delete accounting',
        'export accounting',
    ]);
}
```

### è·¯ç”±æ¬Šé™ä¿è­·

```php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {
    Route::prefix('accounting')->name('accounting.')->group(function () {

        // æ‰€æœ‰å¸³å‹™è·¯ç”±éƒ½éœ€è¦ view accounting æ¬Šé™
        Route::middleware('permission:view accounting')->group(function () {
            Route::get('records', [AccountingRecordController::class, 'index'])
                ->name('records.index');

            Route::get('api/account-details/search', [AccountingRecordController::class, 'searchAccountDetails'])
                ->name('api.account-details.search');
        });

        // æ–°å¢æ¬Šé™
        Route::post('records', [AccountingRecordController::class, 'store'])
            ->name('records.store')
            ->middleware('permission:create accounting');

        // ç·¨è¼¯æ¬Šé™
        Route::put('records/{accountingRecord}', [AccountingRecordController::class, 'update'])
            ->name('records.update')
            ->middleware('permission:edit accounting');

        // åˆªé™¤æ¬Šé™
        Route::delete('records/batch', [AccountingRecordController::class, 'batchDestroy'])
            ->name('records.batch-destroy')
            ->middleware('permission:delete accounting');
    });
});
```

---

## âœ… é©—è­‰è¦å‰‡èˆ‡æ¥­å‹™é‚è¼¯

### è³‡æ–™é©—è­‰è¦å‰‡

#### æ‰¹æ¬¡æ–°å¢é©—è­‰
- **records**: å¿…å¡«ï¼Œé™£åˆ—ï¼Œè‡³å°‘1ç­†
- **account_detail_id**: å¿…å¡«ï¼Œå¿…é ˆå­˜åœ¨æ–¼ account_details è¡¨
- **transaction_date**: å¿…å¡«ï¼Œæ—¥æœŸæ ¼å¼
- **debit_amount**: é¸å¡«ï¼Œæ•¸å­—ï¼Œ0-9999999999.99
- **credit_amount**: é¸å¡«ï¼Œæ•¸å­—ï¼Œ0-9999999999.99
- **å€Ÿæ–¹æˆ–è²¸æ–¹**: è‡³å°‘ä¸€å€‹è¦æœ‰å€¼ä¸”å¤§æ–¼0
- **note**: é¸å¡«ï¼Œå­—ä¸²ï¼Œæœ€é•·1000å­—

### æ¥­å‹™é‚è¼¯è¦å‰‡

#### 1. é‡è¤‡è¨˜éŒ„è™•ç†
- **ç­–ç•¥**: è­¦å‘Šä½†å…è¨±æ–°å¢
- **å¯¦ä½œ**: è¨˜éŒ„åˆ° Logï¼Œä¸é˜»æ“‹æ–°å¢
- **æ¢ä»¶**: åŒé§•é§›+åŒè»Šè¼›+åŒç§‘ç›®+åŒæ—¥æœŸ+åŒé‡‘é¡

#### 2. ä¸¦ç™¼æ§åˆ¶
- ä½¿ç”¨ Laravel Database Transaction
- æ‰¹æ¬¡æ–°å¢æ™‚ç¢ºä¿åŸå­æ€§æ“ä½œ
- å¤±æ•—æ™‚å®Œæ•´å›æ»¾

#### 3. è»Ÿåˆªé™¤æ©Ÿåˆ¶
- ä½¿ç”¨ `deleted_at` æ¨™è¨˜åˆªé™¤
- ä¿ç•™å®Œæ•´æ­·å²è¨˜éŒ„
- æ”¯æ´å¯©è¨ˆè¿½è¹¤

#### 4. å†—ä½™æ¬„ä½è‡ªå‹•å¡«å…¥
```php
// æ–°å¢æ™‚è‡ªå‹•å¡«å…¥
$driver = Driver::find($driverId);
$record->driver_name = $driver->name;
$record->driver_id_number = $driver->id_number;

$vehicle = Vehicle::find($vehicleId);
$record->vehicle_license_number = $vehicle->license_number;
```

---

## ğŸ“Š è³‡æ–™åº« Migration ç¯„ä¾‹

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('accounting_records', function (Blueprint $table) {
            $table->id();

            // å¤–éµé—œè¯
            $table->foreignId('driver_id')->nullable()->constrained('drivers')->nullOnDelete();
            $table->foreignId('vehicle_id')->nullable()->constrained('vehicles')->nullOnDelete();
            $table->foreignId('account_detail_id')->constrained('account_details')->restrictOnDelete();

            // äº¤æ˜“è³‡è¨Š
            $table->date('transaction_date');

            // å†—ä½™æ¬„ä½ï¼ˆæ­·å²è¨˜éŒ„ä¿å­˜ï¼‰
            $table->string('driver_name', 100)->nullable();
            $table->string('driver_id_number', 20)->nullable();
            $table->string('vehicle_license_number', 20)->nullable();

            // é‡‘é¡
            $table->decimal('debit_amount', 15, 2)->nullable();
            $table->decimal('credit_amount', 15, 2)->nullable();

            // å‚™è¨»
            $table->text('note')->nullable();

            // å»ºç«‹è€…èˆ‡æ›´æ–°è€…
            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();

            $table->timestamps();
            $table->softDeletes();

            // ç´¢å¼•
            $table->index('transaction_date');
            $table->index(['driver_id', 'transaction_date']);
            $table->index(['vehicle_id', 'transaction_date']);
            $table->index('driver_name');
            $table->index('driver_id_number');
            $table->index('vehicle_license_number');
        });

        // CHECK ç´„æŸï¼ˆMySQL 8.0.16+ï¼‰
        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_amount CHECK (
            (debit_amount IS NOT NULL AND debit_amount > 0) OR
            (credit_amount IS NOT NULL AND credit_amount > 0)
        )');

        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_debit_positive CHECK (
            debit_amount IS NULL OR debit_amount >= 0
        )');

        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_credit_positive CHECK (
            credit_amount IS NULL OR credit_amount >= 0
        )');
    }

    public function down(): void
    {
        Schema::dropIfExists('accounting_records');
    }
};
```

---

## â±ï¸ é–‹ç™¼æ™‚ç¨‹è¦åŠƒ

### ç¬¬ä¸€éšæ®µï¼šåŸºç¤æ¶æ§‹å»ºç«‹ï¼ˆ1é€±ï¼‰
- [x] è³‡æ–™åº« Migration å»ºç«‹
- [x] Model å»ºç«‹èˆ‡é—œè¯è¨­å®š
- [x] Seeder å»ºç«‹ï¼ˆæ¬Šé™ï¼‰
- [x] åŸºç¤è·¯ç”±è¨­å®š

### ç¬¬äºŒéšæ®µï¼šå¾Œç«¯é–‹ç™¼ï¼ˆ2é€±ï¼‰
- [x] Controller å¯¦ä½œ
- [x] Service å±¤å¯¦ä½œ
- [x] Request é©—è­‰é¡åˆ¥
- [ ] API ç«¯é»æ¸¬è©¦

### ç¬¬ä¸‰éšæ®µï¼šå‰ç«¯é–‹ç™¼ï¼ˆ2-3é€±ï¼‰
- [x] ä¸»é é¢æ¡†æ¶
- [x] æœå°‹é¢æ¿çµ„ä»¶
- [x] é§•é§›/è»Šè¼›åˆ—è¡¨çµ„ä»¶
- [x] å‹•æ…‹è¡¨æ ¼çµ„ä»¶
- [x] æœƒè¨ˆç§‘ç›®é¸æ“‡å™¨ï¼ˆè‡ªå‹•å®Œæˆ+æ¨¡æ…‹æ¡†ï¼‰
- [x] å¸³å‹™è¨˜éŒ„åˆ—è¡¨çµ„ä»¶
- [x] ç·¨è¼¯åŠŸèƒ½
- [x] åˆªé™¤åŠŸèƒ½

### ç¬¬å››éšæ®µï¼šæ•´åˆæ¸¬è©¦ï¼ˆ1é€±ï¼‰
- [ ] åŠŸèƒ½æ¸¬è©¦
- [ ] æ•´åˆæ¸¬è©¦
- [ ] æ•ˆèƒ½æ¸¬è©¦
- [ ] ä½¿ç”¨è€…é©—æ”¶æ¸¬è©¦

### ç¬¬äº”éšæ®µï¼šå„ªåŒ–èˆ‡ä¸Šç·šï¼ˆ1é€±ï¼‰
- [ ] Bug ä¿®å¾©
- [ ] æ•ˆèƒ½å„ªåŒ–
- [ ] ä½¿ç”¨è€…æ–‡ä»¶
- [ ] éƒ¨ç½²ä¸Šç·š

**é ä¼°ç¸½æ™‚ç¨‹ï¼š7-8 é€±**

---

## ğŸ“ å¯¦ä½œæª¢æ ¸æ¸…å–®

### å¾Œç«¯
- [x] Migration æª”æ¡ˆå»ºç«‹ä¸¦åŸ·è¡Œ
- [x] Model é—œè¯é—œä¿‚æ­£ç¢º
- [x] Service å±¤æ¥­å‹™é‚è¼¯å®Œæ•´
- [x] Request é©—è­‰è¦å‰‡å®Œæ•´
- [ ] API ç«¯é»æ¸¬è©¦é€šé
- [x] Transaction æ­£ç¢ºå¯¦ä½œ
- [x] è»Ÿåˆªé™¤æ©Ÿåˆ¶é‹ä½œæ­£å¸¸

### å‰ç«¯
- [x] ä¸»é é¢ä½ˆå±€å®Œæˆ
- [x] æœå°‹åŠŸèƒ½æ­£å¸¸
- [x] é§•é§›/è»Šè¼›åˆ—è¡¨é¡¯ç¤ºæ­£ç¢º
- [x] å‹•æ…‹è¡¨æ ¼æ–°å¢/åˆªé™¤åˆ—æ­£å¸¸
- [x] æœƒè¨ˆç§‘ç›®è‡ªå‹•å®Œæˆæœå°‹æ­£å¸¸
- [x] æœƒè¨ˆç§‘ç›®æ¨¡æ…‹æ¡†é¸æ“‡æ­£å¸¸
- [x] æ‰¹æ¬¡æ–°å¢æäº¤æˆåŠŸ
- [x] ç·¨è¼¯åŠŸèƒ½æ­£å¸¸
- [x] å¤šé¸åˆªé™¤åŠŸèƒ½æ­£å¸¸
- [x] çµ±è¨ˆæ•¸å­—è¨ˆç®—æ­£ç¢º
- [x] åˆ†é åŠŸèƒ½æ­£å¸¸

### æ¬Šé™èˆ‡å®‰å…¨
- [x] æ¬Šé™ Seeder å»ºç«‹
- [x] è·¯ç”±æ¬Šé™ä¿è­·å®Œæ•´
- [x] ä½¿ç”¨è€…æ¬Šé™æª¢æŸ¥æ­£ç¢º
- [x] SQL Injection é˜²è­·
- [x] XSS é˜²è­·

### æ¸¬è©¦
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ >70%
- [ ] åŠŸèƒ½æ¸¬è©¦é€šé
- [ ] æ•´åˆæ¸¬è©¦é€šé
- [ ] æ•ˆèƒ½æ¸¬è©¦é”æ¨™

---

## ğŸš¨ æ³¨æ„äº‹é …èˆ‡é¢¨éšª

### 1. æ•ˆèƒ½è€ƒé‡
- **å¤§é‡è³‡æ–™æŸ¥è©¢**ï¼šå»ºè­°å¯¦ä½œåˆ†é ã€ç´¢å¼•å„ªåŒ–
- **çµ±è¨ˆè¨ˆç®—**ï¼šè€ƒæ…®å¿«å–æ©Ÿåˆ¶
- **é—œè¯æŸ¥è©¢**ï¼šä½¿ç”¨ Eager Loading é¿å… N+1 å•é¡Œ

### 2. è³‡æ–™ä¸€è‡´æ€§
- **å¤–éµç´„æŸ**ï¼šç¢ºä¿åƒç…§å®Œæ•´æ€§
- **Transaction**ï¼šæ‰¹æ¬¡æ“ä½œå¿…é ˆä½¿ç”¨ Transaction
- **å†—ä½™æ¬„ä½åŒæ­¥**ï¼šç¢ºä¿æ›´æ–°æ™‚åŒæ­¥å†—ä½™æ¬„ä½

### 3. ä½¿ç”¨è€…é«”é©—
- **è¼‰å…¥æç¤º**ï¼šé•·æ™‚é–“æ“ä½œéœ€é¡¯ç¤º Loading
- **éŒ¯èª¤æç¤º**ï¼šå‹å–„çš„éŒ¯èª¤è¨Šæ¯
- **æ“ä½œç¢ºèª**ï¼šåˆªé™¤ç­‰å±éšªæ“ä½œéœ€äºŒæ¬¡ç¢ºèª

### 4. æ“´å±•æ€§è€ƒé‡
- **å ±è¡¨åŠŸèƒ½**ï¼šé ç•™å ±è¡¨åŒ¯å‡ºæ¥å£
- **å¯©è¨ˆæ—¥èªŒ**ï¼šè¨˜éŒ„é‡è¦æ“ä½œ
- **æ‰¹æ¬¡åŒ¯å…¥**ï¼šæœªä¾†å¯èƒ½éœ€è¦ Excel æ‰¹æ¬¡åŒ¯å…¥

---

## ğŸ“š åƒè€ƒè³‡æ–™

### ç›¸é—œæ–‡ä»¶
- [æœƒè¨ˆç§‘ç›®ç®¡ç†é–‹ç™¼æ–‡ä»¶](./æœƒè¨ˆç§‘ç›®å»ºç«‹.md)
- [é§•é§›ç®¡ç†ç³»çµ±](../app/Models/Driver.php)
- [è»Šè¼›ç®¡ç†ç³»çµ±](../app/Models/Vehicle.php)
- [Laravel æ–‡ä»¶ - Eloquent Relationships](https://laravel.com/docs/11.x/eloquent-relationships)
- [Vue 3 æ–‡ä»¶](https://vuejs.org/)
- [AdminLTE 4 æ–‡ä»¶](https://adminlte.io/docs/4.0/)

### æŠ€è¡“åƒè€ƒ
- Laravel Database Transactions
- Vue 3 Composition API
- Inertia.js æœ€ä½³å¯¦è¸
- Bootstrap 5 è¡¨å–®è¨­è¨ˆ

---

**æ–‡ä»¶ç‰ˆæœ¬**ï¼š2.0
**æœ€å¾Œæ›´æ–°**ï¼š2025å¹´10æœˆ1æ—¥
**æ–‡ä»¶ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆé–‹ç™¼ï¼ˆå¾…æ¸¬è©¦ï¼‰
**è² è²¬äºº**ï¼šé–‹ç™¼åœ˜éšŠ

---

## ğŸ“Œ é–‹ç™¼å®Œæˆç¸½çµ (2025/10/01)

### âœ… å·²å®Œæˆé …ç›®

#### å¾Œç«¯é–‹ç™¼
1. âœ… **è³‡æ–™åº« Migration** - `2025_10_01_205120_create_accounting_records_table.php`
2. âœ… **AccountingRecord Model** - å®Œæ•´é—œè¯ã€Scopeã€è»Ÿåˆªé™¤
3. âœ… **AccountingRecordService** - æœå°‹ã€çµ±è¨ˆã€æ‰¹æ¬¡æ“ä½œ
4. âœ… **AccountingRecordRequest** - æ‰¹æ¬¡èˆ‡å–®ç­†é©—è­‰
5. âœ… **AccountingRecordController** - å®Œæ•´ CRUD èˆ‡ API
6. âœ… **æ¬Šé™ Seeder** - 5å€‹æ¬Šé™å·²å»ºç«‹ä¸¦åˆ†é…
7. âœ… **è·¯ç”±è¨­å®š** - å®Œæ•´ RESTful è·¯ç”±èˆ‡æ¬Šé™ä¿è­·

#### å‰ç«¯é–‹ç™¼
8. âœ… **SearchPanel.vue** - æœå°‹é¢æ¿
9. âœ… **DriverList.vue** - é§•é§›åˆ—è¡¨
10. âœ… **VehicleList.vue** - è»Šè¼›åˆ—è¡¨
11. âœ… **AccountSelector.vue** - æœƒè¨ˆç§‘ç›®é¸æ“‡å™¨ï¼ˆè‡ªå‹•å®Œæˆ+æ¨¡æ…‹æ¡†ï¼‰
12. âœ… **AccountingForm.vue** - å‹•æ…‹æ–°å¢è¡¨æ ¼
13. âœ… **AccountingRecordList.vue** - å¸³å‹™è¨˜éŒ„åˆ—è¡¨ï¼ˆå«çµ±è¨ˆï¼‰
14. âœ… **Index.vue** - ä¸»é é¢æ•´åˆ
15. âœ… **å´é‚Šæ¬„é¸å–®** - å·²æ–°å¢ã€Œå¸³å‹™ç®¡ç†ã€æŒ‰éˆ•

### ğŸ¯ ç³»çµ±åŠŸèƒ½
- âœ… æ”¯æ´å§“å/è»Šç‰Œ/è»ŠéšŠç·¨è™Ÿæœå°‹
- âœ… é§•é§›èˆ‡è»Šè¼›é—œè¯é¡¯ç¤º
- âœ… æ‰¹æ¬¡æ–°å¢å¸³å‹™è¨˜éŒ„
- âœ… å€Ÿæ–¹/è²¸æ–¹é‡‘é¡çµ±è¨ˆ
- âœ… å¤šé¸åˆªé™¤åŠŸèƒ½
- âœ… åˆ†é é¡¯ç¤º
- âœ… æ¬Šé™æ§ç®¡ï¼ˆ5å€‹æ¬Šé™ï¼‰

### ğŸ“ æ¸¬è©¦å»ºè­°
1. è¨ªå• `/admin/accounting/records` æ¸¬è©¦åŠŸèƒ½
2. ç¢ºèªæ¬Šé™æ˜¯å¦æ­£ç¢ºæ§ç®¡
3. æ¸¬è©¦æœå°‹ã€æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤åŠŸèƒ½
4. é©—è­‰çµ±è¨ˆæ•¸å­—æ˜¯å¦æ­£ç¢º

### ğŸ”„ å¾ŒçºŒå„ªåŒ–å»ºè­°
- [ ] æ–°å¢å–®å…ƒæ¸¬è©¦
- [ ] æ–°å¢åŠŸèƒ½æ¸¬è©¦
- [ ] æ•ˆèƒ½å„ªåŒ–ï¼ˆå¤§é‡è³‡æ–™ï¼‰
- [ ] åŒ¯å‡ºåŠŸèƒ½å¯¦ä½œ
- [ ] æ‰¹æ¬¡åŒ¯å…¥åŠŸèƒ½
- [ ] å¯©è¨ˆæ—¥èªŒè¨˜éŒ„

---

## ğŸ“‹ ä½¿ç”¨è€…æµç¨‹èªªæ˜ï¼ˆv2.1 æ–°å¢ï¼‰

### å®Œæ•´æ“ä½œæµç¨‹

#### æµç¨‹ 1ï¼šæœå°‹èˆ‡æŸ¥çœ‹
1. **æœå°‹é§•é§›æˆ–è»Šè¼›**
   - è¼¸å…¥é—œéµå­—
   - é¸æ“‡æœå°‹é¡å‹ï¼ˆå§“å/è»Šç‰Œ/è»ŠéšŠç·¨è™Ÿï¼‰
   - é»æ“Šæœå°‹æŒ‰éˆ•

2. **ç³»çµ±è‡ªå‹•è™•ç†**
   - é¡¯ç¤ºç¬¦åˆæ¢ä»¶çš„é§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨
   - **é›™åˆ—è¡¨è‡ªå‹•é¸æ“‡**ï¼š
     - âœ… æœ‰é§•é§›è³‡æ–™ â†’ è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹é§•é§›ï¼ˆé«˜äº®é¡¯ç¤ºï¼‰
     - âœ… æœ‰è»Šè¼›è³‡æ–™ â†’ è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹è»Šè¼›ï¼ˆé«˜äº®é¡¯ç¤ºï¼‰
     - ğŸ“Œ **å…©å€‹åˆ—è¡¨å„è‡ªç¨ç«‹é¡¯ç¤ºé¸ä¸­ç‹€æ…‹**
   - **è‡ªå‹•è¼‰å…¥å¸³å‹™è¨˜éŒ„ï¼ˆå„ªå…ˆé§•é§›ï¼‰**ï¼š
     - IF æœ‰é¸ä¸­é§•é§› THEN é¡¯ç¤ºé§•é§›çš„å¸³å‹™è¨˜éŒ„
     - ELSE é¡¯ç¤ºè»Šè¼›çš„å¸³å‹™è¨˜éŒ„
   - é¡¯ç¤ºçµ±è¨ˆè³‡è¨Šï¼ˆå€Ÿæ–¹ã€è²¸æ–¹ã€é¤˜é¡ï¼‰

3. **ä½¿ç”¨è€…å¯æ‰‹å‹•åˆ‡æ›**ï¼ˆå¯é¸ï¼‰
   - é»é¸é§•é§›åˆ—è¡¨ä¸­çš„å…¶ä»–é§•é§› â†’ åˆ‡æ›é¡¯ç¤ºè©²é§•é§›çš„å¸³å‹™è¨˜éŒ„
   - é»é¸è»Šè¼›åˆ—è¡¨ä¸­çš„å…¶ä»–è»Šè¼› â†’ åˆ‡æ›é¡¯ç¤ºè©²è»Šè¼›çš„å¸³å‹™è¨˜éŒ„
   - ğŸ“Œ **åˆ‡æ›æ™‚ä¿æŒå…©å€‹åˆ—è¡¨çš„é¸ä¸­ç‹€æ…‹**ï¼ˆåªæ”¹è®Šé¡¯ç¤ºå…§å®¹ï¼‰

#### æµç¨‹ 2ï¼šæ–°å¢å¸³å‹™è¨˜éŒ„
1. **å¡«å¯«å¸³å‹™è¡¨æ ¼**
   - é¸æ“‡äº¤æ˜“æ—¥æœŸ
   - é¸æ“‡æœƒè¨ˆç§‘ç›®ï¼ˆæ”¯æ´è‡ªå‹•å®Œæˆæœå°‹ï¼‰
   - å¡«å¯«å€Ÿæ–¹æˆ–è²¸æ–¹é‡‘é¡
   - å¡«å¯«å‚™è¨»ï¼ˆå¯é¸ï¼‰

2. **æäº¤æ–°å¢**
   - é»æ“Šã€Œç¢ºå®šæ–°å¢ã€æŒ‰éˆ•

3. **ç³»çµ±è¡Œç‚º**ï¼ˆæ–°å¢æˆåŠŸå¾Œï¼‰
   - âœ… **ä¿ç•™æœå°‹çµæœ**ï¼šé§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨ä¸æœƒæ¶ˆå¤±
   - âœ… **ä¿ç•™é¸æ“‡ç‹€æ…‹**ï¼šç•¶å‰é¸æ“‡çš„é§•é§›/è»Šè¼›ä¿æŒé¸ä¸­
   - âœ… **åˆ·æ–°å¸³å‹™åˆ—è¡¨**ï¼šè‡ªå‹•é¡¯ç¤ºå‰›æ–°å¢çš„è¨˜éŒ„
   - âœ… **æ›´æ–°çµ±è¨ˆè³‡è¨Š**ï¼šé‡æ–°è¨ˆç®—å€Ÿæ–¹ã€è²¸æ–¹ã€é¤˜é¡

#### æµç¨‹ 3ï¼šç·¨è¼¯èˆ‡åˆªé™¤
**ç·¨è¼¯**ï¼š
- é»æ“Šè¨˜éŒ„çš„ç·¨è¼¯æŒ‰éˆ•
- ä¿®æ”¹è³‡æ–™å¾Œå„²å­˜
- ç³»çµ±ä¿ç•™æœå°‹çµæœå’Œé¸æ“‡ç‹€æ…‹

**åˆªé™¤**ï¼š
- å‹¾é¸è¦åˆªé™¤çš„è¨˜éŒ„
- é»æ“Šã€Œåˆªé™¤é¸å–é …ç›®ã€
- ç¢ºèªåˆªé™¤
- ç³»çµ±ä¿ç•™æœå°‹çµæœå’Œé¸æ“‡ç‹€æ…‹

### é—œéµè¨­è¨ˆåŸå‰‡

1. **é›™åˆ—è¡¨é¸æ“‡æ©Ÿåˆ¶**
   - ğŸ“Œ é§•é§›åˆ—è¡¨å’Œè»Šè¼›åˆ—è¡¨å„è‡ªç¶­è­·ç¨ç«‹çš„é¸ä¸­ç‹€æ…‹
   - ğŸ“Œ æœå°‹å¾ŒåŒæ™‚è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹é§•é§›å’Œç¬¬ä¸€å€‹è»Šè¼›ï¼ˆé›™é¸ï¼‰
   - ğŸ“Œ å…©å€‹åˆ—è¡¨éƒ½æœƒé¡¯ç¤ºé«˜äº®é¸ä¸­æ•ˆæœ

2. **é¡¯ç¤ºå„ªå…ˆé †åº**
   - é§•é§›å„ªå…ˆæ–¼è»Šè¼›ï¼ˆç¬¦åˆæ¥­å‹™é‚è¼¯ï¼‰
   - ç•¶å…©è€…éƒ½æœ‰é¸æ“‡æ™‚ï¼Œå„ªå…ˆé¡¯ç¤ºé§•é§›çš„å¸³å‹™è¨˜éŒ„
   - é»é¸ä»»ä¸€åˆ—è¡¨é …ç›®å¯åˆ‡æ›é¡¯ç¤ºå…§å®¹

3. **ç‹€æ…‹ä¿æŒ**
   - æ‰€æœ‰æ“ä½œï¼ˆæ–°å¢/ç·¨è¼¯/åˆªé™¤ï¼‰å¾Œéƒ½ä¿æŒæœå°‹ç‹€æ…‹
   - ä¿æŒå…©å€‹åˆ—è¡¨çš„é¸ä¸­ç‹€æ…‹ä¸è®Š
   - ä¸éœ€è¦é‡æ–°æœå°‹ï¼Œæå‡å·¥ä½œæ•ˆç‡

4. **éˆæ´»æ€§**
   - è‡ªå‹•é¸æ“‡ä¸é™åˆ¶æ‰‹å‹•åˆ‡æ›
   - ä½¿ç”¨è€…å¯è‡ªç”±æŸ¥çœ‹ä»»ä¸€é§•é§›æˆ–è»Šè¼›çš„å¸³å‹™
   - åˆ‡æ›é¡¯ç¤ºæ™‚ä¿ç•™å…©å€‹åˆ—è¡¨çš„é¸æ“‡ç‹€æ…‹

5. **å‹å–„æç¤º**
   - å³ä½¿æ²’æœ‰å¸³å‹™è¨˜éŒ„ï¼Œä¹Ÿé¡¯ç¤ºç©ºåˆ—è¡¨
   - æ¸…æ¥šæ¨™ç¤ºã€Œç›®å‰æ²’æœ‰å¸³å‹™è¨˜éŒ„ã€
