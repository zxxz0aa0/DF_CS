# 帳務管理系統開發規劃文件

此文件為帳務管理系統的完整開發規劃文件，詳細記錄專案背景、需求分析、技術架構、資料庫設計、API 設計、前端介面設計、權限管理、開發時程等完整開發藍圖。

---

## 📋 專案概述

### 🎯 專案背景
企業集團需要建立標準化的帳務管理系統，以記錄財務和帳務處理作業。系統需整合現有的駕駛管理、車輛管理和會計科目管理，提供完整的帳務記錄功能。

### 🎯 專案目標
- **主要目標**：建立完整的帳務記錄管理系統
- **核心功能**：帳務記錄的建立、查詢、編輯和管理
- **系統整合**：整合駕駛、車輛、會計科目等現有模組
- **資料管理**：支援批次新增、多條件搜尋、統計報表
- **使用者體驗**：提供直觀易用的動態表格介面

### 🎯 專案範圍

#### 核心功能模組
- **搜尋功能**：支援姓名、車牌號碼、車隊編號的關鍵字搜尋
- **駕駛列表**：顯示搜尋到的駕駛資料，支援選擇與詳細資料檢視 ✨
- **車輛列表**：顯示搜尋到的車輛資料，支援選擇與詳細資料檢視 ✨
- **帳務新增**：動態表格批次新增多筆帳務記錄
- **帳務查詢**：查詢駕駛或車輛的所有帳務記錄
- **帳務編輯**：修改已建立的帳務記錄
- **帳務刪除**：多選軟刪除帳務記錄
- **統計報表**：借方、貸方金額統計
- **詳細資料檢視**：Modal 彈窗顯示駕駛/車輛完整資料 ✨ 新增功能

#### 技術範圍
- **後端開發**：Laravel 11.x + PHP 8.4+
- **前端開發**：Vue 3 + Inertia.js + AdminLTE 4
- **資料庫設計**：SQLite（開發）/ MySQL（正式）
- **權限管理**：整合現有 Position (職務) 系統
- **測試覆蓋**：單元測試和功能測試

---

## 🎬 使用者操作流程

### 標準操作流程

#### 1️⃣ 搜尋駕駛或車輛
```
使用者輸入關鍵字 → 選擇搜尋類型（姓名/車牌/車隊編號）→ 點擊搜尋
```

**系統行為**：
- 執行搜尋並顯示符合條件的駕駛列表和車輛列表
- 如果有搜尋結果，自動執行以下選擇邏輯

#### 2️⃣ 自動選擇與載入邏輯

**預設選擇規則**（自動執行）：
```
搜尋後自動選擇：
1. IF 有駕駛列表資料 THEN 自動選擇第一個駕駛（高亮顯示）
2. IF 有車輛列表資料 THEN 自動選擇第一個車輛（高亮顯示）

顯示帳務記錄優先順序：
IF 有選擇駕駛 THEN
    顯示該駕駛的帳務記錄
ELSE IF 有選擇車輛 THEN
    顯示該車輛的帳務記錄
END IF
```

**重要特性**：
1. ✅ **雙列表選擇**：駕駛列表和車輛列表都會顯示選中狀態（各自獨立高亮）
2. ✅ **優先顯示駕駛**：同時有駕駛和車輛時，優先顯示駕駛帳務記錄
3. ✅ **可自由切換**：使用者點選任一列表項目，會切換顯示該對象的帳務記錄
4. ✅ **保持選擇狀態**：切換顯示時，兩個列表的選中狀態都保留（不會清空）

**使用者可操作**：
- ✅ 點選駕駛列表中的任一駕駛 → 切換查看該駕駛的帳務記錄
- ✅ 點選車輛列表中的任一車輛 → 切換查看該車輛的帳務記錄
- ✅ 兩個列表都保持各自的選中狀態（視覺提示）

#### 3️⃣ 帳務記錄顯示

**顯示條件**：
- 只要選擇了駕駛或車輛，就會顯示帳務記錄列表卡片
- 即使該駕駛/車輛沒有任何帳務記錄，也會顯示列表（顯示「目前沒有帳務記錄」）

**統計資訊**：
- 自動計算並顯示：借方加總、貸方加總、餘額（借-貸）
- 沒有記錄時顯示 0.00

#### 4️⃣ 新增帳務記錄

**操作流程**：
```
選擇駕駛/車輛 → 顯示帳務新增表格 → 填寫帳務資料 → 點擊「確定新增」
```

**系統行為**（新增後）：
- ✅ **保留搜尋結果**：駕駛列表和車輛列表不會消失
- ✅ **保留選擇狀態**：當前選擇的駕駛/車輛保持選中
- ✅ **更新帳務列表**：自動重新載入帳務記錄，顯示剛新增的記錄
- ✅ **更新統計資訊**：自動重新計算借方、貸方、餘額

#### 5️⃣ 編輯與刪除

**編輯流程**：
```
點擊記錄的編輯按鈕 → 修改資料 → 儲存
```

**刪除流程**：
```
勾選要刪除的記錄 → 點擊「刪除選取項目」→ 確認刪除
```

**系統行為**（編輯/刪除後）：
- ✅ 保留搜尋結果和選擇狀態
- ✅ 自動更新帳務列表和統計資訊

---

## 🔄 互動流程圖

```
┌─────────────┐
│   搜尋頁面   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│ 輸入關鍵字 + 選擇搜尋類型         │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│  執行搜尋                        │
│  • 顯示駕駛列表                  │
│  • 顯示車輛列表                  │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│  自動選擇邏輯（雙列表）          │
│  1. 有駕駛 → 選第一個駕駛✅      │
│  2. 有車輛 → 選第一個車輛✅      │
│  (兩個列表各自獨立高亮)          │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│  自動載入帳務記錄（優先駕駛）    │
│  IF 有駕駛 THEN                  │
│    顯示駕駛帳務記錄              │
│  ELSE                            │
│    顯示車輛帳務記錄              │
│  • 顯示統計資訊                  │
│  • 顯示新增表格                  │
└──────┬──────────────────────────┘
       │
       ├──→ 手動點選駕駛（切換顯示駕駛帳務，保留車輛選擇）
       ├──→ 手動點選車輛（切換顯示車輛帳務，保留駕駛選擇）
       │
       ├──→ 新增帳務記錄
       │         │
       │         ▼
       │    保留搜尋結果 + 選擇
       │    更新列表 + 統計
       │
       ├──→ 編輯帳務記錄
       │         │
       │         ▼
       │    保留搜尋結果 + 選擇
       │    更新列表 + 統計
       │
       └──→ 刪除帳務記錄
                 │
                 ▼
            保留搜尋結果 + 選擇
            更新列表 + 統計
```

---

## 💡 使用者體驗重點

### ✅ 直觀性
- 搜尋後自動選擇第一筆，減少操作步驟
- 優先顯示駕駛帳務（符合業務邏輯）

### ✅ 一致性
- 所有操作（新增/編輯/刪除）後都保持搜尋狀態
- 不需要重新搜尋，提升效率

### ✅ 容錯性
- 即使沒有帳務記錄，也會顯示介面
- 清楚提示「目前沒有帳務記錄」

### ✅ 靈活性
- 自動選擇不影響手動切換
- 駕駛與車輛可自由切換查看

---

## 🗄️ 資料庫設計

### 資料表結構概覽

帳務管理系統的核心資料表關聯：

```
Users (使用者)
    ↓ (建立者)
AccountingRecords (帳務記錄)
    ↓ (N:1)
    ├── Drivers (駕駛) - nullable
    ├── Vehicles (車輛) - nullable
    └── AccountDetails (會計科目明細) - required
        ↓ (N:1)
        ├── AccountMainCategories (會計科目總類)
        └── AccountSubCategories (會計科目子分類)
```

### 1. 帳務記錄主資料表 (accounting_records)

| 欄位名稱 | 資料型態 | 長度 | 約束 | 說明 |
|---------|---------|------|------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | 主鍵 |
| driver_id | BIGINT | - | FOREIGN KEY, NULLABLE | 駕駛外鍵 (drivers.id) |
| vehicle_id | BIGINT | - | FOREIGN KEY, NULLABLE | 車輛外鍵 (vehicles.id) |
| account_detail_id | BIGINT | - | FOREIGN KEY, NOT NULL | 會計科目外鍵 (account_details.id) |
| transaction_date | DATE | - | NOT NULL | 交易日期 |
| driver_name | VARCHAR | 100 | NULLABLE | 駕駛姓名（冗余欄位，保存歷史記錄） |
| driver_id_number | VARCHAR | 20 | NULLABLE | 駕駛身分證字號（冗余欄位） |
| vehicle_license_number | VARCHAR | 20 | NULLABLE | 車牌號碼（冗余欄位） |
| debit_amount | DECIMAL | 15,2 | NULLABLE | 借方金額 |
| credit_amount | DECIMAL | 15,2 | NULLABLE | 貸方金額 |
| note | TEXT | - | NULLABLE | 備註 |
| created_by | BIGINT | - | FOREIGN KEY, NOT NULL | 建立者 (users.id) |
| updated_by | BIGINT | - | FOREIGN KEY, NULLABLE | 最後更新者 (users.id) |
| created_at | TIMESTAMP | - | NOT NULL | 建立時間 |
| updated_at | TIMESTAMP | - | NOT NULL | 更新時間 |
| deleted_at | TIMESTAMP | - | NULLABLE | 軟刪除時間 |

**設計說明**：
1. **冗余欄位設計**：`driver_name`、`driver_id_number`、`vehicle_license_number` 雖然可透過關聯取得，但為了：
   - **效能考量**：避免多次 JOIN 查詢
   - **歷史記錄**：保存建立時的資料狀態，即使駕駛或車輛資料被修改或刪除，帳務記錄仍保持原始資訊

2. **金額欄位**：使用 DECIMAL(15,2) 確保精確計算，避免浮點數誤差

3. **軟刪除**：使用 `deleted_at` 實現軟刪除，保留歷史記錄用於審計

**索引設計**
```sql
-- 主鍵
PRIMARY KEY: `id`

-- 外鍵索引
INDEX: `driver_id`
INDEX: `vehicle_id`
INDEX: `account_detail_id`
INDEX: `created_by`

-- 查詢優化索引
INDEX: `transaction_date`
INDEX: `deleted_at` (用於軟刪除查詢)
COMPOSITE INDEX: `driver_id, transaction_date` (駕駛帳務查詢優化)
COMPOSITE INDEX: `vehicle_id, transaction_date` (車輛帳務查詢優化)

-- 搜尋索引
INDEX: `driver_name`
INDEX: `driver_id_number`
INDEX: `vehicle_license_number`
```

**CHECK 約束**
```sql
-- 確保借方或貸方至少有一個有值
CONSTRAINT chk_amount CHECK (
    (debit_amount IS NOT NULL AND debit_amount > 0) OR
    (credit_amount IS NOT NULL AND credit_amount > 0)
)

-- 確保金額不為負數
CONSTRAINT chk_debit_positive CHECK (debit_amount IS NULL OR debit_amount >= 0)
CONSTRAINT chk_credit_positive CHECK (credit_amount IS NULL OR credit_amount >= 0)
```

### 外鍵約束關係

```sql
-- 帳務記錄表外鍵約束
ALTER TABLE accounting_records
    -- 駕駛外鍵 (nullable, 刪除駕駛時保留記錄)
    ADD CONSTRAINT fk_accounting_records_driver
    FOREIGN KEY (driver_id) REFERENCES drivers(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- 車輛外鍵 (nullable, 刪除車輛時保留記錄)
    ADD CONSTRAINT fk_accounting_records_vehicle
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- 會計科目外鍵 (required, 不允許刪除已使用的科目)
    ADD CONSTRAINT fk_accounting_records_account_detail
    FOREIGN KEY (account_detail_id) REFERENCES account_details(id)
    ON DELETE RESTRICT ON UPDATE CASCADE,

    -- 建立者外鍵 (刪除使用者時保留記錄)
    ADD CONSTRAINT fk_accounting_records_created_by
    FOREIGN KEY (created_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE,

    -- 更新者外鍵
    ADD CONSTRAINT fk_accounting_records_updated_by
    FOREIGN KEY (updated_by) REFERENCES users(id)
    ON DELETE SET NULL ON UPDATE CASCADE;
```

### 資料庫設計要點

#### 1. 資料完整性保障
- 使用外鍵約束確保參照完整性
- 使用 CHECK 約束確保業務邏輯正確性
- 軟刪除機制保護歷史資料

#### 2. 效能最佳化考量
- 針對常用查詢條件建立複合索引
- 冗余欄位減少 JOIN 查詢
- 適當的資料型態減少儲存空間

#### 3. 歷史記錄保存
- 冗余欄位保存快照資料
- 軟刪除保留審計追蹤
- `created_by` 和 `updated_by` 記錄操作者

---

## ⚙️ 技術架構設計

### 後端架構設計

#### 控制器架構 (Controllers)

```php
// 控制器結構
app/Http/Controllers/Admin/
└── AccountingRecordController.php     // 帳務記錄管理
```

**控制器設計模式**
```php
<?php
namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Http\Requests\AccountingRecordRequest;
use App\Models\AccountingRecord;
use App\Models\Driver;
use App\Models\Vehicle;
use App\Services\AccountingRecordService;
use Illuminate\Http\Request;
use Inertia\Inertia;

class AccountingRecordController extends Controller
{
    protected $accountingRecordService;

    public function __construct(AccountingRecordService $accountingRecordService)
    {
        $this->accountingRecordService = $accountingRecordService;
    }

    /**
     * 顯示帳務管理主頁面
     */
    public function index(Request $request)
    {
        // 處理搜尋邏輯
        $searchType = $request->input('search_type'); // name, license, fleet
        $keyword = $request->input('keyword');

        $drivers = [];
        $vehicles = [];
        $records = [];
        $statistics = null;

        if ($keyword) {
            // 根據搜尋類型執行搜尋
            $result = $this->accountingRecordService->search($searchType, $keyword);
            $drivers = $result['drivers'];
            $vehicles = $result['vehicles'];
        }

        // 如果有選擇的駕駛或車輛，載入帳務記錄
        $selectedDriverId = $request->input('driver_id');
        $selectedVehicleId = $request->input('vehicle_id');

        if ($selectedDriverId || $selectedVehicleId) {
            $records = $this->accountingRecordService->getRecords(
                $selectedDriverId,
                $selectedVehicleId
            );
            $statistics = $this->accountingRecordService->calculateStatistics($records);
        }

        return Inertia::render('Admin/AccountingRecords/Index', [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
            'records' => $records,
            'statistics' => $statistics,
            'filters' => [
                'search_type' => $searchType,
                'keyword' => $keyword,
                'driver_id' => $selectedDriverId,
                'vehicle_id' => $selectedVehicleId,
            ]
        ]);
    }

    /**
     * 批次儲存帳務記錄
     */
    public function store(AccountingRecordRequest $request)
    {
        try {
            $records = $this->accountingRecordService->batchCreate(
                $request->validated()
            );

            return redirect()
                ->route('admin.accounting-records.index')
                ->with('success', '成功新增 ' . count($records) . ' 筆帳務記錄');

        } catch (\Exception $e) {
            return back()
                ->withErrors(['error' => '新增失敗：' . $e->getMessage()])
                ->withInput();
        }
    }

    /**
     * 更新單筆帳務記錄
     */
    public function update(AccountingRecordRequest $request, AccountingRecord $accountingRecord)
    {
        try {
            $this->accountingRecordService->update($accountingRecord, $request->validated());

            return back()->with('success', '帳務記錄已更新');

        } catch (\Exception $e) {
            return back()->withErrors(['error' => '更新失敗：' . $e->getMessage()]);
        }
    }

    /**
     * 批次軟刪除帳務記錄
     */
    public function batchDestroy(Request $request)
    {
        $request->validate([
            'ids' => 'required|array',
            'ids.*' => 'exists:accounting_records,id'
        ]);

        try {
            $count = $this->accountingRecordService->batchDelete($request->ids);

            return back()->with('success', "成功刪除 {$count} 筆帳務記錄");

        } catch (\Exception $e) {
            return back()->withErrors(['error' => '刪除失敗：' . $e->getMessage()]);
        }
    }

    /**
     * API: 搜尋會計科目
     */
    public function searchAccountDetails(Request $request)
    {
        $keyword = $request->input('keyword');

        $accounts = $this->accountingRecordService->searchAccountDetails($keyword);

        return response()->json($accounts);
    }
}
```

#### 模型架構 (Models)

**AccountingRecord 模型設計**
```php
<?php
namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\SoftDeletes;

class AccountingRecord extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'driver_id',
        'vehicle_id',
        'account_detail_id',
        'transaction_date',
        'driver_name',
        'driver_id_number',
        'vehicle_license_number',
        'debit_amount',
        'credit_amount',
        'note',
        'created_by',
        'updated_by',
    ];

    protected $casts = [
        'transaction_date' => 'date',
        'debit_amount' => 'decimal:2',
        'credit_amount' => 'decimal:2',
    ];

    /**
     * 關聯：駕駛
     */
    public function driver(): BelongsTo
    {
        return $this->belongsTo(Driver::class)->withTrashed();
    }

    /**
     * 關聯：車輛
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(Vehicle::class)->withTrashed();
    }

    /**
     * 關聯：會計科目明細
     */
    public function accountDetail(): BelongsTo
    {
        return $this->belongsTo(AccountDetail::class);
    }

    /**
     * 關聯：建立者
     */
    public function creator(): BelongsTo
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /**
     * 關聯：更新者
     */
    public function updater(): BelongsTo
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    /**
     * 自動填入建立者
     */
    protected static function boot()
    {
        parent::boot();

        static::creating(function ($model) {
            if (auth()->check()) {
                $model->created_by = auth()->id();
            }
        });

        static::updating(function ($model) {
            if (auth()->check()) {
                $model->updated_by = auth()->id();
            }
        });
    }

    /**
     * Scope: 依駕駛篩選
     */
    public function scopeByDriver($query, $driverId)
    {
        return $query->where('driver_id', $driverId);
    }

    /**
     * Scope: 依車輛篩選
     */
    public function scopeByVehicle($query, $vehicleId)
    {
        return $query->where('vehicle_id', $vehicleId);
    }

    /**
     * Scope: 依日期範圍篩選
     */
    public function scopeDateRange($query, $startDate, $endDate)
    {
        return $query->whereBetween('transaction_date', [$startDate, $endDate]);
    }

    /**
     * Scope: 依關鍵字搜尋
     */
    public function scopeSearch($query, $keyword)
    {
        return $query->where(function($q) use ($keyword) {
            $q->where('driver_name', 'like', "%{$keyword}%")
              ->orWhere('driver_id_number', 'like', "%{$keyword}%")
              ->orWhere('vehicle_license_number', 'like', "%{$keyword}%")
              ->orWhere('note', 'like', "%{$keyword}%");
        });
    }
}
```

#### 服務層設計 (Services)

**AccountingRecordService**
```php
<?php
namespace App\Services;

use App\Models\AccountingRecord;
use App\Models\AccountDetail;
use App\Models\Driver;
use App\Models\Vehicle;
use App\Models\DriverVehicleAssignment;
use Illuminate\Support\Facades\DB;

class AccountingRecordService
{
    /**
     * 搜尋功能
     */
    public function search(string $searchType, string $keyword): array
    {
        $drivers = [];
        $vehicles = [];

        switch ($searchType) {
            case 'name':
                // 搜尋駕駛姓名
                $drivers = Driver::where('name', 'like', "%{$keyword}%")
                    ->select('id', 'name', 'id_number', 'birth_date')
                    ->get();

                // 透過駕駛找車輛
                if ($drivers->isNotEmpty()) {
                    $driverIds = $drivers->pluck('id');
                    $vehicleIds = DriverVehicleAssignment::whereIn('driver_id', $driverIds)
                        ->pluck('vehicle_id');
                    $vehicles = Vehicle::whereIn('id', $vehicleIds)
                        ->select('id', 'license_number', 'fleet_number', 'owner_name')
                        ->get();
                }
                break;

            case 'license':
                // 搜尋車牌號碼
                $vehicles = Vehicle::where('license_number', 'like', "%{$keyword}%")
                    ->select('id', 'license_number', 'fleet_number', 'owner_name')
                    ->get();

                // 透過車輛找駕駛
                if ($vehicles->isNotEmpty()) {
                    $vehicleIds = $vehicles->pluck('id');
                    $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
                        ->pluck('driver_id');
                    $drivers = Driver::whereIn('id', $driverIds)
                        ->select('id', 'name', 'id_number', 'birth_date')
                        ->get();
                }
                break;

            case 'fleet':
                // 搜尋車隊編號
                $vehicles = Vehicle::where('fleet_number', 'like', "%{$keyword}%")
                    ->select('id', 'license_number', 'fleet_number', 'owner_name')
                    ->get();

                // 透過車輛找駕駛
                if ($vehicles->isNotEmpty()) {
                    $vehicleIds = $vehicles->pluck('id');
                    $driverIds = DriverVehicleAssignment::whereIn('vehicle_id', $vehicleIds)
                        ->pluck('driver_id');
                    $drivers = Driver::whereIn('id', $driverIds)
                        ->select('id', 'name', 'id_number', 'birth_date')
                        ->get();
                }
                break;
        }

        return [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
        ];
    }

    /**
     * 取得帳務記錄
     */
    public function getRecords($driverId = null, $vehicleId = null)
    {
        $query = AccountingRecord::with(['accountDetail.mainCategory', 'accountDetail.subCategory']);

        if ($driverId) {
            $query->byDriver($driverId);
        } elseif ($vehicleId) {
            $query->byVehicle($vehicleId);
        }

        return $query->orderBy('transaction_date', 'desc')
            ->orderBy('created_at', 'desc')
            ->paginate(20);
    }

    /**
     * 計算統計數據
     */
    public function calculateStatistics($records): array
    {
        $debitTotal = 0;
        $creditTotal = 0;

        foreach ($records as $record) {
            $debitTotal += $record->debit_amount ?? 0;
            $creditTotal += $record->credit_amount ?? 0;
        }

        $balance = $debitTotal - $creditTotal;

        return [
            'debit_total' => number_format($debitTotal, 2),
            'credit_total' => number_format($creditTotal, 2),
            'balance' => number_format($balance, 2),
            'balance_is_negative' => $balance < 0,
        ];
    }

    /**
     * 批次建立帳務記錄
     */
    public function batchCreate(array $data): array
    {
        $records = [];

        DB::beginTransaction();

        try {
            foreach ($data['records'] as $recordData) {
                // 檢查重複記錄（警告但允許）
                $this->checkDuplicateWarning($recordData);

                // 取得駕駛資料
                $driver = null;
                if (!empty($recordData['driver_id'])) {
                    $driver = Driver::find($recordData['driver_id']);
                }

                // 取得車輛資料
                $vehicle = null;
                if (!empty($recordData['vehicle_id'])) {
                    $vehicle = Vehicle::find($recordData['vehicle_id']);
                }

                // 建立記錄
                $record = AccountingRecord::create([
                    'driver_id' => $recordData['driver_id'] ?? null,
                    'vehicle_id' => $recordData['vehicle_id'] ?? null,
                    'account_detail_id' => $recordData['account_detail_id'],
                    'transaction_date' => $recordData['transaction_date'],
                    'driver_name' => $driver ? $driver->name : null,
                    'driver_id_number' => $driver ? $driver->id_number : null,
                    'vehicle_license_number' => $vehicle ? $vehicle->license_number : null,
                    'debit_amount' => $recordData['debit_amount'] ?? null,
                    'credit_amount' => $recordData['credit_amount'] ?? null,
                    'note' => $recordData['note'] ?? null,
                ]);

                $records[] = $record;
            }

            DB::commit();

            return $records;

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }

    /**
     * 更新帳務記錄
     */
    public function update(AccountingRecord $record, array $data): AccountingRecord
    {
        DB::beginTransaction();

        try {
            // 如果更改了駕駛，更新冗余欄位
            if (isset($data['driver_id']) && $data['driver_id'] != $record->driver_id) {
                $driver = Driver::find($data['driver_id']);
                $data['driver_name'] = $driver ? $driver->name : null;
                $data['driver_id_number'] = $driver ? $driver->id_number : null;
            }

            // 如果更改了車輛，更新冗余欄位
            if (isset($data['vehicle_id']) && $data['vehicle_id'] != $record->vehicle_id) {
                $vehicle = Vehicle::find($data['vehicle_id']);
                $data['vehicle_license_number'] = $vehicle ? $vehicle->license_number : null;
            }

            $record->update($data);

            DB::commit();

            return $record->fresh();

        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }

    /**
     * 批次刪除（軟刪除）
     */
    public function batchDelete(array $ids): int
    {
        return AccountingRecord::whereIn('id', $ids)->delete();
    }

    /**
     * 搜尋會計科目
     */
    public function searchAccountDetails(string $keyword): array
    {
        return AccountDetail::with(['mainCategory', 'subCategory'])
            ->where('account_code', 'like', "{$keyword}%")
            ->orWhere('account_name', 'like', "%{$keyword}%")
            ->where('is_active', true)
            ->orderBy('account_code')
            ->limit(20)
            ->get()
            ->map(function ($account) {
                return [
                    'id' => $account->id,
                    'account_code' => $account->account_code,
                    'account_name' => $account->account_name,
                    'main_category_name' => $account->mainCategory->category_name,
                    'sub_category_name' => $account->subCategory->sub_category_name,
                ];
            })
            ->toArray();
    }

    /**
     * 檢查重複記錄（僅警告）
     */
    protected function checkDuplicateWarning(array $data): void
    {
        $duplicate = AccountingRecord::where('driver_id', $data['driver_id'] ?? null)
            ->where('vehicle_id', $data['vehicle_id'] ?? null)
            ->where('account_detail_id', $data['account_detail_id'])
            ->where('transaction_date', $data['transaction_date'])
            ->where('debit_amount', $data['debit_amount'] ?? null)
            ->where('credit_amount', $data['credit_amount'] ?? null)
            ->exists();

        if ($duplicate) {
            \Log::warning('可能的重複帳務記錄', $data);
            // 這裡只記錄警告，不阻止新增
        }
    }
}
```

#### 請求驗證 (Form Requests)

**AccountingRecordRequest**
```php
<?php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class AccountingRecordRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        // 批次新增
        if ($this->isMethod('post') && $this->has('records')) {
            return [
                'records' => 'required|array|min:1',
                'records.*.driver_id' => 'nullable|exists:drivers,id',
                'records.*.vehicle_id' => 'nullable|exists:vehicles,id',
                'records.*.account_detail_id' => 'required|exists:account_details,id',
                'records.*.transaction_date' => 'required|date',
                'records.*.debit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
                'records.*.credit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
                'records.*.note' => 'nullable|string|max:1000',
            ];
        }

        // 單筆更新
        return [
            'driver_id' => 'nullable|exists:drivers,id',
            'vehicle_id' => 'nullable|exists:vehicles,id',
            'account_detail_id' => 'required|exists:account_details,id',
            'transaction_date' => 'required|date',
            'debit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
            'credit_amount' => 'nullable|numeric|min:0|max:9999999999.99',
            'note' => 'nullable|string|max:1000',
        ];
    }

    public function messages(): array
    {
        return [
            'records.required' => '至少需要新增一筆記錄',
            'records.*.account_detail_id.required' => '會計科目為必填欄位',
            'records.*.transaction_date.required' => '交易日期為必填欄位',
            'records.*.debit_amount.numeric' => '借方金額必須為數字',
            'records.*.credit_amount.numeric' => '貸方金額必須為數字',
        ];
    }

    /**
     * 額外驗證：確保借方或貸方至少有一個有值
     */
    public function withValidator($validator)
    {
        $validator->after(function ($validator) {
            if ($this->has('records')) {
                foreach ($this->records as $index => $record) {
                    $debit = $record['debit_amount'] ?? 0;
                    $credit = $record['credit_amount'] ?? 0;

                    if ($debit == 0 && $credit == 0) {
                        $validator->errors()->add(
                            "records.{$index}.debit_amount",
                            '借方金額或貸方金額至少需要填寫一個'
                        );
                    }
                }
            } else {
                // 單筆驗證
                $debit = $this->debit_amount ?? 0;
                $credit = $this->credit_amount ?? 0;

                if ($debit == 0 && $credit == 0) {
                    $validator->errors()->add(
                        'debit_amount',
                        '借方金額或貸方金額至少需要填寫一個'
                    );
                }
            }
        });
    }
}
```

#### 路由設計 (Routes)

```php
// routes/web.php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {

    // 帳務管理路由群組
    Route::prefix('accounting')->name('accounting.')->middleware('permission:view accounting')->group(function () {

        // 主頁面（搜尋、列表、新增）
        Route::get('records', [AccountingRecordController::class, 'index'])
            ->name('records.index');

        // 批次新增
        Route::post('records', [AccountingRecordController::class, 'store'])
            ->name('records.store')
            ->middleware('permission:create accounting');

        // 單筆更新
        Route::put('records/{accountingRecord}', [AccountingRecordController::class, 'update'])
            ->name('records.update')
            ->middleware('permission:edit accounting');

        // 批次刪除
        Route::delete('records/batch', [AccountingRecordController::class, 'batchDestroy'])
            ->name('records.batch-destroy')
            ->middleware('permission:delete accounting');

        // API 路由
        Route::prefix('api')->name('api.')->group(function () {
            // 搜尋會計科目
            Route::get('account-details/search', [AccountingRecordController::class, 'searchAccountDetails'])
                ->name('account-details.search');
        });
    });
});
```

---

## 🎨 前端介面設計

### Vue 組件架構

**組件結構規劃**
```
resources/js/Pages/Admin/AccountingRecords/
├── Index.vue                    // 帳務管理主頁面
└── Components/
    ├── SearchPanel.vue          // 搜尋面板組件
    ├── DriverList.vue           // 駕駛列表組件
    ├── VehicleList.vue          // 車輛列表組件
    ├── AccountingForm.vue       // 帳務新增表格組件
    ├── AccountingRecordList.vue // 帳務記錄列表組件
    ├── AccountSelector.vue      // 會計科目選擇器組件
    ├── DriverDetailModal.vue    // 駕駛詳細資料模態框組件 ✨ 新增
    └── VehicleDetailModal.vue   // 車輛詳細資料模態框組件 ✨ 新增
```

### 主頁面設計 (Index.vue)

```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <div class="content-wrapper">
      <!-- 頁面標題 -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>帳務管理</h1>
            </div>
          </div>
        </div>
      </div>

      <!-- 主要內容 -->
      <div class="content">
        <div class="container-fluid">

          <!-- 1. 搜尋功能卡片 -->
          <SearchPanel
            :filters="filters"
            @search="handleSearch"
          />

          <!-- 2. 駕駛列表卡片 -->
          <DriverList
            v-if="drivers.length > 0"
            :drivers="drivers"
            :selected-id="selectedDriverId"
            @select="handleDriverSelect"
          />

          <!-- 3. 車輛列表卡片 -->
          <VehicleList
            v-if="vehicles.length > 0"
            :vehicles="vehicles"
            :selected-id="selectedVehicleId"
            @select="handleVehicleSelect"
          />

          <!-- 4. 帳務新增表格卡片 -->
          <AccountingForm
            :selected-driver="selectedDriver"
            :selected-vehicle="selectedVehicle"
            @submit="handleSubmit"
          />

          <!-- 5. 帳務資訊列表卡片 -->
          <AccountingRecordList
            v-if="records.data && records.data.length > 0"
            :records="records"
            :statistics="statistics"
            :show-driver-button="drivers.length > 0"
            :show-vehicle-button="vehicles.length > 0"
            @edit="handleEdit"
            @delete="handleDelete"
            @switch-view="handleSwitchView"
          />

        </div>
      </div>
    </div>

    <!-- 編輯模態框 -->
    <EditModal
      v-if="editingRecord"
      :record="editingRecord"
      @close="editingRecord = null"
      @save="handleUpdate"
    />
  </AdminLayout>
</template>

<script setup>
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import SearchPanel from './Components/SearchPanel.vue'
import DriverList from './Components/DriverList.vue'
import VehicleList from './Components/VehicleList.vue'
import AccountingForm from './Components/AccountingForm.vue'
import AccountingRecordList from './Components/AccountingRecordList.vue'
import EditModal from './Components/EditModal.vue'

const props = defineProps({
  drivers: { type: Array, default: () => [] },
  vehicles: { type: Array, default: () => [] },
  records: { type: Object, default: () => ({ data: [] }) },
  statistics: { type: Object, default: null },
  filters: { type: Object, default: () => ({}) }
})

// 選擇的駕駛和車輛
const selectedDriverId = ref(props.filters.driver_id || (props.drivers[0]?.id || null))
const selectedVehicleId = ref(props.filters.vehicle_id || (props.vehicles[0]?.id || null))

const selectedDriver = computed(() =>
  props.drivers.find(d => d.id === selectedDriverId.value)
)

const selectedVehicle = computed(() =>
  props.vehicles.find(v => v.id === selectedVehicleId.value)
)

// 編輯中的記錄
const editingRecord = ref(null)

// 處理搜尋
const handleSearch = (searchData) => {
  router.get(route('admin.accounting.records.index'), searchData, {
    preserveState: false
  })
}

// 處理駕駛選擇
const handleDriverSelect = (driverId) => {
  selectedDriverId.value = driverId
  loadRecords()
}

// 處理車輛選擇
const handleVehicleSelect = (vehicleId) => {
  selectedVehicleId.value = vehicleId
  loadRecords()
}

// 載入帳務記錄
const loadRecords = () => {
  router.get(route('admin.accounting.records.index'), {
    ...props.filters,
    driver_id: selectedDriverId.value,
    vehicle_id: selectedVehicleId.value
  }, {
    preserveState: true,
    preserveScroll: true,
    only: ['records', 'statistics']
  })
}

// 處理新增提交
const handleSubmit = (formData) => {
  router.post(route('admin.accounting.records.store'), formData, {
    onSuccess: () => {
      loadRecords()
    }
  })
}

// 處理編輯
const handleEdit = (record) => {
  editingRecord.value = record
}

// 處理更新
const handleUpdate = (recordId, data) => {
  router.put(route('admin.accounting.records.update', recordId), data, {
    onSuccess: () => {
      editingRecord.value = null
      loadRecords()
    }
  })
}

// 處理刪除
const handleDelete = (ids) => {
  if (!confirm(`確定要刪除 ${ids.length} 筆帳務記錄嗎？`)) return

  router.delete(route('admin.accounting.records.batch-destroy'), {
    data: { ids },
    onSuccess: () => {
      loadRecords()
    }
  })
}

// 處理切換檢視（駕駛/車輛）
const handleSwitchView = (viewType) => {
  if (viewType === 'driver') {
    selectedVehicleId.value = null
  } else {
    selectedDriverId.value = null
  }
  loadRecords()
}
</script>
```

### 核心組件設計

#### 1. 搜尋面板組件 (SearchPanel.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">搜尋功能</h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <label>搜尋類型</label>
          <select v-model="form.search_type" class="form-select">
            <option value="name">姓名</option>
            <option value="license">車牌號碼</option>
            <option value="fleet">車隊編號</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>關鍵字</label>
          <input
            v-model="form.keyword"
            type="text"
            class="form-control"
            placeholder="請輸入搜尋關鍵字"
            @keyup.enter="search"
          >
        </div>
        <div class="col-md-3">
          <label>&nbsp;</label>
          <button @click="search" class="btn btn-primary d-block w-100">
            <i class="bi bi-search"></i> 搜尋
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { reactive } from 'vue'

const props = defineProps({
  filters: { type: Object, default: () => ({}) }
})

const emit = defineEmits(['search'])

const form = reactive({
  search_type: props.filters.search_type || 'name',
  keyword: props.filters.keyword || ''
})

const search = () => {
  emit('search', { ...form })
}
</script>
```

#### 2. 駕駛列表組件 (DriverList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">駕駛列表</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width: 50px;">選擇</th>
              <th>姓名</th>
              <th>身分證字號</th>
              <th>生日</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="driver in drivers"
              :key="driver.id"
              :class="{ 'table-active': driver.id === selectedId }"
              @click="selectDriver(driver.id)"
              style="cursor: pointer;"
            >
              <td>
                <input
                  type="radio"
                  :checked="driver.id === selectedId"
                  @change="selectDriver(driver.id)"
                >
              </td>
              <td>{{ driver.name }}</td>
              <td>{{ driver.id_number }}</td>
              <td>{{ formatDate(driver.birth_date) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script setup>
const props = defineProps({
  drivers: { type: Array, required: true },
  selectedId: { type: Number, default: null }
})

const emit = defineEmits(['select'])

const selectDriver = (driverId) => {
  emit('select', driverId)
}

const formatDate = (date) => {
  if (!date) return '-'
  return new Date(date).toLocaleDateString('zh-TW')
}
</script>
```

#### 3. 車輛列表組件 (VehicleList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">車輛列表</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width: 50px;">選擇</th>
              <th>車牌號碼</th>
              <th>車隊編號</th>
              <th>車主名稱</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="vehicle in vehicles"
              :key="vehicle.id"
              :class="{ 'table-active': vehicle.id === selectedId }"
              @click="selectVehicle(vehicle.id)"
              style="cursor: pointer;"
            >
              <td>
                <input
                  type="radio"
                  :checked="vehicle.id === selectedId"
                  @change="selectVehicle(vehicle.id)"
                >
              </td>
              <td>{{ vehicle.license_number }}</td>
              <td>{{ vehicle.fleet_number || '-' }}</td>
              <td>{{ vehicle.owner_name || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script setup>
const props = defineProps({
  vehicles: { type: Array, required: true },
  selectedId: { type: Number, default: null }
})

const emit = defineEmits(['select'])

const selectVehicle = (vehicleId) => {
  emit('select', vehicleId)
}
</script>
```

#### 4. 帳務新增表格組件 (AccountingForm.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">帳務新增</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th style="width: 100px;">日期</th>
              <th style="width: 150px;">科目編號</th>
              <th style="width: 120px;">總類</th>
              <th style="width: 120px;">子分類</th>
              <th style="width: 100px;">車牌號碼</th>
              <th style="width: 120px;">身分證字號</th>
              <th style="width: 100px;">姓名</th>
              <th style="width: 120px;">借方金額</th>
              <th style="width: 120px;">貸方金額</th>
              <th style="width: 200px;">備註</th>
              <th style="width: 80px;">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(row, index) in rows" :key="index">
              <!-- 日期 -->
              <td>
                <input
                  v-model="row.transaction_date"
                  type="date"
                  class="form-control form-control-sm"
                  :class="{ 'is-invalid': errors[`records.${index}.transaction_date`] }"
                >
              </td>

              <!-- 科目編號搜尋 -->
              <td>
                <AccountSelector
                  v-model="row.account_detail_id"
                  @select="(account) => handleAccountSelect(index, account)"
                />
              </td>

              <!-- 總類 -->
              <td>
                <input
                  :value="row.main_category_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- 子分類 -->
              <td>
                <input
                  :value="row.sub_category_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- 車牌號碼 -->
              <td>
                <input
                  :value="row.vehicle_license_number"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- 身分證字號 -->
              <td>
                <input
                  :value="row.driver_id_number"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- 姓名 -->
              <td>
                <input
                  :value="row.driver_name"
                  type="text"
                  class="form-control form-control-sm"
                  readonly
                  disabled
                >
              </td>

              <!-- 借方金額 -->
              <td>
                <input
                  v-model.number="row.debit_amount"
                  type="number"
                  step="0.01"
                  class="form-control form-control-sm text-end"
                  :class="{ 'is-invalid': errors[`records.${index}.debit_amount`] }"
                >
              </td>

              <!-- 貸方金額 -->
              <td>
                <input
                  v-model.number="row.credit_amount"
                  type="number"
                  step="0.01"
                  class="form-control form-control-sm text-end"
                  :class="{ 'is-invalid': errors[`records.${index}.credit_amount`] }"
                >
              </td>

              <!-- 備註 -->
              <td>
                <input
                  v-model="row.note"
                  type="text"
                  class="form-control form-control-sm"
                >
              </td>

              <!-- 操作 -->
              <td class="text-center">
                <button
                  @click="removeRow(index)"
                  class="btn btn-sm btn-danger"
                  :disabled="rows.length === 1"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <button @click="addRow" class="btn btn-secondary">
            <i class="bi bi-plus-circle"></i> 新增列
          </button>
        </div>
        <div class="col-md-6 text-end">
          <button @click="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> 確定新增
          </button>
        </div>
      </div>

      <!-- 錯誤訊息顯示 -->
      <div v-if="Object.keys(errors).length > 0" class="alert alert-danger mt-3">
        <ul class="mb-0">
          <li v-for="(error, key) in errors" :key="key">{{ error }}</li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch, computed } from 'vue'
import { usePage } from '@inertiajs/vue3'
import AccountSelector from './AccountSelector.vue'

const props = defineProps({
  selectedDriver: { type: Object, default: null },
  selectedVehicle: { type: Object, default: null }
})

const emit = defineEmits(['submit'])

const page = usePage()
const errors = computed(() => page.props.errors || {})

// 表格列資料
const rows = ref([createNewRow()])

// 建立新列
function createNewRow() {
  const today = new Date().toISOString().split('T')[0]

  return {
    transaction_date: today,
    account_detail_id: null,
    account_code: '',
    main_category_name: '',
    sub_category_name: '',
    driver_id: props.selectedDriver?.id || null,
    driver_name: props.selectedDriver?.name || '',
    driver_id_number: props.selectedDriver?.id_number || '',
    vehicle_id: props.selectedVehicle?.id || null,
    vehicle_license_number: props.selectedVehicle?.license_number || '',
    debit_amount: null,
    credit_amount: null,
    note: ''
  }
}

// 新增列
const addRow = () => {
  rows.value.push(createNewRow())
}

// 刪除列
const removeRow = (index) => {
  if (rows.value.length > 1) {
    rows.value.splice(index, 1)
  }
}

// 處理會計科目選擇
const handleAccountSelect = (index, account) => {
  rows.value[index].account_detail_id = account.id
  rows.value[index].account_code = account.account_code
  rows.value[index].main_category_name = account.main_category_name
  rows.value[index].sub_category_name = account.sub_category_name
}

// 監聽選擇的駕駛變更
watch(() => props.selectedDriver, (newDriver) => {
  rows.value.forEach(row => {
    row.driver_id = newDriver?.id || null
    row.driver_name = newDriver?.name || ''
    row.driver_id_number = newDriver?.id_number || ''
  })
})

// 監聽選擇的車輛變更
watch(() => props.selectedVehicle, (newVehicle) => {
  rows.value.forEach(row => {
    row.vehicle_id = newVehicle?.id || null
    row.vehicle_license_number = newVehicle?.license_number || ''
  })
})

// 提交表單
const submit = () => {
  // 驗證必填欄位
  let hasError = false

  rows.value.forEach((row, index) => {
    if (!row.account_detail_id) {
      alert(`第 ${index + 1} 列：會計科目為必填`)
      hasError = true
      return
    }

    if (!row.transaction_date) {
      alert(`第 ${index + 1} 列：日期為必填`)
      hasError = true
      return
    }

    if (!row.debit_amount && !row.credit_amount) {
      alert(`第 ${index + 1} 列：借方或貸方金額至少需要填寫一個`)
      hasError = true
      return
    }
  })

  if (hasError) return

  emit('submit', { records: rows.value })
}
</script>
```

#### 5. 會計科目選擇器組件 (AccountSelector.vue)

```vue
<template>
  <div class="position-relative">
    <div class="input-group input-group-sm">
      <input
        v-model="searchKeyword"
        type="text"
        class="form-control"
        placeholder="輸入科目編號"
        @input="handleInput"
        @focus="showDropdown = true"
      >
      <button
        @click="openModal"
        class="btn btn-outline-secondary"
        type="button"
      >
        <i class="bi bi-search"></i>
      </button>
    </div>

    <!-- 自動完成下拉選單 -->
    <div
      v-if="showDropdown && filteredAccounts.length > 0"
      class="dropdown-menu show position-absolute w-100"
      style="max-height: 300px; overflow-y: auto; z-index: 1000;"
    >
      <a
        v-for="account in filteredAccounts"
        :key="account.id"
        href="#"
        class="dropdown-item"
        @click.prevent="selectAccount(account)"
      >
        <strong>{{ account.account_code }}</strong> - {{ account.account_name }}
        <br>
        <small class="text-muted">
          {{ account.main_category_name }} / {{ account.sub_category_name }}
        </small>
      </a>
    </div>

    <!-- 模態框選擇器 -->
    <div
      v-if="showModal"
      class="modal fade show d-block"
      tabindex="-1"
      style="background-color: rgba(0,0,0,0.5);"
      @click.self="closeModal"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">選擇會計科目</h5>
            <button
              type="button"
              class="btn-close"
              @click="closeModal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              v-model="modalSearchKeyword"
              type="text"
              class="form-control mb-3"
              placeholder="搜尋科目編號或名稱"
              @input="searchInModal"
            >
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>科目編號</th>
                    <th>科目名稱</th>
                    <th>總類</th>
                    <th>子分類</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="account in modalAccounts"
                    :key="account.id"
                    @click="selectAccount(account)"
                    style="cursor: pointer;"
                  >
                    <td>{{ account.account_code }}</td>
                    <td>{{ account.account_name }}</td>
                    <td>{{ account.main_category_name }}</td>
                    <td>{{ account.sub_category_name }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'
import axios from 'axios'

const props = defineProps({
  modelValue: { type: Number, default: null }
})

const emit = defineEmits(['update:modelValue', 'select'])

const searchKeyword = ref('')
const filteredAccounts = ref([])
const showDropdown = ref(false)

const showModal = ref(false)
const modalSearchKeyword = ref('')
const modalAccounts = ref([])

// 處理輸入 - 自動完成
const handleInput = async () => {
  if (searchKeyword.value.length === 0) {
    filteredAccounts.value = []
    showDropdown.value = false
    return
  }

  try {
    const response = await axios.get(
      route('admin.accounting.api.account-details.search'),
      { params: { keyword: searchKeyword.value } }
    )
    filteredAccounts.value = response.data
    showDropdown.value = true
  } catch (error) {
    console.error('搜尋失敗:', error)
  }
}

// 模態框搜尋
const searchInModal = async () => {
  if (modalSearchKeyword.value.length === 0) {
    modalAccounts.value = []
    return
  }

  try {
    const response = await axios.get(
      route('admin.accounting.api.account-details.search'),
      { params: { keyword: modalSearchKeyword.value } }
    )
    modalAccounts.value = response.data
  } catch (error) {
    console.error('搜尋失敗:', error)
  }
}

// 選擇科目
const selectAccount = (account) => {
  searchKeyword.value = account.account_code
  emit('update:modelValue', account.id)
  emit('select', account)
  showDropdown.value = false
  closeModal()
}

// 開啟模態框
const openModal = () => {
  showModal.value = true
  modalSearchKeyword.value = ''
  modalAccounts.value = []
}

// 關閉模態框
const closeModal = () => {
  showModal.value = false
}

// 點擊外部關閉下拉選單
document.addEventListener('click', (e) => {
  if (!e.target.closest('.position-relative')) {
    showDropdown.value = false
  }
})
</script>
```

#### 6. 帳務記錄列表組件 (AccountingRecordList.vue)

```vue
<template>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">帳務資訊列表</h3>
      <div class="card-tools">
        <button
          v-if="showDriverButton"
          @click="$emit('switch-view', 'driver')"
          class="btn btn-sm btn-primary me-2"
        >
          <i class="bi bi-person"></i> 駕駛帳務
        </button>
        <button
          v-if="showVehicleButton"
          @click="$emit('switch-view', 'vehicle')"
          class="btn btn-sm btn-info"
        >
          <i class="bi bi-car-front"></i> 車輛帳務
        </button>
      </div>
    </div>

    <!-- 統計資訊 -->
    <div v-if="statistics" class="card-body border-bottom">
      <div class="row text-center">
        <div class="col-md-4">
          <h5>借方加總</h5>
          <h3 class="text-primary">{{ statistics.debit_total }}</h3>
        </div>
        <div class="col-md-4">
          <h5>貸方加總</h5>
          <h3 class="text-success">{{ statistics.credit_total }}</h3>
        </div>
        <div class="col-md-4">
          <h5>餘額（借-貸）</h5>
          <h3 :class="statistics.balance_is_negative ? 'text-danger' : 'text-info'">
            {{ statistics.balance }}
          </h3>
        </div>
      </div>
    </div>

    <!-- 帳務列表 -->
    <div class="card-body">
      <div class="mb-3">
        <button
          @click="deleteSelected"
          class="btn btn-danger"
          :disabled="selectedIds.length === 0"
        >
          <i class="bi bi-trash"></i> 刪除選取項目 ({{ selectedIds.length }})
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input
                  type="checkbox"
                  @change="toggleAll"
                  :checked="allSelected"
                >
              </th>
              <th>日期</th>
              <th>科目編號</th>
              <th>科目名稱</th>
              <th>姓名</th>
              <th>車牌</th>
              <th>借方</th>
              <th>貸方</th>
              <th>備註</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="record in records.data" :key="record.id">
              <td>
                <input
                  type="checkbox"
                  :value="record.id"
                  v-model="selectedIds"
                >
              </td>
              <td>{{ formatDate(record.transaction_date) }}</td>
              <td>{{ record.account_detail?.account_code }}</td>
              <td>{{ record.account_detail?.account_name }}</td>
              <td>{{ record.driver_name || '-' }}</td>
              <td>{{ record.vehicle_license_number || '-' }}</td>
              <td class="text-end">{{ formatAmount(record.debit_amount) }}</td>
              <td class="text-end">{{ formatAmount(record.credit_amount) }}</td>
              <td>{{ record.note || '-' }}</td>
              <td>
                <button
                  @click="$emit('edit', record)"
                  class="btn btn-sm btn-warning"
                >
                  <i class="bi bi-pencil"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 分頁 -->
      <div v-if="records.links" class="mt-3">
        <nav>
          <ul class="pagination">
            <li
              v-for="link in records.links"
              :key="link.label"
              class="page-item"
              :class="{ active: link.active, disabled: !link.url }"
            >
              <a
                class="page-link"
                href="#"
                @click.prevent="changePage(link.url)"
                v-html="link.label"
              ></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { router } from '@inertiajs/vue3'

const props = defineProps({
  records: { type: Object, required: true },
  statistics: { type: Object, default: null },
  showDriverButton: { type: Boolean, default: false },
  showVehicleButton: { type: Boolean, default: false }
})

const emit = defineEmits(['edit', 'delete', 'switch-view'])

const selectedIds = ref([])

const allSelected = computed(() => {
  return props.records.data.length > 0 &&
         selectedIds.value.length === props.records.data.length
})

const toggleAll = () => {
  if (allSelected.value) {
    selectedIds.value = []
  } else {
    selectedIds.value = props.records.data.map(r => r.id)
  }
}

const deleteSelected = () => {
  if (selectedIds.value.length === 0) return
  emit('delete', selectedIds.value)
  selectedIds.value = []
}

const changePage = (url) => {
  if (!url) return
  router.visit(url, { preserveState: true, preserveScroll: true })
}

const formatDate = (date) => {
  if (!date) return '-'
  return new Date(date).toLocaleDateString('zh-TW')
}

const formatAmount = (amount) => {
  if (!amount) return '-'
  return new Intl.NumberFormat('zh-TW', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount)
}
</script>
```

---

## 🔌 API 設計

### RESTful API 端點定義

| HTTP方法 | 端點 | 描述 | 權限 |
|---------|------|------|------|
| GET | `/admin/accounting/records` | 取得帳務管理主頁面 | view accounting |
| POST | `/admin/accounting/records` | 批次新增帳務記錄 | create accounting |
| PUT | `/admin/accounting/records/{id}` | 更新單筆帳務記錄 | edit accounting |
| DELETE | `/admin/accounting/records/batch` | 批次刪除帳務記錄 | delete accounting |
| GET | `/admin/accounting/api/account-details/search` | 搜尋會計科目 | view accounting |

### API 請求與回應規範

#### 1. 批次新增帳務記錄

**請求 (POST /admin/accounting/records)**
```json
{
  "records": [
    {
      "driver_id": 1,
      "vehicle_id": 5,
      "account_detail_id": 123,
      "transaction_date": "2025-01-15",
      "debit_amount": 1000.00,
      "credit_amount": null,
      "note": "油資補貼"
    },
    {
      "driver_id": 1,
      "vehicle_id": 5,
      "account_detail_id": 124,
      "transaction_date": "2025-01-15",
      "debit_amount": null,
      "credit_amount": 1000.00,
      "note": "現金支出"
    }
  ]
}
```

**成功回應**
```json
{
  "success": true,
  "message": "成功新增 2 筆帳務記錄"
}
```

#### 2. 搜尋會計科目

**請求 (GET /admin/accounting/api/account-details/search?keyword=1101)**

**回應**
```json
[
  {
    "id": 123,
    "account_code": "1101001",
    "account_name": "現金",
    "main_category_name": "資產",
    "sub_category_name": "流動資產"
  },
  {
    "id": 124,
    "account_code": "1101002",
    "account_name": "銀行存款",
    "main_category_name": "資產",
    "sub_category_name": "流動資產"
  }
]
```

---

## 🔐 權限管理

### 權限定義

```php
// database/seeders/AccountingPermissionSeeder.php
$permissions = [
    'view accounting',        // 查看帳務記錄
    'create accounting',      // 新增帳務記錄
    'edit accounting',        // 編輯帳務記錄
    'delete accounting',      // 刪除帳務記錄
    'export accounting',      // 匯出帳務記錄
];

foreach ($permissions as $permission) {
    Permission::firstOrCreate(['name' => $permission]);
}
```

### 職務權限配置

基於現有的 Position (職務) 系統，為**會計人員**職務新增帳務管理權限：

```php
// 更新會計人員職務權限
$accountantPosition = Position::where('code', 'ACCOUNTANT')->first();

if ($accountantPosition) {
    $accountantPosition->givePermissionTo([
        'view accounting',
        'create accounting',
        'edit accounting',
        'delete accounting',
        'export accounting',
    ]);
}

// 系統管理員也應該有完整權限
$adminPosition = Position::where('code', 'SYS_ADMIN')->first();
if ($adminPosition) {
    $adminPosition->givePermissionTo([
        'view accounting',
        'create accounting',
        'edit accounting',
        'delete accounting',
        'export accounting',
    ]);
}
```

### 路由權限保護

```php
Route::prefix('admin')->name('admin.')->middleware(['auth'])->group(function () {
    Route::prefix('accounting')->name('accounting.')->group(function () {

        // 所有帳務路由都需要 view accounting 權限
        Route::middleware('permission:view accounting')->group(function () {
            Route::get('records', [AccountingRecordController::class, 'index'])
                ->name('records.index');

            Route::get('api/account-details/search', [AccountingRecordController::class, 'searchAccountDetails'])
                ->name('api.account-details.search');
        });

        // 新增權限
        Route::post('records', [AccountingRecordController::class, 'store'])
            ->name('records.store')
            ->middleware('permission:create accounting');

        // 編輯權限
        Route::put('records/{accountingRecord}', [AccountingRecordController::class, 'update'])
            ->name('records.update')
            ->middleware('permission:edit accounting');

        // 刪除權限
        Route::delete('records/batch', [AccountingRecordController::class, 'batchDestroy'])
            ->name('records.batch-destroy')
            ->middleware('permission:delete accounting');
    });
});
```

---

## ✅ 驗證規則與業務邏輯

### 資料驗證規則

#### 批次新增驗證
- **records**: 必填，陣列，至少1筆
- **account_detail_id**: 必填，必須存在於 account_details 表
- **transaction_date**: 必填，日期格式
- **debit_amount**: 選填，數字，0-9999999999.99
- **credit_amount**: 選填，數字，0-9999999999.99
- **借方或貸方**: 至少一個要有值且大於0
- **note**: 選填，字串，最長1000字

### 業務邏輯規則

#### 1. 重複記錄處理
- **策略**: 警告但允許新增
- **實作**: 記錄到 Log，不阻擋新增
- **條件**: 同駕駛+同車輛+同科目+同日期+同金額

#### 2. 並發控制
- 使用 Laravel Database Transaction
- 批次新增時確保原子性操作
- 失敗時完整回滾

#### 3. 軟刪除機制
- 使用 `deleted_at` 標記刪除
- 保留完整歷史記錄
- 支援審計追蹤

#### 4. 冗余欄位自動填入
```php
// 新增時自動填入
$driver = Driver::find($driverId);
$record->driver_name = $driver->name;
$record->driver_id_number = $driver->id_number;

$vehicle = Vehicle::find($vehicleId);
$record->vehicle_license_number = $vehicle->license_number;
```

---

## 📊 資料庫 Migration 範例

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('accounting_records', function (Blueprint $table) {
            $table->id();

            // 外鍵關聯
            $table->foreignId('driver_id')->nullable()->constrained('drivers')->nullOnDelete();
            $table->foreignId('vehicle_id')->nullable()->constrained('vehicles')->nullOnDelete();
            $table->foreignId('account_detail_id')->constrained('account_details')->restrictOnDelete();

            // 交易資訊
            $table->date('transaction_date');

            // 冗余欄位（歷史記錄保存）
            $table->string('driver_name', 100)->nullable();
            $table->string('driver_id_number', 20)->nullable();
            $table->string('vehicle_license_number', 20)->nullable();

            // 金額
            $table->decimal('debit_amount', 15, 2)->nullable();
            $table->decimal('credit_amount', 15, 2)->nullable();

            // 備註
            $table->text('note')->nullable();

            // 建立者與更新者
            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();

            $table->timestamps();
            $table->softDeletes();

            // 索引
            $table->index('transaction_date');
            $table->index(['driver_id', 'transaction_date']);
            $table->index(['vehicle_id', 'transaction_date']);
            $table->index('driver_name');
            $table->index('driver_id_number');
            $table->index('vehicle_license_number');
        });

        // CHECK 約束（MySQL 8.0.16+）
        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_amount CHECK (
            (debit_amount IS NOT NULL AND debit_amount > 0) OR
            (credit_amount IS NOT NULL AND credit_amount > 0)
        )');

        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_debit_positive CHECK (
            debit_amount IS NULL OR debit_amount >= 0
        )');

        DB::statement('ALTER TABLE accounting_records ADD CONSTRAINT chk_credit_positive CHECK (
            credit_amount IS NULL OR credit_amount >= 0
        )');
    }

    public function down(): void
    {
        Schema::dropIfExists('accounting_records');
    }
};
```

---

## ⏱️ 開發時程規劃

### 第一階段：基礎架構建立（1週）
- [x] 資料庫 Migration 建立
- [x] Model 建立與關聯設定
- [x] Seeder 建立（權限）
- [x] 基礎路由設定

### 第二階段：後端開發（2週）
- [x] Controller 實作
- [x] Service 層實作
- [x] Request 驗證類別
- [ ] API 端點測試

### 第三階段：前端開發（2-3週）
- [x] 主頁面框架
- [x] 搜尋面板組件
- [x] 駕駛/車輛列表組件
- [x] 動態表格組件
- [x] 會計科目選擇器（自動完成+模態框）
- [x] 帳務記錄列表組件
- [x] 編輯功能
- [x] 刪除功能

### 第四階段：整合測試（1週）
- [ ] 功能測試
- [ ] 整合測試
- [ ] 效能測試
- [ ] 使用者驗收測試

### 第五階段：優化與上線（1週）
- [ ] Bug 修復
- [ ] 效能優化
- [ ] 使用者文件
- [ ] 部署上線

**預估總時程：7-8 週**

---

## 📝 實作檢核清單

### 後端
- [x] Migration 檔案建立並執行
- [x] Model 關聯關係正確
- [x] Service 層業務邏輯完整
- [x] Request 驗證規則完整
- [ ] API 端點測試通過
- [x] Transaction 正確實作
- [x] 軟刪除機制運作正常

### 前端
- [x] 主頁面佈局完成
- [x] 搜尋功能正常
- [x] 駕駛/車輛列表顯示正確
- [x] 動態表格新增/刪除列正常
- [x] 會計科目自動完成搜尋正常
- [x] 會計科目模態框選擇正常
- [x] 批次新增提交成功
- [x] 編輯功能正常
- [x] 多選刪除功能正常
- [x] 統計數字計算正確
- [x] 分頁功能正常

### 權限與安全
- [x] 權限 Seeder 建立
- [x] 路由權限保護完整
- [x] 使用者權限檢查正確
- [x] SQL Injection 防護
- [x] XSS 防護

### 測試
- [ ] 單元測試覆蓋率 >70%
- [ ] 功能測試通過
- [ ] 整合測試通過
- [ ] 效能測試達標

---

## 🚨 注意事項與風險

### 1. 效能考量
- **大量資料查詢**：建議實作分頁、索引優化
- **統計計算**：考慮快取機制
- **關聯查詢**：使用 Eager Loading 避免 N+1 問題

### 2. 資料一致性
- **外鍵約束**：確保參照完整性
- **Transaction**：批次操作必須使用 Transaction
- **冗余欄位同步**：確保更新時同步冗余欄位

### 3. 使用者體驗
- **載入提示**：長時間操作需顯示 Loading
- **錯誤提示**：友善的錯誤訊息
- **操作確認**：刪除等危險操作需二次確認

### 4. 擴展性考量
- **報表功能**：預留報表匯出接口
- **審計日誌**：記錄重要操作
- **批次匯入**：未來可能需要 Excel 批次匯入

---

## 📚 參考資料

### 相關文件
- [會計科目管理開發文件](./會計科目建立.md)
- [駕駛管理系統](../app/Models/Driver.php)
- [車輛管理系統](../app/Models/Vehicle.php)
- [Laravel 文件 - Eloquent Relationships](https://laravel.com/docs/11.x/eloquent-relationships)
- [Vue 3 文件](https://vuejs.org/)
- [AdminLTE 4 文件](https://adminlte.io/docs/4.0/)

### 技術參考
- Laravel Database Transactions
- Vue 3 Composition API
- Inertia.js 最佳實踐
- Bootstrap 5 表單設計

---

**文件版本**：2.0
**最後更新**：2025年10月1日
**文件狀態**：✅ 已完成開發（待測試）
**負責人**：開發團隊

---

## 📌 開發完成總結 (2025/10/01)

### ✅ 已完成項目

#### 後端開發
1. ✅ **資料庫 Migration** - `2025_10_01_205120_create_accounting_records_table.php`
2. ✅ **AccountingRecord Model** - 完整關聯、Scope、軟刪除
3. ✅ **AccountingRecordService** - 搜尋、統計、批次操作
4. ✅ **AccountingRecordRequest** - 批次與單筆驗證
5. ✅ **AccountingRecordController** - 完整 CRUD 與 API
6. ✅ **權限 Seeder** - 5個權限已建立並分配
7. ✅ **路由設定** - 完整 RESTful 路由與權限保護

#### 前端開發
8. ✅ **SearchPanel.vue** - 搜尋面板
9. ✅ **DriverList.vue** - 駕駛列表
10. ✅ **VehicleList.vue** - 車輛列表
11. ✅ **AccountSelector.vue** - 會計科目選擇器（自動完成+模態框）
12. ✅ **AccountingForm.vue** - 動態新增表格
13. ✅ **AccountingRecordList.vue** - 帳務記錄列表（含統計）
14. ✅ **Index.vue** - 主頁面整合
15. ✅ **側邊欄選單** - 已新增「帳務管理」按鈕

### 🎯 系統功能
- ✅ 支援姓名/車牌/車隊編號搜尋
- ✅ 駕駛與車輛關聯顯示
- ✅ 批次新增帳務記錄
- ✅ 借方/貸方金額統計
- ✅ 多選刪除功能
- ✅ 分頁顯示
- ✅ 權限控管（5個權限）

### 📍 測試建議
1. 訪問 `/admin/accounting/records` 測試功能
2. 確認權限是否正確控管
3. 測試搜尋、新增、編輯、刪除功能
4. 驗證統計數字是否正確

### 🔄 後續優化建議
- [ ] 新增單元測試
- [ ] 新增功能測試
- [ ] 效能優化（大量資料）
- [ ] 匯出功能實作
- [ ] 批次匯入功能
- [ ] 審計日誌記錄

---

## 📋 使用者流程說明（v2.1 新增）

### 完整操作流程

#### 流程 1：搜尋與查看
1. **搜尋駕駛或車輛**
   - 輸入關鍵字
   - 選擇搜尋類型（姓名/車牌/車隊編號）
   - 點擊搜尋按鈕

2. **系統自動處理**
   - 顯示符合條件的駕駛列表和車輛列表
   - **雙列表自動選擇**：
     - ✅ 有駕駛資料 → 自動選擇第一個駕駛（高亮顯示）
     - ✅ 有車輛資料 → 自動選擇第一個車輛（高亮顯示）
     - 📌 **兩個列表各自獨立顯示選中狀態**
   - **自動載入帳務記錄（優先駕駛）**：
     - IF 有選中駕駛 THEN 顯示駕駛的帳務記錄
     - ELSE 顯示車輛的帳務記錄
   - 顯示統計資訊（借方、貸方、餘額）

3. **使用者可手動切換**（可選）
   - 點選駕駛列表中的其他駕駛 → 切換顯示該駕駛的帳務記錄
   - 點選車輛列表中的其他車輛 → 切換顯示該車輛的帳務記錄
   - 📌 **切換時保持兩個列表的選中狀態**（只改變顯示內容）

#### 流程 2：新增帳務記錄
1. **填寫帳務表格**
   - 選擇交易日期
   - 選擇會計科目（支援自動完成搜尋）
   - 填寫借方或貸方金額
   - 填寫備註（可選）

2. **提交新增**
   - 點擊「確定新增」按鈕

3. **系統行為**（新增成功後）
   - ✅ **保留搜尋結果**：駕駛列表和車輛列表不會消失
   - ✅ **保留選擇狀態**：當前選擇的駕駛/車輛保持選中
   - ✅ **刷新帳務列表**：自動顯示剛新增的記錄
   - ✅ **更新統計資訊**：重新計算借方、貸方、餘額

#### 流程 3：編輯與刪除
**編輯**：
- 點擊記錄的編輯按鈕
- 修改資料後儲存
- 系統保留搜尋結果和選擇狀態

**刪除**：
- 勾選要刪除的記錄
- 點擊「刪除選取項目」
- 確認刪除
- 系統保留搜尋結果和選擇狀態

### 關鍵設計原則

1. **雙列表選擇機制**
   - 📌 駕駛列表和車輛列表各自維護獨立的選中狀態
   - 📌 搜尋後同時自動選擇第一個駕駛和第一個車輛（雙選）
   - 📌 兩個列表都會顯示高亮選中效果

2. **顯示優先順序**
   - 駕駛優先於車輛（符合業務邏輯）
   - 當兩者都有選擇時，優先顯示駕駛的帳務記錄
   - 點選任一列表項目可切換顯示內容

3. **狀態保持**
   - 所有操作（新增/編輯/刪除）後都保持搜尋狀態
   - 保持兩個列表的選中狀態不變
   - 不需要重新搜尋，提升工作效率

4. **靈活性**
   - 自動選擇不限制手動切換
   - 使用者可自由查看任一駕駛或車輛的帳務
   - 切換顯示時保留兩個列表的選擇狀態

5. **友善提示**
   - 即使沒有帳務記錄，也顯示空列表
   - 清楚標示「目前沒有帳務記錄」
