# 每日交易明細報表技術規格書

## 1. 系統概要
本文件旨在定義「每日交易明細報表」的技術實作細節。此功能將允許會計與管理人員檢視每日的帳務交易明細，並透過靈活的篩選組合（公司類別、公司、會計科目）來生成客製化報表。

## 2. 資料流與架構設計

### 2.1 核心資料來源
- **主資料表**: `accounting_records`
- **關聯資料**:
    - `drivers` (透過 `driver_id`)
    - `vehicles` (透過 `vehicle_id`)
    - `account_details` (透過 `account_detail_id`)
    - `company_categories` (間接透過 `vehicles.company_category_id` 或 `drivers.company_category_id`)
    - `companies` (間接透過 `vehicles.company_id`，注意：駕駛目前無直接公司關聯)

### 2.2 報表欄位對應邏輯
| 報表欄位 | 資料庫來源 / 邏輯 | 備註 |
| :--- | :--- | :--- |
| **交易日期** | `accounting_records.created_at` | 需求指定使用 `created_at`，格式化為 `YYYY-MM-DD` |
| **公司類別** | `vehicle.companyCategory.name` 或 `driver.companyCategory.name` | 若兩者皆有，優先顯示車輛的類別，或依業務邏輯判定 |
| **車隊編號** | `accounting_records.vehicle_fleet_number` | 冗餘欄位直接存取 |
| **車牌號碼** | `accounting_records.vehicle_license_number` | 冗餘欄位直接存取 |
| **駕駛姓名** | `accounting_records.driver_name` | 冗餘欄位直接存取 |
| **借方金額** | `accounting_records.debit_amount` | |
| **貸方金額** | `accounting_records.credit_amount` | |
| **備註** | `accounting_records.note` | |

### 2.3 篩選邏輯詳細說明
系統需支援「報表組合」功能，即儲存一組篩選條件。
1.  **公司類別篩選 (Company Category)**:
    - 篩選關聯的 `Vehicle` 或 `Driver` 之 `company_category_id` 在選定範圍內的記錄。
    - 邏輯: `whereHas('vehicle', fn($q) => $q->whereIn('company_category_id', $ids)) ->orWhereHas('driver', fn($q) => $q->whereIn('company_category_id', $ids))`
2. **公司篩選 (Company)**:
    - 篩選關聯的 `Vehicle` 之 `company_id`。
    - **解決方案**: 為了包含「僅關聯駕駛而無車輛」的帳務紀錄（駕駛無直接公司關聯），前端公司選單應包含一個 **「無所屬公司 (駕駛/其他)」** 的特殊選項（例如 value 為 `-1` 或 `null`）。
    - 邏輯: 
        - 若選中特定公司 ID: `whereHas('vehicle', fn($q) => $q->whereIn('company_id', $ids))`
        - 若同時選中「無所屬公司」: 使用 `orWhereNull('vehicle_id')` 或 `orWhereHas('vehicle', fn($q) => $q->whereNull('company_id'))` 來納入無車輛關聯的紀錄。
3.  **科目編號篩選 (Account Detail)**:
    - 直接篩選 `account_detail_id`。
4.  **時間範圍**:
    - 篩選 `created_at` (依需求) 或 `transaction_date`。建議前端預設帶入 `created_at` 範圍。

## 3. 資料庫設計變更

### 3.1 新增資料表：報表設定 (Report Configurations)
為了滿足「報表組合」與「後續新增其他報表」的需求，建議建立通用的報表設定表。

```php
Schema::create('report_configurations', function (Blueprint $table) {
    $table->id();
    $table->string('name'); // 報表組合名稱，例如 "計程車-燃料費"
    $table->string('report_type')->index(); // 報表類型標識，例如 "daily_transaction"
    $table->json('filters'); // 儲存篩選條件 JSON，例如 { "categories": [1], "companies": [2], "accounts": [10,11] }
    $table->foreignId('created_by')->constrained('users');
    $table->foreignId('updated_by')->nullable()->constrained('users');
    $table->timestamps();
});
```

### 3.2 模型建立
- 建立 `App\Models\ReportConfiguration` 模型。

## 4. 後端實作規格 (Laravel / Inertia)

### 4.1 控制器
- **Class**: `App\Http\Controllers\Admin\Report\DailyTransactionReportController` (新增)
- **Method `index`**:
    - 接收前端傳來的篩選參數 (`start_date`, `end_date`, `filter_config_id` 或直接的 `filters` 陣列)。
    - 若有 `filter_config_id`，則載入對應設定。
    - 執行查詢並回傳 Inertia 頁面。
    - 回傳 Props:
        - `records`: 分頁後的交易紀錄。
        - `total_debit`: 當前篩選範圍總借方。
        - `total_credit`: 當前篩選範圍總貸方。
        - `report_configs`: 所有已儲存的報表組合 (供下拉選單)。
        - `options`: 供篩選器使用的選項清單 (公司類別、公司、科目)。

### 4.2 API / Action
- **儲存報表組合**: POST `/admin/reports/configurations`
- **刪除報表組合**: DELETE `/admin/reports/configurations/{id}`

## 5. 前端實作規格 (Vue 3 / Inertia)

### 5.1 頁面結構
- **路徑**: `resources/js/Pages/Admin/Reports/DailyTransaction/Index.vue`
- **佈局**:
    - **頂部工具列**:
        - **報表組合選擇**: 下拉選單 (載入預存設定)。
        - **日期選擇**: DateRangePicker。
        - **快速按鈕**: 「今日」按鈕 (設定 DateRange 為今天)。
        - **管理按鈕**: 「儲存目前組合」、「管理報表組合」。
    - **篩選區塊 (可收合/展開)**:
        - 多選框: 公司類別 (Company Categories)
        - 多選框: 公司 (Companies)
        - 多選框: 會計科目 (Account Details) - 支援搜尋
    - **資料表格**:
        - 欄位如 2.2 節所述。
        - 底部 (Footer) 顯示 `debit_amount` 與 `credit_amount` 的加總。

### 5.2 側邊欄選單
- 新增一級選單「報表管理」 (icon: `fas fa-chart-bar`)。
- 其下新增子選單「每日交易明細表」。

## 6. 開發步驟建議

1.  **Migration & Model**: 建立 `report_configurations` 表與模型。
2.  **Route**: 設定 `web.php` 路由。
3.  **Controller**: 實作資料查詢邏輯 (Query Builder 需小心處理關聯篩選)。
4.  **Frontend - Filter Component**: 開發可複用的篩選器組件 (包含報表組合存取功能)。
5.  **Frontend - Main Page**: 整合表格與數據展示。
6.  **測試**: 驗證不同篩選組合下的數據準確性，特別是同時篩選公司與類別時的邏輯。

## 7. 待確認與建議事項
- **建議事項**: 雖然需求指定使用 `created_at`，但在會計實務上 `transaction_date` (交易發生日) 通常更具意義。若 `created_at` (資料建立時間) 與交易日不同步（例如補登），可能會導致報表錯位。建議與使用者確認是否改由 `transaction_date` 篩選。
使用者說明：這份報表會`created_at`是因為這份報表主要是做當日的登打帳務計算，所以不適用transaction_date

