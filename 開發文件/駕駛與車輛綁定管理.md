# 駕駛與車輛綁定管理開發規劃文件

此文件為駕駛與車輛的連結管理開發的完整規劃文件，詳細記錄專案背景、需求分析、技術架構、開發計畫等。

## 📋 專案概述

### 專案背景
企業集團需要統一管理旗下駕駛與車輛的連結關係，主要是記錄哪位駕駛開哪一台車等，以建立完整的企業架構管理系統。此系統將整合現有的公司分類體系，並為未來的帳務與會計管理功能預留擴展空間。

### 專案目標
- 建立駕駛與車輛配對的管理平台
- 提供簡單直觀的綁定關係管理
- 建立可擴展的資料架構
- 整合現有的駕駛和車輛管理系統

### 專案範圍
- 駕駛與車輛的綁定關係管理（CRUD）
- 綁定關係查詢與篩選
- 批量綁定操作
- 綁定關係報表

## 🗄️ 資料庫設計

### driver_vehicle_assignments 資料表結構
| 欄位名稱 | 資料型態 | 必填 | 說明 | 備註 |
|---------|---------|------|------|------|
| id | bigint unsigned | 是 | 主鍵 | 自動遞增 |
| driver_id | bigint unsigned | 是 | 駕駛 ID | 外鍵關聯 drivers.id |
| vehicle_id | bigint unsigned | 是 | 車輛 ID | 外鍵關聯 vehicles.id |
| notes | text | 否 | 備註 | 無資料直接null |
| created_by | bigint unsigned | 否 | 建立者 | 外鍵關聯 users.id |
| updated_by | bigint unsigned | 否 | 更新者 | 外鍵關聯 users.id |
| created_at | timestamp | 是 | 建立時間 | Laravel自動管理 |
| updated_at | timestamp | 是 | 更新時間 | Laravel自動管理 |

### 索引設計
- 主鍵：id
- 唯一索引：driver_id, vehicle_id（避免重複綁定）
- 一般索引：driver_id（查詢駕駛的車輛）
- 一般索引：vehicle_id（查詢車輛的駕駛）

### 業務邏輯約束
1. **多對多關係**：一位駕駛可以綁定多台車輛，一台車輛可以綁定多位駕駛
2. **唯一約束**：同一對駕駛與車輛只能綁定一次（避免重複）

## 🔧 技術實作架構

### 後端架構 (Laravel)

#### 1. 資料庫遷移 (Migration)
```php
// database/migrations/xxxx_create_driver_vehicle_assignments_table.php
Schema::create('driver_vehicle_assignments', function (Blueprint $table) {
    $table->id();
    $table->foreignId('driver_id')->constrained('drivers')->onDelete('cascade');
    $table->foreignId('vehicle_id')->constrained('vehicles')->onDelete('cascade');
    $table->text('notes')->nullable();
    $table->foreignId('created_by')->nullable()->constrained('users');
    $table->foreignId('updated_by')->nullable()->constrained('users');
    $table->timestamps();

    // 唯一約束：避免重複綁定
    $table->unique(['driver_id', 'vehicle_id']);

    $table->index(['driver_id']);
    $table->index(['vehicle_id']);
});
```

#### 2. 模型 (Model)
```php
// app/Models/DriverVehicleAssignment.php
class DriverVehicleAssignment extends Model
{
    protected $fillable = [
        'driver_id', 'vehicle_id', 'notes', 'created_by', 'updated_by'
    ];

    protected $casts = [
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    public function driver()
    {
        return $this->belongsTo(Driver::class);
    }

    public function vehicle()
    {
        return $this->belongsTo(Vehicle::class);
    }

    public function createdBy()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function updatedBy()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }
}
```

#### 3. 控制器 (Controller)
- `App\Http\Controllers\Admin\DriverVehicleAssignmentController`
- 提供 index, create, store, edit, update, destroy 方法
- 支援搜尋、分頁、篩選功能
- 批量操作功能

**destroy 方法（解除綁定）：**
```php
public function destroy(DriverVehicleAssignment $assignment)
{
    $driverName = $assignment->driver->name;
    $vehiclePlate = $assignment->vehicle->license_plate;

    $assignment->delete();

    return redirect()->route('admin.driver-vehicle-assignments.index')
        ->with('success', "已成功解除 {$driverName} 與 {$vehiclePlate} 的綁定！");
}
```

#### 4. 表單驗證 (Form Request)
- `App\Http\Requests\Admin\DriverVehicleAssignmentRequest`
- 驗證駕駛與車輛的綁定資料
- 檢查重複綁定約束

#### 5. 路由設計
```php
// routes/web.php
Route::middleware(['auth', 'permission:assignment.view'])->prefix('admin')->group(function () {
    Route::resource('driver-vehicle-assignments', DriverVehicleAssignmentController::class);
    Route::post('driver-vehicle-assignments/batch', [DriverVehicleAssignmentController::class, 'batchAssign'])->name('driver-vehicle-assignments.batch');
});
```

### 前端架構 (Vue 3 + Inertia.js)

#### 1. 頁面組件
- `resources/js/Pages/Admin/DriverVehicleAssignments/Index.vue` - 綁定關係列表
- `resources/js/Pages/Admin/DriverVehicleAssignments/Create.vue` - 新增綁定
- `resources/js/Pages/Admin/DriverVehicleAssignments/Edit.vue` - 編輯綁定
- `resources/js/Pages/Admin/DriverVehicleAssignments/BatchAssign.vue` - 批量綁定

#### 2. 共用組件
- `resources/js/Components/DriverVehicleForm.vue` - 綁定表單組件
- `resources/js/Components/AssignmentCard.vue` - 綁定關係卡片組件
- `resources/js/Components/DriverSelector.vue` - 駕駛選擇器
- `resources/js/Components/VehicleSelector.vue` - 車輛選擇器
- `resources/js/Components/UnbindConfirmModal.vue` - 解除綁定確認對話框

#### 3. 使用 AdminLTE 4 樣式框架
- 整合 Bootstrap 5 樣式
- 使用 Bootstrap Icons
- 響應式設計

## 🎨 前端 UI/UX 設計

### 主要功能頁面設計

#### 1. 綁定關係列表頁面 (`/admin/driver-vehicle-assignments`)
**版面配置：**
- 使用 AdminLayout 版面
- 頁面標題：「駕駛車輛綁定管理」
- 功能按鈕：「新增綁定」、「批量綁定」（右上角）

**功能區塊：**
- **篩選欄**：駕駛姓名、車輛牌照
- **資料表格**：
  - 欄位：駕駛姓名、車輛牌照、備註、建立時間、操作
  - 操作按鈕：編輯、解除綁定
  - 分頁控制：每頁顯示 15 筆資料

**解除綁定功能：**
- **解除按鈕**：每一列都有紅色的解除綁定按鈕
- **確認對話框**：點擊後彈出確認視窗，顯示「確定要解除 [駕駛姓名] 與 [車輛牌照] 的綁定嗎？」
- **即時更新**：確認後立即從列表中移除該綁定記錄
- **成功提示**：顯示「綁定已成功解除」的提示訊息

#### 2. 新增綁定頁面 (`/admin/driver-vehicle-assignments/create`)
**表單設計：**
- **駕駛選擇**：下拉選單，顯示駕駛姓名和身分證號
- **車輛選擇**：下拉選單，顯示車牌號碼和車型
- **備註**：文字區域輸入框

#### 3. 批量綁定頁面
**功能設計：**
- 左側：未綁定駕駛列表
- 右側：未綁定車輛列表
- 拖拉操作：將駕駛拖拉到車輛上建立綁定
- 批量確認：一次性儲存所有綁定

### 互動體驗
- **重複檢查**：選擇駕駛和車輛時檢查是否已有相同綁定
- **衝突提示**：嘗試重複綁定時顯示警告
- **成功提示**：操作成功時顯示 Toast 訊息

### 解除綁定互動流程
1. **點擊解除按鈕**：每一列的操作欄有紅色的「解除綁定」按鈕 (圖示：`bi-link-45deg`)
2. **確認對話框**：彈出 Modal 顯示：
   ```
   確認解除綁定
   確定要解除 [張三] 與 [ABC-1234] 的綁定嗎？
   此操作無法復原。
   [取消] [確認解除]
   ```
3. **執行解除**：點擊確認後，發送 DELETE 請求到後端
4. **即時回饋**：
   - 成功：顯示成功訊息，自動刷新列表
   - 失敗：顯示錯誤訊息，保持當前狀態

### 前端實作重點
```javascript
// 解除綁定方法
const confirmUnbind = (assignment) => {
    unbindingAssignment.value = assignment
    unbindModal.show()
}

const executeUnbind = () => {
    if (unbindingAssignment.value) {
        router.delete(route('admin.driver-vehicle-assignments.destroy', unbindingAssignment.value.id), {
            onSuccess: () => {
                unbindModal.hide()
                unbindingAssignment.value = null
            }
        })
    }
}
```

## 🔐 權限管理規劃

### 權限定義
```php
// 權限列表
'assignment.view'     => '查看駕駛車輛綁定',
'assignment.create'   => '新增駕駛車輛綁定',
'assignment.edit'     => '編輯駕駛車輛綁定',
'assignment.delete'   => '刪除駕駛車輛綁定',
'assignment.batch'    => '批量綁定操作',
```

### 實作方式
- 路由層級權限檢查
- 控制器層級權限檢查
- 前端介面權限控制

## 📅 開發時程規劃

### 第一階段：基礎建設 (2-3 天)
- [ ] 建立資料表 migration
- [ ] 建立 DriverVehicleAssignment 模型
- [ ] 建立權限種子檔案
- [ ] 更新現有 Driver 和 Vehicle 模型關聯

### 第二階段：後端 API 開發 (2-3 天)
- [ ] 建立 DriverVehicleAssignmentController
- [ ] 實作 CRUD 方法
- [ ] 建立表單驗證
- [ ] 設定路由和中介軟體
- [ ] 實作搜尋和篩選功能

### 第三階段：前端介面開發 (3-4 天)
- [ ] 建立綁定關係列表頁面
- [ ] 建立新增/編輯綁定頁面
- [ ] 開發駕駛和車輛選擇器組件
- [ ] 實作批量綁定功能
- [ ] 響應式設計調整

### 第四階段：整合測試與優化 (1-2 天)
- [ ] 前後端整合測試
- [ ] 權限功能測試
- [ ] 業務邏輯驗證
- [ ] 效能優化

### 總開發時程：8-12 天

## 📋 檢查清單

### 開發完成檢查項目
- [ ] 資料庫結構正確建立
- [ ] 所有 CRUD 功能正常運作
- [ ] 權限控制正確實施
- [ ] 前端介面美觀易用
- [ ] 綁定約束正確執行
- [ ] 搜尋和篩選功能正常
- [ ] 批量操作功能正常
- [ ] 表單驗證正確
- [ ] 錯誤處理完善
