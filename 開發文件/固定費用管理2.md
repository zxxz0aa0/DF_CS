# 經常性費用管理開發規劃文件

此文件為經常性費用管理（固定費用管理）的完整開發規劃文件，詳細記錄專案背景、需求分析、技術架構、開發計畫等。

---

## 📋 需求描述

這是一個紀錄經常性費用組合的功能，每位駕駛每個月都有固定的費用，使用者在這邊設定費用組合後進行存檔，駕駛資料表裡有一個 `recurring_cost_id` 欄位用來關聯費用組合。

組合主要是使用 `account_details` 資料表裡的會計科目來做組合，並且記錄金額，查詢資料就可以知道駕駛有哪些固定費用。

---

## 🎯 功能目標

### 核心概念
- **顯示用途**：組合純粹用來「顯示」駕駛有哪些經常性費用項目和金額
- **共用範本**：多個駕駛可以共用同一組合，修改組合會影響所有使用該組合的駕駛
- **彈性調整**：管理員可以隨時修改組合內的項目和金額
- **差異化處理**：如果某個駕駛需要不同的費用設定，可建立新組合並重新指定
- **刪除行為**：刪除組合時，自動將所有使用該組合的駕駛的 `recurring_cost_id` 設為 `NULL`

### 功能範圍
1. **組合管理**：新增、編輯、刪除費用組合（CRUD）
2. **項目管理**：每個組合包含多個會計科目 + 整數金額
3. **批量套用**：選擇多個駕駛 → 套用指定組合
4. **駕駛關聯**：駕駛可關聯一個費用組合（未來在駕駛管理中顯示）

### 技術需求
- 金額為整數型態（不支援小數點）
- 使用現有的 `account_details` 會計科目表
- 駕駛表的 `recurring_cost_id` 欄位已預留
- 刪除組合時使用 `ON DELETE SET NULL`

---

## 🗄️ 資料庫設計

### 資料表結構

#### 1. recurring_cost_templates（經常性費用組合表）
```sql
CREATE TABLE recurring_cost_templates (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '組合名稱',
    description TEXT NULL COMMENT '說明',
    total_amount INT UNSIGNED DEFAULT 0 COMMENT '組合總金額',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否啟用',
    created_by BIGINT UNSIGNED NULL COMMENT '建立者',
    updated_by BIGINT UNSIGNED NULL COMMENT '最後更新者',
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    deleted_at TIMESTAMP NULL COMMENT '軟刪除',

    -- 索引
    INDEX idx_name (name),
    INDEX idx_is_active (is_active),
    INDEX idx_created_by (created_by),

    -- 外鍵
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL
);
```

#### 2. recurring_cost_items（費用項目明細表）
```sql
CREATE TABLE recurring_cost_items (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    template_id BIGINT UNSIGNED NOT NULL COMMENT '組合ID',
    account_detail_id BIGINT UNSIGNED NOT NULL COMMENT '會計科目ID',
    amount INT UNSIGNED NOT NULL COMMENT '金額',
    note VARCHAR(255) NULL COMMENT '備註',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,

    -- 索引
    INDEX idx_template_id (template_id),
    INDEX idx_account_detail_id (account_detail_id),
    INDEX idx_sort_order (sort_order),

    -- 外鍵
    FOREIGN KEY (template_id) REFERENCES recurring_cost_templates(id) ON DELETE CASCADE,
    FOREIGN KEY (account_detail_id) REFERENCES account_details(id) ON DELETE CASCADE
);
```

#### 3. drivers 表修改
需要為 `recurring_cost_id` 加上外鍵約束：
```sql
ALTER TABLE drivers
ADD CONSTRAINT fk_drivers_recurring_cost
FOREIGN KEY (recurring_cost_id)
REFERENCES recurring_cost_templates(id)
ON DELETE SET NULL;
```

### 資料關聯圖

```
recurring_cost_templates (1) ─┬─ hasMany → recurring_cost_items (N)
                               └─ hasMany → drivers (N)

recurring_cost_items (N) ──┬── belongsTo → recurring_cost_templates (1)
                           └── belongsTo → account_details (1)

drivers (N) ──── belongsTo → recurring_cost_templates (1)

account_details (1) ──── hasMany → recurring_cost_items (N)
```

### 設計重點

1. **軟刪除**：`recurring_cost_templates` 使用軟刪除保留歷史記錄
2. **自動計算**：`total_amount` 可由 items 自動計算或手動維護
3. **排序功能**：items 有 `sort_order` 欄位方便調整顯示順序
4. **審計追蹤**：記錄建立者和更新者
5. **級聯刪除**：刪除組合時，所有 items 自動刪除
6. **ON DELETE SET NULL**：刪除組合時，駕駛的 `recurring_cost_id` 自動設為 NULL

---

## 🏗️ 後端架構

### Model 設計

#### RecurringCostTemplate.php
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class RecurringCostTemplate extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'name',
        'description',
        'total_amount',
        'is_active',
        'created_by',
        'updated_by',
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'total_amount' => 'integer',
    ];

    // 關聯：費用項目
    public function items(): HasMany
    {
        return $this->hasMany(RecurringCostItem::class, 'template_id')->orderBy('sort_order');
    }

    // 關聯：使用此組合的駕駛
    public function drivers(): HasMany
    {
        return $this->hasMany(Driver::class, 'recurring_cost_id');
    }

    // 關聯：建立者
    public function creator(): BelongsTo
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    // 關聯：更新者
    public function updater(): BelongsTo
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    // 計算總金額
    public function calculateTotalAmount(): int
    {
        return $this->items()->sum('amount');
    }

    // Scope: 啟用的組合
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    // Scope: 搜尋
    public function scopeSearch($query, $term)
    {
        return $query->where('name', 'like', "%{$term}%");
    }
}
```

#### RecurringCostItem.php
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class RecurringCostItem extends Model
{
    protected $fillable = [
        'template_id',
        'account_detail_id',
        'amount',
        'note',
        'sort_order',
    ];

    protected $casts = [
        'amount' => 'integer',
        'sort_order' => 'integer',
    ];

    // 關聯：所屬組合
    public function template(): BelongsTo
    {
        return $this->belongsTo(RecurringCostTemplate::class, 'template_id');
    }

    // 關聯：會計科目
    public function accountDetail(): BelongsTo
    {
        return $this->belongsTo(AccountDetail::class);
    }
}
```

#### Driver.php 修改
```php
// 新增關聯方法
public function recurringCostTemplate(): BelongsTo
{
    return $this->belongsTo(RecurringCostTemplate::class, 'recurring_cost_id');
}
```

### Controller 設計

#### RecurringCostController.php
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\RecurringCostTemplate;
use App\Models\AccountDetail;
use App\Models\Driver;
use Illuminate\Http\Request;
use Inertia\Inertia;

class RecurringCostController extends Controller
{
    // 列表頁
    public function index(Request $request)
    {
        $templates = RecurringCostTemplate::query()
            ->with(['items.accountDetail', 'creator'])
            ->when($request->search, function ($query, $search) {
                $query->search($search);
            })
            ->withCount('drivers')
            ->latest()
            ->paginate(15);

        return Inertia::render('Admin/RecurringCosts/Index', [
            'templates' => $templates,
            'filters' => $request->only(['search']),
        ]);
    }

    // 新增頁面
    public function create()
    {
        $accountDetails = AccountDetail::active()
            ->ordered()
            ->get(['id', 'account_code', 'account_name']);

        return Inertia::render('Admin/RecurringCosts/Create', [
            'accountDetails' => $accountDetails,
        ]);
    }

    // 儲存新增
    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:100',
            'description' => 'nullable|string',
            'is_active' => 'boolean',
            'items' => 'required|array|min:1',
            'items.*.account_detail_id' => 'required|exists:account_details,id',
            'items.*.amount' => 'required|integer|min:0',
            'items.*.note' => 'nullable|string|max:255',
        ]);

        $template = RecurringCostTemplate::create([
            'name' => $validated['name'],
            'description' => $validated['description'] ?? null,
            'is_active' => $validated['is_active'] ?? true,
            'created_by' => auth()->id(),
        ]);

        foreach ($validated['items'] as $index => $item) {
            $template->items()->create([
                'account_detail_id' => $item['account_detail_id'],
                'amount' => $item['amount'],
                'note' => $item['note'] ?? null,
                'sort_order' => $index,
            ]);
        }

        // 計算並更新總金額
        $template->update(['total_amount' => $template->calculateTotalAmount()]);

        return redirect()->route('admin.recurring-costs.index')
            ->with('success', '經常性費用組合已建立');
    }

    // 編輯頁面
    public function edit(RecurringCostTemplate $recurringCost)
    {
        $recurringCost->load('items.accountDetail');

        $accountDetails = AccountDetail::active()
            ->ordered()
            ->get(['id', 'account_code', 'account_name']);

        return Inertia::render('Admin/RecurringCosts/Edit', [
            'template' => $recurringCost,
            'accountDetails' => $accountDetails,
        ]);
    }

    // 更新
    public function update(Request $request, RecurringCostTemplate $recurringCost)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:100',
            'description' => 'nullable|string',
            'is_active' => 'boolean',
            'items' => 'required|array|min:1',
            'items.*.account_detail_id' => 'required|exists:account_details,id',
            'items.*.amount' => 'required|integer|min:0',
            'items.*.note' => 'nullable|string|max:255',
        ]);

        $recurringCost->update([
            'name' => $validated['name'],
            'description' => $validated['description'] ?? null,
            'is_active' => $validated['is_active'] ?? true,
            'updated_by' => auth()->id(),
        ]);

        // 刪除舊項目，建立新項目
        $recurringCost->items()->delete();

        foreach ($validated['items'] as $index => $item) {
            $recurringCost->items()->create([
                'account_detail_id' => $item['account_detail_id'],
                'amount' => $item['amount'],
                'note' => $item['note'] ?? null,
                'sort_order' => $index,
            ]);
        }

        // 更新總金額
        $recurringCost->update(['total_amount' => $recurringCost->calculateTotalAmount()]);

        return redirect()->route('admin.recurring-costs.index')
            ->with('success', '經常性費用組合已更新');
    }

    // 刪除
    public function destroy(RecurringCostTemplate $recurringCost)
    {
        $recurringCost->delete();

        return redirect()->route('admin.recurring-costs.index')
            ->with('success', '經常性費用組合已刪除');
    }

    // 批量套用
    public function batchApply(Request $request)
    {
        $validated = $request->validate([
            'template_id' => 'required|exists:recurring_cost_templates,id',
            'driver_ids' => 'required|array|min:1',
            'driver_ids.*' => 'exists:drivers,id',
        ]);

        Driver::whereIn('id', $validated['driver_ids'])
            ->update(['recurring_cost_id' => $validated['template_id']]);

        $count = count($validated['driver_ids']);

        return back()->with('success', "已成功將組合套用至 {$count} 位駕駛");
    }
}
```

### 路由設計

#### routes/web.php
```php
// 管理員路由群組
Route::middleware(['auth', 'role:admin'])->prefix('admin')->name('admin.')->group(function () {

    // 經常性費用管理
    Route::prefix('recurring-costs')->name('recurring-costs.')->group(function () {
        Route::get('/', [RecurringCostController::class, 'index'])->name('index');
        Route::get('/create', [RecurringCostController::class, 'create'])->name('create');
        Route::post('/', [RecurringCostController::class, 'store'])->name('store');
        Route::get('/{recurringCost}/edit', [RecurringCostController::class, 'edit'])->name('edit');
        Route::put('/{recurringCost}', [RecurringCostController::class, 'update'])->name('update');
        Route::delete('/{recurringCost}', [RecurringCostController::class, 'destroy'])->name('destroy');
        Route::post('/batch-apply', [RecurringCostController::class, 'batchApply'])->name('batch-apply');
    });

});
```

---

## 🎨 前端架構

### 頁面結構

#### 1. Index.vue（列表頁）
- 顯示所有費用組合
- 搜尋功能
- 顯示組合名稱、總金額、包含項目數、使用駕駛數
- 操作：編輯、刪除、批量套用

#### 2. Create.vue（新增頁）
- 輸入組合名稱、說明
- 動態新增/刪除費用項目
- 選擇會計科目、輸入金額、備註
- 即時計算總金額

#### 3. Edit.vue（編輯頁）
- 與 Create.vue 類似
- 預填現有資料

#### 4. BatchApplyModal.vue（批量套用彈窗）
- 選擇多個駕駛
- 選擇要套用的組合
- 確認套用

### 組件設計

```vue
<template>
  <AdminLayout :user="$page.props.auth.user">
    <!-- 頁面標題 -->
    <PageHeader title="經常性費用管理" />

    <!-- 搜尋與操作列 -->
    <div class="d-flex justify-content-between mb-3">
      <SearchInput v-model="filters.search" />
      <Link :href="route('admin.recurring-costs.create')" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 新增組合
      </Link>
    </div>

    <!-- 列表 -->
    <DataTable :data="templates" :columns="columns">
      <template #actions="{ row }">
        <ActionButtons :row="row" @edit="edit" @delete="destroy" />
      </template>
    </DataTable>

    <!-- 批量套用彈窗 -->
    <BatchApplyModal v-model="showBatchModal" :templates="templates" />
  </AdminLayout>
</template>
```

---

## 🔐 安全性考量

1. **權限控制**
   - 只有管理員可以管理經常性費用組合
   - 使用 `role:admin` middleware

2. **資料驗證**
   - 金額必須為非負整數
   - 至少要有一個費用項目
   - 會計科目必須存在

3. **刪除保護**
   - 使用軟刪除保留歷史記錄
   - 刪除時自動解除駕駛關聯

4. **審計追蹤**
   - 記錄建立者和更新者
   - 保留 created_at 和 updated_at 時間戳

---

## 📅 開發計畫

### Phase 1: 資料庫與 Model（第 1 天）
- [ ] 建立 migration 檔案
- [ ] 建立 Model 和關聯
- [ ] 執行 migration
- [ ] 建立 Seeder（測試資料）

### Phase 2: 後端 API（第 2 天）
- [ ] 建立 Controller
- [ ] 設定路由
- [ ] 實作 CRUD 功能
- [ ] 實作批量套用功能
- [ ] 測試 API

### Phase 3: 前端介面（第 3-4 天）
- [ ] 建立列表頁（Index.vue）
- [ ] 建立新增/編輯頁（Create/Edit.vue）
- [ ] 建立批量套用彈窗
- [ ] 整合 Bootstrap 5 樣式
- [ ] 測試使用者流程

### Phase 4: 整合測試（第 5 天）
- [ ] 端對端測試
- [ ] 修正 Bug
- [ ] 效能優化
- [ ] 文件補充

---

## 📝 測試案例

### 功能測試
1. ✅ 建立新組合（包含多個項目）
2. ✅ 編輯現有組合
3. ✅ 刪除組合（驗證駕駛關聯自動解除）
4. ✅ 批量套用組合到多個駕駛
5. ✅ 搜尋組合
6. ✅ 總金額自動計算

### 邊界測試
1. ✅ 建立空項目的組合（應失敗）
2. ✅ 金額為負數（應失敗）
3. ✅ 選擇不存在的會計科目（應失敗）
4. ✅ 刪除正在使用的組合（應成功，駕駛關聯自動解除）

---

## 🚀 部署注意事項

1. **資料庫遷移**
   ```bash
   php artisan migrate
   ```

2. **權限設定**
   - 確保管理員角色已建立
   - 測試權限中介軟體

3. **前端編譯**
   ```bash
   npm run build
   ```

4. **清除快取**
   ```bash
   php artisan config:clear
   php artisan route:clear
   php artisan view:clear
   ```

---

## 📚 相關文件

- [Laravel 11 文件](https://laravel.com/docs/11.x)
- [Vue 3 文件](https://vuejs.org/)
- [Inertia.js 文件](https://inertiajs.com/)
- [Bootstrap 5 文件](https://getbootstrap.com/)

---

## 📞 聯絡資訊

如有問題或建議，請聯絡開發團隊。

---

**文件版本**: 1.0
**最後更新**: 2025-10-11
**維護者**: 開發團隊
