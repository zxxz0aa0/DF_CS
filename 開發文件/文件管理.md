# 文件管理系統開發規劃文件

此文件為公司文件管理系統開發的完整規劃文件，詳細記錄專案背景、需求分析、技術架構、開發計畫等。

## 📋 專案概述

### 專案背景
大豐交通企業集團需要統一管理旗下證件資料掃描檔案的儲存資料，並且有些證件會有期限的追蹤需求。使用者將駕駛證件、保險文件、車輛證件經過掃描後上傳至系統裡做留存與管理。

### 專案目標
- 建立統一的文件（掃描文件）資料管理平台
- 提供完整的文件生命週期管理
- 提供文件期限追蹤功能，自動提醒即將到期的文件
- 建立可擴展的資料架構，支援未來新增文件類別
- 整合駕駛與車輛管理系統，建立完整的關聯關係

### 專案範圍
- 文件基本資料管理（CRUD）
- 文件上傳功能（支援 PDF、JPEG、PNG 等格式）
- 一份文件可上傳多個檔案（例如：正反面掃描）
- 期限追蹤與到期提醒功能
- 狀態標籤顯示（已過期、即將到期、有效）
- 關聯駕駛或車輛資料
- 保險證件額外資訊管理（保險等級係數、保險費用）

## 🗄️ 資料庫設計

### documents 資料表結構（文件主表）

| 欄位名稱 | 資料型態 | 必填 | 說明 | 備註 |
|---------|---------|------|------|------|
| id | bigint unsigned | 是 | 主鍵 | 自動遞增 |
| driver_id | bigint unsigned | 否 | 駕駛 ID | 外鍵關聯 drivers.id，與 vehicle_id 二選一 |
| vehicle_id | bigint unsigned | 否 | 車輛 ID | 外鍵關聯 vehicles.id，與 driver_id 二選一 |
| document_category | enum | 是 | 文件類別 | 'identity', 'insurance', 'vehicle' |
| document_name | string(255) | 是 | 文件名稱 | 例如：駕照、行照、強制險 |
| document_number | string(100) | 否 | 文件號碼 | 證件號碼或保單號碼 |
| insurance_level | decimal(10,2) | 否 | 保險等級係數 | 僅保險證件使用 |
| insurance_fee | decimal(10,2) | 否 | 保險費用 | 僅保險證件使用 |
| start_date | date | 否 | 文件開始日 | 若未填寫則不追蹤期限 |
| expiry_date | date | 否 | 文件到期日 | 若未填寫則不追蹤期限 |
| status | enum | 是 | 文件狀態 | 'valid', 'expiring_soon', 'expired' 自動計算 |
| notes | text | 否 | 備註 | 額外說明 |
| created_by | bigint unsigned | 是 | 建立者 | 外鍵關聯 users.id |
| updated_by | bigint unsigned | 否 | 更新者 | 外鍵關聯 users.id |
| created_at | timestamp | 是 | 建立時間 | Laravel 自動管理 |
| updated_at | timestamp | 是 | 更新時間 | Laravel 自動管理 |
| deleted_at | timestamp | 否 | 軟刪除時間 | 支援軟刪除 |

### document_files 資料表結構（文件檔案表）

| 欄位名稱 | 資料型態 | 必填 | 說明 | 備註 |
|---------|---------|------|------|------|
| id | bigint unsigned | 是 | 主鍵 | 自動遞增 |
| document_id | bigint unsigned | 是 | 文件 ID | 外鍵關聯 documents.id |
| file_name | string(255) | 是 | 原始檔案名稱 | 使用者上傳的檔名 |
| file_path | string(500) | 是 | 檔案儲存路徑 | storage 路徑 |
| file_type | string(50) | 是 | 檔案類型 | pdf, jpeg, png, jpg |
| file_size | bigint | 是 | 檔案大小 | 單位：bytes |
| sort_order | integer | 是 | 排序順序 | 用於多檔案排序，預設 0 |
| uploaded_by | bigint unsigned | 是 | 上傳者 | 外鍵關聯 users.id |
| created_at | timestamp | 是 | 上傳時間 | Laravel 自動管理 |
| updated_at | timestamp | 是 | 更新時間 | Laravel 自動管理 |

### 索引設計

#### documents 表
- 主鍵：id
- 外鍵索引：driver_id, vehicle_id, created_by, updated_by
- 一般索引：document_category, status, expiry_date
- 複合索引：(driver_id, document_category), (vehicle_id, document_category)

#### document_files 表
- 主鍵：id
- 外鍵索引：document_id, uploaded_by
- 一般索引：file_type
- 排序索引：(document_id, sort_order)

### 業務邏輯約束

1. **關聯關係約束**：
   - driver_id 和 vehicle_id 必須「二選一」填寫，不可同時為空
   - 不可同時填寫 driver_id 和 vehicle_id
   - 使用資料庫檢查約束或應用層驗證

2. **期限追蹤邏輯**：
   - 若 start_date 或 expiry_date 其中一個為 null，則不追蹤期限
   - status 自動計算規則：
     - `expired`：expiry_date < 今天
     - `expiring_soon`：距離 expiry_date ≤ 60 天
     - `valid`：距離 expiry_date > 60 天

3. **文件類別與欄位關聯**：
   - `insurance_level` 和 `insurance_fee` 主要用於 document_category = 'insurance'
   - 其他類別可彈性使用這些欄位（未來擴展）

4. **檔案上傳限制**：
   - 每份文件可上傳多個檔案
   - 支援格式：PDF, JPEG, JPG, PNG
   - 單檔最大 10MB
   - 總檔案數建議上限 20 個

## 🔧 技術實作架構

### 後端架構 (Laravel)

#### 1. 資料庫遷移 (Migration)

**documents 表 Migration：**
```php
// database/migrations/xxxx_create_documents_table.php
Schema::create('documents', function (Blueprint $table) {
    $table->id();
    $table->foreignId('driver_id')->nullable()->constrained('drivers')->onDelete('cascade');
    $table->foreignId('vehicle_id')->nullable()->constrained('vehicles')->onDelete('cascade');
    $table->enum('document_category', ['identity', 'insurance', 'vehicle']);
    $table->string('document_name', 255);
    $table->string('document_number', 100)->nullable();
    $table->decimal('insurance_level', 10, 2)->nullable();
    $table->decimal('insurance_fee', 10, 2)->nullable();
    $table->date('start_date')->nullable();
    $table->date('expiry_date')->nullable();
    $table->enum('status', ['valid', 'expiring_soon', 'expired'])->default('valid');
    $table->text('notes')->nullable();
    $table->foreignId('created_by')->constrained('users');
    $table->foreignId('updated_by')->nullable()->constrained('users');
    $table->timestamps();
    $table->softDeletes();

    // 索引
    $table->index(['document_category']);
    $table->index(['status']);
    $table->index(['expiry_date']);
    $table->index(['driver_id', 'document_category']);
    $table->index(['vehicle_id', 'document_category']);

    // 約束：driver_id 和 vehicle_id 必須二選一
    // 注意：SQLite 不支援 CHECK 約束，改用應用層驗證
});
```

**document_files 表 Migration：**
```php
// database/migrations/xxxx_create_document_files_table.php
Schema::create('document_files', function (Blueprint $table) {
    $table->id();
    $table->foreignId('document_id')->constrained('documents')->onDelete('cascade');
    $table->string('file_name', 255);
    $table->string('file_path', 500);
    $table->string('file_type', 50);
    $table->bigInteger('file_size');
    $table->integer('sort_order')->default(0);
    $table->foreignId('uploaded_by')->constrained('users');
    $table->timestamps();

    // 索引
    $table->index(['document_id', 'sort_order']);
    $table->index(['file_type']);
});
```

#### 2. 模型 (Model)

**Document Model：**
```php
// app/Models/Document.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Carbon\Carbon;

class Document extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'driver_id',
        'vehicle_id',
        'document_category',
        'document_name',
        'document_number',
        'insurance_level',
        'insurance_fee',
        'start_date',
        'expiry_date',
        'status',
        'notes',
        'created_by',
        'updated_by',
    ];

    protected $casts = [
        'start_date' => 'date',
        'expiry_date' => 'date',
        'insurance_level' => 'decimal:2',
        'insurance_fee' => 'decimal:2',
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    protected $appends = [
        'days_until_expiry',
        'status_text',
        'status_color',
        'category_text',
    ];

    // 關聯
    public function driver()
    {
        return $this->belongsTo(Driver::class);
    }

    public function vehicle()
    {
        return $this->belongsTo(Vehicle::class);
    }

    public function files()
    {
        return $this->hasMany(DocumentFile::class)->orderBy('sort_order');
    }

    public function createdBy()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function updatedBy()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    // 存取器
    public function getDaysUntilExpiryAttribute(): ?int
    {
        if (!$this->expiry_date) {
            return null;
        }
        return (int) now()->diffInDays($this->expiry_date, false);
    }

    public function getStatusTextAttribute(): string
    {
        return match($this->status) {
            'valid' => '有效',
            'expiring_soon' => '即將到期',
            'expired' => '已過期',
            default => '未知',
        };
    }

    public function getStatusColorAttribute(): string
    {
        return match($this->status) {
            'valid' => 'success',
            'expiring_soon' => 'warning',
            'expired' => 'danger',
            default => 'secondary',
        };
    }

    public function getCategoryTextAttribute(): string
    {
        return match($this->document_category) {
            'identity' => '身分證件',
            'insurance' => '保險證件',
            'vehicle' => '車輛證件',
            default => '其他',
        };
    }

    // 範圍查詢
    public function scopeByCategory($query, $category)
    {
        return $query->where('document_category', $category);
    }

    public function scopeExpiringSoon($query, $days = 60)
    {
        return $query->whereNotNull('expiry_date')
            ->whereBetween('expiry_date', [now(), now()->addDays($days)]);
    }

    public function scopeExpired($query)
    {
        return $query->whereNotNull('expiry_date')
            ->where('expiry_date', '<', now());
    }

    public function scopeValid($query)
    {
        return $query->whereNull('expiry_date')
            ->orWhere('expiry_date', '>', now()->addDays(60));
    }

    public function scopeByDriver($query, $driverId)
    {
        return $query->where('driver_id', $driverId);
    }

    public function scopeByVehicle($query, $vehicleId)
    {
        return $query->where('vehicle_id', $vehicleId);
    }

    // 業務方法
    public function updateStatus(): void
    {
        if (!$this->expiry_date) {
            $this->status = 'valid';
            return;
        }

        $daysUntilExpiry = $this->days_until_expiry;

        if ($daysUntilExpiry < 0) {
            $this->status = 'expired';
        } elseif ($daysUntilExpiry <= 60) {
            $this->status = 'expiring_soon';
        } else {
            $this->status = 'valid';
        }

        $this->save();
    }

    public function isExpiringSoon(): bool
    {
        return $this->status === 'expiring_soon';
    }

    public function isExpired(): bool
    {
        return $this->status === 'expired';
    }

    public function isValid(): bool
    {
        return $this->status === 'valid';
    }

    // 模型事件
    protected static function booted()
    {
        static::saving(function ($document) {
            // 自動計算狀態
            if ($document->expiry_date) {
                $daysUntilExpiry = now()->diffInDays($document->expiry_date, false);

                if ($daysUntilExpiry < 0) {
                    $document->status = 'expired';
                } elseif ($daysUntilExpiry <= 60) {
                    $document->status = 'expiring_soon';
                } else {
                    $document->status = 'valid';
                }
            }
        });
    }
}
```

**DocumentFile Model：**
```php
// app/Models/DocumentFile.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;

class DocumentFile extends Model
{
    protected $fillable = [
        'document_id',
        'file_name',
        'file_path',
        'file_type',
        'file_size',
        'sort_order',
        'uploaded_by',
    ];

    protected $casts = [
        'file_size' => 'integer',
        'sort_order' => 'integer',
    ];

    protected $appends = [
        'file_url',
        'file_size_human',
    ];

    // 關聯
    public function document()
    {
        return $this->belongsTo(Document::class);
    }

    public function uploader()
    {
        return $this->belongsTo(User::class, 'uploaded_by');
    }

    // 存取器
    public function getFileUrlAttribute(): string
    {
        return Storage::url($this->file_path);
    }

    public function getFileSizeHumanAttribute(): string
    {
        $bytes = $this->file_size;
        $units = ['B', 'KB', 'MB', 'GB'];

        for ($i = 0; $bytes > 1024; $i++) {
            $bytes /= 1024;
        }

        return round($bytes, 2) . ' ' . $units[$i];
    }

    // 業務方法
    public function deleteFile(): bool
    {
        if (Storage::exists($this->file_path)) {
            Storage::delete($this->file_path);
        }
        return $this->delete();
    }

    public function isPDF(): bool
    {
        return strtolower($this->file_type) === 'pdf';
    }

    public function isImage(): bool
    {
        return in_array(strtolower($this->file_type), ['jpg', 'jpeg', 'png']);
    }
}
```

#### 3. 控制器 (Controller)

```php
// app/Http/Controllers/Admin/DocumentController.php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Document;
use App\Models\DocumentFile;
use App\Models\Driver;
use App\Models\Vehicle;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Inertia\Inertia;

class DocumentController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view documents')->only(['index', 'show']);
        $this->middleware('permission:create documents')->only(['create', 'store']);
        $this->middleware('permission:edit documents')->only(['edit', 'update']);
        $this->middleware('permission:delete documents')->only(['destroy', 'deleteFile']);
    }

    /**
     * 顯示文件列表
     */
    public function index(Request $request)
    {
        $query = Document::with(['driver', 'vehicle', 'files', 'createdBy']);

        // 搜尋
        if ($request->filled('search')) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('document_name', 'like', "%{$search}%")
                  ->orWhere('document_number', 'like', "%{$search}%");
            });
        }

        // 篩選：文件類別
        if ($request->filled('category')) {
            $query->byCategory($request->category);
        }

        // 篩選：狀態
        if ($request->filled('status')) {
            $query->where('status', $request->status);
        }

        // 篩選：關聯對象
        if ($request->filled('driver_id')) {
            $query->byDriver($request->driver_id);
        }
        if ($request->filled('vehicle_id')) {
            $query->byVehicle($request->vehicle_id);
        }

        $documents = $query->orderBy('expiry_date', 'asc')
                          ->orderBy('created_at', 'desc')
                          ->paginate(15);

        return Inertia::render('Admin/Documents/Index', [
            'documents' => $documents,
            'filters' => [
                'search' => $request->search,
                'category' => $request->category,
                'status' => $request->status,
                'driver_id' => $request->driver_id,
                'vehicle_id' => $request->vehicle_id,
            ],
            'stats' => [
                'total' => Document::count(),
                'expiring_soon' => Document::where('status', 'expiring_soon')->count(),
                'expired' => Document::where('status', 'expired')->count(),
            ],
        ]);
    }

    /**
     * 顯示新增表單
     */
    public function create()
    {
        $drivers = Driver::active()->orderBy('name')->get(['id', 'name', 'id_number']);
        $vehicles = Vehicle::active()->orderBy('license_number')->get(['id', 'license_number', 'brand', 'vehicle_model']);

        return Inertia::render('Admin/Documents/Create', [
            'drivers' => $drivers,
            'vehicles' => $vehicles,
        ]);
    }

    /**
     * 儲存新文件
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'driver_id' => 'nullable|exists:drivers,id',
            'vehicle_id' => 'nullable|exists:vehicles,id',
            'document_category' => 'required|in:identity,insurance,vehicle',
            'document_name' => 'required|string|max:255',
            'document_number' => 'nullable|string|max:100',
            'insurance_level' => 'nullable|numeric|min:0',
            'insurance_fee' => 'nullable|numeric|min:0',
            'start_date' => 'nullable|date',
            'expiry_date' => 'nullable|date|after_or_equal:start_date',
            'notes' => 'nullable|string|max:2000',
            'files.*' => 'required|file|mimes:pdf,jpg,jpeg,png|max:10240', // 10MB
        ]);

        // 驗證：driver_id 和 vehicle_id 必須二選一
        if (empty($validated['driver_id']) && empty($validated['vehicle_id'])) {
            return back()->withErrors(['driver_id' => '請選擇駕駛或車輛']);
        }
        if (!empty($validated['driver_id']) && !empty($validated['vehicle_id'])) {
            return back()->withErrors(['vehicle_id' => '不可同時選擇駕駛和車輛']);
        }

        $validated['created_by'] = auth()->id();
        $validated['updated_by'] = auth()->id();

        // 建立文件
        $document = Document::create($validated);

        // 上傳檔案
        if ($request->hasFile('files')) {
            foreach ($request->file('files') as $index => $file) {
                $path = $file->store('documents', 'public');

                DocumentFile::create([
                    'document_id' => $document->id,
                    'file_name' => $file->getClientOriginalName(),
                    'file_path' => $path,
                    'file_type' => $file->getClientOriginalExtension(),
                    'file_size' => $file->getSize(),
                    'sort_order' => $index,
                    'uploaded_by' => auth()->id(),
                ]);
            }
        }

        return redirect()->route('admin.documents.index')
            ->with('success', '文件已成功建立！');
    }

    /**
     * 顯示文件詳情
     */
    public function show(Document $document)
    {
        $document->load(['driver', 'vehicle', 'files', 'createdBy', 'updatedBy']);

        return Inertia::render('Admin/Documents/Show', [
            'document' => $document,
        ]);
    }

    /**
     * 顯示編輯表單
     */
    public function edit(Document $document)
    {
        $drivers = Driver::active()->orderBy('name')->get(['id', 'name', 'id_number']);
        $vehicles = Vehicle::active()->orderBy('license_number')->get(['id', 'license_number', 'brand', 'vehicle_model']);

        return Inertia::render('Admin/Documents/Edit', [
            'document' => $document->load(['driver', 'vehicle', 'files']),
            'drivers' => $drivers,
            'vehicles' => $vehicles,
        ]);
    }

    /**
     * 更新文件
     */
    public function update(Request $request, Document $document)
    {
        $validated = $request->validate([
            'driver_id' => 'nullable|exists:drivers,id',
            'vehicle_id' => 'nullable|exists:vehicles,id',
            'document_category' => 'required|in:identity,insurance,vehicle',
            'document_name' => 'required|string|max:255',
            'document_number' => 'nullable|string|max:100',
            'insurance_level' => 'nullable|numeric|min:0',
            'insurance_fee' => 'nullable|numeric|min:0',
            'start_date' => 'nullable|date',
            'expiry_date' => 'nullable|date|after_or_equal:start_date',
            'notes' => 'nullable|string|max:2000',
            'files.*' => 'nullable|file|mimes:pdf,jpg,jpeg,png|max:10240',
        ]);

        // 驗證：driver_id 和 vehicle_id 必須二選一
        if (empty($validated['driver_id']) && empty($validated['vehicle_id'])) {
            return back()->withErrors(['driver_id' => '請選擇駕駛或車輛']);
        }
        if (!empty($validated['driver_id']) && !empty($validated['vehicle_id'])) {
            return back()->withErrors(['vehicle_id' => '不可同時選擇駕駛和車輛']);
        }

        $validated['updated_by'] = auth()->id();
        $document->update($validated);

        // 新增檔案
        if ($request->hasFile('files')) {
            $maxOrder = $document->files()->max('sort_order') ?? -1;

            foreach ($request->file('files') as $index => $file) {
                $path = $file->store('documents', 'public');

                DocumentFile::create([
                    'document_id' => $document->id,
                    'file_name' => $file->getClientOriginalName(),
                    'file_path' => $path,
                    'file_type' => $file->getClientOriginalExtension(),
                    'file_size' => $file->getSize(),
                    'sort_order' => $maxOrder + $index + 1,
                    'uploaded_by' => auth()->id(),
                ]);
            }
        }

        return redirect()->route('admin.documents.index')
            ->with('success', '文件已成功更新！');
    }

    /**
     * 刪除文件
     */
    public function destroy(Document $document)
    {
        $documentName = $document->document_name;

        // 刪除所有關聯檔案
        foreach ($document->files as $file) {
            if (Storage::exists($file->file_path)) {
                Storage::delete($file->file_path);
            }
        }

        $document->delete();

        return redirect()->route('admin.documents.index')
            ->with('success', "文件「{$documentName}」已成功刪除！");
    }

    /**
     * 刪除單一檔案
     */
    public function deleteFile(DocumentFile $file)
    {
        if (Storage::exists($file->file_path)) {
            Storage::delete($file->file_path);
        }

        $file->delete();

        return back()->with('success', '檔案已成功刪除！');
    }

    /**
     * 下載檔案
     */
    public function downloadFile(DocumentFile $file)
    {
        if (!Storage::exists($file->file_path)) {
            abort(404, '檔案不存在');
        }

        return Storage::download($file->file_path, $file->file_name);
    }
}
```

#### 4. 表單驗證 (Form Request)

```php
// app/Http/Requests/Admin/DocumentRequest.php
<?php

namespace App\Http\Requests\Admin;

use Illuminate\Foundation\Http\FormRequest;

class DocumentRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'driver_id' => 'nullable|exists:drivers,id',
            'vehicle_id' => 'nullable|exists:vehicles,id',
            'document_category' => 'required|in:identity,insurance,vehicle',
            'document_name' => 'required|string|max:255',
            'document_number' => 'nullable|string|max:100',
            'insurance_level' => 'nullable|numeric|min:0|max:999999.99',
            'insurance_fee' => 'nullable|numeric|min:0|max:999999999.99',
            'start_date' => 'nullable|date',
            'expiry_date' => 'nullable|date|after_or_equal:start_date',
            'notes' => 'nullable|string|max:2000',
            'files.*' => 'nullable|file|mimes:pdf,jpg,jpeg,png|max:10240',
        ];
    }

    public function withValidator($validator)
    {
        $validator->after(function ($validator) {
            // 驗證：driver_id 和 vehicle_id 必須二選一
            if (empty($this->driver_id) && empty($this->vehicle_id)) {
                $validator->errors()->add('driver_id', '請選擇駕駛或車輛');
            }

            if (!empty($this->driver_id) && !empty($this->vehicle_id)) {
                $validator->errors()->add('vehicle_id', '不可同時選擇駕駛和車輛');
            }

            // 驗證：保險證件必須填寫保險相關欄位
            if ($this->document_category === 'insurance') {
                if (empty($this->insurance_level)) {
                    $validator->errors()->add('insurance_level', '保險證件必須填寫保險等級係數');
                }
                if (empty($this->insurance_fee)) {
                    $validator->errors()->add('insurance_fee', '保險證件必須填寫保險費用');
                }
            }
        });
    }

    public function messages(): array
    {
        return [
            'document_category.required' => '請選擇文件類別',
            'document_name.required' => '請輸入文件名稱',
            'expiry_date.after_or_equal' => '到期日必須大於或等於開始日',
            'files.*.mimes' => '檔案格式必須為 PDF、JPG、JPEG 或 PNG',
            'files.*.max' => '單一檔案不可超過 10MB',
        ];
    }
}
```

#### 5. 路由設計

```php
// routes/web.php
Route::middleware(['auth', 'permission:view documents'])->prefix('admin')->group(function () {
    Route::resource('documents', DocumentController::class);

    // 檔案相關路由
    Route::delete('document-files/{file}', [DocumentController::class, 'deleteFile'])
        ->name('documents.files.delete')
        ->middleware('permission:delete documents');

    Route::get('document-files/{file}/download', [DocumentController::class, 'downloadFile'])
        ->name('documents.files.download');
});
```

### 前端架構 (Vue 3 + Inertia.js)

#### 1. 頁面組件

- `resources/js/Pages/Admin/Documents/Index.vue` - 文件列表
- `resources/js/Pages/Admin/Documents/Create.vue` - 新增文件
- `resources/js/Pages/Admin/Documents/Edit.vue` - 編輯文件
- `resources/js/Pages/Admin/Documents/Show.vue` - 文件詳情

#### 2. 共用組件

- `resources/js/Components/Documents/FileUploader.vue` - 多檔案上傳組件
- `resources/js/Components/Documents/FilePreview.vue` - 檔案預覽組件
- `resources/js/Components/Documents/StatusBadge.vue` - 狀態標籤組件
- `resources/js/Components/Documents/ExpiryAlert.vue` - 到期提醒組件
- `resources/js/Components/Documents/CategorySelector.vue` - 文件類別選擇器

#### 3. 使用 AdminLTE 4 樣式框架

- 整合 Bootstrap 5 樣式
- 使用 Bootstrap Icons
- 響應式設計
- 卡片式版面配置

## 🎨 前端 UI/UX 設計

### 主要功能頁面設計

#### 1. 文件列表頁面 (`/admin/documents`)

**版面配置：**
- 使用 AdminLayout 版面
- 頁面標題：「文件管理」
- 功能按鈕：「新增文件」（右上角）

**統計卡片區：**
- 總文件數
- 即將到期（60天內）
- 已過期

**篩選區：**
- 關鍵字搜尋（文件名稱、文件號碼）
- 文件類別下拉選單
- 狀態下拉選單
- 駕駛選擇器
- 車輛選擇器

**資料表格：**
| 欄位 | 說明 |
|-----|------|
| 文件名稱 | 點擊可查看詳情 |
| 類別 | 身分證件/保險證件/車輛證件 |
| 關聯對象 | 駕駛姓名 或 車牌號碼 |
| 文件號碼 | - |
| 到期日 | 顯示日期 + 剩餘天數 |
| 狀態 | 標籤顯示（顏色標示） |
| 檔案數 | 顯示上傳檔案數量 |
| 操作 | 查看、編輯、刪除 |

**狀態顯示規則：**
- **已過期**（紅色 badge）：expiry_date < 今天
- **即將到期**（黃色/橘色 badge）：距離到期 ≤ 60 天
- **有效**（綠色 badge）：距離到期 > 60 天
- **無期限**（灰色 badge）：未設定到期日

**剩餘天數顯示：**
```html
<!-- 已過期 -->
<span class="text-danger">已過期 15 天</span>

<!-- 即將到期（≤60天） -->
<span class="text-warning">剩餘 45 天</span>

<!-- 有效 -->
<span class="text-success">剩餘 120 天</span>

<!-- 無期限 -->
<span class="text-muted">—</span>
```

#### 2. 新增文件頁面 (`/admin/documents/create`)

**表單設計：**

**第一區：關聯對象選擇**
- 單選按鈕：「駕駛」或「車輛」（二選一）
- 駕駛搜尋框（可搜尋姓名、身分證字號）
- 車輛搜尋框（可搜尋車牌、廠牌）
- 預覽已選擇的對象資訊

**第二區：文件基本資料**
- 文件類別：下拉選單（身分證件、保險證件、車輛證件）
- 文件名稱：文字輸入框（必填）
- 文件號碼：文字輸入框（選填）

**第三區：期限設定**
- 文件開始日：日期選擇器（選填）
- 文件到期日：日期選擇器（選填）
- 說明文字：「若不需要追蹤期限，可不填寫日期」

**第四區：保險資訊**（當選擇「保險證件」時顯示）
- 保險等級係數：數字輸入框
- 保險費用：數字輸入框

**第五區：檔案上傳**
- 多檔案上傳區（拖拉上傳 + 點擊上傳）
- 顯示已上傳檔案列表
- 支援排序（拖拉排序）
- 每個檔案顯示：檔名、大小、類型、預覽、刪除按鈕

**第六區：備註**
- 備註文字區域

**提交按鈕區：**
- 取消按鈕（返回列表）
- 儲存按鈕

#### 3. 編輯文件頁面 (`/admin/documents/edit/{id}`)

**與新增頁面類似，額外功能：**
- 顯示目前已上傳的檔案列表
- 可新增更多檔案
- 可刪除現有檔案
- 可調整檔案排序
- 顯示建立者、建立時間、最後更新者、更新時間

#### 4. 文件詳情頁面 (`/admin/documents/show/{id}`)

**版面配置：**

**資訊卡片：**
- 文件名稱（大標題）
- 狀態標籤（右上角）
- 剩餘天數提醒（大字體顯示）

**詳細資訊區：**
| 欄位 | 值 |
|-----|---|
| 文件類別 | 身分證件/保險證件/車輛證件 |
| 關聯對象 | 駕駛姓名 或 車牌號碼（可點擊跳轉） |
| 文件號碼 | - |
| 開始日期 | YYYY-MM-DD |
| 到期日期 | YYYY-MM-DD |
| 保險等級係數 | 僅保險證件顯示 |
| 保險費用 | 僅保險證件顯示 |
| 備註 | - |
| 建立者 | 使用者姓名 |
| 建立時間 | YYYY-MM-DD HH:mm |
| 最後更新者 | 使用者姓名 |
| 更新時間 | YYYY-MM-DD HH:mm |

**檔案列表區：**
- 卡片式顯示每個檔案
- 顯示預覽圖（圖片類型）或圖示（PDF）
- 檔案名稱、大小、上傳時間
- 操作按鈕：下載、刪除

**操作按鈕：**
- 編輯文件
- 刪除文件
- 返回列表

### 互動體驗

#### 1. 檔案上傳體驗
- 支援拖拉上傳（Drag & Drop）
- 支援點擊選擇多個檔案
- 即時顯示上傳進度
- 上傳前檔案格式與大小驗證
- 圖片類型即時預覽縮圖
- PDF 顯示 PDF 圖示

#### 2. 到期提醒
- 列表頁用顏色標示到期狀態
- 即將到期的文件置頂顯示
- 剩餘天數 ≤ 60 天時用紅色/橘色醒目顯示
- Dashboard 顯示到期提醒摘要

#### 3. 關聯對象選擇
- 單選「駕駛」或「車輛」
- 選擇後自動隱藏另一選項
- 搜尋框支援模糊搜尋
- 下拉選單顯示關鍵資訊（姓名+身分證、車牌+廠牌）

#### 4. 表單驗證
- 即時驗證（輸入時檢查）
- 錯誤提示（紅色邊框 + 錯誤訊息）
- 成功提示（綠色 Toast 訊息）

## 🔐 權限管理規劃

### 權限定義

```php
// database/seeders/DocumentPermissionSeeder.php
$permissions = [
    'view documents'     => '查看文件',
    'create documents'   => '新增文件',
    'edit documents'     => '編輯文件',
    'delete documents'   => '刪除文件',
    'download documents' => '下載文件',
];
```

### 實作方式
- 路由層級權限檢查
- 控制器層級權限檢查
- 前端介面權限控制

## 📅 開發時程規劃

### 第一階段：基礎建設 (2-3 天)
- [ ] 建立 documents 資料表 migration
- [ ] 建立 document_files 資料表 migration
- [ ] 建立 Document 模型與關聯
- [ ] 建立 DocumentFile 模型與關聯
- [ ] 建立權限種子檔案
- [ ] 更新 Driver 和 Vehicle 模型關聯

### 第二階段：後端 API 開發 (3-4 天)
- [ ] 建立 DocumentController
- [ ] 實作 CRUD 方法
- [ ] 實作檔案上傳功能
- [ ] 實作檔案刪除功能
- [ ] 實作檔案下載功能
- [ ] 建立表單驗證 (DocumentRequest)
- [ ] 設定路由和中介軟體
- [ ] 實作搜尋和篩選功能
- [ ] 實作狀態自動計算邏輯

### 第三階段：前端介面開發 (4-5 天)
- [ ] 建立文件列表頁面 (Index.vue)
- [ ] 建立新增文件頁面 (Create.vue)
- [ ] 建立編輯文件頁面 (Edit.vue)
- [ ] 建立文件詳情頁面 (Show.vue)
- [ ] 開發檔案上傳組件 (FileUploader.vue)
- [ ] 開發檔案預覽組件 (FilePreview.vue)
- [ ] 開發狀態標籤組件 (StatusBadge.vue)
- [ ] 開發到期提醒組件 (ExpiryAlert.vue)
- [ ] 開發文件類別選擇器 (CategorySelector.vue)
- [ ] 實作拖拉上傳功能
- [ ] 實作檔案排序功能
- [ ] 響應式設計調整

### 第四階段：整合測試與優化 (2-3 天)
- [ ] 前後端整合測試
- [ ] 權限功能測試
- [ ] 檔案上傳功能測試
- [ ] 狀態計算邏輯測試
- [ ] 到期提醒功能測試
- [ ] 業務邏輯驗證
- [ ] 效能優化
- [ ] 使用者體驗優化

### 總開發時程：11-15 天

## 📋 檢查清單

### 開發完成檢查項目

#### 資料庫
- [ ] documents 資料表正確建立
- [ ] document_files 資料表正確建立
- [ ] 索引正確設置
- [ ] 外鍵約束正確
- [ ] 軟刪除功能正常

#### 後端功能
- [ ] 所有 CRUD 功能正常運作
- [ ] 檔案上傳功能正常
- [ ] 檔案刪除功能正常
- [ ] 檔案下載功能正常
- [ ] 關聯約束正確執行（駕駛或車輛二選一）
- [ ] 狀態自動計算正確
- [ ] 搜尋和篩選功能正常
- [ ] 表單驗證正確
- [ ] 錯誤處理完善

#### 前端功能
- [ ] 文件列表正常顯示
- [ ] 統計卡片正確顯示
- [ ] 篩選功能正常
- [ ] 新增文件功能正常
- [ ] 編輯文件功能正常
- [ ] 文件詳情正常顯示
- [ ] 檔案上傳功能正常
- [ ] 拖拉上傳功能正常
- [ ] 檔案預覽功能正常
- [ ] 檔案下載功能正常
- [ ] 檔案刪除功能正常
- [ ] 狀態標籤正確顯示
- [ ] 到期提醒正確顯示
- [ ] 剩餘天數計算正確
- [ ] 介面美觀易用
- [ ] 響應式設計正常

#### 權限控制
- [ ] 權限控制正確實施
- [ ] 路由層級權限正常
- [ ] 前端按鈕權限控制正常

#### 安全性
- [ ] 檔案上傳驗證（格式、大小）
- [ ] 檔案儲存路徑安全
- [ ] CSRF 保護啟用
- [ ] SQL 注入防護
- [ ] XSS 防護

#### 效能
- [ ] 資料庫查詢優化
- [ ] 關聯載入優化（Eager Loading）
- [ ] 分頁功能正常
- [ ] 檔案上傳效能可接受

## 🔄 未來擴展規劃

### 可能的功能擴展

1. **批量操作**
   - 批量上傳文件
   - 批量更新到期日
   - 批量刪除文件

2. **進階提醒**
   - Email 到期提醒
   - 系統通知提醒
   - 自訂提醒天數

3. **文件版本控制**
   - 保留文件歷史版本
   - 版本比對功能

4. **文件分享**
   - 產生分享連結
   - 設定分享權限與期限

5. **更多文件類別**
   - 支援自訂文件類別
   - 動態欄位設定

6. **OCR 文字辨識**
   - 自動辨識證件資訊
   - 自動填入表單欄位

7. **報表功能**
   - 到期文件報表
   - 文件統計報表
   - 匯出 Excel/PDF

## 📝 備註

### 開發注意事項

1. **檔案儲存**
   - 使用 Laravel Storage 管理檔案
   - 檔案儲存在 `storage/app/public/documents/`
   - 需執行 `php artisan storage:link` 建立符號連結

2. **狀態自動更新**
   - 使用 Laravel Task Scheduling 每日更新文件狀態
   - 在 `app/Console/Kernel.php` 設定排程

3. **效能考量**
   - 使用 Eager Loading 避免 N+1 問題
   - 大量檔案時考慮使用 CDN 或雲端儲存

4. **安全性**
   - 檔案上傳前驗證 MIME Type
   - 儲存檔案時使用隨機檔名
   - 下載檔案時檢查權限

5. **使用者體驗**
   - 檔案上傳進度條提示
   - 即將到期的文件醒目標示
   - 操作成功/失敗的明確回饋
